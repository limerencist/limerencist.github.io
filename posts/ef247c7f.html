<!DOCTYPE html><html lang="zh-HK" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/rock-gesture.png"><link rel="icon" href="/img/rock-gesture.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Felix Cheung"><meta name="keywords" content=""><meta name="description" content="由于工作需要，K8S总有服务是需要重复部署的，例如监控、日志等，每此都从网上整理很麻烦，而且往往有错误或者因K8S版本原因需要修改。虽然使用helm或者operator方式部署更为方便，但都是经过别人封装的东西，且万变不离yaml。本文旨在记录一些常用的组件yaml，做到开箱即用——至少在我本地直接kubectl apply -f 就可以运行。诚然，有不规范或不严谨的地方在所难免，往各位海"><meta property="og:type" content="article"><meta property="og:title" content="K8S常用yaml汇总"><meta property="og:url" content="https://koanight.github.io/posts/ef247c7f.html"><meta property="og:site_name" content="失落之地"><meta property="og:description" content="由于工作需要，K8S总有服务是需要重复部署的，例如监控、日志等，每此都从网上整理很麻烦，而且往往有错误或者因K8S版本原因需要修改。虽然使用helm或者operator方式部署更为方便，但都是经过别人封装的东西，且万变不离yaml。本文旨在记录一些常用的组件yaml，做到开箱即用——至少在我本地直接kubectl apply -f 就可以运行。诚然，有不规范或不严谨的地方在所难免，往各位海"><meta property="og:locale" content="zh_HK"><meta property="og:image" content="https://koanight.github.io/img/k8s.jpg"><meta property="article:published_time" content="2023-02-23T02:20:52.000Z"><meta property="article:modified_time" content="2023-02-23T07:09:17.000Z"><meta property="article:author" content="Felix Cheung"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://koanight.github.io/img/k8s.jpg"><meta name="referrer" content="no-referrer-when-downgrade"><title>K8S常用yaml汇总 | 失落之地</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"koanight.github.io",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:50,cursorChar:"|",loop:!0,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!1,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"left",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:1},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:50vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>失落之地</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首頁</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>歸檔</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分類</span></a></li><li class="nav-item"><a class="nav-link" href="/playlist/"><i class="iconfont icon-music"></i> <span>歌单</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>關於</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/k8s.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="K8S常用yaml汇总"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-02-23 10:20" pubdate>2023年2月23日 上午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 61k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 305 分鐘 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="padding-left:2rem;margin-right:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目錄</span></p><div class="toc-body" id="toc-body"></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">K8S常用yaml汇总</h1><p class="note note-info">本文最後更新於：3 個月前</p><div class="markdown-body"><p>   由于工作需要，K8S总有服务是需要重复部署的，例如监控、日志等，每此都从网上整理很麻烦，而且往往有错误或者因K8S版本原因需要修改。虽然使用helm或者operator方式部署更为方便，但都是经过别人封装的东西，且万变不离yaml。本文旨在记录一些常用的组件yaml，做到开箱即用——至少在我本地直接kubectl apply -f 就可以运行。诚然，有不规范或不严谨的地方在所难免，往各位海涵。</p><blockquote><p>说明：</p><p>1、涉及到的数据存储都依赖于StorageClass，需要K8S集群内提前创建。</p><p>2、使用的镜像如不加tag，即使用latest镜像，以供使用者有需要添加制定版本的tag。</p><p>3、个人习惯创建资源的顺序为 <code>RBAC</code> → <code>Configmap/Secret</code> → <code>Deployment/Statefulset/Deamonset</code> → <code>Service</code> ，实际可按需使用 <code>Ingress</code>。</p></blockquote><h1 id="通用类"><a class="markdownIt-Anchor" href="#通用类"></a> 通用类</h1><h2 id="grafana"><a class="markdownIt-Anchor" href="#grafana"></a> Grafana</h2><h3 id="01-grafana-pvcyaml"><a class="markdownIt-Anchor" href="#01-grafana-pvcyaml"></a> 01-grafana-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、storage 存储大小</span><br><span class="hljs-comment"># 2、storageclass 名称</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">grafana-data</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br></code></pre></td></tr></table></figure><h3 id="02-grafana-deployyaml"><a class="markdownIt-Anchor" href="#02-grafana-deployyaml"></a> 02-grafana-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">grafana</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">grafana</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">grafana</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">grafana</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">securityContext:</span><br>        <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">472</span><br>        <span class="hljs-attr">supplementalGroups:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-number">0</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grafana</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/grafana</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-grafana</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">3000</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/robots.txt</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">3000</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">2</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">tcpSocket:</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">3000</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">250m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">750Mi</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grafana-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/grafana</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grafana-data-volume</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">grafana-data</span><br></code></pre></td></tr></table></figure><h3 id="03-grafana-svcyaml"><a class="markdownIt-Anchor" href="#03-grafana-svcyaml"></a> 03-grafana-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">grafana</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">grafana</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grafana-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">3000</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-grafana</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31001</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">grafana</span><br></code></pre></td></tr></table></figure><hr><h2 id="minio"><a class="markdownIt-Anchor" href="#minio"></a> Minio</h2><blockquote><p>因Minio简单，此处以minio作为后续用到的对象存储，有其他对象存储的可以略过。</p></blockquote><h3 id="01-minio-pvcyaml"><a class="markdownIt-Anchor" href="#01-minio-pvcyaml"></a> 01-minio-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、storage 存储大小</span><br><span class="hljs-comment"># 2、storageclass 名称</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">minio-data</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">100Gi</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br></code></pre></td></tr></table></figure><h3 id="02-minio-deployyaml"><a class="markdownIt-Anchor" href="#02-minio-deployyaml"></a> 02-minio-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、console-address minio控制台端口</span><br><span class="hljs-comment"># 2、MINIO_ROOT_USER/MINIO_ROOT_PASSWORD 登录minio控制台的账号密码</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">minio</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">minio</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">minio</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">minio</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">minio</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">minio/minio</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">server</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">/data</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--console-address&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;:9001&#x27;</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MINIO_ROOT_USER</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;admin&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MINIO_ROOT_PASSWORD</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;admin123&quot;</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-minio</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9000</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-console</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9001</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">minio-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">minio-data-volume</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">minio-data</span><br></code></pre></td></tr></table></figure><h3 id="03-minio-svcyaml"><a class="markdownIt-Anchor" href="#03-minio-svcyaml"></a> 03-minio-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">minio</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">minio</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">minio-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9000</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-minio</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">console-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9001</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-console</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">minio</span><br></code></pre></td></tr></table></figure><h1 id="日志"><a class="markdownIt-Anchor" href="#日志"></a> 日志</h1><blockquote><p>相对于重量级日志分析的ELK(F)，这里使用更为轻量的Lok仅仅作为日志的查看工具，并对接minio。</p></blockquote><h2 id="loki"><a class="markdownIt-Anchor" href="#loki"></a> Loki</h2><h3 id="01-loki-rbacyaml"><a class="markdownIt-Anchor" href="#01-loki-rbacyaml"></a> 01-loki-rbac.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">extensions</span><br>    <span class="hljs-attr">resourceNames:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">loki</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">podsecuritypolicies</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">use</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure><h3 id="02-loki-cmyaml"><a class="markdownIt-Anchor" href="#02-loki-cmyaml"></a> 02-loki-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、shared_store 存储类型</span><br><span class="hljs-comment"># 2、s3 对象存储的aksk及url</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">loki.yaml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    auth_enabled: false</span><br><span class="hljs-string">    server:</span><br><span class="hljs-string">      http_listen_port: 3100</span><br><span class="hljs-string">    ingester:</span><br><span class="hljs-string">      lifecycler:       #配置ingester的生命周期，以及在哪里注册以进行发现</span><br><span class="hljs-string">        ring:</span><br><span class="hljs-string">          kvstore:</span><br><span class="hljs-string">            store: inmemory      # 用于ring的后端存储，支持consul、etcd、inmemory</span><br><span class="hljs-string">          replication_factor: 1      # 写入和读取的ingesters数量，至少为1（为了冗余和弹性，默认情况下为3）</span><br><span class="hljs-string">      chunk_idle_period: 3m      # 如果块没有达到最大的块大小，那么在刷新之前，块应该在内存中不更新多长时间</span><br><span class="hljs-string">      chunk_block_size: 262144</span><br><span class="hljs-string">      chunk_retain_period: 1m      # 块刷新后应该在内存中保留多长时间</span><br><span class="hljs-string">      max_transfer_retries: 0      # Number of times to try and transfer chunks when leaving before falling back to flushing to the store. Zero = no transfers are done.</span><br><span class="hljs-string">    schema_config:      # 配置从特定时间段开始应该使用哪些索引模式</span><br><span class="hljs-string">      configs:</span><br><span class="hljs-string">      - from: 2020-10-24      # 创建索引的日期。如果这是唯一的schema_config，则使用过去的日期，否则使用希望切换模式时的日期</span><br><span class="hljs-string">        store: boltdb-shipper      # 索引使用哪个存储，如：cassandra, bigtable, dynamodb，或boltdb</span><br><span class="hljs-string">        object_store: filesystem      # 用于块的存储，如：gcs, s3， inmemory, filesystem, cassandra，如果省略，默认值与store相同</span><br><span class="hljs-string">        schema: v11</span><br><span class="hljs-string">        index:      # 配置如何更新和存储索引</span><br><span class="hljs-string">          prefix: index_      # 所有周期表的前缀</span><br><span class="hljs-string">          period: 24h      # 表周期</span><br><span class="hljs-string">    storage_config:      # 为索引和块配置一个或多个存储</span><br><span class="hljs-string">      boltdb_shipper:</span><br><span class="hljs-string">        active_index_directory: /data/loki/boltdb-shipper-active</span><br><span class="hljs-string">        cache_location: /data/loki/boltdb-shipper-cache</span><br><span class="hljs-string">        cache_ttl: 24h         </span><br><span class="hljs-string">        # shared_store: filesystem</span><br><span class="hljs-string">        shared_store: s3</span><br><span class="hljs-string">      filesystem:</span><br><span class="hljs-string">        directory: /data/loki/chunks</span><br><span class="hljs-string">      aws:</span><br><span class="hljs-string">        s3: s3://access_key:secret_key@&lt;minio_svc_name&gt;(.&lt;minio_namspace_name&gt;.svc.cluster.local):&lt;minio_svc_port&gt;/&lt;bucket_name&gt;</span><br><span class="hljs-string">        s3forcepathstyle: true</span><br><span class="hljs-string">    limits_config:</span><br><span class="hljs-string">      enforce_metric_name: false</span><br><span class="hljs-string">      reject_old_samples: true      # 旧样品是否会被拒绝</span><br><span class="hljs-string">      reject_old_samples_max_age: 168h      # 拒绝旧样本的最大时限</span><br><span class="hljs-string">    chunk_store_config:      # 配置如何缓存块，以及在将它们保存到存储之前等待多长时间</span><br><span class="hljs-string">      max_look_back_period: 0s      #限制查询数据的时间，默认是禁用的，这个值应该小于或等于table_manager.retention_period中的值</span><br><span class="hljs-string">    table_manager:</span><br><span class="hljs-string">      retention_deletes_enabled: true      # 日志保留周期开关，用于表保留删除</span><br><span class="hljs-string">      retention_period: 48h       # 日志保留周期，保留期必须是索引/块的倍数</span><br><span class="hljs-string">    compactor:</span><br><span class="hljs-string">      working_directory: /data/loki/boltdb-shipper-compactor</span><br><span class="hljs-string">      # shared_store: filesystem</span><br><span class="hljs-string">      shared_store: s3</span><br><span class="hljs-string">      compaction_interval: 5m</span><br></code></pre></td></tr></table></figure><h3 id="03-loki-stsyaml"><a class="markdownIt-Anchor" href="#03-loki-stsyaml"></a> 03-loki-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、storage 存储大小</span><br><span class="hljs-comment"># 2、storageclass 名称</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">updateStrategy:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">loki</span><br>      <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">10001</span><br>          <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">10001</span><br>          <span class="hljs-attr">runAsNonRoot:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">10001</span><br>      <span class="hljs-attr">initContainers:</span> []<br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/loki</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">-config.file=/etc/loki/loki.yaml</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-loki</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">3100</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/loki</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-data</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-wal</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/wal</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">httpGet:</span> <br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-loki</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">45</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">httpGet:</span> <br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-loki</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">45</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>          <span class="hljs-attr">securityContext:</span><br>            <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">4800</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">defaultMode:</span> <span class="hljs-number">420</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">loki-data</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">&quot;10Gi&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">loki-wal</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">&quot;5Gi&quot;</span><br></code></pre></td></tr></table></figure><h3 id="04-loki-svcyaml"><a class="markdownIt-Anchor" href="#04-loki-svcyaml"></a> 04-loki-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">3100</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-loki</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br></code></pre></td></tr></table></figure><h2 id="promtail"><a class="markdownIt-Anchor" href="#promtail"></a> Promtail</h2><h3 id="01-promtail-rbacyaml"><a class="markdownIt-Anchor" href="#01-promtail-rbacyaml"></a> 01-promtail-rbac.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes/proxy</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure><h3 id="02-protmail-cmyaml"><a class="markdownIt-Anchor" href="#02-protmail-cmyaml"></a> 02-protmail-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">promtail</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">promtail.yaml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    client:      # 配置Promtail如何连接到Loki的实例</span><br><span class="hljs-string">      backoff_config:      # 配置当请求失败时如何重试请求给Loki</span><br><span class="hljs-string">        max_period: 5m </span><br><span class="hljs-string">        max_retries: 10</span><br><span class="hljs-string">        min_period: 500ms</span><br><span class="hljs-string">      batchsize: 1048576      # 发送给Loki的最大批次大小(以字节为单位)</span><br><span class="hljs-string">      batchwait: 1s      # 发送批处理前等待的最大时间（即使批次大小未达到最大值）</span><br><span class="hljs-string">      external_labels: &#123;&#125;      # 所有发送给Loki的日志添加静态标签</span><br><span class="hljs-string">      timeout: 10s      # 等待服务器响应请求的最大时间</span><br><span class="hljs-string">    positions:</span><br><span class="hljs-string">      filename: /run/promtail/positions.yaml</span><br><span class="hljs-string">    server:</span><br><span class="hljs-string">      http_listen_port: 3101</span><br><span class="hljs-string">    target_config:</span><br><span class="hljs-string">      sync_period: 10s</span><br><span class="hljs-string">    scrape_configs:</span><br><span class="hljs-string">    - job_name: kubernetes-pods-name</span><br><span class="hljs-string">      pipeline_stages:</span><br><span class="hljs-string">        - docker: &#123;&#125;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">        - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_name</span><br><span class="hljs-string">        target_label: __service__</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_node_name</span><br><span class="hljs-string">        target_label: __host__</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">        target_label: job</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        target_label: namespace</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_name</span><br><span class="hljs-string">        target_label: pod</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: container</span><br><span class="hljs-string">      - replacement: /var/log/pods/*$1/*.log</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_uid</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: __path__</span><br><span class="hljs-string">    - job_name: kubernetes-pods-app</span><br><span class="hljs-string">      pipeline_stages:</span><br><span class="hljs-string">        - docker: &#123;&#125;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: .+</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_name</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_app</span><br><span class="hljs-string">        target_label: __service__</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_node_name</span><br><span class="hljs-string">        target_label: __host__</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">        target_label: job</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        target_label: namespace</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_name</span><br><span class="hljs-string">        target_label: pod</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: container</span><br><span class="hljs-string">      - replacement: /var/log/pods/*$1/*.log</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_uid</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: __path__</span><br><span class="hljs-string">    - job_name: kubernetes-pods-direct-controllers</span><br><span class="hljs-string">      pipeline_stages:</span><br><span class="hljs-string">        - docker: &#123;&#125;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: .+</span><br><span class="hljs-string">        separator: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_name</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_app</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;[0-9a-z-.]+-[0-9a-f]&#123;8,10&#125;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_controller_name</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_controller_name</span><br><span class="hljs-string">        target_label: __service__</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_node_name</span><br><span class="hljs-string">        target_label: __host__</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">        target_label: job</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        target_label: namespace</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_name</span><br><span class="hljs-string">        target_label: pod</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: container</span><br><span class="hljs-string">      - replacement: /var/log/pods/*$1/*.log</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_uid</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: __path__</span><br><span class="hljs-string">    - job_name: kubernetes-pods-indirect-controller</span><br><span class="hljs-string">      pipeline_stages:</span><br><span class="hljs-string">        - docker: &#123;&#125;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: .+</span><br><span class="hljs-string">        separator: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_name</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_app</span><br><span class="hljs-string">      - action: keep</span><br><span class="hljs-string">        regex: &#x27;[0-9a-z-.]+-[0-9a-f]&#123;8,10&#125;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_controller_name</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        regex: &#x27;([0-9a-z-.]+)-[0-9a-f]&#123;8,10&#125;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_controller_name</span><br><span class="hljs-string">        target_label: __service__</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_node_name</span><br><span class="hljs-string">        target_label: __host__</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">        target_label: job</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        target_label: namespace</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_name</span><br><span class="hljs-string">        target_label: pod</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: container</span><br><span class="hljs-string">      - replacement: /var/log/pods/*$1/*.log</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_uid</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: __path__</span><br><span class="hljs-string">    - job_name: kubernetes-pods-static</span><br><span class="hljs-string">      pipeline_stages:</span><br><span class="hljs-string">        - docker: &#123;&#125;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_component</span><br><span class="hljs-string">        target_label: __service__</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_node_name</span><br><span class="hljs-string">        target_label: __host__</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">        target_label: job</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        target_label: namespace</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_name</span><br><span class="hljs-string">        target_label: pod</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: container</span><br><span class="hljs-string">      - replacement: /var/log/pods/*$1/*.log</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: __path__</span><br></code></pre></td></tr></table></figure><h3 id="03-promtail-dsyaml"><a class="markdownIt-Anchor" href="#03-promtail-dsyaml"></a> 03-promtail-ds.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment">#1. client.url  loki地址</span><br><span class="hljs-comment">#2. volume docker挂载路径</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">promtail</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">promtail</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">promtail</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/promtail</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-string">-config.file=/etc/promtail/promtail.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">-client.url=http://loki:3100/loki/api/v1/push</span><br>          <span class="hljs-attr">env:</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">HOSTNAME</span><br>              <span class="hljs-attr">valueFrom:</span> <br>                <span class="hljs-attr">fieldRef:</span> <br>                  <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br>                  <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">spec.nodeName</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-promtail</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">3101</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/promtail</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/run/promtail</span>              <br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">docker</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data/docker/containers</span>             <br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pods</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log/pods</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">securityContext:</span><br>            <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">0</span><br>            <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">0</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-promtail</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">tolerations:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>          <span class="hljs-attr">key:</span> <span class="hljs-string">node-role.kubernetes.io/master</span><br>          <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">defaultMode:</span> <span class="hljs-number">420</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">promtail-config</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/run/promtail</span><br>            <span class="hljs-attr">type:</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">docker</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/data/docker/containers</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pods</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log/pods</span><br></code></pre></td></tr></table></figure><blockquote><p>部署完成后需要在Grafana中添加Loki数据源，添加地址为&lt;loki_svc_name&gt;(.&lt;loki_namspace_name&gt;.svc.clster.local):&lt;loki_svc_port&gt;。</p></blockquote><h1 id="监控"><a class="markdownIt-Anchor" href="#监控"></a> 监控</h1><blockquote><p>除了普通Prometheus之外，对于多个Prometheus，添加Thanos方案。</p></blockquote><h2 id="alertmanager"><a class="markdownIt-Anchor" href="#alertmanager"></a> Alertmanager</h2><h3 id="01-alertmanager-cmyaml"><a class="markdownIt-Anchor" href="#01-alertmanager-cmyaml"></a> 01-alertmanager-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、邮箱smtp等账户信息</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">alertmanager.yml:</span> <span class="hljs-string">|-</span><br><span class="hljs-string">    # 发送邮箱配置</span><br><span class="hljs-string">    global:</span><br><span class="hljs-string">      resolve_timeout: 1m</span><br><span class="hljs-string">      #用于发送邮件的邮箱的SMTP服务器地址+端口</span><br><span class="hljs-string">      smtp_smarthost: &#x27;smtp.163.com:25&#x27;</span><br><span class="hljs-string">      # 从哪个邮箱发送报警</span><br><span class="hljs-string">      smtp_from: &#x27;&lt;mail_address&gt;&#x27;</span><br><span class="hljs-string">      # 发送邮箱的认证用户，不是邮箱名</span><br><span class="hljs-string">      smtp_auth_username: &#x27;&lt;user_name&gt;&#x27;</span><br><span class="hljs-string">      # 发送邮箱的授权码而不是登录密码</span><br><span class="hljs-string">      smtp_auth_password: &#x27;poxuwotjhdbybdfb&#x27;</span><br><span class="hljs-string">      smtp_require_tls: false</span><br><span class="hljs-string">    route:</span><br><span class="hljs-string">      group_by: [alertname]</span><br><span class="hljs-string">      group_wait: 10s</span><br><span class="hljs-string">      group_interval: 10s</span><br><span class="hljs-string">      repeat_interval: 10m</span><br><span class="hljs-string">      receiver: public</span><br><span class="hljs-string">    # 接收邮箱配置</span><br><span class="hljs-string">    receivers:</span><br><span class="hljs-string">    - name: &#x27;public&#x27;</span><br><span class="hljs-string">      # 接收邮箱地址</span><br><span class="hljs-string">      email_configs:</span><br><span class="hljs-string">      - to: &#x27;&lt;mail_address&gt;&#x27;</span><br><span class="hljs-string">        send_resolved: true</span><br></code></pre></td></tr></table></figure><h3 id="02-alertmanager-pvcyaml"><a class="markdownIt-Anchor" href="#02-alertmanager-pvcyaml"></a> 02-alertmanager-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、storage 存储大小</span><br><span class="hljs-comment"># 2、storageclass 名称</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager-data</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br></code></pre></td></tr></table></figure><h3 id="03-alertmanager-deployyaml"><a class="markdownIt-Anchor" href="#03-alertmanager-deployyaml"></a> 03-alertmanager-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">alertmanager</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">alertmanager</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">alertmanager</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">prom/alertmanager</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--config.file=/etc/config/alertmanager.yml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.path=/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--cluster.advertise-address=0.0.0.0:9093</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-alert</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9093</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/#/status</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">9093</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">30</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">500m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">2500Mi</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alert-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/config</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alert-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&quot;/data&quot;</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alert-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager-config</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alert-data-volume</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">alertmanager-data</span><br></code></pre></td></tr></table></figure><h3 id="04-alertmanager-svcyaml"><a class="markdownIt-Anchor" href="#04-alertmanager-svcyaml"></a> 04-alertmanager-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">alertmanager</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9093</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-alert</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">alertmanager</span><br></code></pre></td></tr></table></figure><h2 id="metrics"><a class="markdownIt-Anchor" href="#metrics"></a> Metrics</h2><h3 id="node-exporter"><a class="markdownIt-Anchor" href="#node-exporter"></a> Node-Exporter</h3><h4 id="01-node-exporter-dsyaml"><a class="markdownIt-Anchor" href="#01-node-exporter-dsyaml"></a> 01-node-exporter-ds.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">node-exporter</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">node-exporter</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">node-exporter</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">node-exporter</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">hostPID:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">hostIPC:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">node-exporter</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">prom/node-exporter</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">args:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--path.procfs</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">/host/proc</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--path.sysfs</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">/host/sys</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--path.rootfs</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">/host/root</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--collector.filesystem.ignored-mount-points</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&quot;^/(sys|proc|dev|host|etc)($|/)&quot;&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;--collector.processes&quot;</span><br>        <span class="hljs-attr">ports:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-node</span><br>            <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9100</span><br>            <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">2000m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">2Gi</span>        <br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">volumeMounts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dev</span><br>            <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/host/dev</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">proc</span><br>            <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/host/proc</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sys</span><br>            <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/host/sys</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rootfs</span><br>            <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/host/root</span><br>      <span class="hljs-attr">tolerations:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;node-role.kubernetes.io/master&quot;</span><br>          <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>          <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoSchedule&quot;</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">proc</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/proc</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dev</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/dev</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sys</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/sys</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rootfs</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br></code></pre></td></tr></table></figure><h4 id="02-node-exporter-svcyaml可以省略"><a class="markdownIt-Anchor" href="#02-node-exporter-svcyaml可以省略"></a> 02-node-exporter-svc.yaml（可以省略）</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">node-exporter</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">node-exporter</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">node-exporter-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9100</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-node</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">node-exporter</span><br></code></pre></td></tr></table></figure><h3 id="blackbox-exporter"><a class="markdownIt-Anchor" href="#blackbox-exporter"></a> Blackbox-Exporter</h3><h4 id="01-blackbox-exporter-cmyaml"><a class="markdownIt-Anchor" href="#01-blackbox-exporter-cmyaml"></a> 01-blackbox-exporter-cm.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span> <br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">blackbox-exporter</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">blackbox.yml:</span> <span class="hljs-string">|-</span><br><span class="hljs-string">    modules:</span><br><span class="hljs-string">      http_2xx:</span><br><span class="hljs-string">        prober: http</span><br><span class="hljs-string">        timeout: 10s</span><br><span class="hljs-string">        http:</span><br><span class="hljs-string">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="hljs-string">          valid_status_codes: []</span><br><span class="hljs-string">          method: GET</span><br><span class="hljs-string">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="hljs-string">      http_post_2xx:</span><br><span class="hljs-string">        prober: http</span><br><span class="hljs-string">        timeout: 10s</span><br><span class="hljs-string">        http:</span><br><span class="hljs-string">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="hljs-string">          method: POST</span><br><span class="hljs-string">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="hljs-string">      tcp_connect:</span><br><span class="hljs-string">        prober: tcp</span><br><span class="hljs-string">        timeout: 10s</span><br><span class="hljs-string">      icmp:</span><br><span class="hljs-string">        prober: icmp</span><br><span class="hljs-string">        timeout: 10s</span><br><span class="hljs-string">        icmp:</span><br><span class="hljs-string">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="hljs-string">      dns: </span><br><span class="hljs-string">        prober: dns</span><br><span class="hljs-string">        dns:</span><br><span class="hljs-string">          transport_protocol: &quot;tcp&quot; </span><br><span class="hljs-string">          preferred_ip_protocol: &quot;ip4&quot; </span><br><span class="hljs-string">          query_name: &quot;kubernetes.default.svc.cluster.local&quot;</span><br></code></pre></td></tr></table></figure><h4 id="02-blackbox-exporter-deployyaml"><a class="markdownIt-Anchor" href="#02-blackbox-exporter-deployyaml"></a> 02-blackbox-exporter-deploy.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---  </span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span> <br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">blackbox-exporter</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">blackbox-exporter</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">blackbox-exporter</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">prom/blackbox-exporter</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">args:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--config.file=/etc/blackbox_exporter/blackbox.yml</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--web.listen-address=:9115</span><br>        <span class="hljs-attr">ports:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-blackbox</span><br>            <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9115</span><br>            <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-attr">readinessProbe:</span><br>          <span class="hljs-attr">tcpSocket:</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-number">9115</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">50Mi</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">60Mi</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">200m</span><br>        <span class="hljs-attr">volumeMounts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-config-volume</span><br>            <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/blackbox_exporter</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter-config</span><br></code></pre></td></tr></table></figure><h4 id="03-blackbox-exporter-svcyaml"><a class="markdownIt-Anchor" href="#03-blackbox-exporter-svcyaml"></a> 03-blackbox-exporter-svc.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9115</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-blackbox</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">blackbox-exporter</span><br></code></pre></td></tr></table></figure><h3 id="kube-state-metrics"><a class="markdownIt-Anchor" href="#kube-state-metrics"></a> Kube-State-Metrics</h3><h4 id="01-kube-state-metrics-rbacyaml"><a class="markdownIt-Anchor" href="#01-kube-state-metrics-rbacyaml"></a> 01-kube-state-metrics-rbac.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">configmaps</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">secrets</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">serviceaccounts</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">resourcequotas</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">replicationcontrollers</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">limitranges</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">persistentvolumeclaims</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">persistentvolumes</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">namespaces</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">apps</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">statefulsets</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">daemonsets</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">deployments</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">replicasets</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">batch</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">cronjobs</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">jobs</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">autoscaling</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">horizontalpodautoscalers</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">authentication.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tokenreviews</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">create</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">authorization.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">subjectaccessreviews</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">create</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">policy</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">poddisruptionbudgets</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">certificates.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">certificatesigningrequests</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">discovery.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpointslices</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">storage.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">storageclasses</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">volumeattachments</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">admissionregistration.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mutatingwebhookconfigurations</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">validatingwebhookconfigurations</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">networking.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">networkpolicies</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingressclasses</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">coordination.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">leases</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">clusterrolebindings</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">clusterroles</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">rolebindings</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">roles</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure><h4 id="02-kube-state-metrics-deployyaml"><a class="markdownIt-Anchor" href="#02-kube-state-metrics-deployyaml"></a> 02-kube-state-metrics-deploy.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span> <br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kube-state-metrics</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">kube-state-metrics</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">automountServiceAccountToken:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">kube-state-metrics</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">kubesphere/kube-state-metrics:v2.8.0</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">livenessProbe:</span><br>          <span class="hljs-attr">httpGet:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/healthz</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">ports:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-metrics</span><br>            <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span><br>            <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">telemetry</span><br>            <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8081</span><br>            <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-attr">readinessProbe:</span><br>          <span class="hljs-attr">httpGet:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">capabilities:</span><br>            <span class="hljs-attr">drop:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">ALL</span><br>          <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">65534</span><br></code></pre></td></tr></table></figure><h4 id="03-kube-state-metrics-svcyaml"><a class="markdownIt-Anchor" href="#03-kube-state-metrics-svcyaml"></a> 03-kube-state-metrics-svc.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span> <br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kube-state-metrics</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metrics-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-metrics</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">telemetry</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">telemetry</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kube-state-metrics</span><br></code></pre></td></tr></table></figure><h2 id="prometheus"><a class="markdownIt-Anchor" href="#prometheus"></a> Prometheus</h2><h3 id="a-idrbac01-prometheus-rbacyamla"><a class="markdownIt-Anchor" href="#a-idrbac01-prometheus-rbacyamla"></a> <a id="rbac">01-prometheus-rbac.yaml</a></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes/proxy</span><br>    <span class="hljs-attr">verbs:</span> <br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;extensions&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses</span><br>    <span class="hljs-attr">verbs:</span> <br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">configmaps</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes/metrics</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">nonResourceURLs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/metrics</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure><h3 id="02-prometheus-cmyaml"><a class="markdownIt-Anchor" href="#02-prometheus-cmyaml"></a> 02-prometheus-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、target url地址</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">prometheus.yml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    global:</span><br><span class="hljs-string">      scrape_interval:     15s</span><br><span class="hljs-string">      evaluation_interval: 15s</span><br><span class="hljs-string">    rule_files:</span><br><span class="hljs-string">    - /etc/prometheus/rules/*.yml</span><br><span class="hljs-string">    alerting:</span><br><span class="hljs-string">      alertmanagers:</span><br><span class="hljs-string">      - static_configs:</span><br><span class="hljs-string">        - targets: [&quot;alertmanager:9093&quot;]</span><br><span class="hljs-string">    scrape_configs:</span><br><span class="hljs-string">    - job_name: &#x27;loki&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 15s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: http</span><br><span class="hljs-string">      follow_redirects: true</span><br><span class="hljs-string">      enable_http2: true</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">      - targets:</span><br><span class="hljs-string">        - loki.logging.svc.cluster.local:3100</span><br><span class="hljs-string">    - job_name: &#x27;node-exporter&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__address__]</span><br><span class="hljs-string">        regex: &#x27;(.*):10250&#x27;</span><br><span class="hljs-string">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span><br><span class="hljs-string">        target_label: __address__</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">        target_label: node      </span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_address_InternalIP]</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">        target_label: ip</span><br><span class="hljs-string">    - job_name: &#x27;blackbox-exporter&#x27;</span><br><span class="hljs-string">      metrics_path: /probe</span><br><span class="hljs-string">      params:</span><br><span class="hljs-string">        module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">        - targets:</span><br><span class="hljs-string">          - https://prometheus.io    # Target to probe with http.</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">        - source_labels: [__address__]</span><br><span class="hljs-string">          target_label: __param_target</span><br><span class="hljs-string">        - source_labels: [__param_target]</span><br><span class="hljs-string">          target_label: instance</span><br><span class="hljs-string">        - target_label: __address__</span><br><span class="hljs-string">          replacement: blackbox-exporter:9115  # The blackbox exporter&#x27;s real hostname:port.</span><br><span class="hljs-string">    - job_name: &#x27;blackbox_tcp_connect&#x27;</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      metrics_path: /probe</span><br><span class="hljs-string">      params:</span><br><span class="hljs-string">        module: [tcp_connect]</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">        - targets:</span><br><span class="hljs-string">          - prometheus:9090</span><br><span class="hljs-string">          - alertmanager:9093</span><br><span class="hljs-string">          - grafana.public.svc.cluster.local:3000</span><br><span class="hljs-string">          - loki.logging.svc.cluster.local:3100</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">        - source_labels: [__address__]</span><br><span class="hljs-string">          target_label: __param_target</span><br><span class="hljs-string">        - source_labels: [__param_target]</span><br><span class="hljs-string">          target_label: instance</span><br><span class="hljs-string">        - target_label: __address__</span><br><span class="hljs-string">          replacement: blackbox-exporter:9115 # blackbox-exporter 服务所在的机器和端口</span><br><span class="hljs-string">    - job_name: &quot;kube-state-metrics&quot; </span><br><span class="hljs-string">      static_configs: </span><br><span class="hljs-string">        - targets: [&quot;kube-state-metrics:8080&quot;]</span><br><span class="hljs-string">    - job_name: &#x27;kube-nodes-cadvisor&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: labelmap</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: /metrics/cadvisor</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">    - job_name: &#x27;kube-pods&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: http</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: &quot;true&quot;</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.+)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: ([^:]+)(?::d+)?;(d+)</span><br><span class="hljs-string">        target_label: __address__</span><br><span class="hljs-string">        replacement:  &lt;img src=&quot;https://www.zhihu.com/equation?tex=1:&quot; alt=&quot;1:&quot; class=&quot;ee_img tr_noresize&quot; eeimg=&quot;1&quot;&gt; 2</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: labelmap</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: kubernetes_namespace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: kubernetes_pod_name</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">    - job_name: &#x27;kube-kubelet&#x27;</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">      - target_label: __address__</span><br><span class="hljs-string">        replacement: kubernetes.default.svc:443</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="hljs-string">        regex: (.+)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics</span><br><span class="hljs-string">    - job_name: &#x27;kube-apiservers&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: default;kubernetes;https</span><br><span class="hljs-string">    - job_name: &#x27;kube-scheduler&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      authorization:</span><br><span class="hljs-string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: kube-system;kube-scheduler;https</span><br><span class="hljs-string">    - job_name: &#x27;kube-controller-manager&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      authorization:</span><br><span class="hljs-string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: kube-system;kube-controller-manager;https</span><br></code></pre></td></tr></table></figure><h3 id="a-idrules03-prometheus-rules-cmyamla"><a class="markdownIt-Anchor" href="#a-idrules03-prometheus-rules-cmyamla"></a> <a id="rules">03-prometheus-rules-cm.yaml</a></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">rules.yml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    groups:</span><br><span class="hljs-string">    - name: hostStatsAlert</span><br><span class="hljs-string">      rules:</span><br><span class="hljs-string">      - alert: hostCpuUsageAlert</span><br><span class="hljs-string">        expr: sum(avg without (cpu)(irate(node_cpu&#123;mode!=&#x27;idle&#x27;&#125;[5m]))) by (instance) &gt; 0.85</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125; CPU usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="hljs-string">      - alert: hostMemUsageAlert</span><br><span class="hljs-string">        expr: (node_memory_MemTotal - node_memory_MemAvailable)/node_memory_MemTotal &gt; 0.85</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125; MEM usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="hljs-string">      - alert: OutOfInodes</span><br><span class="hljs-string">        expr: node_filesystem_free&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/&quot;&#125; / node_filesystem_size&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/&quot;&#125; * 100 &lt; 10</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Out of inodes (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk is almost running out of available inodes (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: OutOfDiskSpace</span><br><span class="hljs-string">        expr: node_filesystem_free&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/rootfs&quot;&#125; / node_filesystem_size&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/rootfs&quot;&#125; * 100 &lt; 10</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Out of disk space (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk is almost full (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualNetworkThroughputIn</span><br><span class="hljs-string">        expr: sum by (instance) (irate(node_network_receive_bytes[2m])) / 1024 / 1024 &gt; 100</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual network throughput in (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Host network interfaces are probably receiving too much data (&gt; 100 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualNetworkThroughputOut</span><br><span class="hljs-string">        expr: sum by (instance) (irate(node_network_transmit_bytes[2m])) / 1024 / 1024 &gt; 100</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual network throughput out (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Host network interfaces are probably sending too much data (&gt; 100 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualDiskReadRate</span><br><span class="hljs-string">        expr: sum by (instance) (irate(node_disk_bytes_read[2m])) / 1024 / 1024 &gt; 50</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual disk read rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk is probably reading too much data (&gt; 50 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualDiskWriteRate</span><br><span class="hljs-string">        expr: sum by (instance) (irate(node_disk_bytes_written[2m])) / 1024 / 1024 &gt; 50</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual disk write rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk is probably writing too much data (&gt; 50 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualDiskReadLatency</span><br><span class="hljs-string">        expr: rate(node_disk_read_time_ms[1m]) / rate(node_disk_reads_completed[1m]) &gt; 100</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual disk read latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk latency is growing (read operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualDiskWriteLatency</span><br><span class="hljs-string">        expr: rate(node_disk_write_time_ms[1m]) / rate(node_disk_writes_completedl[1m]) &gt; 100</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual disk write latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk latency is growing (write operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">    - name: http_status</span><br><span class="hljs-string">      rules:</span><br><span class="hljs-string">      - alert: ProbeFailed</span><br><span class="hljs-string">        expr: probe_success == 0</span><br><span class="hljs-string">        for: 1m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: error</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Probe failed (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Probe failed (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: StatusCode</span><br><span class="hljs-string">        expr: probe_http_status_code &lt;= 199 OR probe_http_status_code &gt;= 400</span><br><span class="hljs-string">        for: 1m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: error</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Status Code (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;HTTP status code is not 200-399 (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: SslCertificateWillExpireSoon</span><br><span class="hljs-string">        expr: probe_ssl_earliest_cert_expiry - time() &lt; 86400 * 30</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;SSL certificate will expire soon (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;SSL certificate expires in 30 days (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: SslCertificateHasExpired</span><br><span class="hljs-string">        expr: probe_ssl_earliest_cert_expiry - time()  &lt;= 0</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: error</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;SSL certificate has expired (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;SSL certificate has expired already (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: BlackboxSlowPing</span><br><span class="hljs-string">        expr: probe_icmp_duration_seconds &gt; 2</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Blackbox slow ping (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Blackbox ping took more than 2s (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: BlackboxSlowRequests</span><br><span class="hljs-string">        expr: probe_http_duration_seconds &gt; 2 </span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Blackbox slow requests (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Blackbox request took more than 2s (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: PodCpuUsagePercent</span><br><span class="hljs-string">        expr: sum(sum(label_replace(irate(container_cpu_usage_seconds_total[1m]),&quot;pod&quot;,&quot;$1&quot;,&quot;container_label_io_kubernetes_pod_name&quot;, &quot;(.*)&quot;))by(pod) / on(pod) group_right kube_pod_container_resource_limits_cpu_cores *100 )by(container,namespace,node,pod,severity) &gt; 80</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Pod cpu usage percent has exceeded 80% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="hljs-string">      - alert: PodMemoryUsagePercent</span><br><span class="hljs-string">        expr: sum(label_replace(container_memory_working_set_bytes,&quot;pod&quot;,&quot;$1&quot;,&quot;container_label_io_kubernetes_pod_name&quot;, &quot;(.*)&quot;) / on(pod) group_left kube_pod_container_resource_limits_memory_bytes&#123;pod!~&quot;prometheus.*|filebeat.*&quot;&#125;)by(pod) * 100 &gt; 80</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Pod emory usage percent has exceeded 80% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="hljs-string">    - name: kube-state-metrics</span><br><span class="hljs-string">      rules:</span><br><span class="hljs-string">      - alert: KubeStateMetricsListErrors</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          description: kube-state-metrics is experiencing errors at an elevated rate in list operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.</span><br><span class="hljs-string">          summary: kube-state-metrics is experiencing errors in list operations.</span><br><span class="hljs-string">        expr: |</span><br><span class="hljs-string">          (sum(rate(kube_state_metrics_list_total&#123;job=&quot;kube-state-metrics&quot;,result=&quot;error&quot;&#125;[5m]))</span><br><span class="hljs-string">            /</span><br><span class="hljs-string">          sum(rate(kube_state_metrics_list_total&#123;job=&quot;kube-state-metrics&quot;&#125;[5m])))</span><br><span class="hljs-string">          &gt; 0.01</span><br><span class="hljs-string">        for: 15m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: critical</span><br><span class="hljs-string">      - alert: KubeStateMetricsWatchErrors</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          description: kube-state-metrics is experiencing errors at an elevated rate in watch operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.</span><br><span class="hljs-string">          summary: kube-state-metrics is experiencing errors in watch operations.</span><br><span class="hljs-string">        expr: |</span><br><span class="hljs-string">          (sum(rate(kube_state_metrics_watch_total&#123;job=&quot;kube-state-metrics&quot;,result=&quot;error&quot;&#125;[5m]))</span><br><span class="hljs-string">            /</span><br><span class="hljs-string">          sum(rate(kube_state_metrics_watch_total&#123;job=&quot;kube-state-metrics&quot;&#125;[5m])))</span><br><span class="hljs-string">          &gt; 0.01</span><br><span class="hljs-string">        for: 15m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: critical</span><br><span class="hljs-string">      - alert: KubeStateMetricsShardingMismatch</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          description: kube-state-metrics pods are running with different --total-shards configuration, some Kubernetes objects may be exposed multiple times or not exposed at all.</span><br><span class="hljs-string">          summary: kube-state-metrics sharding is misconfigured.</span><br><span class="hljs-string">        expr: |</span><br><span class="hljs-string">          stdvar (kube_state_metrics_total_shards&#123;job=&quot;kube-state-metrics&quot;&#125;) != 0</span><br><span class="hljs-string">        for: 15m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: critical</span><br><span class="hljs-string">      - alert: KubeStateMetricsShardsMissing</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          description: kube-state-metrics shards are missing, some Kubernetes objects are not being exposed.</span><br><span class="hljs-string">          summary: kube-state-metrics shards are missing.</span><br><span class="hljs-string">        expr: |</span><br><span class="hljs-string">          2^max(kube_state_metrics_total_shards&#123;job=&quot;kube-state-metrics&quot;&#125;) - 1</span><br><span class="hljs-string">            -</span><br><span class="hljs-string">          sum( 2 ^ max by (shard_ordinal) (kube_state_metrics_shard_ordinal&#123;job=&quot;kube-state-metrics&quot;&#125;) )</span><br><span class="hljs-string">          != 0</span><br><span class="hljs-string">        for: 15m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: critical</span><br></code></pre></td></tr></table></figure><h3 id="04-prometheus-pvcyaml"><a class="markdownIt-Anchor" href="#04-prometheus-pvcyaml"></a> 04-prometheus-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、storage 存储大小</span><br><span class="hljs-comment"># 2、storageclass 名称</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br></code></pre></td></tr></table></figure><h3 id="05-prometheus-deployyaml"><a class="markdownIt-Anchor" href="#05-prometheus-deployyaml"></a> 05-prometheus-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">prometheus</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--config.file=/etc/prometheus/config_out/prometheus.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.path=/prometheus/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.retention=24h</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--web.enable-lifecycle</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-p8s</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9090</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">500m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">2500Mi</span> <br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/config_out</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/rules</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/prometheus/data</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config</span>   <br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-config</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data-volume</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">prometheus-data</span><br></code></pre></td></tr></table></figure><h3 id="06-prometheus-svcyaml"><a class="markdownIt-Anchor" href="#06-prometheus-svcyaml"></a> 06-prometheus-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9090</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-p8s</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31003</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br></code></pre></td></tr></table></figure><h2 id="thanos"><a class="markdownIt-Anchor" href="#thanos"></a> Thanos</h2><blockquote><p>本文采用sidecar模式，把prometheus和sider服务部署在一起，query服务提供跟prometheus一样的查询界面，store服务储存到minio，compact服务压缩数据文件，因为prometheus已经配置rule告警规则，故thanos的rules服务不在部署，仅供参考。（如果部署rules的话，可以在query界面中既包含prometheus本身的告警规则，也可以看到rules服务的规则），详情参考 <a target="_blank" rel="noopener" href="https://github.com/thanos-io/kube-thanos/tree/main/examples/all/manifests">Thanos-io/kube-thanso</a></p></blockquote><h3 id="01-prometheus-rbacyaml"><a class="markdownIt-Anchor" href="#01-prometheus-rbacyaml"></a> 01-prometheus-rbac.yaml</h3><blockquote><p>和 <a href="#rbac">prometheus的rbac</a> 保持一致即可</p></blockquote><h3 id="02-prometheus-tp-cmyaml"><a class="markdownIt-Anchor" href="#02-prometheus-tp-cmyaml"></a> 02-prometheus-tp-cm.yaml</h3><blockquote><p>可以由稍后的 <code>05-prometheus-sidecar-sts.yaml</code> 看出，prometheus 仅提供 <code>后缀为tmpl的模版配置文件</code> 由 sidecar 解析后生成 <code>后缀为yaml的标准配置文件</code> ，所以此configmap只是文件名不同，配置项也和prometheus的一致。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、target url地址</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-tmpl</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">prometheus.yaml.tmpl:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    global:</span><br><span class="hljs-string">      scrape_interval:     15s</span><br><span class="hljs-string">      evaluation_interval: 15s</span><br><span class="hljs-string">      external_labels:</span><br><span class="hljs-string">        cluster: prometheus-ha</span><br><span class="hljs-string">        replica: $(POD_NAME)</span><br><span class="hljs-string">    rule_files:</span><br><span class="hljs-string">    - /etc/prometheus/rules/*.yml</span><br><span class="hljs-string">    alerting:</span><br><span class="hljs-string">      alertmanagers:</span><br><span class="hljs-string">      - static_configs:</span><br><span class="hljs-string">        - targets: [&quot;alertmanager:9093&quot;]</span><br><span class="hljs-string">    scrape_configs:</span><br><span class="hljs-string">    - job_name: &#x27;loki&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 15s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: http</span><br><span class="hljs-string">      follow_redirects: true</span><br><span class="hljs-string">      enable_http2: true</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">      - targets:</span><br><span class="hljs-string">        - loki.tecorigin-logging.svc.cluster.local:3100</span><br><span class="hljs-string">    - job_name: &#x27;node-exporter&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__address__]</span><br><span class="hljs-string">        regex: &#x27;(.*):10250&#x27;</span><br><span class="hljs-string">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span><br><span class="hljs-string">        target_label: __address__</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">        target_label: node      </span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_address_InternalIP]</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">        target_label: ip</span><br><span class="hljs-string">    - job_name: &#x27;blackbox-exporter&#x27;</span><br><span class="hljs-string">      metrics_path: /probe</span><br><span class="hljs-string">      params:</span><br><span class="hljs-string">        module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">        - targets:</span><br><span class="hljs-string">          - https://prometheus.io    # Target to probe with http.</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">        - source_labels: [__address__]</span><br><span class="hljs-string">          target_label: __param_target</span><br><span class="hljs-string">        - source_labels: [__param_target]</span><br><span class="hljs-string">          target_label: instance</span><br><span class="hljs-string">        - target_label: __address__</span><br><span class="hljs-string">          replacement: blackbox-exporter:9115  # The blackbox exporter&#x27;s real hostname:port.</span><br><span class="hljs-string">    - job_name: &#x27;blackbox_tcp_connect&#x27;</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      metrics_path: /probe</span><br><span class="hljs-string">      params:</span><br><span class="hljs-string">        module: [tcp_connect]</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">        - targets:</span><br><span class="hljs-string">          - prometheus:9090</span><br><span class="hljs-string">          - alertmanager:9093</span><br><span class="hljs-string">          - grafana.tecorigin.svc.cluster.local:3000</span><br><span class="hljs-string">          - loki.tecorigin-logging.svc.cluster.local:3100</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">        - source_labels: [__address__]</span><br><span class="hljs-string">          target_label: __param_target</span><br><span class="hljs-string">        - source_labels: [__param_target]</span><br><span class="hljs-string">          target_label: instance</span><br><span class="hljs-string">        - target_label: __address__</span><br><span class="hljs-string">          replacement: blackbox-exporter:9115 # blackbox-exporter 服务所在的机器和端口</span><br><span class="hljs-string">    - job_name: &quot;kube-state-metrics&quot; </span><br><span class="hljs-string">      static_configs: </span><br><span class="hljs-string">        - targets: [&quot;kube-state-metrics:8080&quot;]</span><br><span class="hljs-string">    - job_name: &#x27;kube-nodes-cadvisor&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: labelmap</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: /metrics/cadvisor</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">    - job_name: &#x27;kube-pods&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: http</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: &quot;true&quot;</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.+)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: ([^:]+)(?::d+)?;(d+)</span><br><span class="hljs-string">        target_label: __address__</span><br><span class="hljs-string">        replacement:  &lt;img src=&quot;https://www.zhihu.com/equation?tex=1:&quot; alt=&quot;1:&quot; class=&quot;ee_img tr_noresize&quot; eeimg=&quot;1&quot;&gt; 2</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: labelmap</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: kubernetes_namespace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: kubernetes_pod_name</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">    - job_name: &#x27;kube-kubelet&#x27;</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">      - target_label: __address__</span><br><span class="hljs-string">        replacement: kubernetes.default.svc:443</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="hljs-string">        regex: (.+)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics</span><br><span class="hljs-string">    - job_name: &#x27;kube-apiservers&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: default;kubernetes;https</span><br><span class="hljs-string">    - job_name: &#x27;kube-scheduler&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      authorization:</span><br><span class="hljs-string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: kube-system;kube-scheduler;https</span><br><span class="hljs-string">    - job_name: &#x27;kube-controller-manager&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      authorization:</span><br><span class="hljs-string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: kube-system;kube-controller-manager;https</span><br></code></pre></td></tr></table></figure><h3 id="03-prometheus-rules-cmyaml"><a class="markdownIt-Anchor" href="#03-prometheus-rules-cmyaml"></a> 03-prometheus-rules-cm.yaml</h3><blockquote><p>如果使用prometheus自己告警规则而不是thanos-rules的话，和 <a href="#rules">prometheus的保rules</a> 保持一致即可。</p></blockquote><h3 id="04-thanos-storage-secretyaml"><a class="markdownIt-Anchor" href="#04-thanos-storage-secretyaml"></a> 04-thanos-storage-secret.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span><br><span class="hljs-attr">stringData:</span><br>  <span class="hljs-attr">objectstorage.yaml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    type: S3</span><br><span class="hljs-string">    config:</span><br><span class="hljs-string">      endpoint: &quot;&lt;minio_svc_name&gt;(.&lt;minio_namspace_name&gt;.svc.cluster.local):&lt;minio_svc_port&gt;&quot;</span><br><span class="hljs-string">      bucket: &quot;&lt;bucket_name&gt;&quot;</span><br><span class="hljs-string">      access_key: &quot;&quot;</span><br><span class="hljs-string">      secret_key: &quot;&quot;</span><br><span class="hljs-string">      insecure: true  </span><br></code></pre></td></tr></table></figure><h3 id="05-prometheus-sidecar-stsyaml"><a class="markdownIt-Anchor" href="#05-prometheus-sidecar-stsyaml"></a> 05-prometheus-sidecar-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-sidecar</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus-sidecar</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">prometheus-sidebar-headless</span><br>  <span class="hljs-attr">podManagementPolicy:</span> <span class="hljs-string">Parallel</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus-sidecar</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus-sidecar</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">prometheus</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--config.file=/etc/prometheus/config_out/prometheus.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.path=/prometheus/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.retention=24h</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--web.enable-lifecycle</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.no-lockfile</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.min-block-duration=2h</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.max-block-duration=2h</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-p8s</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9090</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">6</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-p8s</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">120</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-p8s</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/config_out</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/rules</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/prometheus/data</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-sidecar</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/thanos/thanos:v0.30.2</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">sidecar</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.level=debug</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--tsdb.path=/prometheus/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--prometheus.url=http://127.0.0.1:9090</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--grpc-address=0.0.0.0:10901</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--http-address=0.0.0.0:10902</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--reloader.config-file=/etc/prometheus/config/prometheus.yaml.tmpl</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--reloader.config-envsubst-file=/etc/prometheus/config_out/prometheus.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--reloader.rule-dir=/etc/prometheus/rules/</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAME</span><br>              <span class="hljs-attr">valueFrom:</span><br>                <span class="hljs-attr">fieldRef:</span><br>                  <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10901</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10902</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-tmpl-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/config</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/config_out</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/rules</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/thanos/objectstorage.yaml</span><br>              <span class="hljs-attr">subPath:</span> <span class="hljs-string">objectstorage.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/prometheus/data</span><br>      <span class="hljs-attr">securityContext:</span><br>        <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">2000</span><br>        <span class="hljs-attr">runAsNonRoot:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">1000</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-tmpl-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-tmpl</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-volume</span><br>          <span class="hljs-attr">emptyDir:</span> &#123;&#125;<br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-config</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>          <span class="hljs-attr">secret:</span><br>            <span class="hljs-attr">secretName:</span> <span class="hljs-string">thanos-objectstorage</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data-volume</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span> <br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">20Gi</span><br></code></pre></td></tr></table></figure><h3 id="06-prometheus-sidecar-svcyaml"><a class="markdownIt-Anchor" href="#06-prometheus-sidecar-svcyaml"></a> 06-prometheus-sidecar-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-sidecar-headless</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus-sidecar</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10901</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">grpc</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10902</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus-sidecar</span><br></code></pre></td></tr></table></figure><h3 id="07-thanos-store-stsyaml"><a class="markdownIt-Anchor" href="#07-thanos-store-stsyaml"></a> 07-thanos-store-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-store</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">thanos-store-headless</span><br>  <span class="hljs-attr">podManagementPolicy:</span> <span class="hljs-string">Parallel</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-store</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/thanos/thanos:v0.30.2</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">store</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.level=debug</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--data-dir=/var/thanos/store</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--grpc-address=0.0.0.0:10901</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--http-address=0.0.0.0:10902</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10901</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10902</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">8</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">20</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.42</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">420Mi</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.123</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">123Mi</span><br>          <span class="hljs-attr">terminationMessagePolicy:</span> <span class="hljs-string">FallbackToLogsOnError</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/thanos/store</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-store-data</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/thanos/objectstorage.yaml</span><br>              <span class="hljs-attr">subPath:</span> <span class="hljs-string">objectstorage.yaml</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">120</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>          <span class="hljs-attr">secret:</span><br>            <span class="hljs-attr">secretName:</span> <span class="hljs-string">thanos-objectstorage</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-store-data</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span> <br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span><br></code></pre></td></tr></table></figure><h3 id="08-thanos-store-svcyaml"><a class="markdownIt-Anchor" href="#08-thanos-store-svcyaml"></a> 08-thanos-store-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-store-headless</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10901</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">grpc</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">store</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10902</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br></code></pre></td></tr></table></figure><h3 id="09-thanos-compact-stsyaml"><a class="markdownIt-Anchor" href="#09-thanos-compact-stsyaml"></a> 09-thanos-compact-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-compact</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">thanos-compact-headless</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-compact</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/thanos/thanos:v0.30.2</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">compact</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--wait</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.level=info</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.format=logfmt</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--data-dir=/var/thanos/compact</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--debug.accept-malformed-index</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--retention.resolution-raw=90d</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--retention.resolution-5m=180d</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--retention.resolution-1h=360d</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10902</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">4</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">30</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">20</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.42</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">420Mi</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.123</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">123Mi</span><br>          <span class="hljs-attr">terminationMessagePolicy:</span> <span class="hljs-string">FallbackToLogsOnError</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-compact-data</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/thanos/compact</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/thanos/objectstorage.yaml</span><br>              <span class="hljs-attr">subPath:</span> <span class="hljs-string">objectstorage.yaml</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">120</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>          <span class="hljs-attr">secret:</span><br>            <span class="hljs-attr">secretName:</span> <span class="hljs-string">thanos-objectstorage</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-compact-data</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">100Gi</span><br></code></pre></td></tr></table></figure><h3 id="10-thanos-compact-svcyaml"><a class="markdownIt-Anchor" href="#10-thanos-compact-svcyaml"></a> 10-thanos-compact-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-compact-headless</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10902</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br></code></pre></td></tr></table></figure><h3 id="11-thanos-query-deployyaml"><a class="markdownIt-Anchor" href="#11-thanos-query-deployyaml"></a> 11-thanos-query-deploy.yaml</h3><blockquote><p>由于query需要连接sidecar还有store（部署rules的话也要），在这里我最后部署query服务，虽然先部署query它也会自动去重连store或者rules</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-query</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-query</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-query</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-query</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-query</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/thanos/thanos:v0.30.2</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">query</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--grpc-address=0.0.0.0:10901</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--http-address=0.0.0.0:9090</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.level=debug</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.format=logfmt</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query.replica-label=prometheus_replica</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query.replica-label=rule_replica</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--store=dnssrv+_grpc._tcp.prometheus-sidecar-headless</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--store=dnssrv+_grpc._tcp.thanos-store-headless</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query.timeout=5m</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query.lookback-delta=15m</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query.auto-downsampling</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-query</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9090</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10901</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">4</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-query</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">30</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">20</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-query</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><h3 id="12-thanos-query-svcyaml"><a class="markdownIt-Anchor" href="#12-thanos-query-svcyaml"></a> 12-thanos-query-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-query</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-query</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">query-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9090</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-query</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31990</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10901</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">grpc</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31991</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-query</span><br></code></pre></td></tr></table></figure><blockquote><p>以下rules服务为可选项</p></blockquote><h3 id="13-thanos-rules-cmyaml"><a class="markdownIt-Anchor" href="#13-thanos-rules-cmyaml"></a> 13-thanos-rules-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">record.rules.yaml:</span> <span class="hljs-string">|-</span><br><span class="hljs-string">    groups:</span><br><span class="hljs-string">    - name: k8s.rules</span><br><span class="hljs-string">      rules:</span><br><span class="hljs-string">      - expr: |</span><br><span class="hljs-string">          sum(rate(container_cpu_usage_seconds_total&#123;job=&quot;cadvisor&quot;, image!=&quot;&quot;, container!=&quot;&quot;&#125;[5m])) by (namespace)</span><br><span class="hljs-string">        record: namespace:container_cpu_usage_seconds_total:sum_rate</span><br><span class="hljs-string">      - expr: |</span><br><span class="hljs-string">          sum(container_memory_usage_bytes&#123;job=&quot;cadvisor&quot;, image!=&quot;&quot;, container!=&quot;&quot;&#125;) by (namespace)</span><br><span class="hljs-string">        record: namespace:container_memory_usage_bytes:sum</span><br><span class="hljs-string">      - expr: |</span><br><span class="hljs-string">          sum by (namespace, pod, container) (</span><br><span class="hljs-string">            rate(container_cpu_usage_seconds_total&#123;job=&quot;cadvisor&quot;, image!=&quot;&quot;, container!=&quot;&quot;&#125;[5m])</span><br><span class="hljs-string">          )</span><br><span class="hljs-string">        record: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate</span><br></code></pre></td></tr></table></figure><h3 id="14-thanos-rules-stsyaml"><a class="markdownIt-Anchor" href="#14-thanos-rules-stsyaml"></a> 14-thanos-rules-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rule</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">thanos-rule-headless</span><br>  <span class="hljs-attr">podManagementPolicy:</span> <span class="hljs-string">Parallel</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rule</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/thanos/thanos:v0.30.2</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">rule</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.level=info</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.format=logfmt</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--grpc-address=0.0.0.0:10901</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--http-address=0.0.0.0:10902</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--rule-file=/etc/thanos/rules/*rules.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--data-dir=/var/thanos/rule</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--label=rule_replica=&quot;$(NAME)&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--alert.label-drop=&quot;rule_replica&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--tsdb.retention=48h</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--tsdb.block-duration=2h</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query=dnssrv+_http._tcp.thanos-query</span><br>          <span class="hljs-attr">env:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">NAME</span><br>            <span class="hljs-attr">valueFrom:</span><br>              <span class="hljs-attr">fieldRef:</span><br>                <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10901</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10902</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">24</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">18</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.42</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">420Mi</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.123</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">123Mi</span><br>          <span class="hljs-attr">terminationMessagePolicy:</span> <span class="hljs-string">FallbackToLogsOnError</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-data</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/thanos/rule</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/thanos/objectstorage.yaml</span><br>              <span class="hljs-attr">subPath:</span> <span class="hljs-string">objectstorage.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/thanos/rules</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>          <span class="hljs-attr">secret:</span><br>            <span class="hljs-attr">secretName:</span> <span class="hljs-string">thanos-objectstorage</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-config</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-data</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">100Gi</span><br></code></pre></td></tr></table></figure><h3 id="15-thanos-rules-svcyaml"><a class="markdownIt-Anchor" href="#15-thanos-rules-svcyaml"></a> 15-thanos-rules-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rule-headless</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10901</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">grpc</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10902</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%AD%A6%E6%B5%B7%E6%97%A0%E6%B6%AF/" class="category-chain-item">学海无涯</a> <span>></span> <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%97%A0%E6%B6%AF/K8S/" class="category-chain-item">K8S</a></span></span></div></div><div class="license-box my-3"><div class="license-title"><div>K8S常用yaml汇总</div><div>https://koanight.github.io/posts/ef247c7f.html</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Felix Cheung</div></div><div class="license-meta-item license-meta-date"><div>發布於</div><div>2023年2月23日</div></div><div class="license-meta-item"><div>許可協議</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/posts/4fc885b8.html" title="K8S部署方式简介"><span class="hidden-mobile">K8S部署方式简介</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-left:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="学海无涯" id="heading-7ad80c1ac8571d0cd560336bc99df249" role="tab" data-toggle="collapse" href="#collapse-7ad80c1ac8571d0cd560336bc99df249" aria-expanded="true">学海无涯 <span class="list-group-count">(9)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-7ad80c1ac8571d0cd560336bc99df249" role="tabpanel" aria-labelledby="heading-7ad80c1ac8571d0cd560336bc99df249"><div class="category-post-list"></div><div class="category-sub row nomargin-x"><a class="category-subitem collapsed list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Hexo" id="heading-c00d1eb68b529768ba98c975c76a9b66" role="tab" data-toggle="collapse" href="#collapse-c00d1eb68b529768ba98c975c76a9b66" aria-expanded="false">Hexo <span class="list-group-count">(2)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse" id="collapse-c00d1eb68b529768ba98c975c76a9b66" role="tabpanel" aria-labelledby="heading-c00d1eb68b529768ba98c975c76a9b66"><div class="category-post-list"><a href="/posts/5438079.html" title="Hexo常用插件汇总" class="list-group-item list-group-item-action"><span class="category-post">Hexo常用插件汇总</span> </a><a href="/posts/c1d5d64c.html" title="搭建Hexo博客" class="list-group-item list-group-item-action"><span class="category-post">搭建Hexo博客</span></a></div></div></div><div class="category-sub row nomargin-x"><a class="category-subitem list-group-item category-item-action col-10 col-md-11 col-xm-11" title="K8S" id="heading-97452006dd1cdcd5beb286d2656dea33" role="tab" data-toggle="collapse" href="#collapse-97452006dd1cdcd5beb286d2656dea33" aria-expanded="true">K8S <span class="list-group-count">(5)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-97452006dd1cdcd5beb286d2656dea33" role="tabpanel" aria-labelledby="heading-97452006dd1cdcd5beb286d2656dea33"><div class="category-post-list"><a href="/posts/ef247c7f.html" title="K8S常用yaml汇总" class="list-group-item list-group-item-action active"><span class="category-post">K8S常用yaml汇总</span> </a><a href="/posts/4fc885b8.html" title="K8S部署方式简介" class="list-group-item list-group-item-action"><span class="category-post">K8S部署方式简介</span> </a><a href="/posts/89a5c5a5.html" title="通过二进制方式部署Kubernetes集群" class="list-group-item list-group-item-action"><span class="category-post">通过二进制方式部署Kubernetes集群</span> </a><a href="/posts/43012f97.html" title="通过Kubeadm部署Kubernetes高可用集群" class="list-group-item list-group-item-action"><span class="category-post">通过Kubeadm部署Kubernetes高可用集群</span> </a><a href="/posts/50bdf01d.html" title="通过Kubeadm部署Kubernetes单主多从集群" class="list-group-item list-group-item-action"><span class="category-post">通过Kubeadm部署Kubernetes单主多从集群</span></a></div></div></div><div class="category-sub row nomargin-x"><a class="category-subitem collapsed list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Others" id="heading-52ef9633d88a7480b3a938ff9eaa2a25" role="tab" data-toggle="collapse" href="#collapse-52ef9633d88a7480b3a938ff9eaa2a25" aria-expanded="false">Others <span class="list-group-count">(2)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse" id="collapse-52ef9633d88a7480b3a938ff9eaa2a25" role="tabpanel" aria-labelledby="heading-52ef9633d88a7480b3a938ff9eaa2a25"><div class="category-post-list"><a href="/posts/476f61d5.html" title="手动部署Train版OpenStack" class="list-group-item list-group-item-action"><span class="category-post">手动部署Train版OpenStack</span> </a><a href="/posts/6348717a.html" title="Commands" class="list-group-item list-group-item-action"><span class="category-post">Commands</span></a></div></div></div></div></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜尋</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">關鍵字</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">總訪問量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">總訪客數 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.3.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.3.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.32/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.31/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允許 JavaScript 運行的環境下瀏覽效果更佳</div></noscript></body></html>