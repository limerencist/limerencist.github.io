<!DOCTYPE html><html lang="zh-HK" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/rock-gesture.png"><link rel="icon" href="/img/rock-gesture.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Felix Cheung"><meta name="keywords" content=""><meta name="description" content="Refence https:&#x2F;&#x2F;www.cnblogs.com&#x2F;lizexiong&#x2F;p&#x2F;14882419.html#blogTitle32  Enviroment    Role IP Component Hostname     master(Kubernetes,Etcd) 10.10.10.101 cfssletcddockerkube-apiserverkube-controller-m"><meta property="og:type" content="article"><meta property="og:title" content="通过二进制方式部署Kubernetes集群"><meta property="og:url" content="https://koanight.github.io/posts/89a5c5a5.html"><meta property="og:site_name" content="失落之地"><meta property="og:description" content="Refence https:&#x2F;&#x2F;www.cnblogs.com&#x2F;lizexiong&#x2F;p&#x2F;14882419.html#blogTitle32  Enviroment    Role IP Component Hostname     master(Kubernetes,Etcd) 10.10.10.101 cfssletcddockerkube-apiserverkube-controller-m"><meta property="og:locale" content="zh_HK"><meta property="og:image" content="https://koanight.github.io/img/k8s.jpg"><meta property="article:published_time" content="2022-12-22T02:45:09.000Z"><meta property="article:modified_time" content="2022-12-23T08:43:15.000Z"><meta property="article:author" content="Felix Cheung"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://koanight.github.io/img/k8s.jpg"><meta name="referrer" content="no-referrer-when-downgrade"><title>通过二进制方式部署Kubernetes集群 | 失落之地</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"koanight.github.io",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:50,cursorChar:"|",loop:!0,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!1,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"left",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:1},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:50vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>失落之地</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首頁</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>歸檔</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分類</span></a></li><li class="nav-item"><a class="nav-link" href="/playlist/"><i class="iconfont icon-music"></i> <span>歌单</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>關於</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/k8s.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="通过二进制方式部署Kubernetes集群"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-12-22 10:45" pubdate>2022年12月22日 上午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 25k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 125 分鐘 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="padding-left:2rem;margin-right:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目錄</span></p><div class="toc-body" id="toc-body"></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">通过二进制方式部署Kubernetes集群</h1><p class="note note-info">本文最後更新於：5 個月前</p><div class="markdown-body"><h1 id="refence"><a class="markdownIt-Anchor" href="#refence"></a> Refence</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lizexiong/p/14882419.html#blogTitle32">https://www.cnblogs.com/lizexiong/p/14882419.html#blogTitle32</a></p><h1 id="enviroment"><a class="markdownIt-Anchor" href="#enviroment"></a> Enviroment</h1><table><thead><tr><th style="text-align:center">Role</th><th style="text-align:center">IP</th><th style="text-align:center">Component</th><th style="text-align:center">Hostname</th></tr></thead><tbody><tr><td style="text-align:center">master(Kubernetes,Etcd)</td><td style="text-align:center">10.10.10.101</td><td style="text-align:center">cfssl<br>etcd<br>docker<br>kube-apiserver<br>kube-controller-manager<br>kube-scheduler<br>kubectl</td><td style="text-align:center">master</td></tr><tr><td style="text-align:center">node1(Kubernetes,Etcd)</td><td style="text-align:center">10.10.10.102</td><td style="text-align:center">etcd<br>docker<br>kubelet<br>kube-proxy</td><td style="text-align:center">minion</td></tr><tr><td style="text-align:center">node2(Kubernetes,Etcd)</td><td style="text-align:center">10.10.10.103</td><td style="text-align:center">etcd<br>docker<br>kubelet<br>kube-proxy</td><td style="text-align:center">slave</td></tr></tbody></table><h1 id="prepare"><a class="markdownIt-Anchor" href="#prepare"></a> Prepare</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">关闭防火墙</span><br>systemctl disable firewalld --now<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭selinux</span><br>setenforce 0<br><span class="hljs-meta prompt_">#</span><span class="language-bash">禁用,重启生效</span><br>sed -i &quot;s/enforcing/disabled/g&quot; /etc/selinux/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭swap</span><br>swapoff -a<br><span class="hljs-meta prompt_">#</span><span class="language-bash">永久关闭</span><br>sed -i &#x27;s/^[^#].*swap*/#&amp;/g&#x27; /etc/fstab<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装常用软件包</span><br>yum install vim net-tools lrzsz unzip dos2unix telnet sysstat iotop pciutils lsof tcpdump psmisc bc wget socat gcc tree chrony ntpdate mlocate zip unzip -y<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置主机名</span><br>hostnamectl set-hostname &lt;hostname&gt; <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主机名写入hosts</span><br>cat &gt;&gt; /etc/hosts &lt;&lt; EOF<br>10.10.10.101 master<br>10.10.10.102 minion<br>10.10.10.103 slave<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主机间配置ssh免密登录</span><br>ssh-keygen -t rsa<br>for host in master minion slave; do ssh-copy-id -i ~/.ssh/id_rsa.pub $host;done<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">内核开启网络支持</span><br>cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>net.ipv4.ip_forward = 1<br>net.ipv4.ip_nonlocal_bind = 1<br>EOF<br>modprobe br_netfilter<br>sysctl -p /etc/sysctl.d/kubernetes.conf<br></code></pre></td></tr></table></figure><h1 id="cfssl"><a class="markdownIt-Anchor" href="#cfssl"></a> Cfssl</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64<br>wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64<br>wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64<br>chmod +x cfssl*<br><br>mv cfssl_linux-amd64 /usr/bin/cfssl<br>mv cfssljson_linux-amd64 /usr/bin/cfssljson<br>mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo<br></code></pre></td></tr></table></figure><h1 id="etcd"><a class="markdownIt-Anchor" href="#etcd"></a> Etcd</h1><h2 id="自签ca"><a class="markdownIt-Anchor" href="#自签ca"></a> 自签CA</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir cfssl/etcd -p &amp;&amp; cd cfssl/etcd <br><br>cat &gt; ca-config.json &lt;&lt; EOF<br>&#123;<br>  &quot;signing&quot;: &#123;<br>    &quot;default&quot;: &#123;<br>      &quot;expiry&quot;: &quot;87600h&quot;<br>    &#125;,<br>    &quot;profiles&quot;: &#123;<br>      &quot;www&quot;: &#123;<br>         &quot;expiry&quot;: &quot;87600h&quot;,<br>         &quot;usages&quot;: [<br>            &quot;signing&quot;,<br>            &quot;key encipherment&quot;,<br>            &quot;server auth&quot;,<br>            &quot;client auth&quot;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>EOF<br><br>cat &gt; ca-csr.json &lt;&lt; EOF<br>&#123;<br>    &quot;CN&quot;: &quot;etcd CA&quot;,<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;ShangHai&quot;,<br>            &quot;ST&quot;: &quot;ShangHai&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成ca.pem和ca-key.pem文件</span><br>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -<br></code></pre></td></tr></table></figure><h2 id="使用自签ca签发https证书"><a class="markdownIt-Anchor" href="#使用自签ca签发https证书"></a> 使用自签CA签发HTTPS证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">hosts内为节点IP</span><br>cat &gt; server-csr.json &lt;&lt; EOF<br>&#123;<br>    &quot;CN&quot;: &quot;etcd&quot;,<br>    &quot;hosts&quot;: [<br>    &quot;10.10.10.101&quot;,<br>    &quot;10.10.10.102&quot;,<br>    &quot;10.10.10.103&quot;<br>    ],<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;ShangHai&quot;,<br>            &quot;ST&quot;: &quot;ShangHai&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成server.pem和server-key.pem文件</span><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server<br></code></pre></td></tr></table></figure><h2 id="手动安装"><a class="markdownIt-Anchor" href="#手动安装"></a> 手动安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可以在https://github.com/etcd-io/etcd/releases寻找下载</span><br>mkdir /etc/etcd/&#123;bin,ssl&#125; -p<br>tar -mxvf etcd-v3.5.0-linux-amd64.tar<br>mv etcd-v3.5.0-linux-amd64.tar/etcd* /etc/etcd/bin/<br></code></pre></td></tr></table></figure><h2 id="yum安装"><a class="markdownIt-Anchor" href="#yum安装"></a> Yum安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install etcd -y<br>mkdir /etc/etcd/ssl -p<br></code></pre></td></tr></table></figure><h2 id="修改配置文件"><a class="markdownIt-Anchor" href="#修改配置文件"></a> 修改配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">注意检查各个节点的etcd.conf中主机名和IP是否和当前节点一致(没有则新建)</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">[Member]</span><br>ETCD_NAME=&quot;etcd-master&quot;<br>ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;<br>ETCD_LISTEN_PEER_URLS=&quot;https://10.10.10.101:2380&quot;<br>ETCD_LISTEN_CLIENT_URLS=&quot;https://10.10.10.101:2379&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">[Clustering]</span><br>ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://10.10.10.101:2380&quot;<br>ETCD_ADVERTISE_CLIENT_URLS=&quot;https://10.10.10.101:2379&quot;<br>ETCD_INITIAL_CLUSTER=&quot;etcd-master=https://10.10.10.101:2380,etcd-minion=https://10.10.10.102:2380,etcd-slave=https://10.10.10.103:2380&quot;<br>ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;<br>ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;<br></code></pre></td></tr></table></figure><h2 id="拷贝证书"><a class="markdownIt-Anchor" href="#拷贝证书"></a> 拷贝证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">for host in master minion slave; do scp cfssl/etcd/*.pem $host:/etc/etcd/ssl/;done<br></code></pre></td></tr></table></figure><h2 id="修改系统服务文件"><a class="markdownIt-Anchor" href="#修改系统服务文件"></a> 修改系统服务文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">/lib/systemd/system/etcd.service(没有则新建)</span><br>[Unit]<br>Description=Etcd Server<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br><br>[Service]<br>Type=notify<br>EnvironmentFile=/etc/etcd/etcd.conf<br>ExecStart=/etc/etcd/etcd \<br>--cert-file=/etc/etcd/ssl/server.pem \<br>--key-file=/etc/etcd/ssl/server-key.pem \<br>--peer-cert-file=/etc/etcd/ssl/server.pem \<br>--peer-key-file=/etc/etcd/ssl/server-key.pem \<br>--trusted-ca-file=/etc/etcd/ssl/ca.pem \<br>--peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \<br>--logger=zap<br>Restart=on-failure<br>LimitNOFILE=65536<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure><h2 id="自启启动"><a class="markdownIt-Anchor" href="#自启启动"></a> 自启启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">for host in master minion slave;do ssh $host &#x27;systemctl daemon-reload;systemctl enable etcd --now&#x27;;done<br></code></pre></td></tr></table></figure><h2 id="查看集群状态"><a class="markdownIt-Anchor" href="#查看集群状态"></a> 查看集群状态</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">ETCDCTL_API=3 /etc/etcd/etcdctl --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/server.pem --key=/etc/etcd/ssl/server-key.pem --endpoints=&quot;https://10.10.10.101:2379,https://10.10.10.102:2379,https://10.10.10.103:2379&quot; endpoint health --write-out=table<br><br>+-----------------------------+--------+-------------+-------+<br>|          ENDPOINT           | HEALTH |    TOOK     | ERROR |<br>+-----------------------------+--------+-------------+-------+<br>| https://10.10.10.101:2379   |  true  | 50.191672ms |       |<br>| https://10.10.10.102:2379   |  true  | 52.394036ms |       |<br>| https://10.10.10.103:2379   |  true  | 46.009422ms |       |<br>+-----------------------------+--------+-------------+-------+<br></code></pre></td></tr></table></figure><h1 id="docker"><a class="markdownIt-Anchor" href="#docker"></a> Docker</h1><h2 id="手动安装-2"><a class="markdownIt-Anchor" href="#手动安装-2"></a> 手动安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可以在https://download.docker.com/linux/static/stable/x86_64/载</span><br>tar -mxvf docker-20.10.7.tgz<br>mv docker/* /usr/bin<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建系统服务文件</span><br>cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF<br>[Unit]<br>Description=Docker Application Container Engine<br>Documentation=https://docs.docker.com<br>After=network-online.target firewalld.service<br>Wants=network-online.target<br><br>[Service]<br>Type=notify<br>ExecStart=/usr/bin/dockerd<br>ExecReload=/bin/kill -s HUP $MAINPID<br>LimitNOFILE=infinity<br>LimitNPROC=infinity<br>LimitCORE=infinity<br>TimeoutStartSec=0<br>Delegate=yes<br>KillMode=process<br>Restart=on-failure<br>StartLimitBurst=3<br>StartLimitInterval=60s<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h2 id="yum安装-2"><a class="markdownIt-Anchor" href="#yum安装-2"></a> Yum安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">官方脚本安装</span><br>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">手动yum安装</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">卸载原有docker</span><br>yum remove docker*<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装所需的软件包。yum-utils 提供了 yum-config-manager ，并且 device mapper 存储驱动程序需要 device-mapper-persistent-data 和 lvm2</span><br>yum install -y yum-utils device-mapper-persistent-data lvm2<br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置阿里源地址</span><br>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装</span><br>yum install docker-ce docker-ce-cli containerd.io -y<br></code></pre></td></tr></table></figure><h2 id="修改配置"><a class="markdownIt-Anchor" href="#修改配置"></a> 修改配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">配置镜像加速地址,并修改Cgroup Driver(docker默认cgroupfs，k8s推荐使用systemd)</span><br>mkdir /etc/docker -p<br>cat &gt; /etc/docker/daemon.json &lt;&lt; EOF<br>&#123;&quot;registry-mirrors&quot;:[&quot;https://docker.mirrors.ustc.edu.cn/&quot;],<br>  &quot;exec-etcs&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125;<br>EOF<br></code></pre></td></tr></table></figure><h2 id="自启启动-2"><a class="markdownIt-Anchor" href="#自启启动-2"></a> 自启启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">for host in master minion slave;do ssh $host &#x27;systemctl daemon-reload;systemctl enable docker --now&#x27;;done<br></code></pre></td></tr></table></figure><h1 id="master"><a class="markdownIt-Anchor" href="#master"></a> Master</h1><h2 id="二进制文件"><a class="markdownIt-Anchor" href="#二进制文件"></a> 二进制文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可以在https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md寻找下载</span><br>mkdir -p /etc/kubernetes/&#123;bin,conf,ssl,logs&#125;<br>tar -mxvf kubernetes-server-linux-amd64.tar.gz<br>cd kubernetes/server/bin/<br>cp kube-apiserver kube-scheduler kube-controller-manager /etc/kubernetes/bin/<br>cp kubectl /usr/bin/<br></code></pre></td></tr></table></figure><h2 id="自签ca-2"><a class="markdownIt-Anchor" href="#自签ca-2"></a> 自签CA</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir cfssl/kubernetes -p &amp;&amp; cd cfssl/kubernetes<br><br>cat &gt; ca-config.json &lt;&lt; EOF<br>&#123;<br>  &quot;signing&quot;: &#123;<br>    &quot;default&quot;: &#123;<br>      &quot;expiry&quot;: &quot;87600h&quot;<br>    &#125;,<br>    &quot;profiles&quot;: &#123;<br>      &quot;kubernetes&quot;: &#123;<br>         &quot;expiry&quot;: &quot;87600h&quot;,<br>         &quot;usages&quot;: [<br>            &quot;signing&quot;,<br>            &quot;key encipherment&quot;,<br>            &quot;server auth&quot;,<br>            &quot;client auth&quot;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>EOF<br><br>cat &gt; ca-csr.json &lt;&lt; EOF<br>&#123;<br>    &quot;CN&quot;: &quot;kubernetes&quot;,<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;ShangHai&quot;,<br>            &quot;ST&quot;: &quot;ShangHai&quot;,<br>            &quot;O&quot;: &quot;Kubernetes&quot;,<br>            &quot;OU&quot;: &quot;System&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成ca.pem和ca-key.pem文件</span><br>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -<br></code></pre></td></tr></table></figure><h2 id="kube-apiserver"><a class="markdownIt-Anchor" href="#kube-apiserver"></a> kube-apiserver</h2><h3 id="使用自签ca签-https证书"><a class="markdownIt-Anchor" href="#使用自签ca签-https证书"></a> 使用自签CA签 HTTPS证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">hosts内为节点IP,为了方便后期扩容可以多写几个预留的IP</span><br>cat &gt; server-csr.json &lt;&lt; EOF<br>&#123;<br>    &quot;CN&quot;: &quot;kubernetes&quot;,<br>    &quot;hosts&quot;: [<br>      &quot;10.0.0.1&quot;,<br>      &quot;127.0.0.1&quot;,<br>      &quot;10.10.10.101&quot;,<br>      &quot;10.10.10.102&quot;,<br>      &quot;10.10.10.103&quot;,<br>      &quot;kubernetes&quot;,<br>      &quot;kubernetes.default&quot;,<br>      &quot;kubernetes.default.svc&quot;,<br>      &quot;kubernetes.default.svc.cluster&quot;,<br>      &quot;kubernetes.default.svc.cluster.local&quot;<br>    ],<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;ShangHai&quot;,<br>            &quot;ST&quot;: &quot;ShangHai&quot;,<br>            &quot;O&quot;: &quot;Kubernetes&quot;,<br>            &quot;OU&quot;: &quot;System&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成server.pem和server-key.pem文件</span><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span><br>cp cfssl/kubernetes/*.pem /etc/kubernetes/ssl<br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果etcd和master不在一台机器部署，这里etcd的证书也要拷贝</span><br>cp cfssl/etcd/*.pem /etc/etcd/ssl<br></code></pre></td></tr></table></figure><h3 id="创建配置文件"><a class="markdownIt-Anchor" href="#创建配置文件"></a> 创建配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建token</span><br>cat &gt; /opt/kubernetes/conf/token.csv &lt;&lt; EOF<br>c47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">token也可自行生成替换</span><br>head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;<br><br>cat &gt; /opt/kubernetes/conf/kube-apiserver.conf &lt;&lt; EOF<br>KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\<br>--v=2 \\<br>--log-dir=/opt/kubernetes/logs \\<br>--etcd-servers=https://10.10.10.101:2379,https://10.10.10.102:2379,https://10.10.10.103:2379 \\<br>--bind-address=10.10.10.101 \\<br>--secure-port=6443 \\<br>--advertise-address=10.10.10.101 \\<br>--allow-privileged=true \\<br>--service-cluster-ip-range=10.0.0.0/24 \\<br>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\<br>--authorization-mode=RBAC,Node \\<br>--enable-bootstrap-token-auth=true \\<br>--token-auth-file=/opt/kubernetes/conf/token.csv \\<br>--service-node-port-range=1-65535 \\<br>--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\<br>--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\<br>--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\<br>--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\<br>--client-ca-file=/opt/kubernetes/ssl/ca.pem \\<br>--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\<br>--service-account-issuer=api \\<br>--service-account-signing-key-file=/opt/kubernetes/ssl/server-key.pem \\<br>--etcd-cafile=/opt/etcd/ssl/ca.pem \\<br>--etcd-certfile=/opt/etcd/ssl/server.pem \\<br>--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\<br>--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\<br>--proxy-client-cert-file=/opt/kubernetes/ssl/server.pem \\<br>--proxy-client-key-file=/opt/kubernetes/ssl/server-key.pem \\<br>--requestheader-allowed-names=kubernetes \\<br>--requestheader-extra-headers-prefix=X-Remote-Extra- \\<br>--requestheader-group-headers=X-Remote-Group \\<br>--requestheader-username-headers=X-Remote-User \\<br>--enable-aggregator-routing=true \\<br>--audit-log-maxage=30 \\<br>--audit-log-maxbackup=3 \\<br>--audit-log-maxsize=100 \\<br>--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;<br>EOF<br></code></pre></td></tr></table></figure><h3 id="创建系统服务文件"><a class="markdownIt-Anchor" href="#创建系统服务文件"></a> 创建系统服务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /lib/systemd/system/kube-apiserver.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes API Server<br>Documentation=https://github.com/kubernetes/kubernetes<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/conf/kube-apiserver.conf<br>ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS<br>Restart=on-failure<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h3 id="自启启动-3"><a class="markdownIt-Anchor" href="#自启启动-3"></a> 自启启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable kube-apiserver --now<br></code></pre></td></tr></table></figure><h2 id="kube-controller-manager"><a class="markdownIt-Anchor" href="#kube-controller-manager"></a> kube-controller-manager</h2><h3 id="证书"><a class="markdownIt-Anchor" href="#证书"></a> 证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span><br>cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF<br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;ShangHai&quot;, <br>      &quot;ST&quot;: &quot;ShangHai&quot;,<br>      &quot;O&quot;: &quot;system:masters&quot;,<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span><br>cp cfssl/kubernetes/kube-controller-manager*.pem /etc/kubernetes/ssl<br></code></pre></td></tr></table></figure><h3 id="创建配置文件-2"><a class="markdownIt-Anchor" href="#创建配置文件-2"></a> 创建配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-controller-manager.conf &lt;&lt; EOF<br>KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\<br>--v=2 \\<br>--log-dir=/opt/kubernetes/logs \\<br>--leader-elect=true \\<br>--kubeconfig=/opt/kubernetes/conf/kube-controller-manager.kubeconfig \\<br>--bind-address=127.0.0.1 \\<br>--allocate-node-cidrs=true \\<br>--cluster-cidr=10.244.0.0/16 \\<br>--service-cluster-ip-range=10.0.0.0/24 \\<br>--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\<br>--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\<br>--root-ca-file=/opt/kubernetes/ssl/ca.pem \\<br>--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\<br>--cluster-signing-duration=87600h0m0s&quot;<br>EOF<br></code></pre></td></tr></table></figure><h3 id="创建kubeconfig文件"><a class="markdownIt-Anchor" href="#创建kubeconfig文件"></a> 创建kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/kube-controller-manager.kubeconfig&quot;<br>KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;<br><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/opt/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-credentials kube-controller-manager \<br>  --client-certificate=/opt/kubernetes/ssl/kube-controller-manager.pem \<br>  --client-key=/opt/kubernetes/ssl/kube-controller-manager-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kube-controller-manager \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;<br></code></pre></td></tr></table></figure><h3 id="创建系统服务文件-2"><a class="markdownIt-Anchor" href="#创建系统服务文件-2"></a> 创建系统服务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Controller Manager<br>Documentation=https://github.com/kubernetes/kubernetes<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/conf/kube-controller-manager.conf<br>ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS<br>Restart=on-failure<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h3 id="自启启动-4"><a class="markdownIt-Anchor" href="#自启启动-4"></a> 自启启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable kube-controller-manager --now<br></code></pre></td></tr></table></figure><h2 id="kube-scheduler"><a class="markdownIt-Anchor" href="#kube-scheduler"></a> kube-scheduler</h2><h3 id="证书-2"><a class="markdownIt-Anchor" href="#证书-2"></a> 证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span><br>cat &gt; kube-scheduler-csr.json &lt;&lt; EOF<br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;ShangHai&quot;,<br>      &quot;ST&quot;: &quot;ShangHai&quot;,<br>      &quot;O&quot;: &quot;system:masters&quot;,<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span><br>cp cfssl/kubernetes/kube-cheduler*.pem /etc/kubernetes/ssl<br></code></pre></td></tr></table></figure><h3 id="创建配置文件-3"><a class="markdownIt-Anchor" href="#创建配置文件-3"></a> 创建配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-scheduler.conf &lt;&lt; EOF<br>KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \\<br>--v=2 \\<br>--log-dir=/opt/kubernetes/logs \\<br>--leader-elect \\<br>--kubeconfig=/opt/kubernetes/conf/kube-scheduler.kubeconfig \\<br>--bind-address=127.0.0.1&quot;<br>EOF<br></code></pre></td></tr></table></figure><h3 id="创建kubeconfig文件-2"><a class="markdownIt-Anchor" href="#创建kubeconfig文件-2"></a> 创建kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/kube-scheduler.kubeconfig&quot;<br>KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;<br><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/opt/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-credentials kube-scheduler \<br>  --client-certificate=/opt/kubernetes/ssl/kube-scheduler.pem \<br>  --client-key=/opt/kubernetes/ssl/kube-scheduler-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kube-scheduler \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;<br></code></pre></td></tr></table></figure><h3 id="创建系统服务"><a class="markdownIt-Anchor" href="#创建系统服务"></a> 创建系统服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Scheduler<br>Documentation=https://github.com/kubernetes/kubernetes<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/conf/kube-scheduler.conf<br>ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS<br>Restart=on-failure<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h3 id="自启启动-5"><a class="markdownIt-Anchor" href="#自启启动-5"></a> 自启启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable kube-scheduler --now<br></code></pre></td></tr></table></figure><h2 id="查看集群状态-2"><a class="markdownIt-Anchor" href="#查看集群状态-2"></a> 查看集群状态</h2><h3 id="证书-3"><a class="markdownIt-Anchor" href="#证书-3"></a> 证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span><br>cat &gt; admin-csr.json &lt;&lt;EOF<br>&#123;<br>  &quot;CN&quot;: &quot;admin&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;ShangHai&quot;,<br>      &quot;ST&quot;: &quot;ShangHai&quot;,<br>      &quot;O&quot;: &quot;system:masters&quot;,<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span><br>cp cfssl/kubernetes/admin*.pem /etc/kubernetes/ssl<br></code></pre></td></tr></table></figure><h3 id="创建kubeconfig文件-3"><a class="markdownIt-Anchor" href="#创建kubeconfig文件-3"></a> 创建kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir /root/.kube<br><br>KUBE_CONFIG=&quot;/root/.kube/config&quot;<br>KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;<br><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/etc/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-credentials cluster-admin \<br>  --client-certificate=//etc/kubernetes/ssl/admin.pem \<br>  --client-key=/etc/kubernetes/ssl/admin-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=cluster-admin \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;<br></code></pre></td></tr></table></figure><h3 id="查看当前组建状态"><a class="markdownIt-Anchor" href="#查看当前组建状态"></a> 查看当前组建状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get cs<br>NAME                STATUS    MESSAGE             ERROR<br>scheduler           Healthy   ok                  <br>controller-manager  Healthy   ok                   <br>etcd-master         Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;<br>etcd-minio          Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;  <br>etcd-slave          Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;  <br></code></pre></td></tr></table></figure><h3 id="授权kubelet-bootstrap用户允许请求证书"><a class="markdownIt-Anchor" href="#授权kubelet-bootstrap用户允许请求证书"></a> 授权kubelet-bootstrap用户允许请求证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建node必备，不然node的kubelet无法启动,就是创建一个可以申请证书的用户</span><br>kubectl create clusterrolebinding kubelet-bootstrap \<br>--clusterrole=system:node-bootstrapper \<br>--user=kubelet-bootstrap<br><br>kubectl create clusterrolebinding system:anonymous --clusterrole=cluster-admin ?--user=system:anonymous<br></code></pre></td></tr></table></figure><h1 id="nodes"><a class="markdownIt-Anchor" href="#nodes"></a> Nodes</h1><h2 id="拷贝二进制文件和证书"><a class="markdownIt-Anchor" href="#拷贝二进制文件和证书"></a> 拷贝二进制文件和证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh minion &quot;mkdir -p /opt/kubernetes/&#123;bin,conf,ssl,logs&#125;&quot;<br>cd kubernetes/server/bin/<br>scp -r kubelet kube-proxy minion:/opt/kubernetes/bin/<br>scp /opt/kubernetes/ssl/ca.pem minion:/opt/kubernetes/ssl/<br>scp /usr/bin/kubectl minion:/usr/bin<br></code></pre></td></tr></table></figure><h2 id="kubulet"><a class="markdownIt-Anchor" href="#kubulet"></a> kubulet</h2><h3 id="创建配置文件-4"><a class="markdownIt-Anchor" href="#创建配置文件-4"></a> 创建配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kubelet.conf &lt;&lt; EOF<br>KUBELET_OPTS=&quot;--logtostderr=false \\<br>--v=2 \\<br>--log-dir=/opt/kubernetes/logs \\<br>--hostname-override=(节点名) \\<br>--network-plugin=cni \\<br>--kubeconfig=/opt/kubernetes/conf/kubelet.kubeconfig \\<br>--bootstrap-kubeconfig=/opt/kubernetes/conf/bootstrap.kubeconfig \\<br>--config=/opt/kubernetes/conf/kubelet-config.yml \\<br>--cert-dir=/opt/kubernetes/ssl \\<br>--pod-infra-container-image=lizexiong/pause-amd64:3.0(pause镜像)&quot;<br>EOF<br></code></pre></td></tr></table></figure><h3 id="配置参数文件"><a class="markdownIt-Anchor" href="#配置参数文件"></a> 配置参数文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kubelet-config.yml &lt;&lt; EOF<br>kind: KubeletConfiguration<br>apiVersion: kubelet.config.k8s.io/v1beta1<br>address: 0.0.0.0<br>port: 10250<br>readOnlyPort: 10255<br>cgroupDriver: systemd(和docker的cgroupdriver保持一致)<br>clusterDNS:<br>- 10.0.0.2<br>clusterDomain: cluster.local <br>failSwapOn: false<br>authentication:<br>  anonymous:<br>    enabled: false<br>  webhook:<br>    cacheTTL: 2m0s<br>    enabled: true<br>  x509:<br>    clientCAFile: /opt/kubernetes/ssl/ca.pem <br>authorization:<br>  mode: Webhook<br>  webhook:<br>    cacheAuthorizedTTL: 5m0s<br>    cacheUnauthorizedTTL: 30s<br>evictionHard:<br>  imagefs.available: 15%<br>  memory.available: 100Mi<br>  nodefs.available: 10%<br>  nodefs.inodesFree: 5%<br>maxOpenFiles: 1000000<br>maxPods: 110<br>EOF<br></code></pre></td></tr></table></figure><h3 id="创建kubeconfig文件-4"><a class="markdownIt-Anchor" href="#创建kubeconfig文件-4"></a> 创建kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/bootstrap.kubeconfig&quot;<br>KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot; # apiserver IP:PORT<br>TOKEN=&quot;c47ffb939f5ca36231d9e3121a252940&quot; # 与token.csv里保持一致<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">生成 kubelet bootstrap kubeconfig 配置文件</span><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/opt/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-credentials &quot;kubelet-bootstrap&quot; \<br>  --token=$&#123;TOKEN&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=&quot;kubelet-bootstrap&quot; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;<br></code></pre></td></tr></table></figure><h3 id="创建系统服务文件-3"><a class="markdownIt-Anchor" href="#创建系统服务文件-3"></a> 创建系统服务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Kubelet<br>After=docker.service<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/conf/kubelet.conf<br>ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS<br>Restart=on-failure<br>LimitNOFILE=65536<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h3 id="自启启动-6"><a class="markdownIt-Anchor" href="#自启启动-6"></a> 自启启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable kubelet --now<br></code></pre></td></tr></table></figure><h3 id="master批准node加入集群"><a class="markdownIt-Anchor" href="#master批准node加入集群"></a> master批准node加入集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">获取node-csr名称</span><br>kubectl get csr <br><span class="hljs-meta prompt_">#</span><span class="language-bash">批准</span><br>kubectl certificate approve &lt;node-csr-name&gt;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">获取节点信息</span><br>kubectl get node<br></code></pre></td></tr></table></figure><h2 id="kube-proxy"><a class="markdownIt-Anchor" href="#kube-proxy"></a> kube-proxy</h2><h3 id="创建配置文件-5"><a class="markdownIt-Anchor" href="#创建配置文件-5"></a> 创建配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-proxy.conf &lt;&lt; EOF<br>KUBE_PROXY_OPTS=&quot;--logtostderr=false \\<br>--v=2 \\<br>--log-dir=/opt/kubernetes/logs \\<br>--config=/opt/kubernetes/conf/kube-proxy-config.yml&quot;<br>EOF<br></code></pre></td></tr></table></figure><h3 id="配置参数文件-2"><a class="markdownIt-Anchor" href="#配置参数文件-2"></a> 配置参数文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-proxy-config.yml &lt;&lt; EOF<br>kind: KubeProxyConfiguration<br>apiVersion: kubeproxy.config.k8s.io/v1alpha1<br>bindAddress: 0.0.0.0<br>metricsBindAddress: 0.0.0.0:10249<br>clientConnection:<br>  kubeconfig: /opt/kubernetes/conf/kube-proxy.kubeconfig<br>hostnameOverride: node01<br>clusterCIDR: 10.0.0.0/24<br>EOF<br></code></pre></td></tr></table></figure><h3 id="master生成证书并拷贝"><a class="markdownIt-Anchor" href="#master生成证书并拷贝"></a> master生成证书并拷贝</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd cfssl/kubernetes<br><br>cat &gt; kube-proxy-csr.json &lt;&lt; EOF<br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-proxy&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;ShangHai&quot;,<br>      &quot;ST&quot;: &quot;ShangHai&quot;,<br>      &quot;O&quot;: &quot;Kubernets&quot;,<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span><br>scp /cfssl/kubernetes/kube-proxy*pem minion:/opt/kubernetes/ssl<br></code></pre></td></tr></table></figure><h3 id="创建kubeconfig文件-5"><a class="markdownIt-Anchor" href="#创建kubeconfig文件-5"></a> 创建kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/kube-proxy.kubeconfig&quot;<br>KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;<br><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/opt/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-credentials kube-proxy \<br>  --client-certificate=/opt/kubernetes/ssl/kube-proxy.pem \<br>  --client-key=/opt/kubernetes/ssl/kube-proxy-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kube-proxy \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;<br></code></pre></td></tr></table></figure><h3 id="创建系统服务文件-4"><a class="markdownIt-Anchor" href="#创建系统服务文件-4"></a> 创建系统服务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Proxy<br>After=network.target<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/conf/kube-proxy.conf<br>ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS<br>Restart=on-failure<br>LimitNOFILE=65536<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h3 id="自启启动-7"><a class="markdownIt-Anchor" href="#自启启动-7"></a> 自启启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable kube-proxy --now<br></code></pre></td></tr></table></figure><h2 id="部署网络组件"><a class="markdownIt-Anchor" href="#部署网络组件"></a> 部署网络组件</h2><h3 id="calico"><a class="markdownIt-Anchor" href="#calico"></a> calico</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">https://blog.csdn.net/qq_31136839/article/details/100032022<br><span class="hljs-meta prompt_">#</span><span class="language-bash">下载yaml</span><br>wget https://docs.projectcalico.org/manifests/calico.yaml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改CALICO_IPV4POOL_CIDR,此处的网段地址应和kube-controller-manager.conf中的--cluster-cidr保持一致,修改后应用</span><br>kubectl apply -f calico.yaml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看pod直到成功运行</span><br>kubectl get pods -n kube-system<br></code></pre></td></tr></table></figure><h3 id="flannel"><a class="markdownIt-Anchor" href="#flannel"></a> flannel</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">修改Network,此处的网段地址应和kube-controller-manager.conf中的--cluster-cidr保持一致,修改后应用</span><br>kubectl apply -f flannel.yaml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看pod直到成功运行</span><br>kubectl get pods -n kube-system<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果报错找不到/run/flannel/subnet.env</span><br>cat &gt; /run/flannel/subnet.env &lt;&lt; EOF<br>FLANNEL_NETWORK=10.244.0.0/16<br>FLANNEL_SUBNET=10.244.0.1/24<br>FLANNEL_MTU=1450<br>FLANNEL_IPMASQ=true<br>EOF<br></code></pre></td></tr></table></figure><h2 id="授权apiserver"><a class="markdownIt-Anchor" href="#授权apiserver"></a> 授权apiserver</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; EOF<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRole<br>metadata:<br>  annotations:<br>    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;<br>  labels:<br>    kubernetes.io/bootstrapping: rbac-defaults<br>  name: system:kube-apiserver-to-kubelet<br>rules:<br>  - apiGroups:<br>      - &quot;&quot;<br>    resources:<br>      - nodes/proxy<br>      - nodes/stats<br>      - nodes/log<br>      - nodes/spec<br>      - nodes/metrics<br>      - pods/log<br>    verbs:<br>      - &quot;*&quot;<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: system:kube-apiserver<br>  namespace: &quot;&quot;<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: system:kube-apiserver-to-kubelet<br>subjects:<br>  - apiGroup: rbac.authorization.k8s.io<br>    kind: User<br>    name: kubernetes<br>EOF<br><br>kubectl apply -f apiserver-to-kubelet-rbac.yaml<br></code></pre></td></tr></table></figure><h2 id="部署coredns"><a class="markdownIt-Anchor" href="#部署coredns"></a> 部署Coredns</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/coredns/coredns.yaml.in<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改dns_memory_limit和clusterIP,clusterIP地址应和kubelet-config.yml中的clusterDNS保持一致,修改后应用</span><br>kubelet apply -f coredns.yaml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">授权</span><br>kubectl create clusterrolebinding add-on-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:coredns<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看pod成功运行</span><br>kubectl get pods -n kube-system<br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%AD%A6%E6%B5%B7%E6%97%A0%E6%B6%AF/" class="category-chain-item">学海无涯</a> <span>></span> <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%97%A0%E6%B6%AF/K8S/" class="category-chain-item">K8S</a></span></span></div></div><div class="license-box my-3"><div class="license-title"><div>通过二进制方式部署Kubernetes集群</div><div>https://koanight.github.io/posts/89a5c5a5.html</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Felix Cheung</div></div><div class="license-meta-item license-meta-date"><div>發布於</div><div>2022年12月22日</div></div><div class="license-meta-item"><div>許可協議</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/posts/476f61d5.html" title="手动部署Train版OpenStack"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">手动部署Train版OpenStack</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/6348717a.html" title="Commands"><span class="hidden-mobile">Commands</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-left:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="学海无涯" id="heading-7ad80c1ac8571d0cd560336bc99df249" role="tab" data-toggle="collapse" href="#collapse-7ad80c1ac8571d0cd560336bc99df249" aria-expanded="true">学海无涯 <span class="list-group-count">(9)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-7ad80c1ac8571d0cd560336bc99df249" role="tabpanel" aria-labelledby="heading-7ad80c1ac8571d0cd560336bc99df249"><div class="category-post-list"></div><div class="category-sub row nomargin-x"><a class="category-subitem collapsed list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Hexo" id="heading-c00d1eb68b529768ba98c975c76a9b66" role="tab" data-toggle="collapse" href="#collapse-c00d1eb68b529768ba98c975c76a9b66" aria-expanded="false">Hexo <span class="list-group-count">(2)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse" id="collapse-c00d1eb68b529768ba98c975c76a9b66" role="tabpanel" aria-labelledby="heading-c00d1eb68b529768ba98c975c76a9b66"><div class="category-post-list"><a href="/posts/5438079.html" title="Hexo常用插件汇总" class="list-group-item list-group-item-action"><span class="category-post">Hexo常用插件汇总</span> </a><a href="/posts/c1d5d64c.html" title="搭建Hexo博客" class="list-group-item list-group-item-action"><span class="category-post">搭建Hexo博客</span></a></div></div></div><div class="category-sub row nomargin-x"><a class="category-subitem list-group-item category-item-action col-10 col-md-11 col-xm-11" title="K8S" id="heading-97452006dd1cdcd5beb286d2656dea33" role="tab" data-toggle="collapse" href="#collapse-97452006dd1cdcd5beb286d2656dea33" aria-expanded="true">K8S <span class="list-group-count">(5)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-97452006dd1cdcd5beb286d2656dea33" role="tabpanel" aria-labelledby="heading-97452006dd1cdcd5beb286d2656dea33"><div class="category-post-list"><a href="/posts/ef247c7f.html" title="K8S常用yaml汇总" class="list-group-item list-group-item-action"><span class="category-post">K8S常用yaml汇总</span> </a><a href="/posts/4fc885b8.html" title="K8S部署方式简介" class="list-group-item list-group-item-action"><span class="category-post">K8S部署方式简介</span> </a><a href="/posts/89a5c5a5.html" title="通过二进制方式部署Kubernetes集群" class="list-group-item list-group-item-action active"><span class="category-post">通过二进制方式部署Kubernetes集群</span> </a><a href="/posts/43012f97.html" title="通过Kubeadm部署Kubernetes高可用集群" class="list-group-item list-group-item-action"><span class="category-post">通过Kubeadm部署Kubernetes高可用集群</span> </a><a href="/posts/50bdf01d.html" title="通过Kubeadm部署Kubernetes单主多从集群" class="list-group-item list-group-item-action"><span class="category-post">通过Kubeadm部署Kubernetes单主多从集群</span></a></div></div></div><div class="category-sub row nomargin-x"><a class="category-subitem collapsed list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Others" id="heading-52ef9633d88a7480b3a938ff9eaa2a25" role="tab" data-toggle="collapse" href="#collapse-52ef9633d88a7480b3a938ff9eaa2a25" aria-expanded="false">Others <span class="list-group-count">(2)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse" id="collapse-52ef9633d88a7480b3a938ff9eaa2a25" role="tabpanel" aria-labelledby="heading-52ef9633d88a7480b3a938ff9eaa2a25"><div class="category-post-list"><a href="/posts/476f61d5.html" title="手动部署Train版OpenStack" class="list-group-item list-group-item-action"><span class="category-post">手动部署Train版OpenStack</span> </a><a href="/posts/6348717a.html" title="Commands" class="list-group-item list-group-item-action"><span class="category-post">Commands</span></a></div></div></div></div></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜尋</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">關鍵字</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">總訪問量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">總訪客數 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.3.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.3.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.32/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.31/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允許 JavaScript 運行的環境下瀏覽效果更佳</div></noscript></body></html>