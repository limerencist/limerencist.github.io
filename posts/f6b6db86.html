<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf8"><meta name="viewport" content="initial-scale=1,width=device-width"><title>通过Kubeadm搭建Kubernetes高可用集群 | 失落之地</title><meta name="description" content=""><meta name="keywords" content=""><link rel="apple-touch-icon" sizes="180x180" href="/images/rock-gesture.svg"><link rel="icon" type="image/png" sizes="32x32" href="/images/rock-gesture.svg"><link rel="icon" type="image/png" sizes="16x16" href="/images/rock-gesture.svg"><link rel="mask-icon" href="/images/rock-gesture.svg" color=""><style>@font-face{font-family:STXingkai;src:url(/font/regular.ttf);font-weight:regular}</style><link rel="stylesheet" type="text/css" href="/css/layout.css"><link rel="stylesheet" type="text/css" href="/css/post.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="head"><div class="nav"><a href="/" class="nav-logo"><img alt="logo" height="60px" width="60px" src="/images/rock-gesture.svg"> </a><input id="navBtn" type="checkbox"><div class="nav-menu"><a class="nav-menu-item" href="/devops">運維</a> <a class="nav-menu-item" href="/playlist">歌單</a> <a class="nav-menu-item" href="/cv/">简历</a></div><label class="nav-btn" for="navBtn"></label></div></div><div class="body"><article class="post-content"><div class="post-inner--toc"><div class="post-content__head"><div class="post-title">通过Kubeadm搭建Kubernetes高可用集群</div><div class="post-info"><a href="/tags/K8S/" class="post-tag">#K8S</a><a href="/tags/%E5%AE%B9%E5%99%A8/" class="post-tag">#容器</a> <span class="post-date">2022-12-21</span></div></div><aside class="toc-outer"><div class="toc-title">目录</div><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%8E%AF%E5%A2%83"><span class="post-toc-text">学习环境</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%87%86%E5%A4%87%E6%93%8D%E4%BD%9C"><span class="post-toc-text">准备操作</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%AE%89%E8%A3%85-docker"><span class="post-toc-text">安装 Docker</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#master"><span class="post-toc-text">Master</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#keepalived"><span class="post-toc-text">keepalived</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#haproxy%E5%8F%AF%E4%BB%A5%E4%B8%8D%E8%A3%85%E4%B8%8D%E8%A3%85%E5%88%99%E4%B8%8D%E8%B4%9F%E8%BD%BD"><span class="post-toc-text">haproxy(可以不装，不装则不负载)</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="post-toc-text">初始化</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%BB-master"><span class="post-toc-text">主 Master</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%89%AF-master"><span class="post-toc-text">副 Master</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%AE%BE%E7%BD%AE%E4%B8%BA-node"><span class="post-toc-text">设置为 node</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#token-%E8%BF%87%E6%9C%9F"><span class="post-toc-text">token 过期</span></a></li></ol></li></ol><a href="#" class="toc-top">回到顶部</a></aside><div class="post-content__body"><div class="post-gallery"></div><blockquote><p>  学习搭建使用 <code>Kubeadm</code> 搭建 <code>Kubernetes</code> 高可用集群</p></blockquote><h1 id="学习环境"><a class="markdownIt-Anchor" href="#学习环境"></a> 学习环境</h1><p>vmware 安装三台虚拟机，或者先安装一台，完成下面的准备操作后克隆两台虚拟机，再修改 IP；主机名可以在安装时候设置，或者装完之后通过 hostnamectl set-hostname 修改</p><table><thead><tr><th style="text-align:center">hostname</th><th style="text-align:center">os</th><th style="text-align:center">static ip</th><th style="text-align:center">role</th></tr></thead><tbody><tr><td style="text-align:center">master</td><td style="text-align:center">centos7.8</td><td style="text-align:center">192.168.204.141</td><td style="text-align:center">master1，node1</td></tr><tr><td style="text-align:center">backup</td><td style="text-align:center">centos7.8</td><td style="text-align:center">192.168.204.142</td><td style="text-align:center">master2，node2</td></tr><tr><td style="text-align:center">node</td><td style="text-align:center">centos7.8</td><td style="text-align:center">192.168.204.143</td><td style="text-align:center">master3，node3</td></tr></tbody></table><p>没有特殊说明，默认每台虚拟机都要操作</p><p>网站文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p><h1 id="准备操作"><a class="markdownIt-Anchor" href="#准备操作"></a> 准备操作</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">临时关闭防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">禁用，重启生效</span></span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">临时关闭</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">禁用，重启生效</span></span><br><span class="line">sed -i &quot;s/enforcing/disabled/g&quot; /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">临时关闭</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">永久关闭</span></span><br><span class="line">sed -i &#x27;s/^[^#].*swap*/#&amp;/g&#x27; /etc/fstab</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装常用软件包</span></span><br><span class="line">yum install vim net-tools lrzsz unzip dos2unix telnet sysstat iotop pciutils lsof tcpdump psmisc bc wget socat gcc tree chrony ntpdate mlocate -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">主机名写入hosts</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.204.141 master</span><br><span class="line">192.168.204.142 backup</span><br><span class="line">192.168.204.143 node</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">主机间配置ssh免密登录</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">for host in master backup node; do ssh-copy-id -i ~/.ssh/id_rsa.pub $host;done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">内核开启网络支持</span></span><br><span class="line">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.ipv4.ip_nonlocal_bind = 1</span><br><span class="line">EOF</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf</span><br></pre></td></tr></table></figure><h1 id="安装-docker"><a class="markdownIt-Anchor" href="#安装-docker"></a> 安装 Docker</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">官方脚本安装</span></span><br><span class="line">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">手动yum安装</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">卸载原有docker</span></span><br><span class="line">yum remove docker*</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装所需的软件包。yum-utils 提供了 yum-config-manager ，并且 device mapper 存储驱动程序需要 device-mapper-persistent-data 和 lvm2</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置阿里源地址</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装docker-ce</span></span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置镜像加速地址,并修改Cgroup Driver(docker默认cgroupfs，k8s推荐使用systemd)</span></span><br><span class="line">mkdir /etc/docker/ -p</span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;&quot;registry-mirrors&quot;:[&quot;https://docker.mirrors.ustc.edu.cn/&quot;],</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动docker并设置自启</span></span><br><span class="line">for op in enable start status;do systemctl $op docker;done</span><br></pre></td></tr></table></figure><h1 id="master"><a class="markdownIt-Anchor" href="#master"></a> Master</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置k8s阿里源地址</span></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装k8s相关</span></span><br><span class="line">yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line">systemctl enable --now kubelet</span><br></pre></td></tr></table></figure><h2 id="keepalived"><a class="markdownIt-Anchor" href="#keepalived"></a> keepalived</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装keeplived并备份配置⽂件</span></span><br><span class="line">for host in master backup node;do ssh root@$host &quot;yum install -y keepalived&quot;;done</span><br><span class="line">for host in master backup node;do ssh root@$host &quot;mv /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak&quot;;done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改keepalived配置⽂件如下，标注的地⽅需要修改</span></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id master                        #标识，可⽤机器主机名作为标识</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER                             #设置⻆⾊，第⼀个master为MASTER，剩余的节点均为BACKUP</span><br><span class="line">    interface ens32                         #设置vip绑定端⼝</span><br><span class="line">    virtual_router_id 51                     #让master和backup在同⼀个虚拟路由⾥，id号必须相同</span><br><span class="line">    priority 100                             #优先级,谁的优先级⾼谁就是master，值越⼤优先级越⾼</span><br><span class="line">    advert_int 1                             #⼼跳间隔时间</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS                         #认证</span><br><span class="line">        auth_pass k8s                         #密码</span><br><span class="line">    &#125;</span><br><span class="line">     virtual_ipaddress &#123;</span><br><span class="line">        192.168.204.200                        #虚拟ip</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动keepalived并设置开机⾃启</span></span><br><span class="line">for op in enable start status;do systemctl $op keepalived;done</span><br></pre></td></tr></table></figure><h2 id="haproxy可以不装不装则不负载"><a class="markdownIt-Anchor" href="#haproxy可以不装不装则不负载"></a> haproxy(可以不装，不装则不负载)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装haproxy并备份配置⽂件</span></span><br><span class="line">for host in master backup node;do ssh root@$host &quot;yum install -y haproxy&quot;;done</span><br><span class="line">for host in master backup node;do ssh root@$host &quot;mv /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak&quot;;done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改haproxy配置⽂件如下，标注的地⽅需要修改</span></span><br><span class="line">cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; EOF</span><br><span class="line">global</span><br><span class="line">        chroot /var/lib/haproxy</span><br><span class="line">        daemon</span><br><span class="line">        group haproxy</span><br><span class="line">        user haproxy</span><br><span class="line">        log 127.0.0.1:514 local0 warning</span><br><span class="line">        pidfile /var/lib/haproxy.pid</span><br><span class="line">        maxconn 20000</span><br><span class="line">        spread-checks 3</span><br><span class="line">        nbproc 8</span><br><span class="line">defaults</span><br><span class="line">        log global</span><br><span class="line">        mode tcp</span><br><span class="line">        retries 3</span><br><span class="line">        option redispatch</span><br><span class="line">listen k8s-apiserver</span><br><span class="line">        bind 0.0.0.0:8443</span><br><span class="line">        mode tcp</span><br><span class="line">        balance roundrobin</span><br><span class="line">        timeout server 15s</span><br><span class="line">        timeout connect 15s</span><br><span class="line">        server k8sapiserver1 192.168.204.141:6443 check port 6443 inter 5000 fall 5</span><br><span class="line">        server k8sapiserver2 192.168.204.142:6443 check port 6443 inter 5000 fall 5</span><br><span class="line">        server k8sapiserver3 192.168.204.143:6443 check port 6443 inter 5000 fall 5</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动haproxy并设置开机⾃启</span></span><br><span class="line">for op in enable start status;do systemctl $op haproxy;done</span><br></pre></td></tr></table></figure><h1 id="初始化"><a class="markdownIt-Anchor" href="#初始化"></a> 初始化</h1><h2 id="主-master"><a class="markdownIt-Anchor" href="#主-master"></a> 主 Master</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化master</span></span><br><span class="line">A:参数初始(可选参数较多，命令会比较长)</span><br><span class="line">kubeadm init \</span><br><span class="line">--apiserver-advertise-address=192.168.204.141 \</span><br><span class="line">--kubernetes-version v1.20.4 \</span><br><span class="line">--service-cidr=192.100.0.0/16 \</span><br><span class="line">--pod-network-cidr=192.244.0.0/16 \</span><br><span class="line">--control-plane-endpoint 192.168.204.200:8443 \</span><br><span class="line">--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line"></span><br><span class="line">B:配置文件初始(通过配置文件修改参数，复用性高，易修改)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">导出默认配置文件</span></span><br><span class="line">kubeadm config print init-defaults &gt; kubeadm-init.yml</span><br><span class="line">vim kubeadm-init.yml</span><br><span class="line">//</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef                        #token,默认值即可</span><br><span class="line">  ttl: 2400h0m0s                                         #token有效期，添加节点如果token过期需要重新⽣成</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.204.131                   #修改为本地主机IP</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: master                                        #默认为本地主机名</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controlPlaneEndpoint: &quot;192.168.204.200:8443&quot;                 #单master节点时这⾥写“本地真实IP:6443”；多master节点时写“VIP:端⼝”，端⼝要与haproxy配置中的bind字段的端⼝⼀致（如果没有装haproxy则仍然是6443）</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns: &#123;&#125;</span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers     #镜像地址，默认为k8s地址，此处已修改为阿里云</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.20.4                                    #指定k8s版本，可以通用kubectl version查看获取</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  podSubnet: 192.244.0.0/16                                    #指定Pod的⽹络范围</span><br><span class="line">  serviceSubnet: 192.100.0.0/16                                #指定Service的⽹络范围</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">//</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">预下载镜像</span></span><br><span class="line">kubeadm config images pull --config kubeadm-init.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化</span></span><br><span class="line">kubeadm init --config kubeadm-init.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置kubectl的config⽂件</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装flannel网络插件（k8s支持很多网络插件，此处以flannel为例）</span></span><br><span class="line">cat &gt; /run/flannel/subnet.env &lt;&lt; EOF</span><br><span class="line">FLANNEL_NETWORK=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.0.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=true</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置命令补全</span></span><br><span class="line">yum install -y bash-completion</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">切换默认命名空间</span></span><br><span class="line">kubectl config set-context $(kubectl config current-context) --namespace=kube-system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看pod情况</span></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化失败或者反复可以重置</span></span><br><span class="line">kubeadm reset</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">复制一下脚本内容</span></span><br><span class="line">vim add_master.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">/bin/bash</span></span><br><span class="line">CONTROL_PLANE_IPS=&quot;backup node&quot;                                               #多个节点以空格隔开</span><br><span class="line">for host in $&#123;CONTROL_PLANE_IPS&#125;</span><br><span class="line">do</span><br><span class="line"> ssh root@$&#123;host&#125; &quot;mkdir -p /etc/kubernetes/pki/etcd&quot;</span><br><span class="line"> scp -r /etc/kubernetes/pki/ca.* root@$&#123;host&#125;:/etc/kubernetes/pki/</span><br><span class="line"> scp -r /etc/kubernetes/pki/sa.* root@$&#123;host&#125;:/etc/kubernetes/pki/</span><br><span class="line"> scp -r /etc/kubernetes/pki/front-proxy-ca.* root@$&#123;host&#125;:/etc/kubernetes/pki/</span><br><span class="line"> scp -r /etc/kubernetes/pki/etcd/ca.* root@$&#123;host&#125;:/etc/kubernetes/pki/etcd/</span><br><span class="line"> scp -r /etc/kubernetes/admin.conf root@$&#123;host&#125;:/etc/kubernetes/</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行脚本，将证书信息传到其他副master</span></span><br><span class="line">sh add_master.sh</span><br></pre></td></tr></table></figure><h2 id="副-master"><a class="markdownIt-Anchor" href="#副-master"></a> 副 Master</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">加入进已经初始化的主master(此处命令在主master初始化会有)</span></span><br><span class="line">kubeadm join 192.168.204.200:8443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:4159d86c40fea91f3b7a2669eb4ca0e927466928e7df0a901c11b40dfd766dda --control-plane</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置kubectl的config⽂件</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装flannel网络插件（k8s支持很多网络插件，此处以flannel为例）</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看节点情况（如果不安装网络插件，查看的STATUS会为NOT READY）</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES                  AGE     VERSION</span><br><span class="line">backup   Ready    control-plane,master   9m53s   v1.20.4</span><br><span class="line">master   Ready    control-plane,master   32m     v1.20.4</span><br><span class="line">node     Ready    control-plane,master   4m20s   v1.20.4</span><br></pre></td></tr></table></figure><h2 id="设置为-node"><a class="markdownIt-Anchor" href="#设置为-node"></a> 设置为 node</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看节点容忍，当前三个节点无法调用pod</span></span><br><span class="line">kubectl describe node master |grep -E &#x27;(Role|Taint)&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">取消污点后，master可以当作node</span></span><br><span class="line">kubectl taint nodes master node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure><h2 id="token-过期"><a class="markdownIt-Anchor" href="#token-过期"></a> token 过期</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">列出token信息</span></span><br><span class="line">kubeadm token list</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建新的token</span></span><br><span class="line">kubeadm token create</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">获取ca证书sha256编码<span class="built_in">hash</span>值</span></span><br><span class="line">openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &#x27;s/^.* //&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生成新token和获取<span class="built_in">hash</span>后放入之前的<span class="built_in">join</span>命令重新拼接执行</span></span><br></pre></td></tr></table></figure></div></div></article><div class="post__foot"><div class="like-author"><input type="checkbox" id="likeCode"><div class="author-face"><img height="100px" width="100px" id="front-face" alt="author face" src="/images/avatar.jpg"> <img height="100px" width="100px" id="back-face" alt="like code" src="/images/wechatpay.png"></div><div class="like-text">俾Mucy食[凍乾]~(￣▽￣)~*</div><label for="likeCode" class="like-btn"><svg viewBox="0 0 1024 1024" width="20px" style="margin-right:10px" height="20px"><path d="M466.88 908.96L113.824 563.296a270.08 270.08 0 0 1 0-387.392c108.8-106.56 284.896-106.56 393.696 0 1.504 1.472 2.976 2.944 4.448 4.48 1.472-1.536 2.944-3.008 4.448-4.48 108.8-106.56 284.896-106.56 393.696 0a269.952 269.952 0 0 1 34.016 347.072l-387.392 385.6a64 64 0 0 1-89.92 0.384z" p-id="13650" fill="#ee4242"/></svg> 心水</label></div><div class="post-nav"><a class="post-nav-item-left" href="/posts/6348717a.html"><div class="text-align"><svg t="1670570876164" class="icon" viewBox="0 0 1024 1024" width="16" height="16"><path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/></svg> <span class="text-small">上一篇</span></div><div>Commands</div></a><div class="vhr"></div><a class="post-nav-item-right" href="/posts/688c3b79.html"><div class="text-align"><span class="text-small">下一篇</span> <svg t="1670570876164" class="icon" viewBox="0 0 1024 1024" transform="scale(-1,-1)" width="16" height="16"><path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/></svg></div>通过Kubeadm搭建Kubernetes单主多从集群</a></div><div class="related-post"><div class="related__head"><a href="/tags/K8S/" class="post-tag">#K8S</a><a href="/tags/%E5%AE%B9%E5%99%A8/" class="post-tag">#容器</a></div><div class="realated__body"><div class="null"><div class="null-item"><div class="null-title"><a href="\posts\688c3b79.html" title="通过Kubeadm搭建Kubernetes单主多从集群" rel="bookmark">通过Kubeadm搭建Kubernetes单主多从集群</a></div><div class="null-excerpt"><p></p><blockquote><p>  学习搭建使用 <code>Kubeadm</code> 搭建 <code>Kubernetes</code> 单主多从集群</p></blockquote><p></p></div></div><div class="null-item"><div class="null-title"><a href="\posts\6c8009ea.html" title="手动搭建Train版OpenStack" rel="bookmark">手动搭建Train版OpenStack</a></div><div class="null-excerpt"><p></p><blockquote><p>  学习搭建 <code>OpenStack</code></p></blockquote><p></p></div></div><div class="null-item"><div class="null-title"><a href="\posts\6348717a.html" title="Commands" rel="bookmark">Commands</a></div><div class="null-excerpt"><p></p><blockquote><p>  总结一些常用命令</p></blockquote><p></p></div></div></div></div></div></div></div><div class="foot"><div class="foot-inner"><div class="foot__head"><div class="foot-line"><div class="matts">用</div><div class="matts">捨</div><div class="matts">由</div><div class="matts">時</div></div><div class="foot-line"><div class="matts">行</div><div class="matts">藏</div><div class="matts">在</div><div class="matts">我</div></div></div><div class="foot__body"><div class="foot-item"><div class="foot-item__head">账号</div><div class="foot-item__body"><div class="text"><img alt="link" height="20px" width="20px" src="/images/icon/icon-github.svg"> <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/limerencist">github</a></div></div></div><div class="foot-item"><div class="foot-item__head">联系</div><div class="foot-item__body"><div class="text"><img alt="link" height="20px" width="20px" src="/images/icon/icon-email.svg"> <a class="foot-link" href="mailto:limerencist@gmail.com">limerencist@gmail.com</a></div></div></div></div><div class="copyright"><a href="https://limerencist.github.io">失落之地</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp; <svg width="20" height="20" viewBox="0 0 725 725"><path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z"/><path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z"/><path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z"/></svg> <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动</div></div></div></body></html>