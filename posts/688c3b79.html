<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf8"><meta name="viewport" content="initial-scale=1,width=device-width"><title>通过Kubeadm搭建Kubernetes单主多从集群 | 失落之地</title><meta name="description" content=""><meta name="keywords" content=""><link rel="apple-touch-icon" sizes="180x180" href="/images/rock-gesture.svg"><link rel="icon" type="image/png" sizes="32x32" href="/images/rock-gesture.svg"><link rel="icon" type="image/png" sizes="16x16" href="/images/rock-gesture.svg"><link rel="mask-icon" href="/images/rock-gesture.svg" color=""><style>@font-face{font-family:STXingkai;src:url(/font/regular.ttf);font-weight:regular}</style><link rel="stylesheet" type="text/css" href="/css/layout.css"><link rel="stylesheet" type="text/css" href="/css/post.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="head"><div class="nav"><a href="/" class="nav-logo"><img alt="logo" height="60px" width="60px" src="/images/rock-gesture.svg"> </a><input id="navBtn" type="checkbox"><div class="nav-menu"><a class="nav-menu-item" href="/devops">運維</a> <a class="nav-menu-item" href="/playlist">歌單</a> <a class="nav-menu-item" href="/cv/">简历</a></div><label class="nav-btn" for="navBtn"></label></div></div><div class="body"><article class="post-content"><div class="post-inner--toc"><div class="post-content__head"><div class="post-title">通过Kubeadm搭建Kubernetes单主多从集群</div><div class="post-info"><a href="/tags/K8S/" class="post-tag">#K8S</a><a href="/tags/%E5%AE%B9%E5%99%A8/" class="post-tag">#容器</a> <span class="post-date">2022-12-21</span></div></div><aside class="toc-outer"><div class="toc-title">目录</div><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%8E%AF%E5%A2%83"><span class="post-toc-text">学习环境</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%87%86%E5%A4%87%E6%93%8D%E4%BD%9C"><span class="post-toc-text">准备操作</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#docker"><span class="post-toc-text">Docker</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#master"><span class="post-toc-text">Master</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#nodes"><span class="post-toc-text">Nodes</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%AE%89%E8%A3%85-dashboardmaster"><span class="post-toc-text">安装 dashboard（Master）</span></a></li></ol><a href="#" class="toc-top">回到顶部</a></aside><div class="post-content__body"><div class="post-gallery"></div><blockquote><p>  学习搭建使用 <code>Kubeadm</code> 搭建 <code>Kubernetes</code> 单主多从集群</p></blockquote><h1 id="学习环境"><a class="markdownIt-Anchor" href="#学习环境"></a> 学习环境</h1><p>vmware 安装三台虚拟机，或者先安装一台，完成下面的准备操作后克隆两台虚拟机，再修改 IP；主机名可以在安装时候设置，或者装完之后通过 hostnamectl set-hostname 修改；</p><table><thead><tr><th style="text-align:center">hostname</th><th style="text-align:center">os</th><th style="text-align:center">static ip</th><th style="text-align:center">role</th></tr></thead><tbody><tr><td style="text-align:center">master</td><td style="text-align:center">centos7.6</td><td style="text-align:center">192.168.204.131</td><td style="text-align:center">master</td></tr><tr><td style="text-align:center">minion</td><td style="text-align:center">centos7.6</td><td style="text-align:center">192.168.204.132</td><td style="text-align:center">node1</td></tr><tr><td style="text-align:center">slave</td><td style="text-align:center">centos7.6</td><td style="text-align:center">192.168.204.133</td><td style="text-align:center">node2</td></tr></tbody></table><p>没有特殊说明，默认每台虚拟机都要操作；</p><p>网站文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/%EF%BC%9B">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/；</a></p><h1 id="准备操作"><a class="markdownIt-Anchor" href="#准备操作"></a> 准备操作</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">临时关闭</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">禁用，重启生效</span></span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">临时关闭</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">禁用,重启生效</span></span><br><span class="line">sed -i &quot;s/enforcing/disabled/g&quot; /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">临时关闭</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">永久关闭</span></span><br><span class="line">sed -i &#x27;s/^[^#].*swap*/#&amp;/g&#x27; /etc/fstab</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装常用软件包</span></span><br><span class="line">yum install vim net-tools lrzsz unzip dos2unix telnet sysstat iotop pciutils lsof tcpdump psmisc bc wget socat gcc tree chrony ntpdate mlocate -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">主机名写入hosts</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.204.131 master</span><br><span class="line">192.168.204.132 minion</span><br><span class="line">192.168.204.133 slave</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">主机间配置ssh免密登录</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">for host in master minion slave; do ssh-copy-id -i ~/.ssh/id_rsa.pub $host;done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">内核开启网络支持</span></span><br><span class="line">cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.ipv4.ip_nonlocal_bind = 1</span><br><span class="line">EOF</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf</span><br></pre></td></tr></table></figure><h1 id="docker"><a class="markdownIt-Anchor" href="#docker"></a> Docker</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">官方脚本安装</span></span><br><span class="line">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">手动yum安装</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">卸载原有docker</span></span><br><span class="line">yum remove docker*</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装所需的软件包。yum-utils 提供了 yum-config-manager ，并且 device mapper 存储驱动程序需要 device-mapper-persistent-data 和 lvm2</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置阿里源地址</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装</span></span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置镜像加速地址,并修改Cgroup Driver(docker默认cgroupfs，k8s推荐使用systemd)</span></span><br><span class="line">mkdir /etc/docker -p</span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;&quot;registry-mirrors&quot;:[&quot;https://docker.mirrors.ustc.edu.cn/&quot;],</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动docker并设置自启</span></span><br><span class="line">for op in enable start status;do systemctl $op docker;done</span><br></pre></td></tr></table></figure><h1 id="master"><a class="markdownIt-Anchor" href="#master"></a> Master</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置k8s阿里源地址</span></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装k8s相关</span></span><br><span class="line">yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line">systemctl enable --now kubelet</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化master</span></span><br><span class="line">A:参数初始(可选参数较多，命令会比较长)</span><br><span class="line">kubeadm init \</span><br><span class="line">--apiserver-advertise-address=192.168.204.131 \</span><br><span class="line">--kubernetes-version v1.20.4 \</span><br><span class="line">--service-cidr=192.100.0.0/16 \</span><br><span class="line">--pod-network-cidr=192.244.0.0/16 \</span><br><span class="line">--control-plane-endpoint 192.168.204.200:8443 \</span><br><span class="line">--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line"></span><br><span class="line">B:配置文件初始(通过配置文件修改参数，复用性高，易修改)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">导出默认配置文件</span></span><br><span class="line">kubeadm config print init-defaults &gt; kubeadm-init.yml</span><br><span class="line">vim kubeadm-init.yml</span><br><span class="line">//</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef                        #token,默认值即可</span><br><span class="line">  ttl: 2400h0m0s                                         #token有效期，添加节点如果token过期需要重新⽣成</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.204.131                   #修改为本地主机IP</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: master                                        #默认为本地主机名</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controlPlaneEndpoint: &quot;192.168.204.131:6443&quot;                 #单master节点时这⾥写“本地真实IP:6443”；多master节点时写“VIP:端⼝”，端⼝要与haproxy配置中的bind字段的端⼝⼀致</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns: &#123;&#125;</span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers    #镜像地址，默认为k8s地址，此处已修改为阿里云</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.20.4                                    #指定k8s版本，可以通用kubectl version查看获取</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  podSubnet: 192.244.0.0/16                                    #指定Pod的⽹络范围</span><br><span class="line">  serviceSubnet: 192.100.0.0/16                                #指定Service的⽹络范围</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">//</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">预下载镜像</span></span><br><span class="line">kubeadm config images pull --config kubeadm-init.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化</span></span><br><span class="line">kubeadm init --config kubeadm-init.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置kubectl的config⽂件(此处命令在master初始化会有)</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装flannel网络插件（k8s支持很多网络插件，此处以flannel为例）</span></span><br><span class="line">cat &gt; /run/flannel/subnet.env &lt;&lt; EOF</span><br><span class="line">FLANNEL_NETWORK=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.0.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=true</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置命令补全</span></span><br><span class="line">yum install -y bash-completion</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">切换默认命名空间</span></span><br><span class="line">kubectl config set-context $(kubectl config current-context) --namespace=kube-system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看pod情况</span></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化失败或者反复可以重置</span></span><br><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure><h1 id="nodes"><a class="markdownIt-Anchor" href="#nodes"></a> Nodes</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置k8s阿里源地址</span></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装k8s相关</span></span><br><span class="line">yum install -y kubelet kubeadm --disableexcludes=kubernetes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动kubelet并设置自启</span></span><br><span class="line">for op in enable start status;do systemctl $op kubelet;done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">加入nodes(此处命令在master初始化会有)</span></span><br><span class="line">kubeadm join 192.168.204.131:6443 --token abcdef.0123456789abcdef</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:724d623dc0cde1d350ebea86b6a583c3221a2bdef735db804b145eac751037b0</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果忘记通过以下命令查看</span></span><br><span class="line">kubeadm token create --print-join-command</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">node节点<span class="built_in">join</span>之后，可以在master查看节点情况（如果不安装网络插件，查看的STATUS会为NOT READY）</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES                  AGE     VERSION</span><br><span class="line">master   Ready    control-plane,master   32m     v1.20.4</span><br><span class="line">minion   Ready    &lt;none&gt;                   9m      v1.20.4</span><br><span class="line">slave    Ready    &lt;none&gt;                4m20s   v1.20.4</span><br></pre></td></tr></table></figure><h1 id="安装-dashboardmaster"><a class="markdownIt-Anchor" href="#安装-dashboardmaster"></a> 安装 dashboard（Master）</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载默认yaml文件</span></span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta4/aio/deploy/recommended.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改yaml</span></span><br><span class="line">vim recommended.yaml修改NodePort</span><br><span class="line">//</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort                              #默认没有，添加</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodePort: 30001                        #默认没有，添加，30001为自定义端口</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">//</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动dashboard，执行命令之后可以稍微等一会</span></span><br><span class="line">kubectl apply -f recommended.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看dashboard的pod</span></span><br><span class="line">kubectl get pod -n kubernetes-dashboard | grep dashboard</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生成证书</span></span><br><span class="line">openssl genrsa -out dashboard.key 2048</span><br><span class="line">openssl req -new -out dashboard.csr -key dashboard.key -subj &#x27;/CN=192.168.204.131&#x27;</span><br><span class="line">openssl x509 -req -days 3650 -in dashboard.csr -signkey dashboard.key -out dashboard.crt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除原有证书</span></span><br><span class="line">kubectl delete secret kubernetes-dashboard-certs -n kubernetes-dashboard</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通过新生成的证书创建secret</span></span><br><span class="line">kubectl create secret generic kubernetes-dashboard-certs --from-file=dashboard.key --from-file=dashboard.crt -n kubernetes-dashboard</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除原有pod即可（会自动创建新的pod）</span></span><br><span class="line">kubectl delete pod &lt;pod name&gt; -n kubernetes-dashboard</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">给所有namespace授权</span></span><br><span class="line">kubectl create serviceaccount dashboard-serviceaccount -n kubernetes-dashboard</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建clusterrolebinding</span></span><br><span class="line">kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-serviceaccount</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">获取token</span></span><br><span class="line">kubectl get secret -n kubernetes-dashboard | grep dashboard-serviceaccount-token</span><br><span class="line">kubectl describe secret &lt;secret name&gt;</span><br><span class="line"></span><br><span class="line">访问https://IP:之前自定义的端口,输入上一步获取的token即可登录看到相关信息</span><br></pre></td></tr></table></figure></div></div></article><div class="post__foot"><div class="like-author"><input type="checkbox" id="likeCode"><div class="author-face"><img height="100px" width="100px" id="front-face" alt="author face" src="/images/avatar.jpg"> <img height="100px" width="100px" id="back-face" alt="like code" src="/images/wechatpay.png"></div><div class="like-text">俾Mucy食[凍乾]~(￣▽￣)~*</div><label for="likeCode" class="like-btn"><svg viewBox="0 0 1024 1024" width="20px" style="margin-right:10px" height="20px"><path d="M466.88 908.96L113.824 563.296a270.08 270.08 0 0 1 0-387.392c108.8-106.56 284.896-106.56 393.696 0 1.504 1.472 2.976 2.944 4.448 4.48 1.472-1.536 2.944-3.008 4.448-4.48 108.8-106.56 284.896-106.56 393.696 0a269.952 269.952 0 0 1 34.016 347.072l-387.392 385.6a64 64 0 0 1-89.92 0.384z" p-id="13650" fill="#ee4242"/></svg> 心水</label></div><div class="post-nav"><a class="post-nav-item-left" href="/posts/f6b6db86.html"><div class="text-align"><svg t="1670570876164" class="icon" viewBox="0 0 1024 1024" width="16" height="16"><path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/></svg> <span class="text-small">上一篇</span></div><div>通过Kubeadm搭建Kubernetes高可用集群</div></a><div class="vhr"></div><a class="post-nav-item-right" href="/posts/56d9cde9.html"><div class="text-align"><span class="text-small">下一篇</span> <svg t="1670570876164" class="icon" viewBox="0 0 1024 1024" transform="scale(-1,-1)" width="16" height="16"><path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/></svg></div>中國風電音</a></div><div class="related-post"><div class="related__head"><a href="/tags/K8S/" class="post-tag">#K8S</a><a href="/tags/%E5%AE%B9%E5%99%A8/" class="post-tag">#容器</a></div><div class="realated__body"><div class="null"><div class="null-item"><div class="null-title"><a href="\posts\f6b6db86.html" title="通过Kubeadm搭建Kubernetes高可用集群" rel="bookmark">通过Kubeadm搭建Kubernetes高可用集群</a></div><div class="null-excerpt"><p></p><blockquote><p>  学习搭建使用 <code>Kubeadm</code> 搭建 <code>Kubernetes</code> 高可用集群</p></blockquote><p></p></div></div><div class="null-item"><div class="null-title"><a href="\posts\6c8009ea.html" title="手动搭建Train版OpenStack" rel="bookmark">手动搭建Train版OpenStack</a></div><div class="null-excerpt"><p></p><blockquote><p>  学习搭建 <code>OpenStack</code></p></blockquote><p></p></div></div><div class="null-item"><div class="null-title"><a href="\posts\6348717a.html" title="Commands" rel="bookmark">Commands</a></div><div class="null-excerpt"><p></p><blockquote><p>  总结一些常用命令</p></blockquote><p></p></div></div></div></div></div></div></div><div class="foot"><div class="foot-inner"><div class="foot__head"><div class="foot-line"><div class="matts">用</div><div class="matts">捨</div><div class="matts">由</div><div class="matts">時</div></div><div class="foot-line"><div class="matts">行</div><div class="matts">藏</div><div class="matts">在</div><div class="matts">我</div></div></div><div class="foot__body"><div class="foot-item"><div class="foot-item__head">账号</div><div class="foot-item__body"><div class="text"><img alt="link" height="20px" width="20px" src="/images/icon/icon-github.svg"> <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/limerencist">github</a></div></div></div><div class="foot-item"><div class="foot-item__head">联系</div><div class="foot-item__body"><div class="text"><img alt="link" height="20px" width="20px" src="/images/icon/icon-email.svg"> <a class="foot-link" href="mailto:limerencist@gmail.com">limerencist@gmail.com</a></div></div></div></div><div class="copyright"><a href="https://limerencist.github.io">失落之地</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp; <svg width="20" height="20" viewBox="0 0 725 725"><path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z"/><path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z"/><path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z"/></svg> <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动</div></div></div></body></html>