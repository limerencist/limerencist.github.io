<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf8"><meta name="viewport" content="initial-scale=1,width=device-width"><title>Prometheus常用配置汇总 | 失落之地</title><meta name="description" content=""><meta name="keywords" content=""><link rel="apple-touch-icon" sizes="180x180" href="/images/rock-gesture.svg"><link rel="icon" type="image/png" sizes="32x32" href="/images/rock-gesture.svg"><link rel="icon" type="image/png" sizes="16x16" href="/images/rock-gesture.svg"><link rel="mask-icon" href="/images/rock-gesture.svg" color=""><style>@font-face{font-family:STXingkai;src:url(/font/regular.ttf);font-weight:regular}</style><link rel="stylesheet" type="text/css" href="/css/layout.css"><link rel="stylesheet" type="text/css" href="/css/post.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="head"><div class="nav"><a href="/" class="nav-logo"><img alt="logo" height="60px" width="60px" src="/images/rock-gesture.svg"> </a><input id="navBtn" type="checkbox"><div class="nav-menu"><a class="nav-menu-item" href="/devops">運維</a> <a class="nav-menu-item" href="/playlist">歌單</a> <a class="nav-menu-item" href="/cv/">简历</a></div><label class="nav-btn" for="navBtn"></label></div></div><div class="body"><article class="post-content"><div class="post-inner--toc"><div class="post-content__head"><div class="post-title">Prometheus常用配置汇总</div><div class="post-info"><a href="/tags/K8S/" class="post-tag">#K8S</a><a href="/tags/%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/" class="post-tag">#监控告警</a> <span class="post-date">2023-03-23</span></div></div><aside class="toc-outer"><div class="toc-title">目录</div><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#target"><span class="post-toc-text">Target</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#rules"><span class="post-toc-text">Rules</span></a></li></ol><a href="#" class="toc-top">回到顶部</a></aside><div class="post-content__body"><div class="post-gallery"></div><blockquote><p>  在之前的 <a href="https://limerencist.github.io/posts/ef247c7f.html">K8S常用yaml汇总</a> 中的 Prometheus 部分，为了快速部署应用，并没有添加常用的target和rules配置，然而在实际工作中，任务的服务发现和告警规则必不可少，本文就 target 和 rules 也整理了一些常用的配置，做到开箱即用。</p></blockquote><h1 id="target"><a class="markdownIt-Anchor" href="#target"></a> Target</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">prometheus-ha</span></span><br><span class="line">    <span class="attr">replica:</span> <span class="string">$(POD_NAME)</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">/etc/prometheus/rules/*.yml</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;alertmanager:9093&quot;</span>]</span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;alertmanager&#x27;</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;alertmanager:9093&#x27;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;node-exporter&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">    <span class="attr">regex:</span> <span class="string">&#x27;(.*):10250&#x27;</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">&#x27;$&#123;1&#125;:9100&#x27;</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">node</span>      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_address_InternalIP</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">ip</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox-exporter&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">http_2xx</span>]  <span class="comment"># Look for a HTTP 200 response.</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https://prometheus.io</span>    <span class="comment"># Target to probe with http.</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">blackbox-exporter:9115</span>  <span class="comment"># The blackbox exporter&#x27;s real hostname:port.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;kube-state-metrics&quot;</span> </span><br><span class="line">  <span class="attr">static_configs:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;kube-state-metrics:8080&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kube-nodes-cadvisor&#x27;</span></span><br><span class="line">  <span class="attr">honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">/metrics/cadvisor</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line"><span class="comment"># kubelet</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kube-kubelet&#x27;</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$&#123;1&#125;/proxy/metrics</span></span><br><span class="line"><span class="comment"># apiserver</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kube-apiservers&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>, <span class="string">__meta_kubernetes_service_name</span>, <span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br><span class="line"><span class="comment"># 添加controller和scheduler的任务之前，需要保证启动参数中有--bind-address=0.0.0.0，以及创建了对应的svc名称</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kube-controller-manager&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">authorization:</span></span><br><span class="line">    <span class="attr">credentials_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>, <span class="string">__meta_kubernetes_service_name</span>, <span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">kube-system;kube-controller-manager;https</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kube-scheduler&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">authorization:</span></span><br><span class="line">    <span class="attr">credentials_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>, <span class="string">__meta_kubernetes_service_name</span>, <span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">kube-system;kube-scheduler;https</span></span><br></pre></td></tr></table></figure><h1 id="rules"><a class="markdownIt-Anchor" href="#rules"></a> Rules</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hostStatsAlert</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">hostCpuUsageAlert</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">sum(avg</span> <span class="string">without</span> <span class="string">(cpu)(irate(node_cpu&#123;mode!=&#x27;idle&#x27;&#125;[5m])))</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">&gt;</span> <span class="number">0.85</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> CPU usage above 85% (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">hostMemUsageAlert</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">(node_memory_MemTotal</span> <span class="bullet">-</span> <span class="string">node_memory_MemAvailable)/node_memory_MemTotal</span> <span class="string">&gt;</span> <span class="number">0.85</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> MEM usage above 85% (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">OutOfInodes</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">node_filesystem_free&#123;fstype=&quot;overlay&quot;,mountpoint</span> <span class="string">=&quot;/&quot;&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size&#123;fstype=&quot;overlay&quot;,mountpoint</span> <span class="string">=&quot;/&quot;&#125;</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&lt;</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Out of inodes (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Disk is almost running out of available inodes (&lt; 10% left) (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">OutOfDiskSpace</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">node_filesystem_free&#123;fstype=&quot;overlay&quot;,mountpoint</span> <span class="string">=&quot;/rootfs&quot;&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size&#123;fstype=&quot;overlay&quot;,mountpoint</span> <span class="string">=&quot;/rootfs&quot;&#125;</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&lt;</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Out of disk space (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Disk is almost full (&lt; 10% left) (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">UnusualNetworkThroughputIn</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">(irate(node_network_receive_bytes[2m]))</span> <span class="string">/</span> <span class="number">1024</span> <span class="string">/</span> <span class="number">1024</span> <span class="string">&gt;</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Unusual network throughput in (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Host network interfaces are probably receiving too much data (&gt; 100 MB/s) (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">UnusualNetworkThroughputOut</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">(irate(node_network_transmit_bytes[2m]))</span> <span class="string">/</span> <span class="number">1024</span> <span class="string">/</span> <span class="number">1024</span> <span class="string">&gt;</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Unusual network throughput out (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Host network interfaces are probably sending too much data (&gt; 100 MB/s) (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">UnusualDiskReadRate</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">(irate(node_disk_bytes_read[2m]))</span> <span class="string">/</span> <span class="number">1024</span> <span class="string">/</span> <span class="number">1024</span> <span class="string">&gt;</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Unusual disk read rate (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Disk is probably reading too much data (&gt; 50 MB/s) (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">UnusualDiskWriteRate</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">sum</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">(irate(node_disk_bytes_written[2m]))</span> <span class="string">/</span> <span class="number">1024</span> <span class="string">/</span> <span class="number">1024</span> <span class="string">&gt;</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Unusual disk write rate (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Disk is probably writing too much data (&gt; 50 MB/s) (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">UnusualDiskReadLatency</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">rate(node_disk_read_time_ms[1m])</span> <span class="string">/</span> <span class="string">rate(node_disk_reads_completed[1m])</span> <span class="string">&gt;</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Unusual disk read latency (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Disk latency is growing (read operations &gt; 100ms) (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">UnusualDiskWriteLatency</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">rate(node_disk_write_time_ms[1m])</span> <span class="string">/</span> <span class="string">rate(node_disk_writes_completedl[1m])</span> <span class="string">&gt;</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Unusual disk write latency (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Disk latency is growing (write operations &gt; 100ms) (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http_status</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">ProbeFailed</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">probe_success</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">error</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Probe failed (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Probe failed (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">StatusCode</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">probe_http_status_code</span> <span class="string">&lt;=</span> <span class="number">199</span> <span class="string">OR</span> <span class="string">probe_http_status_code</span> <span class="string">&gt;=</span> <span class="number">400</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">error</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Status Code (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;HTTP status code is not 200-399 (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">SslCertificateWillExpireSoon</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">probe_ssl_earliest_cert_expiry</span> <span class="bullet">-</span> <span class="string">time()</span> <span class="string">&lt;</span> <span class="number">86400</span> <span class="string">*</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;SSL certificate will expire soon (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;SSL certificate expires in 30 days (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">SslCertificateHasExpired</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">probe_ssl_earliest_cert_expiry</span> <span class="bullet">-</span> <span class="string">time()</span>  <span class="string">&lt;=</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">error</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;SSL certificate has expired (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;SSL certificate has expired already (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">BlackboxSlowPing</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">probe_icmp_duration_seconds</span> <span class="string">&gt;</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Blackbox slow ping (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Blackbox ping took more than 2s (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">BlackboxSlowRequests</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">probe_http_duration_seconds</span> <span class="string">&gt;</span> <span class="number">2</span> </span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Blackbox slow requests (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Blackbox request took more than 2s (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">PodCpuUsagePercent</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">sum(sum(label_replace(irate(container_cpu_usage_seconds_total[1m]),&quot;pod&quot;,&quot;$1&quot;,&quot;container_label_io_kubernetes_pod_name&quot;,</span> <span class="string">&quot;(.*)&quot;</span><span class="string">))by(pod)</span> <span class="string">/</span> <span class="string">on(pod)</span> <span class="string">group_right</span> <span class="string">kube_pod_container_resource_limits_cpu_cores</span> <span class="string">*100</span> <span class="string">)by(container,namespace,node,pod,severity)</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Pod cpu usage percent has exceeded 80% (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%)&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">PodMemoryUsagePercent</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">sum(label_replace(container_memory_working_set_bytes,&quot;pod&quot;,&quot;$1&quot;,&quot;container_label_io_kubernetes_pod_name&quot;,</span> <span class="string">&quot;(.*)&quot;</span><span class="string">)</span> <span class="string">/</span> <span class="string">on(pod)</span> <span class="string">group_left</span> <span class="string">kube_pod_container_resource_limits_memory_bytes&#123;pod!~&quot;prometheus.*|filebeat.*&quot;&#125;)by(pod)</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Pod emory usage percent has exceeded 80% (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>%)&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-state-metrics</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">KubeStateMetricsListErrors</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">kube-state-metrics</span> <span class="string">is</span> <span class="string">experiencing</span> <span class="string">errors</span> <span class="string">at</span> <span class="string">an</span> <span class="string">elevated</span> <span class="string">rate</span> <span class="string">in</span> <span class="string">list</span> <span class="string">operations.</span> <span class="string">This</span> <span class="string">is</span> <span class="string">likely</span> <span class="string">causing</span> <span class="string">it</span> <span class="string">to</span> <span class="string">not</span> <span class="string">be</span> <span class="string">able</span> <span class="string">to</span> <span class="string">expose</span> <span class="string">metrics</span> <span class="string">about</span> <span class="string">Kubernetes</span> <span class="string">objects</span> <span class="string">correctly</span> <span class="string">or</span> <span class="string">at</span> <span class="string">all.</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">kube-state-metrics</span> <span class="string">is</span> <span class="string">experiencing</span> <span class="string">errors</span> <span class="string">in</span> <span class="string">list</span> <span class="string">operations.</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      (sum(rate(kube_state_metrics_list_total&#123;job=&quot;kube-state-metrics&quot;,result=&quot;error&quot;&#125;[5m]))</span></span><br><span class="line"><span class="string">        /</span></span><br><span class="line"><span class="string">      sum(rate(kube_state_metrics_list_total&#123;job=&quot;kube-state-metrics&quot;&#125;[5m])))</span></span><br><span class="line"><span class="string">      &gt; 0.01</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">15m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">KubeStateMetricsWatchErrors</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">kube-state-metrics</span> <span class="string">is</span> <span class="string">experiencing</span> <span class="string">errors</span> <span class="string">at</span> <span class="string">an</span> <span class="string">elevated</span> <span class="string">rate</span> <span class="string">in</span> <span class="string">watch</span> <span class="string">operations.</span> <span class="string">This</span> <span class="string">is</span> <span class="string">likely</span> <span class="string">causing</span> <span class="string">it</span> <span class="string">to</span> <span class="string">not</span> <span class="string">be</span> <span class="string">able</span> <span class="string">to</span> <span class="string">expose</span> <span class="string">metrics</span> <span class="string">about</span> <span class="string">Kubernetes</span> <span class="string">objects</span> <span class="string">correctly</span> <span class="string">or</span> <span class="string">at</span> <span class="string">all.</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">kube-state-metrics</span> <span class="string">is</span> <span class="string">experiencing</span> <span class="string">errors</span> <span class="string">in</span> <span class="string">watch</span> <span class="string">operations.</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      (sum(rate(kube_state_metrics_watch_total&#123;job=&quot;kube-state-metrics&quot;,result=&quot;error&quot;&#125;[5m]))</span></span><br><span class="line"><span class="string">        /</span></span><br><span class="line"><span class="string">      sum(rate(kube_state_metrics_watch_total&#123;job=&quot;kube-state-metrics&quot;&#125;[5m])))</span></span><br><span class="line"><span class="string">      &gt; 0.01</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">15m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">KubeStateMetricsShardingMismatch</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">kube-state-metrics</span> <span class="string">pods</span> <span class="string">are</span> <span class="string">running</span> <span class="string">with</span> <span class="string">different</span> <span class="string">--total-shards</span> <span class="string">configuration,</span> <span class="string">some</span> <span class="string">Kubernetes</span> <span class="string">objects</span> <span class="string">may</span> <span class="string">be</span> <span class="string">exposed</span> <span class="string">multiple</span> <span class="string">times</span> <span class="string">or</span> <span class="string">not</span> <span class="string">exposed</span> <span class="string">at</span> <span class="string">all.</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">kube-state-metrics</span> <span class="string">sharding</span> <span class="string">is</span> <span class="string">misconfigured.</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      stdvar (kube_state_metrics_total_shards&#123;job=&quot;kube-state-metrics&quot;&#125;) != 0</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">15m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">KubeStateMetricsShardsMissing</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">kube-state-metrics</span> <span class="string">shards</span> <span class="string">are</span> <span class="string">missing,</span> <span class="string">some</span> <span class="string">Kubernetes</span> <span class="string">objects</span> <span class="string">are</span> <span class="string">not</span> <span class="string">being</span> <span class="string">exposed.</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">kube-state-metrics</span> <span class="string">shards</span> <span class="string">are</span> <span class="string">missing.</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      2^max(kube_state_metrics_total_shards&#123;job=&quot;kube-state-metrics&quot;&#125;) - 1</span></span><br><span class="line"><span class="string">        -</span></span><br><span class="line"><span class="string">      sum( 2 ^ max by (shard_ordinal) (kube_state_metrics_shard_ordinal&#123;job=&quot;kube-state-metrics&quot;&#125;) )</span></span><br><span class="line"><span class="string">      != 0</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">15m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br></pre></td></tr></table></figure></div></div></article><div class="post__foot"><div class="like-author"><input type="checkbox" id="likeCode"><div class="author-face"><img height="100px" width="100px" id="front-face" alt="author face" src="/images/avatar.jpg"> <img height="100px" width="100px" id="back-face" alt="like code" src="/images/wechatpay.png"></div><div class="like-text">俾Mucy食[凍乾]~(￣▽￣)~*</div><label for="likeCode" class="like-btn"><svg viewBox="0 0 1024 1024" width="20px" style="margin-right:10px" height="20px"><path d="M466.88 908.96L113.824 563.296a270.08 270.08 0 0 1 0-387.392c108.8-106.56 284.896-106.56 393.696 0 1.504 1.472 2.976 2.944 4.448 4.48 1.472-1.536 2.944-3.008 4.448-4.48 108.8-106.56 284.896-106.56 393.696 0a269.952 269.952 0 0 1 34.016 347.072l-387.392 385.6a64 64 0 0 1-89.92 0.384z" p-id="13650" fill="#ee4242"/></svg> 心水</label></div><div class="post-nav"><a class="post-nav-item-left" href="/posts/15d5b004.html"><div class="text-align"><svg t="1670570876164" class="icon" viewBox="0 0 1024 1024" width="16" height="16"><path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/></svg> <span class="text-small">上一篇</span></div><div>後搖</div></a><div class="vhr"></div><a class="post-nav-item-right" href="/posts/4f9469f2.html"><div class="text-align"><span class="text-small">下一篇</span> <svg t="1670570876164" class="icon" viewBox="0 0 1024 1024" transform="scale(-1,-1)" width="16" height="16"><path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/></svg></div>伍佰老大</a></div><div class="related-post"><div class="related__head"><a href="/tags/K8S/" class="post-tag">#K8S</a><a href="/tags/%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/" class="post-tag">#监控告警</a></div><div class="realated__body"><div class="null"><div class="null-item"><div class="null-title"><a href="\posts\ef247c7f.html" title="K8S常用yaml汇总" rel="bookmark">K8S常用yaml汇总</a></div><div class="null-excerpt"><p></p><blockquote><p>  由于工作需要，K8S 总有服务是需要重复部署的，例如监控、日志等，每此都从网上整理很麻烦，而且往往有错误或者因 K8S 版本原因需要修改。虽然使用 helm 或者 operator 方式部署更为方便，但都是经过别人封装的东西，且万变不离 yaml。本文旨在记录一些常用的组件 yaml，做到开箱即用——至少在我本地直接 kubectl apply -f 就可以运行。诚然，有不规范或不严谨的地方在所难免，往各位海涵。</p></blockquote><p></p></div></div><div class="null-item"><div class="null-title"><a href="\posts\6c8009ea.html" title="手动搭建Train版OpenStack" rel="bookmark">手动搭建Train版OpenStack</a></div><div class="null-excerpt"><p></p><blockquote><p>  学习搭建 <code>OpenStack</code></p></blockquote><p></p></div></div><div class="null-item"><div class="null-title"><a href="\posts\6348717a.html" title="Commands" rel="bookmark">Commands</a></div><div class="null-excerpt"><p></p><blockquote><p>  总结一些常用命令</p></blockquote><p></p></div></div></div></div></div></div></div><div class="foot"><div class="foot-inner"><div class="foot__head"><div class="foot-line"><div class="matts">用</div><div class="matts">捨</div><div class="matts">由</div><div class="matts">時</div></div><div class="foot-line"><div class="matts">行</div><div class="matts">藏</div><div class="matts">在</div><div class="matts">我</div></div></div><div class="foot__body"><div class="foot-item"><div class="foot-item__head">账号</div><div class="foot-item__body"><div class="text"><img alt="link" height="20px" width="20px" src="/images/icon/icon-github.svg"> <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/limerencist">github</a></div></div></div><div class="foot-item"><div class="foot-item__head">联系</div><div class="foot-item__body"><div class="text"><img alt="link" height="20px" width="20px" src="/images/icon/icon-email.svg"> <a class="foot-link" href="mailto:limerencist@gmail.com">limerencist@gmail.com</a></div></div></div></div><div class="copyright"><a href="https://limerencist.github.io">失落之地</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp; <svg width="20" height="20" viewBox="0 0 725 725"><path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z"/><path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z"/><path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z"/></svg> <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动</div></div></div></body></html>