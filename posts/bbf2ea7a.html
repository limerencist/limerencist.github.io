<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf8"><meta name="viewport" content="initial-scale=1,width=device-width"><title>Jenkins流水线脚本 | 失落之地</title><meta name="description" content=""><meta name="keywords" content=""><link rel="apple-touch-icon" sizes="180x180" href="/images/rock-gesture.svg"><link rel="icon" type="image/png" sizes="32x32" href="/images/rock-gesture.svg"><link rel="icon" type="image/png" sizes="16x16" href="/images/rock-gesture.svg"><link rel="mask-icon" href="/images/rock-gesture.svg" color=""><style>@font-face{font-family:STXingkai;src:url(/font/regular.ttf);font-weight:regular}</style><link rel="stylesheet" type="text/css" href="/css/layout.css"><link rel="stylesheet" type="text/css" href="/css/post.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="head"><div class="nav"><a href="/" class="nav-logo"><img alt="logo" height="60px" width="60px" src="/images/rock-gesture.svg"> </a><input id="navBtn" type="checkbox"><div class="nav-menu"><a class="nav-menu-item" href="/devops">運維</a> <a class="nav-menu-item" href="/playlist">歌單</a> <a class="nav-menu-item" href="/cv/">简历</a></div><label class="nav-btn" for="navBtn"></label></div></div><div class="body"><article class="post-content"><div class="post-inner--toc"><div class="post-content__head"><div class="post-title">Jenkins流水线脚本</div><div class="post-info"><a href="/tags/CI-CD/" class="post-tag">#CI/CD</a><a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/" class="post-tag">#自动化</a> <span class="post-date">2023-06-05</span></div></div><aside class="toc-outer"><div class="toc-title">目录</div><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80%E6%9E%84%E5%BB%BAjava%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="post-toc-text">案例一：构建java后端项目</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%80%BB%E7%BB%93%E8%AF%B4%E6%98%8E"><span class="post-toc-text">总结说明</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C%E6%9E%84%E5%BB%BAnode%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="post-toc-text">案例二：构建node前端项目</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%80%BB%E7%BB%93%E8%AF%B4%E6%98%8E-2"><span class="post-toc-text">总结说明</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%89%E6%9E%84%E5%BB%BAgolang%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="post-toc-text">案例三：构建golang后端项目</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%80%BB%E7%BB%93%E8%AF%B4%E6%98%8E-3"><span class="post-toc-text">总结说明</span></a></li></ol></li></ol><a href="#" class="toc-top">回到顶部</a></aside><div class="post-content__body"><div class="post-gallery"></div><blockquote><p>  作为一名合格的运维工程师，使用自动化工具来实现应用的 <code>CI/CD</code> 必不可少。在实际工作中，一般使用 <code>Jenkins</code> 并撰写相应的 <code>pipeline</code> 来完成此类工作。针对不同的情况，流水线的组合也不尽相同，例如前后端编译方式不一样、一个 <code>git</code> 地址里实际包含多个项目等等。对此，我主要总结成几个案例以供分析（流水线中一些 <code>git</code> 项目地址和账户凭据以 xxxxx 代替）。</p></blockquote><h1 id="案例一构建java后端项目"><a class="markdownIt-Anchor" href="#案例一构建java后端项目"></a> 案例一：构建java后端项目</h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">	agent any </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一些常用选项</span></span><br><span class="line">    options &#123;</span><br><span class="line">      <span class="comment">// 构建过程显示时间戳</span></span><br><span class="line">      timestamps()</span><br><span class="line">      <span class="comment">// 构建事件保留策略</span></span><br><span class="line">      buildDiscarder logRotator(</span><br><span class="line">        <span class="symbol">artifactDaysToKeepStr:</span> <span class="string">&#x27;30&#x27;</span>, </span><br><span class="line">        <span class="symbol">artifactNumToKeepStr:</span> <span class="string">&#x27;5&#x27;</span>, </span><br><span class="line">        <span class="symbol">daysToKeepStr:</span> <span class="string">&#x27;3&#x27;</span>, </span><br><span class="line">        <span class="symbol">numToKeepStr:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line">      )</span><br><span class="line">  	&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 声明一些变量，这样针对其他类似项目修改变量即可</span></span><br><span class="line">    environment &#123;</span><br><span class="line">        <span class="comment">// git相关，拉取项目代码的凭据需要提前配置</span></span><br><span class="line">        GIT_BRANCH = <span class="string">&#x27;master&#x27;</span></span><br><span class="line">        GIT_CR_ID = <span class="string">&#x27;xxxxxxx&#x27;</span>  </span><br><span class="line">        GIT_URL = <span class="string">&#x27;http://xxx.git&#x27;</span></span><br><span class="line">        <span class="comment">// 项目名称，不一定和git中一致，主要是为了区分</span></span><br><span class="line">        APP_NAME = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">        APP_SPACE = <span class="string">&#x27;/opt&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;初始化工作目录&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo <span class="string">&quot;STEP1: 初始化工作目录&quot;</span></span><br><span class="line">                deleteDir()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;拉取项目代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo <span class="string">&quot;STEP2: 拉取项目代码&quot;</span></span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&quot;$&#123;GIT_BRANCH&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;$&#123;GIT_CR_ID&#125;&quot;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;GIT_URL&#125;&quot;</span>   </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        stage(<span class="string">&#x27;项目编译&#x27;</span>) &#123;</span><br><span class="line">                echo <span class="string">&quot;STEP3: 项目编译&quot;</span></span><br><span class="line">                sh <span class="string">&#x27;mvn -U -am clean package -Dmaven.test.skip=true -DskipTests=true&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        stage(<span class="string">&#x27;准备项目包&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo <span class="string">&quot;STEP4: 准备项目包&quot;</span></span><br><span class="line">                <span class="comment">// 获取maven编译出来的war包并放到指定目录（主要是因为本人强迫症，不喜欢一个目录里有不必要的东西）</span></span><br><span class="line">                sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                    VERFILE=$(ls $&#123;WORKSPACE&#125;/target -A | grep war | grep -v original)</span></span><br><span class="line"><span class="string">                    if [ ! -d $&#123;APP_SPACE&#125;/$&#123;GIT_BRANCH&#125; ]; then mkdir -p $&#123;APP_SPACE&#125;/$&#123;GIT_BRANCH&#125; ; fi</span></span><br><span class="line"><span class="string">                    cp $&#123;WORKSPACE&#125;/target/$&#123;VERFILE&#125; $&#123;APP_SPACE&#125;/$&#123;GIT_BRANCH&#125;/$&#123;APP_NAME&#125;.war</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        stage(<span class="string">&#x27;生成镜像&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo <span class="string">&quot;STEP5: 生成镜像&quot;</span></span><br><span class="line">                sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                    cd $&#123;APP_SPACE&#125;/$&#123;GIT_BRANCH&#125;</span></span><br><span class="line"><span class="string">                    IMGAETAG=hub.xxxx.cn/$&#123;APP_NAME&#125;:$&#123;BUILD_NUMBER&#125;</span></span><br><span class="line"><span class="string">                    docker build -t $&#123;IMGAETAG&#125; -f $&#123;APP_NAME&#125;_dockerfile .</span></span><br><span class="line"><span class="string">                    cat /root/hubyozocloud | docker login -u xxx hub.xxxx.cn --password-stdin</span></span><br><span class="line"><span class="string">                    docker push $&#123;IMGAETAG&#125;</span></span><br><span class="line"><span class="string">                    docker rmi $&#123;IMGAETAG&#125;</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置钉钉通知</span></span><br><span class="line">    post&#123;</span><br><span class="line">        always&#123;</span><br><span class="line">            wrap([<span class="attr">$class:</span> <span class="string">&#x27;BuildUser&#x27;</span>]) &#123;</span><br><span class="line">                buildDescription <span class="string">&quot;Build Person: $&#123;BUILD_USER&#125;\nBuild Task: $&#123;JOB_NAME&#125;&quot;</span></span><br><span class="line">            &#125;            </span><br><span class="line">        &#125;</span><br><span class="line">        success&#123;</span><br><span class="line">            dingtalk (</span><br><span class="line">                <span class="comment">// 机器人ID</span></span><br><span class="line">                <span class="symbol">robot:</span> <span class="string">&#x27;xxxxxxxxxxxxxxx&#x27;</span>,</span><br><span class="line">                <span class="symbol">type:</span> <span class="string">&#x27;LINK&#x27;</span>,</span><br><span class="line">                <span class="comment">// 如果不@所有人的话，配置指定@的人</span></span><br><span class="line">                <span class="symbol">at:</span> [<span class="string">&#x27;xxxxxxxxxx&#x27;</span>],</span><br><span class="line">                <span class="symbol">atAll:</span> <span class="literal">false</span>,</span><br><span class="line">                <span class="symbol">title:</span> <span class="string">&#x27;Test&#x27;</span>,</span><br><span class="line">                <span class="symbol">text:</span> [<span class="string">&#x27;构建成功！&#x27;</span>],</span><br><span class="line">                <span class="comment">// 可以配置Jenkins地址</span></span><br><span class="line">                <span class="symbol">messageUrl:</span> <span class="string">&#x27;xxxxxxxx&#x27;</span>,</span><br><span class="line">                <span class="symbol">picUrl:</span> <span class="string">&#x27;https://img2.baidu.com/it/u=1641501037,1168798543&amp;fm=15&amp;fmt=auto&amp;gp=0.jpg&#x27;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        failure&#123;</span><br><span class="line">            dingtalk (</span><br><span class="line">                <span class="comment">// 机器人ID</span></span><br><span class="line">                <span class="symbol">robot:</span> <span class="string">&#x27;xxxxxxxxxxxxxxx&#x27;</span>,</span><br><span class="line">                <span class="symbol">type:</span> <span class="string">&#x27;LINK&#x27;</span>,</span><br><span class="line">                <span class="comment">// 如果不@所有人的话，配置指定@的人</span></span><br><span class="line">                <span class="symbol">at:</span> [<span class="string">&#x27;xxxxxxxxxx&#x27;</span>],</span><br><span class="line">                <span class="symbol">atAll:</span> <span class="literal">false</span>,</span><br><span class="line">                <span class="symbol">title:</span> <span class="string">&#x27;Test&#x27;</span>,</span><br><span class="line">                <span class="symbol">text:</span> [<span class="string">&#x27;构建失败！&#x27;</span>],</span><br><span class="line">                <span class="comment">// 可以配置Jenkins地址</span></span><br><span class="line">                <span class="symbol">messageUrl:</span> <span class="string">&#x27;xxxxxxxx&#x27;</span>,</span><br><span class="line">                <span class="symbol">picUrl:</span> <span class="string">&#x27;https://img2.baidu.com/it/u=1641501037,1168798543&amp;fm=15&amp;fmt=auto&amp;gp=0.jpg&#x27;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结说明"><a class="markdownIt-Anchor" href="#总结说明"></a> 总结说明</h2><blockquote><p>这是本人刚接触 <code>jenkins</code> 时候撰写的 <code>pipeline</code> (一些配置项可以看注释)，主要是根据前人留下来的模版，尝试添加 <code>docker build</code>（实际写得很粗糙），并且把可以在界面上配置的一些选项和钉钉通知也转换在脚本里（这样就完全可以不依赖界面配置，但实际也没有必要，纯粹是早期为了学习）</p></blockquote><h1 id="案例二构建node前端项目"><a class="markdownIt-Anchor" href="#案例二构建node前端项目"></a> 案例二：构建node前端项目</h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    <span class="comment">// 指定jenkins从节点</span></span><br><span class="line">    agent &#123;</span><br><span class="line">        label <span class="string">&#x27;agent slave1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 还是习惯声明一些常用并可以修改的变量</span></span><br><span class="line">    environment &#123;</span><br><span class="line">        <span class="comment">// git相关</span></span><br><span class="line">        GIT_URL = <span class="string">&#x27;xxxxxxx&#x27;</span></span><br><span class="line">        GIT_CR_ID = <span class="string">&#x27;xxxxx&#x27;</span></span><br><span class="line">        GIT_BRANCH_TAG = <span class="string">&#x27;develop&#x27;</span></span><br><span class="line">        <span class="comment">// 服务相关</span></span><br><span class="line">        APP_NAME = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">        APP_ALL=<span class="string">&quot;a,b,c,d&quot;</span></span><br><span class="line">        <span class="comment">// 镜像相关</span></span><br><span class="line">        HUB_URL = <span class="string">&#x27;xxxxxx&#x27;</span></span><br><span class="line">        PROJECT_NAME = <span class="string">&#x27;project&#x27;</span></span><br><span class="line">        ARCH = <span class="string">&#x27;x86_64&#x27;</span></span><br><span class="line">        ENV = <span class="string">&#x27;uat&#x27;</span></span><br><span class="line">        <span class="comment">// 部署/更新相关</span></span><br><span class="line">        HOST = <span class="string">&#x27;192.168.20.10&#x27;</span></span><br><span class="line">        BASE_PATH = <span class="string">&#x27;/opt&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;ClearDir&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                deleteDir()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;Get Code&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    sh <span class="string">&#x27;rm -rf build-tmp&#x27;</span></span><br><span class="line">                    <span class="comment">// 涉及到不同git项目，写了个循环</span></span><br><span class="line">                    <span class="keyword">for</span> ( app_name <span class="keyword">in</span> APP_ALL.tokenize(<span class="string">&quot;,&quot;</span>) )&#123;</span><br><span class="line">                        checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>, </span><br><span class="line">                            <span class="symbol">branches:</span> [[<span class="attr">name:</span> <span class="string">&quot;$&#123;GIT_BRANCH_TAG&#125;&quot;</span>]], </span><br><span class="line">                            <span class="symbol">doGenerateSubmoduleConfigurations:</span> <span class="literal">false</span>, </span><br><span class="line">                            <span class="symbol">extensions:</span> [[<span class="attr">$class:</span> <span class="string">&#x27;RelativeTargetDirectory&#x27;</span>,<span class="attr">relativeTargetDir:</span> <span class="string">&quot;$&#123;app_name&#125;&quot;</span>]], </span><br><span class="line">                            <span class="symbol">submoduleCfg:</span> [], </span><br><span class="line">                            <span class="symbol">userRemoteConfigs:</span> [[<span class="attr">credentialsId:</span> GIT_CR_ID, <span class="attr">url:</span> GIT_URL+ <span class="string">&quot;$&#123;app_name&#125;&quot;</span> +<span class="string">&#x27;.git&#x27;</span>]]</span><br><span class="line">                        ])</span><br><span class="line">                    &#125;    </span><br><span class="line">                &#125;       </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;Compile&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    sh <span class="string">&#x27;mkdir build-tmp&#x27;</span></span><br><span class="line">                    <span class="comment">// 同理循环，编译多个前端项目包</span></span><br><span class="line">                    <span class="keyword">for</span> ( app_name <span class="keyword">in</span> APP_ALL.tokenize(<span class="string">&quot;,&quot;</span>) )&#123;</span><br><span class="line">                        dir( <span class="string">&quot;$&#123;WORKSPACE&#125;/&quot;</span> + app_name )&#123;</span><br><span class="line">                            <span class="comment">// 使用docker编译前端项目</span></span><br><span class="line">                            docker.image(<span class="string">&#x27;node:16.17.0-alpine3.16&#x27;</span>).inside(<span class="string">&#x27;-v /etc/hosts:/etc/hosts -v /home/build/.yarnrc:/.yarnrc -v /home/build/.docmiddle_npmrc:/.npmrc -v /home/build/.docmiddle_yarn:/.cache/yarn  --network host&#x27;</span>) &#123;</span><br><span class="line">                                sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                                  npm config set registry https://registry.npmmirror.com/</span></span><br><span class="line"><span class="string">                                  yarn config set registry https://registry.npmmirror.com/</span></span><br><span class="line"><span class="string">                                  yarn install</span></span><br><span class="line"><span class="string">                                  yarn build</span></span><br><span class="line"><span class="string">                                &#x27;&#x27;&#x27;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 生成项目包</span></span><br><span class="line">                            sh <span class="string">&#x27;cp -ar dist &#x27;</span>+ app_name</span><br><span class="line">                            sh <span class="string">&#x27;tar zcpf &#x27;</span> + app_name + <span class="string">&#x27;.tar.gz &#x27;</span>+ app_name +<span class="string">&#x27;/&#x27;</span></span><br><span class="line">                            sh <span class="string">&#x27;mv &#x27;</span>+ app_name + <span class="string">&#x27;.tar.gz ../build-tmp/&#x27;</span></span><br><span class="line">                        &#125;                   </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">// 将多个静态资源包构建一个前端镜像</span></span><br><span class="line">                script &#123;</span><br><span class="line">                    dir( <span class="string">&quot;$&#123;WORKSPACE&#125;/build-tmp&quot;</span>)&#123;</span><br><span class="line">                        docker.withRegistry(<span class="string">&quot;https://$&#123;HUB_URL&#125;&quot;</span>, <span class="string">&#x27;7cd81781-9c42-479c-9ed2-4e26d272520c&#x27;</span>) &#123;</span><br><span class="line">                            <span class="keyword">def</span> customImage=docker.build(<span class="string">&quot;$&#123;HUB_URL&#125;/$&#123;PROJECT_NAME&#125;/$&#123;ARCH&#125;/$&#123;ENV&#125;/$&#123;APP_NAME&#125;:$&#123;GIT_BRANCH_TAG&#125;&quot;</span>)</span><br><span class="line">                            customImage.push()</span><br><span class="line">                        &#125;</span><br><span class="line">                        sh <span class="string">&#x27;docker rmi $&#123;HUB_URL&#125;/$&#123;PROJECT_NAME&#125;/$&#123;ARCH&#125;/$&#123;ENV&#125;/$&#123;APP_NAME&#125;:$&#123;GIT_BRANCH_TAG&#125;&#x27;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;Update&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">// 撰写playbook并使用ansible插件更新项目</span></span><br><span class="line">                script &#123;</span><br><span class="line">                    app_image = <span class="string">&#x27;$&#123;HUB_URL&#125;/$&#123;PROJECT_NAME&#125;/$&#123;ARCH&#125;/$&#123;ENV&#125;/$&#123;APP_NAME&#125;:$&#123;GIT_BRANCH_TAG&#125;&#x27;</span></span><br><span class="line">                    Map&lt;String,String&gt; extra_vars = [ <span class="string">&#x27;host&#x27;</span>: <span class="string">&#x27;$&#123;HOST&#125;&#x27;</span>, <span class="string">&#x27;app_name&#x27;</span>: <span class="string">&#x27;$&#123;APP_NAME&#125;&#x27;</span>, <span class="string">&#x27;app_image&#x27;</span>: app_image, <span class="string">&#x27;base_path&#x27;</span>: <span class="string">&#x27;$&#123;BASE_PATH&#125;&#x27;</span> ]</span><br><span class="line">                    ansiblePlaybook(</span><br><span class="line">                        <span class="symbol">playbook:</span> <span class="string">&#x27;/etc/ansible/scripts/docker_image.yml&#x27;</span>, </span><br><span class="line">                        <span class="symbol">inventory:</span> <span class="string">&#x27;/etc/ansible/hosts&#x27;</span>, </span><br><span class="line">                        <span class="symbol">extraVars:</span> extra_vars</span><br><span class="line">                    )</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结说明-2"><a class="markdownIt-Anchor" href="#总结说明-2"></a> 总结说明</h2><blockquote><p>这个前端项目的镜像由4个静态资源组成，分别在4个 <code>git</code> 地址上 ，在拉取代码阶段用循环拼接不同的项目地址分别拉取；</p><p>编译阶段为了避免在 <code>jenkins</code> 本地安装及配置 <code>nodejs</code> , 使用对应镜像在容器中编译成静态资源，并且映射相关依赖目录，加快下载依赖的速度，最后打包并压缩成 <code>gz</code> 包；</p><p>构建镜像时候使用 <code>docker</code> 插件，使用 withRegistry 方法 <code>build</code> 并 <code>push</code> ；未防止机器上镜像过多，在 <code>push</code> 之后进行删除（纯粹也是学习，和直接使用 <code>docker build</code> 或者 <code>docker push</code> 的命令 一样）；</p><p>更新阶段学习使用 <code>ansible</code> 插件，提前写了对应的playbook，当时服务是用 <code>docker-compose</code> 编排的，更新服务只要更新镜像即可，就写了个 py脚本替换 yml 里的 image 字段，再重启服务</p></blockquote><h1 id="案例三构建golang后端项目"><a class="markdownIt-Anchor" href="#案例三构建golang后端项目"></a> 案例三：构建golang后端项目</h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">timestamps &#123;</span><br><span class="line">  podTemplate(</span><br><span class="line">    <span class="symbol">containers:</span> [</span><br><span class="line">      containerTemplate(<span class="attr">name:</span> <span class="string">&#x27;sonar&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;sonar:v4.8.0&#x27;</span>, <span class="attr">command:</span> <span class="string">&#x27;sleep&#x27;</span>, <span class="attr">args:</span> <span class="string">&#x27;99d&#x27;</span>),</span><br><span class="line">      containerTemplate(<span class="attr">name:</span> <span class="string">&#x27;golang&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;golang:1.20&#x27;</span>, <span class="attr">command:</span> <span class="string">&#x27;sleep&#x27;</span>, <span class="attr">args:</span> <span class="string">&#x27;99d&#x27;</span>),</span><br><span class="line">      containerTemplate(<span class="attr">name:</span> <span class="string">&#x27;kubectl&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;kubectl:v1&#x27;</span>, <span class="attr">command:</span> <span class="string">&#x27;sleep&#x27;</span>, <span class="attr">args:</span> <span class="string">&#x27;99d&#x27;</span>)</span><br><span class="line">    ],</span><br><span class="line">    <span class="symbol">volumes:</span> [</span><br><span class="line">      hostPathVolume(<span class="attr">hostPath:</span> <span class="string">&#x27;/etc/docker&#x27;</span>, <span class="attr">mountPath:</span> <span class="string">&#x27;/etc/docker&#x27;</span>),</span><br><span class="line">      hostPathVolume(<span class="attr">hostPath:</span> <span class="string">&#x27;/usr/bin/docker&#x27;</span>, <span class="attr">mountPath:</span> <span class="string">&#x27;/usr/bin/docker&#x27;</span>),</span><br><span class="line">      hostPathVolume(<span class="attr">hostPath:</span> <span class="string">&#x27;/etc/resolv.conf&#x27;</span>, <span class="attr">mountPath:</span> <span class="string">&#x27;/etc/resolv.conf&#x27;</span>),</span><br><span class="line">      hostPathVolume(<span class="attr">hostPath:</span> <span class="string">&#x27;/var/run/docker.sock&#x27;</span>, <span class="attr">mountPath:</span> <span class="string">&#x27;/var/run/docker.sock&#x27;</span>)</span><br><span class="line">    ],</span><br><span class="line">    <span class="symbol">envVars:</span> [</span><br><span class="line">      envVar(<span class="attr">key:</span> <span class="string">&#x27;GOPROXY&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;https://goproxy.cn,direct&#x27;</span>),</span><br><span class="line">      envVar(<span class="attr">key:</span> <span class="string">&#x27;GONOPROXY&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;xxxxxx&#x27;</span>),</span><br><span class="line">      envVar(<span class="attr">key:</span> <span class="string">&#x27;GONOSUMDB&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;xxxxxx&#x27;</span>),</span><br><span class="line">      envVar(<span class="attr">key:</span> <span class="string">&#x27;GOPRIVATE&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;xxxxxx&#x27;</span>),</span><br><span class="line">      envVar(<span class="attr">key:</span> <span class="string">&#x27;GOINSECURE&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;xxxxxx&#x27;</span>),</span><br><span class="line">    ]</span><br><span class="line">  )&#123;</span><br><span class="line">    node(POD_LABEL) &#123;</span><br><span class="line">      <span class="comment">// 祖传的一些变量</span></span><br><span class="line">      git_cr_id=<span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line">      git_url=<span class="string">&#x27;xxxxx&#x27;</span></span><br><span class="line">      harbor_url = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line">      project = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">      arch = <span class="string">&#x27;x86_64&#x27;</span></span><br><span class="line">      apps = <span class="string">&#x27;xxxxxx&#x27;</span></span><br><span class="line">        </span><br><span class="line">      stage(<span class="string">&#x27;Git&#x27;</span>) &#123;</span><br><span class="line">        checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>, </span><br><span class="line">            <span class="symbol">branches:</span> [[<span class="attr">name:</span> <span class="string">&quot;$&#123;target&#125;&quot;</span>]], </span><br><span class="line">            <span class="symbol">extensions:</span> [[<span class="attr">$class:</span> <span class="string">&#x27;CloneOption&#x27;</span>,<span class="attr">shallow:</span> <span class="literal">true</span>,<span class="attr">depth:</span> <span class="number">1</span>,<span class="attr">timeout:</span> <span class="number">30</span>]], </span><br><span class="line">            <span class="symbol">userRemoteConfigs:</span> [[<span class="attr">credentialsId:</span> git_cr_id, <span class="attr">url:</span> git_url]]</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        image_tag=sh(<span class="attr">returnStdout:</span> <span class="literal">true</span>, <span class="attr">script:</span> <span class="string">&#x27;git rev-parse --short HEAD&#x27;</span>).trim()</span><br><span class="line"></span><br><span class="line">        container(<span class="string">&#x27;sonar&#x27;</span>)&#123;</span><br><span class="line">          stage(<span class="string">&#x27;Sonar&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> ( app <span class="keyword">in</span> apps.tokenize(<span class="string">&quot;,&quot;</span>) )&#123;</span><br><span class="line">              dir(<span class="string">&quot;/home/jenkins/agent/workspace/$&#123;JOB_NAME&#125;/app/&quot;</span>+app)&#123;</span><br><span class="line">                withSonarQubeEnv(<span class="string">&#x27;sonarqubeserver&#x27;</span>) &#123;</span><br><span class="line">                  withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&#x27;sonar-scan&#x27;</span>, <span class="attr">passwordVariable:</span> <span class="string">&#x27;snoarPSW&#x27;</span>, <span class="attr">usernameVariable:</span> <span class="string">&#x27;snoarUSR&#x27;</span>)]) &#123;</span><br><span class="line">                    sh <span class="string">&quot;sonar-scanner -Dsonar.projectKey=$&#123;app&#125; -Dsonar.projectName=$&#123;app&#125;  -Dsonar.login=$snoarUSR -Dsonar.password=$snoarPSW&quot;</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        container(<span class="string">&#x27;golang&#x27;</span>) &#123;</span><br><span class="line">          stage(<span class="string">&#x27;Make&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> ( app <span class="keyword">in</span> apps.tokenize(<span class="string">&quot;,&quot;</span>) )&#123;</span><br><span class="line">              dir(<span class="string">&quot;/home/jenkins/agent/workspace/$&#123;JOB_NAME&#125;/app/$&#123;app&#125;&quot;</span>)&#123;</span><br><span class="line">                sh <span class="string">&#x27;git config --global user.name &quot;xxxxxx&quot;&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;git config --global user.email &quot;xxxxxx&quot;&#x27;</span></span><br><span class="line">                sh <span class="string">&quot;git config --global --add safe.directory /home/jenkins/agent/workspace/$&#123;JOB_NAME&#125;&quot;</span></span><br><span class="line">                sh <span class="string">&#x27;git config --global url.&quot;git@xxxxxx:&quot;.insteadof &quot;http://xxxxxx/&quot;&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;make linux-build&#x27;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          stage(<span class="string">&#x27;Image&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> ( app <span class="keyword">in</span> apps.tokenize(<span class="string">&quot;,&quot;</span>) )&#123;</span><br><span class="line">              dir(<span class="string">&quot;/home/jenkins/agent/workspace/$&#123;JOB_NAME&#125;/app/$&#123;app&#125;&quot;</span>)&#123;</span><br><span class="line">                image = <span class="string">&quot;$&#123;harbor_url&#125;/$&#123;project&#125;/$&#123;arch&#125;/$&#123;app&#125;:$&#123;image_tag&#125;&quot;</span></span><br><span class="line">                build_image(image)</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        container(<span class="string">&#x27;kubectl&#x27;</span>) &#123;</span><br><span class="line">          stage(<span class="string">&#x27;Deploy&#x27;</span>)&#123;</span><br><span class="line">            sh <span class="string">&quot;mkdir -p ~/.kube&quot;</span></span><br><span class="line">              </span><br><span class="line">            <span class="keyword">if</span> (target == <span class="string">&#x27;rc&#x27;</span>) &#123;</span><br><span class="line">              withCredentials([string(<span class="attr">credentialsId:</span> <span class="string">&#x27;k8s-uat-admin&#x27;</span>, <span class="attr">variable:</span> <span class="string">&#x27;K8S_UAT_CONF&#x27;</span>)]) &#123;</span><br><span class="line">                sh <span class="string">&#x27;echo $K8S_UAT_CONF | base64 -d &gt; ~/.kube/config&#x27;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              withCredentials([string(<span class="attr">credentialsId:</span> <span class="string">&#x27;k8s-dev-admin&#x27;</span>, <span class="attr">variable:</span> <span class="string">&#x27;K8S_DEV_CONF&#x27;</span>)]) &#123;</span><br><span class="line">                sh <span class="string">&#x27;echo $K8S_DEV_CONF | base64 -d &gt; ~/.kube/config&#x27;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> ( app <span class="keyword">in</span> apps.tokenize(<span class="string">&quot;,&quot;</span>) )&#123;</span><br><span class="line">              dir(<span class="string">&quot;/home/jenkins/agent/workspace/$&#123;JOB_NAME&#125;/app/$&#123;app&#125;&quot;</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (target ==<span class="string">&#x27;develop&#x27;</span> || target ==<span class="string">&#x27;rc&#x27;</span>)&#123;</span><br><span class="line">                  sh <span class="string">&quot;helm upgrade -i -n tecoai --set image.tag=$&#123;image_tag&#125; --set labels.branch=$&#123;target&#125; $&#123;app&#125; ./helm/&quot;</span></span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                  sh <span class="string">&quot;sed -i &#x27;s/$&#123;app&#125;/$&#123;app&#125;-$&#123;target&#125;/g&#x27; helm/Chart.yaml&quot;</span></span><br><span class="line">                  sh <span class="string">&quot;helm upgrade -i -n tecoai --set image.tag=$&#123;image_tag&#125; --set labels.branch=$&#123;target&#125; --set app=$&#123;app&#125;-$&#123;target&#125; $&#123;app&#125;-$&#123;target&#125; ./helm/&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> build_image(String image)&#123;</span><br><span class="line">    docker.withRegistry(<span class="string">&quot;https://$&#123;harbor_url&#125;&quot;</span>, <span class="string">&#x27;harbor&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">def</span> customImage=docker.build(<span class="string">&quot;$&#123;image&#125;&quot;</span>)</span><br><span class="line">        customImage.push()</span><br><span class="line">    &#125;</span><br><span class="line">    sh <span class="string">&quot;docker rmi $&#123;image&#125;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结说明-3"><a class="markdownIt-Anchor" href="#总结说明-3"></a> 总结说明</h2><blockquote><p>这个是最近比较折腾的一个流水线，说下总体的思路：</p><p>使用 <code>Jenkins</code> 的 <code>Kubernetes</code> 插件，在已有的 <code>K8S</code> 集群中添加一个云节点（需要提前在 <code>Jenkins</code> 里配置的，具体可以看插件的说明）；</p><p>这个云节点会和 <code>podTemplate</code> 里写的多个容器组成一个 pod 运行 （podTemplate里的语法也可以使用最直接的yaml），例如此处创建了3个 <code>container</code>；</p><p>代码拉取： 使用 <code>checkout</code> 来实现浅拷贝，加快拉取速度，以 <code>commit id</code> 作为之后镜像的 <code>tag</code></p><p>代码扫描：使用 <code>pod</code> 中的 <code>sonar</code> 容器（sonor镜像需要提前准备）完成扫描；</p><p>代码编译：使用 <code>pod</code> 中的 <code>golang</code> 容器，利用研发在项目中撰写的 <code>Makefile</code> ，执行 <code>make linux-build</code> 生成可执行文件（因为 <code>go build</code> 中依赖其他项目中的公共库，所以这里加了一些其他的 <code>git config</code>，在 <code>podTemplate</code> 的 <code>envVars</code> 中也添加了一些编译需要的环境变量 ）; 这个 <code>golang</code> 容器的镜像为了能够免密拉取公共库的包，配置了 <code>git</code> 中 <code>ssh</code> 的秘钥；</p><p>构建镜像：这个和之前一样，使用 <code>Jenkins</code> 的 <code>docker</code> 插件完成，稍微不同的就是单独封装成了一个方法，需要时候直接调用；为了避免 <code>docker build</code> 时上下文过大，添加 <code>.dockerignore</code> 文件；另外，这一步使用 <code>pod</code> 中的 <code>golang</code> 容器，在 <code>podTemplate</code> 的 <code>volumes</code> 中也添加 hostpath 实现 <code>docker in docker</code> ；</p><p>更新服务：使用 <code>pod</code>中的 <code>kubectl</code> 容器，根据不同分支选择对应 K8S 集群环境（不同的 <code>kubeconfig</code> 需要提前在 <code>Jenkins</code> 里配置），使用helm部署或者更新应用。</p><p>之前的流水线都是声明式的，通过 <code>script</code> 来写一些脚本，这次干脆直接使用脚本式；在这个项目中实际包含了两个应用，也用到了循环分别进到不同的目录构建和部署（需要和研发沟通）；除此之外，之前都是明确分支或者标签的，所以在一开始写了个 <code>GIT_BRANCH</code> 或者 <code>GIT_BRANCH_TAG</code> 的变量，而在这个流水线里拉取的分支变量是 <code>target</code> ，考虑到和触发器有关就在 Jenkins 的页面上配置了：这里的逻辑是 <code>rc</code> 分支部署到测试环境供测试人员测试，<code>develop</code> 分支部署到开发环境供开发人员自测，而 <code>develop</code> 是可能有多个研发完成不同特性分支 <code>merge</code> 上去的，这个单独的特性分支 <code>push</code> 之后，也会通过 <code>helm</code> 部署一个特性的 <code>release</code> 应用以供研发自测特性功能。</p></blockquote><p><em><strong>还需说明的一点是，个人认为流水线一般只负责到更新就完成了，至于更新是否成功或者如果失败是否需要回滚，可能需要研发排查代码或者运维排查配置其他问题，没有必要包含在流水线内。</strong></em></p><hr><p>  可以看到本人在不同阶段的流水线中用了很多插件，实际上对于 <code>DevOps</code> 工具而言，应该尽可能只使用它最核心的功能。插件是有学习成本的，增加了阅读和编写难度的同时，也可能导致其他问题：比如最后一个案例中所有编译和构建都在 pod 中，虽然提高了隔离性，但不管是前端还是后端的依赖都需要重新拉取，影响了构建速度，如果再使用 <code>hostpath</code> 挂载目录，就需要考虑固定某一节点，这样反而复杂了。<br>  业务繁多，任何流水线都有优化的空间。说句有用的废话，适合自己的才是最好的。</p></div></div></article><div class="post__foot"><div class="like-author"><input type="checkbox" id="likeCode"><div class="author-face"><img height="100px" width="100px" id="front-face" alt="author face" src="/images/avatar.jpg"> <img height="100px" width="100px" id="back-face" alt="like code" src="/images/wechatpay.png"></div><div class="like-text">俾Mucy食[凍乾]~(￣▽￣)~*</div><label for="likeCode" class="like-btn"><svg viewBox="0 0 1024 1024" width="20px" style="margin-right:10px" height="20px"><path d="M466.88 908.96L113.824 563.296a270.08 270.08 0 0 1 0-387.392c108.8-106.56 284.896-106.56 393.696 0 1.504 1.472 2.976 2.944 4.448 4.48 1.472-1.536 2.944-3.008 4.448-4.48 108.8-106.56 284.896-106.56 393.696 0a269.952 269.952 0 0 1 34.016 347.072l-387.392 385.6a64 64 0 0 1-89.92 0.384z" p-id="13650" fill="#ee4242"/></svg> 心水</label></div><div class="post-nav"><a class="post-nav-item-left" href="/posts/bcaebdb7.html"><div class="text-align"><svg t="1670570876164" class="icon" viewBox="0 0 1024 1024" width="16" height="16"><path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/></svg> <span class="text-small">上一篇</span></div><div>K8S使用Multus-cni实现pod第二网络</div></a><div class="vhr"></div><a class="post-nav-item-right" href="/posts/15d5b004.html"><div class="text-align"><span class="text-small">下一篇</span> <svg t="1670570876164" class="icon" viewBox="0 0 1024 1024" transform="scale(-1,-1)" width="16" height="16"><path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/></svg></div>後搖</a></div><div class="related-post"><div class="related__head"><a href="/tags/CI-CD/" class="post-tag">#CI/CD</a><a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/" class="post-tag">#自动化</a></div><div class="realated__body"><div class="null"><div class="null-item"><div class="null-title"><a href="\posts\6c8009ea.html" title="手动搭建Train版OpenStack" rel="bookmark">手动搭建Train版OpenStack</a></div><div class="null-excerpt"><p></p><blockquote><p>  学习搭建 <code>OpenStack</code></p></blockquote><p></p></div></div><div class="null-item"><div class="null-title"><a href="\posts\6348717a.html" title="Commands" rel="bookmark">Commands</a></div><div class="null-excerpt"><p></p><blockquote><p>  总结一些常用命令</p></blockquote><p></p></div></div></div></div></div></div></div><div class="foot"><div class="foot-inner"><div class="foot__head"><div class="foot-line"><div class="matts">用</div><div class="matts">捨</div><div class="matts">由</div><div class="matts">時</div></div><div class="foot-line"><div class="matts">行</div><div class="matts">藏</div><div class="matts">在</div><div class="matts">我</div></div></div><div class="foot__body"><div class="foot-item"><div class="foot-item__head">账号</div><div class="foot-item__body"><div class="text"><img alt="link" height="20px" width="20px" src="/images/icon/icon-github.svg"> <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/limerencist">github</a></div></div></div><div class="foot-item"><div class="foot-item__head">联系</div><div class="foot-item__body"><div class="text"><img alt="link" height="20px" width="20px" src="/images/icon/icon-email.svg"> <a class="foot-link" href="mailto:limerencist@gmail.com">limerencist@gmail.com</a></div></div></div></div><div class="copyright"><a href="https://limerencist.github.io">失落之地</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp; <svg width="20" height="20" viewBox="0 0 725 725"><path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z"/><path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z"/><path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z"/></svg> <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动</div></div></div></body></html>