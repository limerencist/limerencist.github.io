<!DOCTYPE html><html lang="zh-HK" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/rock-gesture.png"><link rel="icon" href="/img/rock-gesture.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Felix Cheung"><meta name="keywords" content=""><meta name="description" content="作为一名合格的运维工程师，使用自动化工具来实现应用的CI&#x2F;CD必不可少。在实际工作中，一般使用Jenkins并撰写相应的pipeline来完成此类工作。针对不同的情况，流水线的组合也不尽相同，例如前后端编译方式不一样、一个git地址里实际包含多个项目等等。对此，我主要总结成几个案例以供分析（流水线中一些git项目地址和账户凭据以xxxxx代替）。 	  案例一：构建java后端项目  1"><meta property="og:type" content="article"><meta property="og:title" content="Jenkins流水线脚本"><meta property="og:url" content="https://limerencist.github.io/posts/bbf2ea7a.html"><meta property="og:site_name" content="失落之地"><meta property="og:description" content="作为一名合格的运维工程师，使用自动化工具来实现应用的CI&#x2F;CD必不可少。在实际工作中，一般使用Jenkins并撰写相应的pipeline来完成此类工作。针对不同的情况，流水线的组合也不尽相同，例如前后端编译方式不一样、一个git地址里实际包含多个项目等等。对此，我主要总结成几个案例以供分析（流水线中一些git项目地址和账户凭据以xxxxx代替）。 	  案例一：构建java后端项目  1"><meta property="og:locale" content="zh_HK"><meta property="og:image" content="https://limerencist.github.io/img/jenkins.jpg"><meta property="article:published_time" content="2023-06-05T02:27:27.000Z"><meta property="article:modified_time" content="2023-06-06T02:04:47.000Z"><meta property="article:author" content="Felix Cheung"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://limerencist.github.io/img/jenkins.jpg"><meta name="referrer" content="no-referrer-when-downgrade"><title>Jenkins流水线脚本 | 失落之地</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"limerencist.github.io",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:50,cursorChar:"|",loop:!0,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!1,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"left",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:1},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:50vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>失落之地</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首頁</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>歸檔</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分類</span></a></li><li class="nav-item"><a class="nav-link" href="/playlist/"><i class="iconfont icon-music"></i> <span>歌单</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>關於</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/jenkins.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Jenkins流水线脚本"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-06-05 10:27" pubdate>2023年6月5日 上午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 13k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 66 分鐘 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="padding-left:2rem;margin-right:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目錄</span></p><div class="toc-body" id="toc-body"></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Jenkins流水线脚本</h1><p class="note note-info">本文最後更新於：1 天前</p><div class="markdown-body"><p>    作为一名合格的运维工程师，使用自动化工具来实现应用的CI/CD必不可少。在实际工作中，一般使用Jenkins并撰写相应的pipeline来完成此类工作。针对不同的情况，流水线的组合也不尽相同，例如前后端编译方式不一样、一个git地址里实际包含多个项目等等。对此，我主要总结成几个案例以供分析（流水线中一些git项目地址和账户凭据以xxxxx代替）。</p><h1 id="案例一构建java后端项目"><a class="markdownIt-Anchor" href="#案例一构建java后端项目"></a> 案例一：构建java后端项目</h1><hr><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>		agent any <br><br>    <span class="hljs-comment">// 一些常用选项</span><br>    options &#123;<br>      <span class="hljs-comment">// 构建过程显示时间戳</span><br>      timestamps()<br>      <span class="hljs-comment">// 构建事件保留策略</span><br>      buildDiscarder logRotator(<br>        <span class="hljs-symbol">artifactDaysToKeepStr:</span> <span class="hljs-string">&#x27;30&#x27;</span>, <br>        <span class="hljs-symbol">artifactNumToKeepStr:</span> <span class="hljs-string">&#x27;5&#x27;</span>, <br>        <span class="hljs-symbol">daysToKeepStr:</span> <span class="hljs-string">&#x27;3&#x27;</span>, <br>        <span class="hljs-symbol">numToKeepStr:</span> <span class="hljs-string">&#x27;3&#x27;</span><br>      )<br>  	&#125;<br>  <br>    <span class="hljs-comment">// 声明一些变量，这样针对其他类似项目修改变量即可</span><br>    environment &#123;<br>        <span class="hljs-comment">// git相关，拉取项目代码的凭据需要提前配置</span><br>        GIT_BRANCH = <span class="hljs-string">&#x27;master&#x27;</span><br>        GIT_CR_ID = <span class="hljs-string">&#x27;xxxxxxx&#x27;</span>  <br>        GIT_URL = <span class="hljs-string">&#x27;http://xxx.git&#x27;</span><br>        <span class="hljs-comment">// 项目名称，不一定和git中一致，主要是为了区分</span><br>        APP_NAME = <span class="hljs-string">&#x27;xxx&#x27;</span><br>        APP_SPACE = <span class="hljs-string">&#x27;/opt&#x27;</span><br>    &#125;<br>   <br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;初始化工作目录&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&quot;STEP1: 初始化工作目录&quot;</span><br>                deleteDir()<br>            &#125;<br>        &#125;<br>        <br>        stage(<span class="hljs-string">&#x27;拉取项目代码&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&quot;STEP2: 拉取项目代码&quot;</span><br>                git <span class="hljs-attr">branch:</span> <span class="hljs-string">&quot;$&#123;GIT_BRANCH&#125;&quot;</span>, <span class="hljs-attr">credentialsId:</span> <span class="hljs-string">&quot;$&#123;GIT_CR_ID&#125;&quot;</span>, <span class="hljs-attr">url:</span> <span class="hljs-string">&quot;$&#123;GIT_URL&#125;&quot;</span>   <br>            &#125;<br>        &#125;<br>      <br>        stage(<span class="hljs-string">&#x27;项目编译&#x27;</span>) &#123;<br>                echo <span class="hljs-string">&quot;STEP3: 项目编译&quot;</span><br>                sh <span class="hljs-string">&#x27;mvn -U -am clean package -Dmaven.test.skip=true -DskipTests=true&#x27;</span><br>        &#125;<br>      <br>        stage(<span class="hljs-string">&#x27;准备项目包&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&quot;STEP4: 准备项目包&quot;</span><br>                <span class="hljs-comment">// 获取maven编译出来的war包并放到指定目录（主要是因为本人强迫症，不喜欢一个目录里有不必要的东西）</span><br>                sh <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">                    VERFILE=$(ls $&#123;WORKSPACE&#125;/target -A | grep war | grep -v original)</span><br><span class="hljs-string">                    if [ ! -d $&#123;APP_SPACE&#125;/$&#123;GIT_BRANCH&#125; ]; then mkdir -p $&#123;APP_SPACE&#125;/$&#123;GIT_BRANCH&#125; ; fi</span><br><span class="hljs-string">                    cp $&#123;WORKSPACE&#125;/target/$&#123;VERFILE&#125; $&#123;APP_SPACE&#125;/$&#123;GIT_BRANCH&#125;/$&#123;APP_NAME&#125;.war</span><br><span class="hljs-string">                &#x27;&#x27;&#x27;</span><br>            &#125;<br>        &#125;<br>      <br>        stage(<span class="hljs-string">&#x27;生成镜像&#x27;</span>) &#123;<br>            steps &#123;<br>                echo <span class="hljs-string">&quot;STEP5: 生成镜像&quot;</span><br>                sh <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">                    cd $&#123;APP_SPACE&#125;/$&#123;GIT_BRANCH&#125;</span><br><span class="hljs-string">                    IMGAETAG=hub.xxxx.cn/$&#123;APP_NAME&#125;:$&#123;BUILD_NUMBER&#125;</span><br><span class="hljs-string">                    docker build -t $&#123;IMGAETAG&#125; -f $&#123;APP_NAME&#125;_dockerfile .</span><br><span class="hljs-string">                    cat /root/hubyozocloud | docker login -u xxx hub.xxxx.cn --password-stdin</span><br><span class="hljs-string">                    docker push $&#123;IMGAETAG&#125;</span><br><span class="hljs-string">                    docker rmi $&#123;IMGAETAG&#125;</span><br><span class="hljs-string">                &#x27;&#x27;&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 配置钉钉通知</span><br>    post&#123;<br>        always&#123;<br>            wrap([<span class="hljs-attr">$class:</span> <span class="hljs-string">&#x27;BuildUser&#x27;</span>]) &#123;<br>                buildDescription <span class="hljs-string">&quot;Build Person: $&#123;BUILD_USER&#125;\nBuild Task: $&#123;JOB_NAME&#125;&quot;</span><br>            &#125;            <br>        &#125;<br>        success&#123;<br>            dingtalk (<br>                <span class="hljs-comment">// 机器人ID</span><br>                <span class="hljs-symbol">robot:</span> <span class="hljs-string">&#x27;xxxxxxxxxxxxxxx&#x27;</span>,<br>                <span class="hljs-symbol">type:</span> <span class="hljs-string">&#x27;LINK&#x27;</span>,<br>                <span class="hljs-comment">// 如果不@所有人的话，配置指定@的人</span><br>                <span class="hljs-symbol">at:</span> [<span class="hljs-string">&#x27;xxxxxxxxxx&#x27;</span>],<br>                <span class="hljs-symbol">atAll:</span> <span class="hljs-literal">false</span>,<br>                <span class="hljs-symbol">title:</span> <span class="hljs-string">&#x27;Test&#x27;</span>,<br>                <span class="hljs-symbol">text:</span> [<span class="hljs-string">&#x27;构建成功！&#x27;</span>],<br>                <span class="hljs-comment">// 可以配置Jenkins地址</span><br>                <span class="hljs-symbol">messageUrl:</span> <span class="hljs-string">&#x27;xxxxxxxx&#x27;</span>,<br>                <span class="hljs-symbol">picUrl:</span> <span class="hljs-string">&#x27;https://img2.baidu.com/it/u=1641501037,1168798543&amp;fm=15&amp;fmt=auto&amp;gp=0.jpg&#x27;</span><br>            )<br>        &#125;<br>        failure&#123;<br>            dingtalk (<br>                <span class="hljs-comment">// 机器人ID</span><br>                <span class="hljs-symbol">robot:</span> <span class="hljs-string">&#x27;xxxxxxxxxxxxxxx&#x27;</span>,<br>                <span class="hljs-symbol">type:</span> <span class="hljs-string">&#x27;LINK&#x27;</span>,<br>                <span class="hljs-comment">// 如果不@所有人的话，配置指定@的人</span><br>                <span class="hljs-symbol">at:</span> [<span class="hljs-string">&#x27;xxxxxxxxxx&#x27;</span>],<br>                <span class="hljs-symbol">atAll:</span> <span class="hljs-literal">false</span>,<br>                <span class="hljs-symbol">title:</span> <span class="hljs-string">&#x27;Test&#x27;</span>,<br>                <span class="hljs-symbol">text:</span> [<span class="hljs-string">&#x27;构建失败！&#x27;</span>],<br>                <span class="hljs-comment">// 可以配置Jenkins地址</span><br>                <span class="hljs-symbol">messageUrl:</span> <span class="hljs-string">&#x27;xxxxxxxx&#x27;</span>,<br>                <span class="hljs-symbol">picUrl:</span> <span class="hljs-string">&#x27;https://img2.baidu.com/it/u=1641501037,1168798543&amp;fm=15&amp;fmt=auto&amp;gp=0.jpg&#x27;</span><br>            )<br>        &#125;<br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结说明"><a class="markdownIt-Anchor" href="#总结说明"></a> 总结说明</h2><blockquote><p>这是本人刚接触 <code>jenkins</code> 时候撰写的 <code>pipeline</code> (一些配置项可以看注释)，主要是根据前人留下来的模版，尝试添加 <code>docker build</code>（实际写得很粗糙），并且把可以在界面上配置的一些选项和钉钉通知也转换在脚本里（这样就完全可以不依赖界面配置，但实际也没有必要，纯粹是早期为了学习）</p></blockquote><h1 id="案例二构建node前端项目"><a class="markdownIt-Anchor" href="#案例二构建node前端项目"></a> 案例二：构建node前端项目</h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    <span class="hljs-comment">// 指定jenkins从节点</span><br>    agent &#123;<br>        label <span class="hljs-string">&#x27;agent slave1&#x27;</span><br>    &#125;<br><br>    <span class="hljs-comment">// 还是习惯声明一些常用并可以修改的变量</span><br>    environment &#123;<br>        <span class="hljs-comment">// git相关</span><br>        GIT_URL = <span class="hljs-string">&#x27;xxxxxxx&#x27;</span><br>        GIT_CR_ID = <span class="hljs-string">&#x27;xxxxx&#x27;</span><br>        GIT_BRANCH_TAG = <span class="hljs-string">&#x27;develop&#x27;</span><br>        <span class="hljs-comment">// 服务相关</span><br>        APP_NAME = <span class="hljs-string">&#x27;xxx&#x27;</span><br>        APP_ALL=<span class="hljs-string">&quot;a,b,c,d&quot;</span><br>        <span class="hljs-comment">// 镜像相关</span><br>        HUB_URL = <span class="hljs-string">&#x27;xxxxxx&#x27;</span><br>        PROJECT_NAME = <span class="hljs-string">&#x27;project&#x27;</span><br>        ARCH = <span class="hljs-string">&#x27;x86_64&#x27;</span><br>        ENV = <span class="hljs-string">&#x27;uat&#x27;</span><br>        <span class="hljs-comment">// 部署/更新相关</span><br>        HOST = <span class="hljs-string">&#x27;192.168.20.10&#x27;</span><br>        BASE_PATH = <span class="hljs-string">&#x27;/opt&#x27;</span><br>    &#125;<br>   <br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;ClearDir&#x27;</span>) &#123;<br>            steps &#123;<br>                deleteDir()<br>            &#125;<br>        &#125;<br>        <br>        stage(<span class="hljs-string">&#x27;Get Code&#x27;</span>) &#123;<br>            steps &#123;<br>                script &#123;<br>                    sh <span class="hljs-string">&#x27;rm -rf build-tmp&#x27;</span><br>                    <span class="hljs-comment">// 涉及到不同git项目，写了个循环</span><br>                    <span class="hljs-keyword">for</span> ( app_name <span class="hljs-keyword">in</span> APP_ALL.tokenize(<span class="hljs-string">&quot;,&quot;</span>) )&#123;<br>                        checkout([<span class="hljs-attr">$class:</span> <span class="hljs-string">&#x27;GitSCM&#x27;</span>, <br>                            <span class="hljs-symbol">branches:</span> [[<span class="hljs-attr">name:</span> <span class="hljs-string">&quot;$&#123;GIT_BRANCH_TAG&#125;&quot;</span>]], <br>                            <span class="hljs-symbol">doGenerateSubmoduleConfigurations:</span> <span class="hljs-literal">false</span>, <br>                            <span class="hljs-symbol">extensions:</span> [[<span class="hljs-attr">$class:</span> <span class="hljs-string">&#x27;RelativeTargetDirectory&#x27;</span>,<span class="hljs-attr">relativeTargetDir:</span> <span class="hljs-string">&quot;$&#123;app_name&#125;&quot;</span>]], <br>                            <span class="hljs-symbol">submoduleCfg:</span> [], <br>                            <span class="hljs-symbol">userRemoteConfigs:</span> [[<span class="hljs-attr">credentialsId:</span> GIT_CR_ID, <span class="hljs-attr">url:</span> GIT_URL+ <span class="hljs-string">&quot;$&#123;app_name&#125;&quot;</span> +<span class="hljs-string">&#x27;.git&#x27;</span>]]<br>                        ])<br>                    &#125;    <br>                &#125;       <br>            &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;Compile&#x27;</span>) &#123;<br>            steps &#123;<br>                script &#123;<br>                    sh <span class="hljs-string">&#x27;mkdir build-tmp&#x27;</span><br>                    <span class="hljs-comment">// 同理循环，编译多个前端项目包</span><br>                    <span class="hljs-keyword">for</span> ( app_name <span class="hljs-keyword">in</span> APP_ALL.tokenize(<span class="hljs-string">&quot;,&quot;</span>) )&#123;<br>                        dir( <span class="hljs-string">&quot;$&#123;WORKSPACE&#125;/&quot;</span> + app_name )&#123;<br>                            <span class="hljs-comment">// 使用docker编译前端项目</span><br>                            docker.image(<span class="hljs-string">&#x27;node:16.17.0-alpine3.16&#x27;</span>).inside(<span class="hljs-string">&#x27;-v /etc/hosts:/etc/hosts -v /home/build/.yarnrc:/.yarnrc -v /home/build/.docmiddle_npmrc:/.npmrc -v /home/build/.docmiddle_yarn:/.cache/yarn  --network host&#x27;</span>) &#123;<br>                                sh <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">                                  npm config set registry https://registry.npmmirror.com/</span><br><span class="hljs-string">                                  yarn config set registry https://registry.npmmirror.com/</span><br><span class="hljs-string">                                  yarn install</span><br><span class="hljs-string">                                  yarn build</span><br><span class="hljs-string">                                &#x27;&#x27;&#x27;</span><br>                            &#125;<br>                            <span class="hljs-comment">// 生成项目包</span><br>                            sh <span class="hljs-string">&#x27;cp -ar dist &#x27;</span>+ app_name<br>                            sh <span class="hljs-string">&#x27;tar zcpf &#x27;</span> + app_name + <span class="hljs-string">&#x27;.tar.gz &#x27;</span>+ app_name +<span class="hljs-string">&#x27;/&#x27;</span><br>                            sh <span class="hljs-string">&#x27;mv &#x27;</span>+ app_name + <span class="hljs-string">&#x27;.tar.gz ../build-tmp/&#x27;</span><br>                        &#125;                   <br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;Build&#x27;</span>) &#123;<br>            steps &#123;<br>                <span class="hljs-comment">// 将多个静态资源包构建一个前端镜像</span><br>                script &#123;<br>                    dir( <span class="hljs-string">&quot;$&#123;WORKSPACE&#125;/build-tmp&quot;</span>)&#123;<br>                        docker.withRegistry(<span class="hljs-string">&quot;https://$&#123;HUB_URL&#125;&quot;</span>, <span class="hljs-string">&#x27;7cd81781-9c42-479c-9ed2-4e26d272520c&#x27;</span>) &#123;<br>                            <span class="hljs-keyword">def</span> customImage=docker.build(<span class="hljs-string">&quot;$&#123;HUB_URL&#125;/$&#123;PROJECT_NAME&#125;/$&#123;ARCH&#125;/$&#123;ENV&#125;/$&#123;APP_NAME&#125;:$&#123;GIT_BRANCH_TAG&#125;&quot;</span>)<br>                            customImage.push()<br>                        &#125;<br>                        sh <span class="hljs-string">&#x27;docker rmi $&#123;HUB_URL&#125;/$&#123;PROJECT_NAME&#125;/$&#123;ARCH&#125;/$&#123;ENV&#125;/$&#123;APP_NAME&#125;:$&#123;GIT_BRANCH_TAG&#125;&#x27;</span><br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;Update&#x27;</span>) &#123;<br>            steps &#123;<br>                <span class="hljs-comment">// 撰写playbook并使用ansible插件更新项目</span><br>                script &#123;<br>                    app_image = <span class="hljs-string">&#x27;$&#123;HUB_URL&#125;/$&#123;PROJECT_NAME&#125;/$&#123;ARCH&#125;/$&#123;ENV&#125;/$&#123;APP_NAME&#125;:$&#123;GIT_BRANCH_TAG&#125;&#x27;</span><br>                    Map&lt;String,String&gt; extra_vars = [ <span class="hljs-string">&#x27;host&#x27;</span>: <span class="hljs-string">&#x27;$&#123;HOST&#125;&#x27;</span>, <span class="hljs-string">&#x27;app_name&#x27;</span>: <span class="hljs-string">&#x27;$&#123;APP_NAME&#125;&#x27;</span>, <span class="hljs-string">&#x27;app_image&#x27;</span>: app_image, <span class="hljs-string">&#x27;base_path&#x27;</span>: <span class="hljs-string">&#x27;$&#123;BASE_PATH&#125;&#x27;</span> ]<br>                    ansiblePlaybook(<br>                        <span class="hljs-symbol">playbook:</span> <span class="hljs-string">&#x27;/etc/ansible/scripts/docker_image.yml&#x27;</span>, <br>                        <span class="hljs-symbol">inventory:</span> <span class="hljs-string">&#x27;/etc/ansible/hosts&#x27;</span>, <br>                        <span class="hljs-symbol">extraVars:</span> extra_vars<br>                    )<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结说明-2"><a class="markdownIt-Anchor" href="#总结说明-2"></a> 总结说明</h2><blockquote><p>这个前端项目的镜像由4个静态资源组成，分别在4个 <code>git</code> 地址上 ，在拉取代码阶段用循环拼接不同的项目地址分别拉取；</p><p>编译阶段为了避免在 <code>jenkins</code> 本地安装及配置 <code>nodejs</code> , 使用对应镜像在容器中编译成静态资源，并且映射相关依赖目录，加快下载依赖的速度，最后打包并压缩成 <code>gz</code> 包；</p><p>构建镜像时候使用 <code>docker</code> 插件，使用 withRegistry 方法 <code>build</code> 并 <code>push</code> ；未防止机器上镜像过多，在 <code>push</code> 之后进行删除（纯粹也是学习，和直接使用 <code>docker build</code> 或者 <code>docker push</code> 的命令 一样）；</p><p>更新阶段学习使用 <code>ansible</code> 插件，提前写了对应的playbook，当时服务是用 <code>docker-compose</code> 编排的，更新服务只要更新镜像即可，就写了个 py脚本替换 yml 里的 image 字段，再重启服务</p></blockquote><h1 id="案例三构建golang后端项目"><a class="markdownIt-Anchor" href="#案例三构建golang后端项目"></a> 案例三：构建golang后端项目</h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs groovy">timestamps &#123;<br>  podTemplate(<br>    <span class="hljs-symbol">containers:</span> [<br>      containerTemplate(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;sonar&#x27;</span>, <span class="hljs-attr">image:</span> <span class="hljs-string">&#x27;sonar:v4.8.0&#x27;</span>, <span class="hljs-attr">command:</span> <span class="hljs-string">&#x27;sleep&#x27;</span>, <span class="hljs-attr">args:</span> <span class="hljs-string">&#x27;99d&#x27;</span>),<br>      containerTemplate(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;golang&#x27;</span>, <span class="hljs-attr">image:</span> <span class="hljs-string">&#x27;golang:1.20&#x27;</span>, <span class="hljs-attr">command:</span> <span class="hljs-string">&#x27;sleep&#x27;</span>, <span class="hljs-attr">args:</span> <span class="hljs-string">&#x27;99d&#x27;</span>),<br>      containerTemplate(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;kubectl&#x27;</span>, <span class="hljs-attr">image:</span> <span class="hljs-string">&#x27;kubectl:v1&#x27;</span>, <span class="hljs-attr">command:</span> <span class="hljs-string">&#x27;sleep&#x27;</span>, <span class="hljs-attr">args:</span> <span class="hljs-string">&#x27;99d&#x27;</span>)<br>    ],<br>    <span class="hljs-symbol">volumes:</span> [<br>      hostPathVolume(<span class="hljs-attr">hostPath:</span> <span class="hljs-string">&#x27;/etc/docker&#x27;</span>, <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&#x27;/etc/docker&#x27;</span>),<br>      hostPathVolume(<span class="hljs-attr">hostPath:</span> <span class="hljs-string">&#x27;/usr/bin/docker&#x27;</span>, <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&#x27;/usr/bin/docker&#x27;</span>),<br>      hostPathVolume(<span class="hljs-attr">hostPath:</span> <span class="hljs-string">&#x27;/etc/resolv.conf&#x27;</span>, <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&#x27;/etc/resolv.conf&#x27;</span>),<br>      hostPathVolume(<span class="hljs-attr">hostPath:</span> <span class="hljs-string">&#x27;/var/run/docker.sock&#x27;</span>, <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&#x27;/var/run/docker.sock&#x27;</span>)<br>    ],<br>    <span class="hljs-symbol">envVars:</span> [<br>      envVar(<span class="hljs-attr">key:</span> <span class="hljs-string">&#x27;GOPROXY&#x27;</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;https://goproxy.cn,direct&#x27;</span>),<br>      envVar(<span class="hljs-attr">key:</span> <span class="hljs-string">&#x27;GONOPROXY&#x27;</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;xxxxxx&#x27;</span>),<br>      envVar(<span class="hljs-attr">key:</span> <span class="hljs-string">&#x27;GONOSUMDB&#x27;</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;xxxxxx&#x27;</span>),<br>      envVar(<span class="hljs-attr">key:</span> <span class="hljs-string">&#x27;GOPRIVATE&#x27;</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;xxxxxx&#x27;</span>),<br>      envVar(<span class="hljs-attr">key:</span> <span class="hljs-string">&#x27;GOINSECURE&#x27;</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;xxxxxx&#x27;</span>),<br>    ]<br>  )&#123;<br>    node(POD_LABEL) &#123;<br>      <span class="hljs-comment">// 祖传的一些变量</span><br>      git_cr_id=<span class="hljs-string">&#x27;xxxx&#x27;</span><br>      git_url=<span class="hljs-string">&#x27;xxxxx&#x27;</span><br>      harbor_url = <span class="hljs-string">&#x27;xxxx&#x27;</span><br>      project = <span class="hljs-string">&#x27;xxx&#x27;</span><br>      arch = <span class="hljs-string">&#x27;x86_64&#x27;</span><br>      apps = <span class="hljs-string">&#x27;xxxxxx&#x27;</span><br>        <br>      stage(<span class="hljs-string">&#x27;Git&#x27;</span>) &#123;<br>        checkout([<span class="hljs-attr">$class:</span> <span class="hljs-string">&#x27;GitSCM&#x27;</span>, <br>            <span class="hljs-symbol">branches:</span> [[<span class="hljs-attr">name:</span> <span class="hljs-string">&quot;$&#123;target&#125;&quot;</span>]], <br>            <span class="hljs-symbol">extensions:</span> [[<span class="hljs-attr">$class:</span> <span class="hljs-string">&#x27;CloneOption&#x27;</span>,<span class="hljs-attr">shallow:</span> <span class="hljs-literal">true</span>,<span class="hljs-attr">depth:</span> <span class="hljs-number">1</span>,<span class="hljs-attr">timeout:</span> <span class="hljs-number">30</span>]], <br>            <span class="hljs-symbol">userRemoteConfigs:</span> [[<span class="hljs-attr">credentialsId:</span> git_cr_id, <span class="hljs-attr">url:</span> git_url]]<br>        ])<br><br>        image_tag=sh(<span class="hljs-attr">returnStdout:</span> <span class="hljs-literal">true</span>, <span class="hljs-attr">script:</span> <span class="hljs-string">&#x27;git rev-parse --short HEAD&#x27;</span>).trim()<br><br>        container(<span class="hljs-string">&#x27;sonar&#x27;</span>)&#123;<br>          stage(<span class="hljs-string">&#x27;Sonar&#x27;</span>)&#123;<br>            <span class="hljs-keyword">for</span> ( app <span class="hljs-keyword">in</span> apps.tokenize(<span class="hljs-string">&quot;,&quot;</span>) )&#123;<br>              dir(<span class="hljs-string">&quot;/home/jenkins/agent/workspace/$&#123;JOB_NAME&#125;/app/&quot;</span>+app)&#123;<br>                withSonarQubeEnv(<span class="hljs-string">&#x27;sonarqubeserver&#x27;</span>) &#123;<br>                  withCredentials([usernamePassword(<span class="hljs-attr">credentialsId:</span> <span class="hljs-string">&#x27;sonar-scan&#x27;</span>, <span class="hljs-attr">passwordVariable:</span> <span class="hljs-string">&#x27;snoarPSW&#x27;</span>, <span class="hljs-attr">usernameVariable:</span> <span class="hljs-string">&#x27;snoarUSR&#x27;</span>)]) &#123;<br>                    sh <span class="hljs-string">&quot;sonar-scanner -Dsonar.projectKey=$&#123;app&#125; -Dsonar.projectName=$&#123;app&#125;  -Dsonar.login=$snoarUSR -Dsonar.password=$snoarPSW&quot;</span><br>                  &#125;<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br><br>        container(<span class="hljs-string">&#x27;golang&#x27;</span>) &#123;<br>          stage(<span class="hljs-string">&#x27;Make&#x27;</span>) &#123;<br>            <span class="hljs-keyword">for</span> ( app <span class="hljs-keyword">in</span> apps.tokenize(<span class="hljs-string">&quot;,&quot;</span>) )&#123;<br>              dir(<span class="hljs-string">&quot;/home/jenkins/agent/workspace/$&#123;JOB_NAME&#125;/app/$&#123;app&#125;&quot;</span>)&#123;<br>                sh <span class="hljs-string">&#x27;git config --global user.name &quot;xxxxxx&quot;&#x27;</span><br>                sh <span class="hljs-string">&#x27;git config --global user.email &quot;xxxxxx&quot;&#x27;</span><br>                sh <span class="hljs-string">&quot;git config --global --add safe.directory /home/jenkins/agent/workspace/$&#123;JOB_NAME&#125;&quot;</span><br>                sh <span class="hljs-string">&#x27;git config --global url.&quot;git@xxxxxx:&quot;.insteadof &quot;http://xxxxxx/&quot;&#x27;</span><br>                sh <span class="hljs-string">&#x27;make linux-build&#x27;</span><br>              &#125;<br>            &#125;<br>          &#125;<br><br>          stage(<span class="hljs-string">&#x27;Image&#x27;</span>)&#123;<br>            <span class="hljs-keyword">for</span> ( app <span class="hljs-keyword">in</span> apps.tokenize(<span class="hljs-string">&quot;,&quot;</span>) )&#123;<br>              dir(<span class="hljs-string">&quot;/home/jenkins/agent/workspace/$&#123;JOB_NAME&#125;/app/$&#123;app&#125;&quot;</span>)&#123;<br>                image = <span class="hljs-string">&quot;$&#123;harbor_url&#125;/$&#123;project&#125;/$&#123;arch&#125;/$&#123;app&#125;:$&#123;image_tag&#125;&quot;</span><br>                build_image(image)<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;  <br><br>        container(<span class="hljs-string">&#x27;kubectl&#x27;</span>) &#123;<br>          stage(<span class="hljs-string">&#x27;Deploy&#x27;</span>)&#123;<br>            sh <span class="hljs-string">&quot;mkdir -p ~/.kube&quot;</span><br>              <br>            <span class="hljs-keyword">if</span> (target == <span class="hljs-string">&#x27;rc&#x27;</span>) &#123;<br>              withCredentials([string(<span class="hljs-attr">credentialsId:</span> <span class="hljs-string">&#x27;k8s-uat-admin&#x27;</span>, <span class="hljs-attr">variable:</span> <span class="hljs-string">&#x27;K8S_UAT_CONF&#x27;</span>)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo $K8S_UAT_CONF | base64 -d &gt; ~/.kube/config&#x27;</span><br>              &#125;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>              withCredentials([string(<span class="hljs-attr">credentialsId:</span> <span class="hljs-string">&#x27;k8s-dev-admin&#x27;</span>, <span class="hljs-attr">variable:</span> <span class="hljs-string">&#x27;K8S_DEV_CONF&#x27;</span>)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo $K8S_DEV_CONF | base64 -d &gt; ~/.kube/config&#x27;</span><br>              &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">for</span> ( app <span class="hljs-keyword">in</span> apps.tokenize(<span class="hljs-string">&quot;,&quot;</span>) )&#123;<br>              dir(<span class="hljs-string">&quot;/home/jenkins/agent/workspace/$&#123;JOB_NAME&#125;/app/$&#123;app&#125;&quot;</span>)&#123;<br>                <span class="hljs-keyword">if</span> (target ==<span class="hljs-string">&#x27;develop&#x27;</span> || target ==<span class="hljs-string">&#x27;rc&#x27;</span>)&#123;<br>                  sh <span class="hljs-string">&quot;helm upgrade -i -n tecoai --set image.tag=$&#123;image_tag&#125; --set labels.branch=$&#123;target&#125; $&#123;app&#125; ./helm/&quot;</span><br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                  sh <span class="hljs-string">&quot;sed -i &#x27;s/$&#123;app&#125;/$&#123;app&#125;-$&#123;target&#125;/g&#x27; helm/Chart.yaml&quot;</span><br>                  sh <span class="hljs-string">&quot;helm upgrade -i -n tecoai --set image.tag=$&#123;image_tag&#125; --set labels.branch=$&#123;target&#125; --set app=$&#123;app&#125;-$&#123;target&#125; $&#123;app&#125;-$&#123;target&#125; ./helm/&quot;</span><br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">def</span> build_image(String image)&#123;<br>    docker.withRegistry(<span class="hljs-string">&quot;https://$&#123;harbor_url&#125;&quot;</span>, <span class="hljs-string">&#x27;harbor&#x27;</span>) &#123;<br>        <span class="hljs-keyword">def</span> customImage=docker.build(<span class="hljs-string">&quot;$&#123;image&#125;&quot;</span>)<br>        customImage.push()<br>    &#125;<br>    sh <span class="hljs-string">&quot;docker rmi $&#123;image&#125;&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结说明-3"><a class="markdownIt-Anchor" href="#总结说明-3"></a> 总结说明</h2><blockquote><p>这个是最近比较折腾的一个流水线，说下总体的思路：</p><p>使用 <code>Jenkins</code> 的 <code>Kubernetes</code> 插件，在已有的 <code>K8S</code> 集群中添加一个云节点（需要提前在 <code>Jenkins</code> 里配置的，具体可以看插件的说明）；</p><p>这个云节点会和 <code>podTemplate</code> 里写的多个容器组成一个 pod 运行 （podTemplate里的语法也可以使用最直接的yaml），例如此处创建了3个 <code>container</code>；</p><p>代码拉取： 使用 <code>checkout</code> 来实现浅拷贝，加快拉取速度，以 <code>commit id</code> 作为之后镜像的 <code>tag</code></p><p>代码扫描：使用 <code>pod</code>中的 <code>sonar</code> 容器（sonor镜像需要提前准备）完成扫描；</p><p>代码编译：使用 <code>pod</code>中的 <code>golang</code> 容器，利用研发在项目中撰写的 <code>Makefile</code> ，执行 <code>make linux-build</code> 生成可执行文件（因为 <code>go build</code> 中依赖其他项目中的公共库，所以这里加了一些其他的 <code>git config</code>，在 <code>podTemplate</code> 的 <code>envVars</code> 中也添加了一些编译需要的环境变量 ）; 这个 <code>golang</code> 容器的镜像为了能够免密拉取公共库的包，配置了 <code>git</code> 中 <code>ssh</code> 的秘钥；</p><p>构建镜像：这个和之前一样，使用 <code>Jenkins</code> 的 <code>docker</code> 插件完成，稍微不同的就是单独封装成了一个方法，需要时候直接调用；为了避免 <code>docker build</code> 时上下文过大，添加 <code>.dockerignore</code> 文件；另外，这一步使用 <code>pod</code>中的 <code>golang</code> 容器，在 <code>podTemplate</code> 的 <code>volumes</code> 中也添加 hostpath 实现 <code>docker in docker</code> ；</p><p>更新服务：使用 <code>pod</code>中的 <code>kubectl</code> 容器，根据不同分支选择对应 K8S 集群环境（不同的 <code>kubeconfig</code> 需要提前在 <code>Jenkins</code> 里配置），使用helm部署或者更新应用。</p><p>之前的流水线都是声明式的，通过 <code>script</code> 来写一些脚本，这次干脆直接使用脚本式；在这个项目中实际包含了两个应用，也用到了循环分别进到不同的目录构建和部署（需要和研发沟通）；除此之外，之前都是明确分支或者标签的，所以在一开始写了个 <code>GIT_BRANCH</code> 或者 <code>GIT_BRANCH_TAG</code> 的变量，而在这个流水线里拉取的分支变量是 <code>target</code> ，考虑到和触发器有关就在 Jenkins 的页面上配置了：这里的逻辑是 <code>rc</code> 分支部署到测试环境供测试人员测试，<code>develop</code> 分支部署到开发环境供开发人员自测，而 <code>develop</code> 是可能有多个研发完成不同特性分支 <code>merge</code> 上去的，这个单独的特性分支 <code>push</code> 之后，也会通过 <code>helm</code> 部署一个特性的 <code>release</code> 应用以供研发自测特性功能。</p></blockquote><p><em><strong>还需说明的一点是，个人认为流水线一般只负责到更新就完成了，至于更新是否成功或者如果失败是否需要回滚，可能需要研发排查代码或者运维排查配置其他问题，没有必要包含在流水线内。</strong></em></p><hr><p>    可以看到本人在不同阶段的流水线中用了很多插件，实际上对于 <code>DevOps</code> 工具而言，应该尽可能只使用它最核心的功能。插件是有学习成本的，增加了阅读和编写难度的同时，也可能导致其他问题：比如最后一个案例中所有编译和构建都在 pod 中，虽然提高了隔离性，但不管是前端还是后端的依赖都需要重新拉取，影响了构建速度，如果再使用 <code>hostpath</code> 挂载目录，就需要考虑固定某一节点，这样反而复杂了。</p><p>    业务繁多，任何流水线都有优化的空间。说句有用的废话，适合自己的才是最好的。</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%AD%A6%E6%B5%B7%E6%97%A0%E6%B6%AF/" class="category-chain-item">学海无涯</a> <span>></span> <a href="/categories/%E5%AD%A6%E6%B5%B7%E6%97%A0%E6%B6%AF/Others/" class="category-chain-item">Others</a></span></span></div></div><div class="license-box my-3"><div class="license-title"><div>Jenkins流水线脚本</div><div>https://limerencist.github.io/posts/bbf2ea7a.html</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Felix Cheung</div></div><div class="license-meta-item license-meta-date"><div>發布於</div><div>2023年6月5日</div></div><div class="license-meta-item"><div>許可協議</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/posts/6fe7255f.html" title="Prometheus常用配置汇总"><span class="hidden-mobile">Prometheus常用配置汇总</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-left:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="学海无涯" id="heading-7ad80c1ac8571d0cd560336bc99df249" role="tab" data-toggle="collapse" href="#collapse-7ad80c1ac8571d0cd560336bc99df249" aria-expanded="true">学海无涯 <span class="list-group-count">(11)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-7ad80c1ac8571d0cd560336bc99df249" role="tabpanel" aria-labelledby="heading-7ad80c1ac8571d0cd560336bc99df249"><div class="category-post-list"></div><div class="category-sub row nomargin-x"><a class="category-subitem collapsed list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Hexo" id="heading-c00d1eb68b529768ba98c975c76a9b66" role="tab" data-toggle="collapse" href="#collapse-c00d1eb68b529768ba98c975c76a9b66" aria-expanded="false">Hexo <span class="list-group-count">(2)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse" id="collapse-c00d1eb68b529768ba98c975c76a9b66" role="tabpanel" aria-labelledby="heading-c00d1eb68b529768ba98c975c76a9b66"><div class="category-post-list"><a href="/posts/5438079.html" title="Hexo常用插件汇总" class="list-group-item list-group-item-action"><span class="category-post">Hexo常用插件汇总</span> </a><a href="/posts/c1d5d64c.html" title="搭建Hexo博客" class="list-group-item list-group-item-action"><span class="category-post">搭建Hexo博客</span></a></div></div></div><div class="category-sub row nomargin-x"><a class="category-subitem collapsed list-group-item category-item-action col-10 col-md-11 col-xm-11" title="K8S" id="heading-97452006dd1cdcd5beb286d2656dea33" role="tab" data-toggle="collapse" href="#collapse-97452006dd1cdcd5beb286d2656dea33" aria-expanded="false">K8S <span class="list-group-count">(5)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse" id="collapse-97452006dd1cdcd5beb286d2656dea33" role="tabpanel" aria-labelledby="heading-97452006dd1cdcd5beb286d2656dea33"><div class="category-post-list"><a href="/posts/ef247c7f.html" title="K8S常用yaml汇总" class="list-group-item list-group-item-action"><span class="category-post">K8S常用yaml汇总</span> </a><a href="/posts/4fc885b8.html" title="K8S部署方式简介" class="list-group-item list-group-item-action"><span class="category-post">K8S部署方式简介</span> </a><a href="/posts/89a5c5a5.html" title="通过二进制方式部署Kubernetes集群" class="list-group-item list-group-item-action"><span class="category-post">通过二进制方式部署Kubernetes集群</span> </a><a href="/posts/43012f97.html" title="通过Kubeadm部署Kubernetes高可用集群" class="list-group-item list-group-item-action"><span class="category-post">通过Kubeadm部署Kubernetes高可用集群</span> </a><a href="/posts/50bdf01d.html" title="通过Kubeadm部署Kubernetes单主多从集群" class="list-group-item list-group-item-action"><span class="category-post">通过Kubeadm部署Kubernetes单主多从集群</span></a></div></div></div><div class="category-sub row nomargin-x"><a class="category-subitem list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Others" id="heading-52ef9633d88a7480b3a938ff9eaa2a25" role="tab" data-toggle="collapse" href="#collapse-52ef9633d88a7480b3a938ff9eaa2a25" aria-expanded="true">Others <span class="list-group-count">(4)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-52ef9633d88a7480b3a938ff9eaa2a25" role="tabpanel" aria-labelledby="heading-52ef9633d88a7480b3a938ff9eaa2a25"><div class="category-post-list"><a href="/posts/bbf2ea7a.html" title="Jenkins流水线脚本" class="list-group-item list-group-item-action active"><span class="category-post">Jenkins流水线脚本</span> </a><a href="/posts/6fe7255f.html" title="Prometheus常用配置汇总" class="list-group-item list-group-item-action"><span class="category-post">Prometheus常用配置汇总</span> </a><a href="/posts/476f61d5.html" title="手动部署Train版OpenStack" class="list-group-item list-group-item-action"><span class="category-post">手动部署Train版OpenStack</span> </a><a href="/posts/6348717a.html" title="Commands" class="list-group-item list-group-item-action"><span class="category-post">Commands</span></a></div></div></div></div></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜尋</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">關鍵字</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">總訪問量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">總訪客數 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.3.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.3.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.32/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.31/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允許 JavaScript 運行的環境下瀏覽效果更佳</div></noscript></body></html>