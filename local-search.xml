<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>K8S常用yaml汇总</title>
    <link href="/posts/ef247c7f.html"/>
    <url>/posts/ef247c7f.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><!-- block --><p>   由于工作需要，K8S总有服务是需要重复部署的，例如监控、日志等，每此都从网上整理很麻烦，而且往往有错误或者因K8S版本原因需要修改。虽然使用helm或者operator方式部署更为方便，但都是经过别人封装的东西，且万变不离yaml。本文旨在记录一些常用的组件yaml，做到开箱即用——至少在我本地直接kubectl apply -f 就可以运行。诚然，有不规范或不严谨的地方在所难免，往各位海涵。</p><!-- block --><blockquote><p>说明：</p><p>1、涉及到的数据存储都依赖于StorageClass，需要K8S集群内提前创建。</p><p>2、使用的镜像如不加tag，即使用latest镜像，以供使用者有需要添加制定版本的tag。</p><p>3、个人习惯创建资源的顺序为 <code>RBAC</code> → <code>Configmap/Secret</code> → <code>Deployment/Statefulset/Deamonset</code> → <code>Service</code> ，实际可按需使用  <code>Ingress</code>。</p></blockquote><h1 id="通用类"><a class="markdownIt-Anchor" href="#通用类"></a> 通用类</h1><h2 id="grafana"><a class="markdownIt-Anchor" href="#grafana"></a> Grafana</h2><h3 id="01-grafana-pvcyaml"><a class="markdownIt-Anchor" href="#01-grafana-pvcyaml"></a> 01-grafana-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、storage 存储大小</span><br><span class="hljs-comment"># 2、storageclass 名称</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">grafana-data</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br></code></pre></td></tr></table></figure><h3 id="02-grafana-deployyaml"><a class="markdownIt-Anchor" href="#02-grafana-deployyaml"></a> 02-grafana-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">grafana</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">grafana</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">grafana</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">grafana</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">securityContext:</span><br>        <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">472</span><br>        <span class="hljs-attr">supplementalGroups:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-number">0</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grafana</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/grafana</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-grafana</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">3000</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/robots.txt</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">3000</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">2</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">tcpSocket:</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">3000</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">250m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">750Mi</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grafana-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/grafana</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grafana-data-volume</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">grafana-data</span><br></code></pre></td></tr></table></figure><h3 id="03-grafana-svcyaml"><a class="markdownIt-Anchor" href="#03-grafana-svcyaml"></a> 03-grafana-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">grafana</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">grafana</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grafana-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">3000</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-grafana</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31001</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">grafana</span><br></code></pre></td></tr></table></figure><hr /><h2 id="minio"><a class="markdownIt-Anchor" href="#minio"></a> Minio</h2><blockquote><p>因Minio简单，此处以minio作为后续用到的对象存储，有其他对象存储的可以略过。</p></blockquote><h3 id="01-minio-pvcyaml"><a class="markdownIt-Anchor" href="#01-minio-pvcyaml"></a> 01-minio-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、storage 存储大小</span><br><span class="hljs-comment"># 2、storageclass 名称</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">minio-data</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">100Gi</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br></code></pre></td></tr></table></figure><h3 id="02-minio-deployyaml"><a class="markdownIt-Anchor" href="#02-minio-deployyaml"></a> 02-minio-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、console-address minio控制台端口</span><br><span class="hljs-comment"># 2、MINIO_ROOT_USER/MINIO_ROOT_PASSWORD 登录minio控制台的账号密码</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">minio</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">minio</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">minio</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">minio</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">minio</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">minio/minio</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">server</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">/data</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--console-address&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;:9001&#x27;</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MINIO_ROOT_USER</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;admin&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MINIO_ROOT_PASSWORD</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;admin123&quot;</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-minio</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9000</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-console</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9001</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">minio-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">minio-data-volume</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">minio-data</span><br></code></pre></td></tr></table></figure><h3 id="03-minio-svcyaml"><a class="markdownIt-Anchor" href="#03-minio-svcyaml"></a> 03-minio-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">minio</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">minio</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">minio-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9000</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-minio</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">console-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9001</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-console</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">minio</span><br></code></pre></td></tr></table></figure><h1 id="日志"><a class="markdownIt-Anchor" href="#日志"></a> 日志</h1><blockquote><p>相对于重量级日志分析的ELK(F)，这里使用更为轻量的Lok仅仅作为日志的查看工具，并对接minio。</p></blockquote><h2 id="loki"><a class="markdownIt-Anchor" href="#loki"></a> Loki</h2><h3 id="01-loki-rbacyaml"><a class="markdownIt-Anchor" href="#01-loki-rbacyaml"></a> 01-loki-rbac.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">extensions</span><br>    <span class="hljs-attr">resourceNames:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">loki</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">podsecuritypolicies</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">use</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure><h3 id="02-loki-cmyaml"><a class="markdownIt-Anchor" href="#02-loki-cmyaml"></a> 02-loki-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、shared_store 存储类型</span><br><span class="hljs-comment"># 2、s3 对象存储的aksk及url</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">loki.yaml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    auth_enabled: false</span><br><span class="hljs-string">    server:</span><br><span class="hljs-string">      http_listen_port: 3100</span><br><span class="hljs-string">    ingester:</span><br><span class="hljs-string">      lifecycler:       #配置ingester的生命周期，以及在哪里注册以进行发现</span><br><span class="hljs-string">        ring:</span><br><span class="hljs-string">          kvstore:</span><br><span class="hljs-string">            store: inmemory      # 用于ring的后端存储，支持consul、etcd、inmemory</span><br><span class="hljs-string">          replication_factor: 1      # 写入和读取的ingesters数量，至少为1（为了冗余和弹性，默认情况下为3）</span><br><span class="hljs-string">      chunk_idle_period: 3m      # 如果块没有达到最大的块大小，那么在刷新之前，块应该在内存中不更新多长时间</span><br><span class="hljs-string">      chunk_block_size: 262144</span><br><span class="hljs-string">      chunk_retain_period: 1m      # 块刷新后应该在内存中保留多长时间</span><br><span class="hljs-string">      max_transfer_retries: 0      # Number of times to try and transfer chunks when leaving before falling back to flushing to the store. Zero = no transfers are done.</span><br><span class="hljs-string">    schema_config:      # 配置从特定时间段开始应该使用哪些索引模式</span><br><span class="hljs-string">      configs:</span><br><span class="hljs-string">      - from: 2020-10-24      # 创建索引的日期。如果这是唯一的schema_config，则使用过去的日期，否则使用希望切换模式时的日期</span><br><span class="hljs-string">        store: boltdb-shipper      # 索引使用哪个存储，如：cassandra, bigtable, dynamodb，或boltdb</span><br><span class="hljs-string">        object_store: filesystem      # 用于块的存储，如：gcs, s3， inmemory, filesystem, cassandra，如果省略，默认值与store相同</span><br><span class="hljs-string">        schema: v11</span><br><span class="hljs-string">        index:      # 配置如何更新和存储索引</span><br><span class="hljs-string">          prefix: index_      # 所有周期表的前缀</span><br><span class="hljs-string">          period: 24h      # 表周期</span><br><span class="hljs-string">    storage_config:      # 为索引和块配置一个或多个存储</span><br><span class="hljs-string">      boltdb_shipper:</span><br><span class="hljs-string">        active_index_directory: /data/loki/boltdb-shipper-active</span><br><span class="hljs-string">        cache_location: /data/loki/boltdb-shipper-cache</span><br><span class="hljs-string">        cache_ttl: 24h         </span><br><span class="hljs-string">        # shared_store: filesystem</span><br><span class="hljs-string">        shared_store: s3</span><br><span class="hljs-string">      filesystem:</span><br><span class="hljs-string">        directory: /data/loki/chunks</span><br><span class="hljs-string">      aws:</span><br><span class="hljs-string">        s3: s3://access_key:secret_key@&lt;minio_svc_name&gt;(.&lt;minio_namspace_name&gt;.svc.cluster.local):&lt;minio_svc_port&gt;/&lt;bucket_name&gt;</span><br><span class="hljs-string">        s3forcepathstyle: true</span><br><span class="hljs-string">    limits_config:</span><br><span class="hljs-string">      enforce_metric_name: false</span><br><span class="hljs-string">      reject_old_samples: true      # 旧样品是否会被拒绝</span><br><span class="hljs-string">      reject_old_samples_max_age: 168h      # 拒绝旧样本的最大时限</span><br><span class="hljs-string">    chunk_store_config:      # 配置如何缓存块，以及在将它们保存到存储之前等待多长时间</span><br><span class="hljs-string">      max_look_back_period: 0s      #限制查询数据的时间，默认是禁用的，这个值应该小于或等于table_manager.retention_period中的值</span><br><span class="hljs-string">    table_manager:</span><br><span class="hljs-string">      retention_deletes_enabled: true      # 日志保留周期开关，用于表保留删除</span><br><span class="hljs-string">      retention_period: 48h       # 日志保留周期，保留期必须是索引/块的倍数</span><br><span class="hljs-string">    compactor:</span><br><span class="hljs-string">      working_directory: /data/loki/boltdb-shipper-compactor</span><br><span class="hljs-string">      # shared_store: filesystem</span><br><span class="hljs-string">      shared_store: s3</span><br><span class="hljs-string">      compaction_interval: 5m</span><br></code></pre></td></tr></table></figure><h3 id="03-loki-stsyaml"><a class="markdownIt-Anchor" href="#03-loki-stsyaml"></a> 03-loki-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、storage 存储大小</span><br><span class="hljs-comment"># 2、storageclass 名称</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">updateStrategy:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">loki</span><br>      <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">10001</span><br>          <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">10001</span><br>          <span class="hljs-attr">runAsNonRoot:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">10001</span><br>      <span class="hljs-attr">initContainers:</span> []<br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/loki</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">-config.file=/etc/loki/loki.yaml</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-loki</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">3100</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/loki</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-data</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-wal</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/wal</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">httpGet:</span> <br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-loki</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">45</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">httpGet:</span> <br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-loki</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">45</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>          <span class="hljs-attr">securityContext:</span><br>            <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">4800</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">defaultMode:</span> <span class="hljs-number">420</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">loki-data</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">&quot;10Gi&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">loki-wal</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">&quot;5Gi&quot;</span><br></code></pre></td></tr></table></figure><h3 id="04-loki-svcyaml"><a class="markdownIt-Anchor" href="#04-loki-svcyaml"></a> 04-loki-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">3100</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-loki</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">loki</span><br></code></pre></td></tr></table></figure><h2 id="promtail"><a class="markdownIt-Anchor" href="#promtail"></a> Promtail</h2><h3 id="01-promtail-rbacyaml"><a class="markdownIt-Anchor" href="#01-promtail-rbacyaml"></a> 01-promtail-rbac.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes/proxy</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure><h3 id="02-protmail-cmyaml"><a class="markdownIt-Anchor" href="#02-protmail-cmyaml"></a> 02-protmail-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">promtail</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">promtail.yaml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    client:      # 配置Promtail如何连接到Loki的实例</span><br><span class="hljs-string">      backoff_config:      # 配置当请求失败时如何重试请求给Loki</span><br><span class="hljs-string">        max_period: 5m </span><br><span class="hljs-string">        max_retries: 10</span><br><span class="hljs-string">        min_period: 500ms</span><br><span class="hljs-string">      batchsize: 1048576      # 发送给Loki的最大批次大小(以字节为单位)</span><br><span class="hljs-string">      batchwait: 1s      # 发送批处理前等待的最大时间（即使批次大小未达到最大值）</span><br><span class="hljs-string">      external_labels: &#123;&#125;      # 所有发送给Loki的日志添加静态标签</span><br><span class="hljs-string">      timeout: 10s      # 等待服务器响应请求的最大时间</span><br><span class="hljs-string">    positions:</span><br><span class="hljs-string">      filename: /run/promtail/positions.yaml</span><br><span class="hljs-string">    server:</span><br><span class="hljs-string">      http_listen_port: 3101</span><br><span class="hljs-string">    target_config:</span><br><span class="hljs-string">      sync_period: 10s</span><br><span class="hljs-string">    scrape_configs:</span><br><span class="hljs-string">    - job_name: kubernetes-pods-name</span><br><span class="hljs-string">      pipeline_stages:</span><br><span class="hljs-string">        - docker: &#123;&#125;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">        - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_name</span><br><span class="hljs-string">        target_label: __service__</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_node_name</span><br><span class="hljs-string">        target_label: __host__</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">        target_label: job</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        target_label: namespace</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_name</span><br><span class="hljs-string">        target_label: pod</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: container</span><br><span class="hljs-string">      - replacement: /var/log/pods/*$1/*.log</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_uid</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: __path__</span><br><span class="hljs-string">    - job_name: kubernetes-pods-app</span><br><span class="hljs-string">      pipeline_stages:</span><br><span class="hljs-string">        - docker: &#123;&#125;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: .+</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_name</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_app</span><br><span class="hljs-string">        target_label: __service__</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_node_name</span><br><span class="hljs-string">        target_label: __host__</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">        target_label: job</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        target_label: namespace</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_name</span><br><span class="hljs-string">        target_label: pod</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: container</span><br><span class="hljs-string">      - replacement: /var/log/pods/*$1/*.log</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_uid</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: __path__</span><br><span class="hljs-string">    - job_name: kubernetes-pods-direct-controllers</span><br><span class="hljs-string">      pipeline_stages:</span><br><span class="hljs-string">        - docker: &#123;&#125;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: .+</span><br><span class="hljs-string">        separator: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_name</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_app</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;[0-9a-z-.]+-[0-9a-f]&#123;8,10&#125;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_controller_name</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_controller_name</span><br><span class="hljs-string">        target_label: __service__</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_node_name</span><br><span class="hljs-string">        target_label: __host__</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">        target_label: job</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        target_label: namespace</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_name</span><br><span class="hljs-string">        target_label: pod</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: container</span><br><span class="hljs-string">      - replacement: /var/log/pods/*$1/*.log</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_uid</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: __path__</span><br><span class="hljs-string">    - job_name: kubernetes-pods-indirect-controller</span><br><span class="hljs-string">      pipeline_stages:</span><br><span class="hljs-string">        - docker: &#123;&#125;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: .+</span><br><span class="hljs-string">        separator: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_name</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_app</span><br><span class="hljs-string">      - action: keep</span><br><span class="hljs-string">        regex: &#x27;[0-9a-z-.]+-[0-9a-f]&#123;8,10&#125;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_controller_name</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        regex: &#x27;([0-9a-z-.]+)-[0-9a-f]&#123;8,10&#125;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_controller_name</span><br><span class="hljs-string">        target_label: __service__</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_node_name</span><br><span class="hljs-string">        target_label: __host__</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">        target_label: job</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        target_label: namespace</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_name</span><br><span class="hljs-string">        target_label: pod</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: container</span><br><span class="hljs-string">      - replacement: /var/log/pods/*$1/*.log</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_uid</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: __path__</span><br><span class="hljs-string">    - job_name: kubernetes-pods-static</span><br><span class="hljs-string">      pipeline_stages:</span><br><span class="hljs-string">        - docker: &#123;&#125;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_label_component</span><br><span class="hljs-string">        target_label: __service__</span><br><span class="hljs-string">      - source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_node_name</span><br><span class="hljs-string">        target_label: __host__</span><br><span class="hljs-string">      - action: drop</span><br><span class="hljs-string">        regex: &#x27;&#x27;</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        - __service__</span><br><span class="hljs-string">        target_label: job</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_namespace</span><br><span class="hljs-string">        target_label: namespace</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_name</span><br><span class="hljs-string">        target_label: pod</span><br><span class="hljs-string">      - action: replace</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: container</span><br><span class="hljs-string">      - replacement: /var/log/pods/*$1/*.log</span><br><span class="hljs-string">        separator: /</span><br><span class="hljs-string">        source_labels:</span><br><span class="hljs-string">        - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror</span><br><span class="hljs-string">        - __meta_kubernetes_pod_container_name</span><br><span class="hljs-string">        target_label: __path__</span><br></code></pre></td></tr></table></figure><h3 id="03-promtail-dsyaml"><a class="markdownIt-Anchor" href="#03-promtail-dsyaml"></a> 03-promtail-ds.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment">#1. client.url  loki地址</span><br><span class="hljs-comment">#2. volume docker挂载路径</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">promtail</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">promtail</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">promtail</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">promtail</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">promtail</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/promtail</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-string">-config.file=/etc/promtail/promtail.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">-client.url=http://loki:3100/loki/api/v1/push</span><br>          <span class="hljs-attr">env:</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">HOSTNAME</span><br>              <span class="hljs-attr">valueFrom:</span> <br>                <span class="hljs-attr">fieldRef:</span> <br>                  <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br>                  <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">spec.nodeName</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-promtail</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">3101</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/promtail</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/run/promtail</span>              <br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">docker</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data/docker/containers</span>             <br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pods</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log/pods</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">securityContext:</span><br>            <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">0</span><br>            <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">0</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-promtail</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">tolerations:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>          <span class="hljs-attr">key:</span> <span class="hljs-string">node-role.kubernetes.io/master</span><br>          <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">loki-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">defaultMode:</span> <span class="hljs-number">420</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">promtail-config</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/run/promtail</span><br>            <span class="hljs-attr">type:</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">docker</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/data/docker/containers</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pods</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log/pods</span><br></code></pre></td></tr></table></figure><blockquote><p>部署完成后需要在Grafana中添加Loki数据源，添加地址为&lt;loki_svc_name&gt;(.&lt;loki_namspace_name&gt;.svc.clster.local):&lt;loki_svc_port&gt;。</p></blockquote><h1 id="监控"><a class="markdownIt-Anchor" href="#监控"></a> 监控</h1><blockquote><p>除了普通Prometheus之外，对于多个Prometheus，添加Thanos方案。</p></blockquote><h2 id="alertmanager"><a class="markdownIt-Anchor" href="#alertmanager"></a> Alertmanager</h2><h3 id="01-alertmanager-cmyaml"><a class="markdownIt-Anchor" href="#01-alertmanager-cmyaml"></a> 01-alertmanager-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、邮箱smtp等账户信息</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">alertmanager.yml:</span> <span class="hljs-string">|-</span><br><span class="hljs-string">    # 发送邮箱配置</span><br><span class="hljs-string">    global:</span><br><span class="hljs-string">      resolve_timeout: 1m</span><br><span class="hljs-string">      #用于发送邮件的邮箱的SMTP服务器地址+端口</span><br><span class="hljs-string">      smtp_smarthost: &#x27;smtp.163.com:25&#x27;</span><br><span class="hljs-string">      # 从哪个邮箱发送报警</span><br><span class="hljs-string">      smtp_from: &#x27;&lt;mail_address&gt;&#x27;</span><br><span class="hljs-string">      # 发送邮箱的认证用户，不是邮箱名</span><br><span class="hljs-string">      smtp_auth_username: &#x27;&lt;user_name&gt;&#x27;</span><br><span class="hljs-string">      # 发送邮箱的授权码而不是登录密码</span><br><span class="hljs-string">      smtp_auth_password: &#x27;poxuwotjhdbybdfb&#x27;</span><br><span class="hljs-string">      smtp_require_tls: false</span><br><span class="hljs-string">    route:</span><br><span class="hljs-string">      group_by: [alertname]</span><br><span class="hljs-string">      group_wait: 10s</span><br><span class="hljs-string">      group_interval: 10s</span><br><span class="hljs-string">      repeat_interval: 10m</span><br><span class="hljs-string">      receiver: public</span><br><span class="hljs-string">    # 接收邮箱配置</span><br><span class="hljs-string">    receivers:</span><br><span class="hljs-string">    - name: &#x27;public&#x27;</span><br><span class="hljs-string">      # 接收邮箱地址</span><br><span class="hljs-string">      email_configs:</span><br><span class="hljs-string">      - to: &#x27;&lt;mail_address&gt;&#x27;</span><br><span class="hljs-string">        send_resolved: true</span><br></code></pre></td></tr></table></figure><h3 id="02-alertmanager-pvcyaml"><a class="markdownIt-Anchor" href="#02-alertmanager-pvcyaml"></a> 02-alertmanager-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、storage 存储大小</span><br><span class="hljs-comment"># 2、storageclass 名称</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager-data</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br></code></pre></td></tr></table></figure><h3 id="03-alertmanager-deployyaml"><a class="markdownIt-Anchor" href="#03-alertmanager-deployyaml"></a> 03-alertmanager-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">alertmanager</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">alertmanager</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">alertmanager</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">prom/alertmanager</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--config.file=/etc/config/alertmanager.yml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.path=/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--cluster.advertise-address=0.0.0.0:9093</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-alert</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9093</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/#/status</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">9093</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">30</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">500m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">2500Mi</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alert-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/config</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alert-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&quot;/data&quot;</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alert-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager-config</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alert-data-volume</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">alertmanager-data</span><br></code></pre></td></tr></table></figure><h3 id="04-alertmanager-svcyaml"><a class="markdownIt-Anchor" href="#04-alertmanager-svcyaml"></a> 04-alertmanager-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">alertmanager</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9093</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-alert</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">alertmanager</span><br></code></pre></td></tr></table></figure><h2 id="metrics"><a class="markdownIt-Anchor" href="#metrics"></a> Metrics</h2><h3 id="node-exporter"><a class="markdownIt-Anchor" href="#node-exporter"></a> Node-Exporter</h3><h4 id="01-node-exporter-dsyaml"><a class="markdownIt-Anchor" href="#01-node-exporter-dsyaml"></a> 01-node-exporter-ds.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">node-exporter</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">node-exporter</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">node-exporter</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">node-exporter</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">hostPID:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">hostIPC:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">node-exporter</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">prom/node-exporter</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">args:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--path.procfs</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">/host/proc</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--path.sysfs</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">/host/sys</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--path.rootfs</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">/host/root</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--collector.filesystem.ignored-mount-points</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&quot;^/(sys|proc|dev|host|etc)($|/)&quot;&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;--collector.processes&quot;</span><br>        <span class="hljs-attr">ports:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-node</span><br>            <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9100</span><br>            <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">2000m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">2Gi</span>        <br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">volumeMounts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dev</span><br>            <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/host/dev</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">proc</span><br>            <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/host/proc</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sys</span><br>            <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/host/sys</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rootfs</span><br>            <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/host/root</span><br>      <span class="hljs-attr">tolerations:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;node-role.kubernetes.io/master&quot;</span><br>          <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>          <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoSchedule&quot;</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">proc</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/proc</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dev</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/dev</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sys</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/sys</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rootfs</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br></code></pre></td></tr></table></figure><h4 id="02-node-exporter-svcyaml可以省略"><a class="markdownIt-Anchor" href="#02-node-exporter-svcyaml可以省略"></a> 02-node-exporter-svc.yaml（可以省略）</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">node-exporter</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">node-exporter</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">node-exporter-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9100</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-node</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">node-exporter</span><br></code></pre></td></tr></table></figure><h3 id="blackbox-exporter"><a class="markdownIt-Anchor" href="#blackbox-exporter"></a> Blackbox-Exporter</h3><h4 id="01-blackbox-exporter-cmyaml"><a class="markdownIt-Anchor" href="#01-blackbox-exporter-cmyaml"></a> 01-blackbox-exporter-cm.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span> <br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">blackbox-exporter</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">blackbox.yml:</span> <span class="hljs-string">|-</span><br><span class="hljs-string">    modules:</span><br><span class="hljs-string">      http_2xx:</span><br><span class="hljs-string">        prober: http</span><br><span class="hljs-string">        timeout: 10s</span><br><span class="hljs-string">        http:</span><br><span class="hljs-string">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="hljs-string">          valid_status_codes: []</span><br><span class="hljs-string">          method: GET</span><br><span class="hljs-string">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="hljs-string">      http_post_2xx:</span><br><span class="hljs-string">        prober: http</span><br><span class="hljs-string">        timeout: 10s</span><br><span class="hljs-string">        http:</span><br><span class="hljs-string">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="hljs-string">          method: POST</span><br><span class="hljs-string">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="hljs-string">      tcp_connect:</span><br><span class="hljs-string">        prober: tcp</span><br><span class="hljs-string">        timeout: 10s</span><br><span class="hljs-string">      icmp:</span><br><span class="hljs-string">        prober: icmp</span><br><span class="hljs-string">        timeout: 10s</span><br><span class="hljs-string">        icmp:</span><br><span class="hljs-string">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="hljs-string">      dns: </span><br><span class="hljs-string">        prober: dns</span><br><span class="hljs-string">        dns:</span><br><span class="hljs-string">          transport_protocol: &quot;tcp&quot; </span><br><span class="hljs-string">          preferred_ip_protocol: &quot;ip4&quot; </span><br><span class="hljs-string">          query_name: &quot;kubernetes.default.svc.cluster.local&quot;</span><br></code></pre></td></tr></table></figure><h4 id="02-blackbox-exporter-deployyaml"><a class="markdownIt-Anchor" href="#02-blackbox-exporter-deployyaml"></a> 02-blackbox-exporter-deploy.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---  </span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span> <br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">blackbox-exporter</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">blackbox-exporter</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">blackbox-exporter</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">prom/blackbox-exporter</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">args:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--config.file=/etc/blackbox_exporter/blackbox.yml</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--web.listen-address=:9115</span><br>        <span class="hljs-attr">ports:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-blackbox</span><br>            <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9115</span><br>            <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-attr">readinessProbe:</span><br>          <span class="hljs-attr">tcpSocket:</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-number">9115</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">50Mi</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">60Mi</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">200m</span><br>        <span class="hljs-attr">volumeMounts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-config-volume</span><br>            <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/blackbox_exporter</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter-config</span><br></code></pre></td></tr></table></figure><h4 id="03-blackbox-exporter-svcyaml"><a class="markdownIt-Anchor" href="#03-blackbox-exporter-svcyaml"></a> 03-blackbox-exporter-svc.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">blackbox-exporter-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9115</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-blackbox</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">blackbox-exporter</span><br></code></pre></td></tr></table></figure><h3 id="kube-state-metrics"><a class="markdownIt-Anchor" href="#kube-state-metrics"></a> Kube-State-Metrics</h3><h4 id="01-kube-state-metrics-rbacyaml"><a class="markdownIt-Anchor" href="#01-kube-state-metrics-rbacyaml"></a> 01-kube-state-metrics-rbac.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">configmaps</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">secrets</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">serviceaccounts</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">resourcequotas</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">replicationcontrollers</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">limitranges</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">persistentvolumeclaims</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">persistentvolumes</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">namespaces</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">apps</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">statefulsets</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">daemonsets</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">deployments</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">replicasets</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">batch</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">cronjobs</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">jobs</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">autoscaling</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">horizontalpodautoscalers</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">authentication.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">tokenreviews</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">create</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">authorization.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">subjectaccessreviews</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">create</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">policy</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">poddisruptionbudgets</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">certificates.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">certificatesigningrequests</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">discovery.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpointslices</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">storage.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">storageclasses</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">volumeattachments</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">admissionregistration.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mutatingwebhookconfigurations</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">validatingwebhookconfigurations</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">networking.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">networkpolicies</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingressclasses</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">coordination.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">leases</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">clusterrolebindings</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">clusterroles</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">rolebindings</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">roles</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure><h4 id="02-kube-state-metrics-deployyaml"><a class="markdownIt-Anchor" href="#02-kube-state-metrics-deployyaml"></a> 02-kube-state-metrics-deploy.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span> <br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kube-state-metrics</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">kube-state-metrics</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">automountServiceAccountToken:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">kube-state-metrics</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">kubesphere/kube-state-metrics:v2.8.0</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">livenessProbe:</span><br>          <span class="hljs-attr">httpGet:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/healthz</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">ports:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-metrics</span><br>            <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span><br>            <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">telemetry</span><br>            <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8081</span><br>            <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-attr">readinessProbe:</span><br>          <span class="hljs-attr">httpGet:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">capabilities:</span><br>            <span class="hljs-attr">drop:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">ALL</span><br>          <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">65534</span><br></code></pre></td></tr></table></figure><h4 id="03-kube-state-metrics-svcyaml"><a class="markdownIt-Anchor" href="#03-kube-state-metrics-svcyaml"></a> 03-kube-state-metrics-svc.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span> <br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kube-state-metrics</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metrics-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-metrics</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">telemetry</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">telemetry</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kube-state-metrics</span><br></code></pre></td></tr></table></figure><h2 id="prometheus"><a class="markdownIt-Anchor" href="#prometheus"></a> Prometheus</h2><h3 id="a-idrbac01-prometheus-rbacyamla"><a class="markdownIt-Anchor" href="#a-idrbac01-prometheus-rbacyamla"></a> <a id="rbac">01-prometheus-rbac.yaml</a></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes/proxy</span><br>    <span class="hljs-attr">verbs:</span> <br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;extensions&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses</span><br>    <span class="hljs-attr">verbs:</span> <br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">configmaps</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes/metrics</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">nonResourceURLs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/metrics</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure><h3 id="02-prometheus-cmyaml"><a class="markdownIt-Anchor" href="#02-prometheus-cmyaml"></a> 02-prometheus-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、target url地址</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">prometheus.yml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    global:</span><br><span class="hljs-string">      scrape_interval:     15s</span><br><span class="hljs-string">      evaluation_interval: 15s</span><br><span class="hljs-string">    rule_files:</span><br><span class="hljs-string">    - /etc/prometheus/rules/*.yml</span><br><span class="hljs-string">    alerting:</span><br><span class="hljs-string">      alertmanagers:</span><br><span class="hljs-string">      - static_configs:</span><br><span class="hljs-string">        - targets: [&quot;alertmanager:9093&quot;]</span><br><span class="hljs-string">    scrape_configs:</span><br><span class="hljs-string">    - job_name: &#x27;loki&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 15s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: http</span><br><span class="hljs-string">      follow_redirects: true</span><br><span class="hljs-string">      enable_http2: true</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">      - targets:</span><br><span class="hljs-string">        - loki.logging.svc.cluster.local:3100</span><br><span class="hljs-string">    - job_name: &#x27;node-exporter&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__address__]</span><br><span class="hljs-string">        regex: &#x27;(.*):10250&#x27;</span><br><span class="hljs-string">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span><br><span class="hljs-string">        target_label: __address__</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">        target_label: node      </span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_address_InternalIP]</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">        target_label: ip</span><br><span class="hljs-string">    - job_name: &#x27;blackbox-exporter&#x27;</span><br><span class="hljs-string">      metrics_path: /probe</span><br><span class="hljs-string">      params:</span><br><span class="hljs-string">        module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">        - targets:</span><br><span class="hljs-string">          - https://prometheus.io    # Target to probe with http.</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">        - source_labels: [__address__]</span><br><span class="hljs-string">          target_label: __param_target</span><br><span class="hljs-string">        - source_labels: [__param_target]</span><br><span class="hljs-string">          target_label: instance</span><br><span class="hljs-string">        - target_label: __address__</span><br><span class="hljs-string">          replacement: blackbox-exporter:9115  # The blackbox exporter&#x27;s real hostname:port.</span><br><span class="hljs-string">    - job_name: &#x27;blackbox_tcp_connect&#x27;</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      metrics_path: /probe</span><br><span class="hljs-string">      params:</span><br><span class="hljs-string">        module: [tcp_connect]</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">        - targets:</span><br><span class="hljs-string">          - prometheus:9090</span><br><span class="hljs-string">          - alertmanager:9093</span><br><span class="hljs-string">          - grafana.public.svc.cluster.local:3000</span><br><span class="hljs-string">          - loki.logging.svc.cluster.local:3100</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">        - source_labels: [__address__]</span><br><span class="hljs-string">          target_label: __param_target</span><br><span class="hljs-string">        - source_labels: [__param_target]</span><br><span class="hljs-string">          target_label: instance</span><br><span class="hljs-string">        - target_label: __address__</span><br><span class="hljs-string">          replacement: blackbox-exporter:9115 # blackbox-exporter 服务所在的机器和端口</span><br><span class="hljs-string">    - job_name: &quot;kube-state-metrics&quot; </span><br><span class="hljs-string">      static_configs: </span><br><span class="hljs-string">        - targets: [&quot;kube-state-metrics:8080&quot;]</span><br><span class="hljs-string">    - job_name: &#x27;kube-nodes-cadvisor&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: labelmap</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: /metrics/cadvisor</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">    - job_name: &#x27;kube-pods&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: http</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: &quot;true&quot;</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.+)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: ([^:]+)(?::d+)?;(d+)</span><br><span class="hljs-string">        target_label: __address__</span><br><span class="hljs-string">        replacement:  &lt;img src=&quot;https://www.zhihu.com/equation?tex=1:&quot; alt=&quot;1:&quot; class=&quot;ee_img tr_noresize&quot; eeimg=&quot;1&quot;&gt; 2</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: labelmap</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: kubernetes_namespace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: kubernetes_pod_name</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">    - job_name: &#x27;kube-kubelet&#x27;</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">      - target_label: __address__</span><br><span class="hljs-string">        replacement: kubernetes.default.svc:443</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="hljs-string">        regex: (.+)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics</span><br><span class="hljs-string">    - job_name: &#x27;kube-apiservers&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: default;kubernetes;https</span><br><span class="hljs-string">    - job_name: &#x27;kube-scheduler&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      authorization:</span><br><span class="hljs-string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: kube-system;kube-scheduler;https</span><br><span class="hljs-string">    - job_name: &#x27;kube-controller-manager&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      authorization:</span><br><span class="hljs-string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: kube-system;kube-controller-manager;https</span><br></code></pre></td></tr></table></figure><h3 id="a-idrules03-prometheus-rules-cmyamla"><a class="markdownIt-Anchor" href="#a-idrules03-prometheus-rules-cmyamla"></a> <a id="rules">03-prometheus-rules-cm.yaml</a></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">rules.yml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    groups:</span><br><span class="hljs-string">    - name: hostStatsAlert</span><br><span class="hljs-string">      rules:</span><br><span class="hljs-string">      - alert: hostCpuUsageAlert</span><br><span class="hljs-string">        expr: sum(avg without (cpu)(irate(node_cpu&#123;mode!=&#x27;idle&#x27;&#125;[5m]))) by (instance) &gt; 0.85</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125; CPU usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="hljs-string">      - alert: hostMemUsageAlert</span><br><span class="hljs-string">        expr: (node_memory_MemTotal - node_memory_MemAvailable)/node_memory_MemTotal &gt; 0.85</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125; MEM usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="hljs-string">      - alert: OutOfInodes</span><br><span class="hljs-string">        expr: node_filesystem_free&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/&quot;&#125; / node_filesystem_size&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/&quot;&#125; * 100 &lt; 10</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Out of inodes (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk is almost running out of available inodes (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: OutOfDiskSpace</span><br><span class="hljs-string">        expr: node_filesystem_free&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/rootfs&quot;&#125; / node_filesystem_size&#123;fstype=&quot;overlay&quot;,mountpoint =&quot;/rootfs&quot;&#125; * 100 &lt; 10</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Out of disk space (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk is almost full (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualNetworkThroughputIn</span><br><span class="hljs-string">        expr: sum by (instance) (irate(node_network_receive_bytes[2m])) / 1024 / 1024 &gt; 100</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual network throughput in (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Host network interfaces are probably receiving too much data (&gt; 100 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualNetworkThroughputOut</span><br><span class="hljs-string">        expr: sum by (instance) (irate(node_network_transmit_bytes[2m])) / 1024 / 1024 &gt; 100</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual network throughput out (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Host network interfaces are probably sending too much data (&gt; 100 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualDiskReadRate</span><br><span class="hljs-string">        expr: sum by (instance) (irate(node_disk_bytes_read[2m])) / 1024 / 1024 &gt; 50</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual disk read rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk is probably reading too much data (&gt; 50 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualDiskWriteRate</span><br><span class="hljs-string">        expr: sum by (instance) (irate(node_disk_bytes_written[2m])) / 1024 / 1024 &gt; 50</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual disk write rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk is probably writing too much data (&gt; 50 MB/s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualDiskReadLatency</span><br><span class="hljs-string">        expr: rate(node_disk_read_time_ms[1m]) / rate(node_disk_reads_completed[1m]) &gt; 100</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual disk read latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk latency is growing (read operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: UnusualDiskWriteLatency</span><br><span class="hljs-string">        expr: rate(node_disk_write_time_ms[1m]) / rate(node_disk_writes_completedl[1m]) &gt; 100</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Unusual disk write latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Disk latency is growing (write operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">    - name: http_status</span><br><span class="hljs-string">      rules:</span><br><span class="hljs-string">      - alert: ProbeFailed</span><br><span class="hljs-string">        expr: probe_success == 0</span><br><span class="hljs-string">        for: 1m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: error</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Probe failed (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Probe failed (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: StatusCode</span><br><span class="hljs-string">        expr: probe_http_status_code &lt;= 199 OR probe_http_status_code &gt;= 400</span><br><span class="hljs-string">        for: 1m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: error</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Status Code (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;HTTP status code is not 200-399 (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: SslCertificateWillExpireSoon</span><br><span class="hljs-string">        expr: probe_ssl_earliest_cert_expiry - time() &lt; 86400 * 30</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;SSL certificate will expire soon (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;SSL certificate expires in 30 days (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: SslCertificateHasExpired</span><br><span class="hljs-string">        expr: probe_ssl_earliest_cert_expiry - time()  &lt;= 0</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: error</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;SSL certificate has expired (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;SSL certificate has expired already (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: BlackboxSlowPing</span><br><span class="hljs-string">        expr: probe_icmp_duration_seconds &gt; 2</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Blackbox slow ping (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Blackbox ping took more than 2s (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: BlackboxSlowRequests</span><br><span class="hljs-string">        expr: probe_http_duration_seconds &gt; 2 </span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Blackbox slow requests (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="hljs-string">          description: &quot;Blackbox request took more than 2s (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="hljs-string">      - alert: PodCpuUsagePercent</span><br><span class="hljs-string">        expr: sum(sum(label_replace(irate(container_cpu_usage_seconds_total[1m]),&quot;pod&quot;,&quot;$1&quot;,&quot;container_label_io_kubernetes_pod_name&quot;, &quot;(.*)&quot;))by(pod) / on(pod) group_right kube_pod_container_resource_limits_cpu_cores *100 )by(container,namespace,node,pod,severity) &gt; 80</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Pod cpu usage percent has exceeded 80% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="hljs-string">      - alert: PodMemoryUsagePercent</span><br><span class="hljs-string">        expr: sum(label_replace(container_memory_working_set_bytes,&quot;pod&quot;,&quot;$1&quot;,&quot;container_label_io_kubernetes_pod_name&quot;, &quot;(.*)&quot;) / on(pod) group_left kube_pod_container_resource_limits_memory_bytes&#123;pod!~&quot;prometheus.*|filebeat.*&quot;&#125;)by(pod) * 100 &gt; 80</span><br><span class="hljs-string">        for: 5m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: warning</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          summary: &quot;Pod emory usage percent has exceeded 80% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="hljs-string">    - name: kube-state-metrics</span><br><span class="hljs-string">      rules:</span><br><span class="hljs-string">      - alert: KubeStateMetricsListErrors</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          description: kube-state-metrics is experiencing errors at an elevated rate in list operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.</span><br><span class="hljs-string">          summary: kube-state-metrics is experiencing errors in list operations.</span><br><span class="hljs-string">        expr: |</span><br><span class="hljs-string">          (sum(rate(kube_state_metrics_list_total&#123;job=&quot;kube-state-metrics&quot;,result=&quot;error&quot;&#125;[5m]))</span><br><span class="hljs-string">            /</span><br><span class="hljs-string">          sum(rate(kube_state_metrics_list_total&#123;job=&quot;kube-state-metrics&quot;&#125;[5m])))</span><br><span class="hljs-string">          &gt; 0.01</span><br><span class="hljs-string">        for: 15m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: critical</span><br><span class="hljs-string">      - alert: KubeStateMetricsWatchErrors</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          description: kube-state-metrics is experiencing errors at an elevated rate in watch operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.</span><br><span class="hljs-string">          summary: kube-state-metrics is experiencing errors in watch operations.</span><br><span class="hljs-string">        expr: |</span><br><span class="hljs-string">          (sum(rate(kube_state_metrics_watch_total&#123;job=&quot;kube-state-metrics&quot;,result=&quot;error&quot;&#125;[5m]))</span><br><span class="hljs-string">            /</span><br><span class="hljs-string">          sum(rate(kube_state_metrics_watch_total&#123;job=&quot;kube-state-metrics&quot;&#125;[5m])))</span><br><span class="hljs-string">          &gt; 0.01</span><br><span class="hljs-string">        for: 15m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: critical</span><br><span class="hljs-string">      - alert: KubeStateMetricsShardingMismatch</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          description: kube-state-metrics pods are running with different --total-shards configuration, some Kubernetes objects may be exposed multiple times or not exposed at all.</span><br><span class="hljs-string">          summary: kube-state-metrics sharding is misconfigured.</span><br><span class="hljs-string">        expr: |</span><br><span class="hljs-string">          stdvar (kube_state_metrics_total_shards&#123;job=&quot;kube-state-metrics&quot;&#125;) != 0</span><br><span class="hljs-string">        for: 15m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: critical</span><br><span class="hljs-string">      - alert: KubeStateMetricsShardsMissing</span><br><span class="hljs-string">        annotations:</span><br><span class="hljs-string">          description: kube-state-metrics shards are missing, some Kubernetes objects are not being exposed.</span><br><span class="hljs-string">          summary: kube-state-metrics shards are missing.</span><br><span class="hljs-string">        expr: |</span><br><span class="hljs-string">          2^max(kube_state_metrics_total_shards&#123;job=&quot;kube-state-metrics&quot;&#125;) - 1</span><br><span class="hljs-string">            -</span><br><span class="hljs-string">          sum( 2 ^ max by (shard_ordinal) (kube_state_metrics_shard_ordinal&#123;job=&quot;kube-state-metrics&quot;&#125;) )</span><br><span class="hljs-string">          != 0</span><br><span class="hljs-string">        for: 15m</span><br><span class="hljs-string">        labels:</span><br><span class="hljs-string">          severity: critical</span><br></code></pre></td></tr></table></figure><h3 id="04-prometheus-pvcyaml"><a class="markdownIt-Anchor" href="#04-prometheus-pvcyaml"></a> 04-prometheus-pvc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、storage 存储大小</span><br><span class="hljs-comment"># 2、storageclass 名称</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br></code></pre></td></tr></table></figure><h3 id="05-prometheus-deployyaml"><a class="markdownIt-Anchor" href="#05-prometheus-deployyaml"></a> 05-prometheus-deploy.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">prometheus</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--config.file=/etc/prometheus/config_out/prometheus.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.path=/prometheus/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.retention=24h</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--web.enable-lifecycle</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-p8s</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9090</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">500m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">2500Mi</span> <br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/config_out</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/rules</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/prometheus/data</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config</span>   <br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-config</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data-volume</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">prometheus-data</span><br></code></pre></td></tr></table></figure><h3 id="06-prometheus-svcyaml"><a class="markdownIt-Anchor" href="#06-prometheus-svcyaml"></a> 06-prometheus-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9090</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-p8s</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31003</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br></code></pre></td></tr></table></figure><h2 id="thanos"><a class="markdownIt-Anchor" href="#thanos"></a> Thanos</h2><blockquote><p>本文采用sidecar模式，把prometheus和sider服务部署在一起，query服务提供跟prometheus一样的查询界面，store服务储存到minio，compact服务压缩数据文件，因为prometheus已经配置rule告警规则，故thanos的rules服务不在部署，仅供参考。（如果部署rules的话，可以在query界面中既包含prometheus本身的告警规则，也可以看到rules服务的规则），详情参考 <a href="https://github.com/thanos-io/kube-thanos/tree/main/examples/all/manifests">Thanos-io/kube-thanso</a></p></blockquote><h3 id="01-prometheus-rbacyaml"><a class="markdownIt-Anchor" href="#01-prometheus-rbacyaml"></a> 01-prometheus-rbac.yaml</h3><blockquote><p>和 <a href="#rbac">prometheus的rbac</a> 保持一致即可</p></blockquote><h3 id="02-prometheus-tp-cmyaml"><a class="markdownIt-Anchor" href="#02-prometheus-tp-cmyaml"></a> 02-prometheus-tp-cm.yaml</h3><blockquote><p>可以由稍后的 <code>05-prometheus-sidecar-sts.yaml</code> 看出，prometheus 仅提供 <code>后缀为tmpl的模版配置文件</code> 由 sidecar 解析后生成  <code>后缀为yaml的标准配置文件</code> ，所以此configmap只是文件名不同，配置项也和prometheus的一致。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 除K8S属性如namespace外的修改点</span><br><span class="hljs-comment"># 1、target url地址</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-tmpl</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">prometheus.yaml.tmpl:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    global:</span><br><span class="hljs-string">      scrape_interval:     15s</span><br><span class="hljs-string">      evaluation_interval: 15s</span><br><span class="hljs-string">      external_labels:</span><br><span class="hljs-string">        cluster: prometheus-ha</span><br><span class="hljs-string">        replica: $(POD_NAME)</span><br><span class="hljs-string">    rule_files:</span><br><span class="hljs-string">    - /etc/prometheus/rules/*.yml</span><br><span class="hljs-string">    alerting:</span><br><span class="hljs-string">      alertmanagers:</span><br><span class="hljs-string">      - static_configs:</span><br><span class="hljs-string">        - targets: [&quot;alertmanager:9093&quot;]</span><br><span class="hljs-string">    scrape_configs:</span><br><span class="hljs-string">    - job_name: &#x27;loki&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 15s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: http</span><br><span class="hljs-string">      follow_redirects: true</span><br><span class="hljs-string">      enable_http2: true</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">      - targets:</span><br><span class="hljs-string">        - loki.tecorigin-logging.svc.cluster.local:3100</span><br><span class="hljs-string">    - job_name: &#x27;node-exporter&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__address__]</span><br><span class="hljs-string">        regex: &#x27;(.*):10250&#x27;</span><br><span class="hljs-string">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span><br><span class="hljs-string">        target_label: __address__</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">        target_label: node      </span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_address_InternalIP]</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">        target_label: ip</span><br><span class="hljs-string">    - job_name: &#x27;blackbox-exporter&#x27;</span><br><span class="hljs-string">      metrics_path: /probe</span><br><span class="hljs-string">      params:</span><br><span class="hljs-string">        module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">        - targets:</span><br><span class="hljs-string">          - https://prometheus.io    # Target to probe with http.</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">        - source_labels: [__address__]</span><br><span class="hljs-string">          target_label: __param_target</span><br><span class="hljs-string">        - source_labels: [__param_target]</span><br><span class="hljs-string">          target_label: instance</span><br><span class="hljs-string">        - target_label: __address__</span><br><span class="hljs-string">          replacement: blackbox-exporter:9115  # The blackbox exporter&#x27;s real hostname:port.</span><br><span class="hljs-string">    - job_name: &#x27;blackbox_tcp_connect&#x27;</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      metrics_path: /probe</span><br><span class="hljs-string">      params:</span><br><span class="hljs-string">        module: [tcp_connect]</span><br><span class="hljs-string">      static_configs:</span><br><span class="hljs-string">        - targets:</span><br><span class="hljs-string">          - prometheus:9090</span><br><span class="hljs-string">          - alertmanager:9093</span><br><span class="hljs-string">          - grafana.tecorigin.svc.cluster.local:3000</span><br><span class="hljs-string">          - loki.tecorigin-logging.svc.cluster.local:3100</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">        - source_labels: [__address__]</span><br><span class="hljs-string">          target_label: __param_target</span><br><span class="hljs-string">        - source_labels: [__param_target]</span><br><span class="hljs-string">          target_label: instance</span><br><span class="hljs-string">        - target_label: __address__</span><br><span class="hljs-string">          replacement: blackbox-exporter:9115 # blackbox-exporter 服务所在的机器和端口</span><br><span class="hljs-string">    - job_name: &quot;kube-state-metrics&quot; </span><br><span class="hljs-string">      static_configs: </span><br><span class="hljs-string">        - targets: [&quot;kube-state-metrics:8080&quot;]</span><br><span class="hljs-string">    - job_name: &#x27;kube-nodes-cadvisor&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: labelmap</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: /metrics/cadvisor</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">    - job_name: &#x27;kube-pods&#x27;</span><br><span class="hljs-string">      honor_timestamps: true</span><br><span class="hljs-string">      scrape_interval: 30s</span><br><span class="hljs-string">      scrape_timeout: 10s</span><br><span class="hljs-string">      metrics_path: /metrics</span><br><span class="hljs-string">      scheme: http</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: pod</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: &quot;true&quot;</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.+)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: ([^:]+)(?::d+)?;(d+)</span><br><span class="hljs-string">        target_label: __address__</span><br><span class="hljs-string">        replacement:  &lt;img src=&quot;https://www.zhihu.com/equation?tex=1:&quot; alt=&quot;1:&quot; class=&quot;ee_img tr_noresize&quot; eeimg=&quot;1&quot;&gt; 2</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - separator: ;</span><br><span class="hljs-string">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: labelmap</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: kubernetes_namespace</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="hljs-string">        separator: ;</span><br><span class="hljs-string">        regex: (.*)</span><br><span class="hljs-string">        target_label: kubernetes_pod_name</span><br><span class="hljs-string">        replacement: $1</span><br><span class="hljs-string">        action: replace</span><br><span class="hljs-string">    - job_name: &#x27;kube-kubelet&#x27;</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: node</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - action: labelmap</span><br><span class="hljs-string">        regex: __meta_kubernetes_node_label_(.+)</span><br><span class="hljs-string">      - target_label: __address__</span><br><span class="hljs-string">        replacement: kubernetes.default.svc:443</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_node_name]</span><br><span class="hljs-string">        regex: (.+)</span><br><span class="hljs-string">        target_label: __metrics_path__</span><br><span class="hljs-string">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics</span><br><span class="hljs-string">    - job_name: &#x27;kube-apiservers&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: default;kubernetes;https</span><br><span class="hljs-string">    - job_name: &#x27;kube-scheduler&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      authorization:</span><br><span class="hljs-string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: kube-system;kube-scheduler;https</span><br><span class="hljs-string">    - job_name: &#x27;kube-controller-manager&#x27;</span><br><span class="hljs-string">      kubernetes_sd_configs:</span><br><span class="hljs-string">      - role: endpoints</span><br><span class="hljs-string">      scheme: https</span><br><span class="hljs-string">      tls_config:</span><br><span class="hljs-string">        insecure_skip_verify: true</span><br><span class="hljs-string">      authorization:</span><br><span class="hljs-string">        credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">      relabel_configs:</span><br><span class="hljs-string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="hljs-string">        action: keep</span><br><span class="hljs-string">        regex: kube-system;kube-controller-manager;https</span><br></code></pre></td></tr></table></figure><h3 id="03-prometheus-rules-cmyaml"><a class="markdownIt-Anchor" href="#03-prometheus-rules-cmyaml"></a> 03-prometheus-rules-cm.yaml</h3><blockquote><p>如果使用prometheus自己告警规则而不是thanos-rules的话，和  <a href="#rules">prometheus的保rules</a> 保持一致即可。</p></blockquote><h3 id="04-thanos-storage-secretyaml"><a class="markdownIt-Anchor" href="#04-thanos-storage-secretyaml"></a> 04-thanos-storage-secret.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span><br><span class="hljs-attr">stringData:</span><br>  <span class="hljs-attr">objectstorage.yaml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    type: S3</span><br><span class="hljs-string">    config:</span><br><span class="hljs-string">      endpoint: &quot;&lt;minio_svc_name&gt;(.&lt;minio_namspace_name&gt;.svc.cluster.local):&lt;minio_svc_port&gt;&quot;</span><br><span class="hljs-string">      bucket: &quot;&lt;bucket_name&gt;&quot;</span><br><span class="hljs-string">      access_key: &quot;&quot;</span><br><span class="hljs-string">      secret_key: &quot;&quot;</span><br><span class="hljs-string">      insecure: true  </span><br></code></pre></td></tr></table></figure><h3 id="05-prometheus-sidecar-stsyaml"><a class="markdownIt-Anchor" href="#05-prometheus-sidecar-stsyaml"></a> 05-prometheus-sidecar-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-sidecar</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus-sidecar</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">prometheus-sidebar-headless</span><br>  <span class="hljs-attr">podManagementPolicy:</span> <span class="hljs-string">Parallel</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus-sidecar</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus-sidecar</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">prometheus</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--config.file=/etc/prometheus/config_out/prometheus.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.path=/prometheus/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.retention=24h</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--web.enable-lifecycle</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.no-lockfile</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.min-block-duration=2h</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--storage.tsdb.max-block-duration=2h</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-p8s</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9090</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">6</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-p8s</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">120</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-p8s</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/config_out</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/rules</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/prometheus/data</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-sidecar</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/thanos/thanos:v0.30.2</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">sidecar</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.level=debug</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--tsdb.path=/prometheus/data</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--prometheus.url=http://127.0.0.1:9090</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--grpc-address=0.0.0.0:10901</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--http-address=0.0.0.0:10902</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--reloader.config-file=/etc/prometheus/config/prometheus.yaml.tmpl</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--reloader.config-envsubst-file=/etc/prometheus/config_out/prometheus.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--reloader.rule-dir=/etc/prometheus/rules/</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAME</span><br>              <span class="hljs-attr">valueFrom:</span><br>                <span class="hljs-attr">fieldRef:</span><br>                  <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10901</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10902</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-tmpl-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/config</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/config_out</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus/rules</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/thanos/objectstorage.yaml</span><br>              <span class="hljs-attr">subPath:</span> <span class="hljs-string">objectstorage.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/prometheus/data</span><br>      <span class="hljs-attr">securityContext:</span><br>        <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">2000</span><br>        <span class="hljs-attr">runAsNonRoot:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">1000</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-tmpl-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-tmpl</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config-volume</span><br>          <span class="hljs-attr">emptyDir:</span> &#123;&#125;<br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-rules-config</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>          <span class="hljs-attr">secret:</span><br>            <span class="hljs-attr">secretName:</span> <span class="hljs-string">thanos-objectstorage</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-data-volume</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span> <br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">20Gi</span><br></code></pre></td></tr></table></figure><h3 id="06-prometheus-sidecar-svcyaml"><a class="markdownIt-Anchor" href="#06-prometheus-sidecar-svcyaml"></a> 06-prometheus-sidecar-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-sidecar-headless</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus-sidecar</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10901</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">grpc</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10902</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus-sidecar</span><br></code></pre></td></tr></table></figure><h3 id="07-thanos-store-stsyaml"><a class="markdownIt-Anchor" href="#07-thanos-store-stsyaml"></a> 07-thanos-store-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-store</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">thanos-store-headless</span><br>  <span class="hljs-attr">podManagementPolicy:</span> <span class="hljs-string">Parallel</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-store</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/thanos/thanos:v0.30.2</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">store</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.level=debug</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--data-dir=/var/thanos/store</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--grpc-address=0.0.0.0:10901</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--http-address=0.0.0.0:10902</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10901</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10902</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">8</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">20</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.42</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">420Mi</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.123</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">123Mi</span><br>          <span class="hljs-attr">terminationMessagePolicy:</span> <span class="hljs-string">FallbackToLogsOnError</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/thanos/store</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-store-data</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/thanos/objectstorage.yaml</span><br>              <span class="hljs-attr">subPath:</span> <span class="hljs-string">objectstorage.yaml</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">120</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>          <span class="hljs-attr">secret:</span><br>            <span class="hljs-attr">secretName:</span> <span class="hljs-string">thanos-objectstorage</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-store-data</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span> <br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span><br></code></pre></td></tr></table></figure><h3 id="08-thanos-store-svcyaml"><a class="markdownIt-Anchor" href="#08-thanos-store-svcyaml"></a> 08-thanos-store-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-store-headless</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10901</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">grpc</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">store</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10902</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-store</span><br></code></pre></td></tr></table></figure><h3 id="09-thanos-compact-stsyaml"><a class="markdownIt-Anchor" href="#09-thanos-compact-stsyaml"></a> 09-thanos-compact-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-compact</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">thanos-compact-headless</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-compact</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/thanos/thanos:v0.30.2</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">compact</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--wait</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.level=info</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.format=logfmt</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--data-dir=/var/thanos/compact</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--debug.accept-malformed-index</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--retention.resolution-raw=90d</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--retention.resolution-5m=180d</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--retention.resolution-1h=360d</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10902</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">4</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">30</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">20</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.42</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">420Mi</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.123</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">123Mi</span><br>          <span class="hljs-attr">terminationMessagePolicy:</span> <span class="hljs-string">FallbackToLogsOnError</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-compact-data</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/thanos/compact</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/thanos/objectstorage.yaml</span><br>              <span class="hljs-attr">subPath:</span> <span class="hljs-string">objectstorage.yaml</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">120</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>          <span class="hljs-attr">secret:</span><br>            <span class="hljs-attr">secretName:</span> <span class="hljs-string">thanos-objectstorage</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-compact-data</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">100Gi</span><br></code></pre></td></tr></table></figure><h3 id="10-thanos-compact-svcyaml"><a class="markdownIt-Anchor" href="#10-thanos-compact-svcyaml"></a> 10-thanos-compact-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-compact-headless</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10902</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-compact</span><br></code></pre></td></tr></table></figure><h3 id="11-thanos-query-deployyaml"><a class="markdownIt-Anchor" href="#11-thanos-query-deployyaml"></a> 11-thanos-query-deploy.yaml</h3><blockquote><p>由于query需要连接sidecar还有store（部署rules的话也要），在这里我最后部署query服务，虽然先部署query它也会自动去重连store或者rules</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-query</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-query</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-query</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-query</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-query</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/thanos/thanos:v0.30.2</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">query</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--grpc-address=0.0.0.0:10901</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--http-address=0.0.0.0:9090</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.level=debug</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.format=logfmt</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query.replica-label=prometheus_replica</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query.replica-label=rule_replica</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--store=dnssrv+_grpc._tcp.prometheus-sidecar-headless</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--store=dnssrv+_grpc._tcp.thanos-store-headless</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query.timeout=5m</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query.lookback-delta=15m</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query.auto-downsampling</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-query</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9090</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10901</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">4</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-query</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">30</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">20</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http-query</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><h3 id="12-thanos-query-svcyaml"><a class="markdownIt-Anchor" href="#12-thanos-query-svcyaml"></a> 12-thanos-query-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-query</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-query</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">query-port</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9090</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-query</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31990</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10901</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">grpc</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31991</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-query</span><br></code></pre></td></tr></table></figure><blockquote><p>以下rules服务为可选项</p></blockquote><h3 id="13-thanos-rules-cmyaml"><a class="markdownIt-Anchor" href="#13-thanos-rules-cmyaml"></a> 13-thanos-rules-cm.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">record.rules.yaml:</span> <span class="hljs-string">|-</span><br><span class="hljs-string">    groups:</span><br><span class="hljs-string">    - name: k8s.rules</span><br><span class="hljs-string">      rules:</span><br><span class="hljs-string">      - expr: |</span><br><span class="hljs-string">          sum(rate(container_cpu_usage_seconds_total&#123;job=&quot;cadvisor&quot;, image!=&quot;&quot;, container!=&quot;&quot;&#125;[5m])) by (namespace)</span><br><span class="hljs-string">        record: namespace:container_cpu_usage_seconds_total:sum_rate</span><br><span class="hljs-string">      - expr: |</span><br><span class="hljs-string">          sum(container_memory_usage_bytes&#123;job=&quot;cadvisor&quot;, image!=&quot;&quot;, container!=&quot;&quot;&#125;) by (namespace)</span><br><span class="hljs-string">        record: namespace:container_memory_usage_bytes:sum</span><br><span class="hljs-string">      - expr: |</span><br><span class="hljs-string">          sum by (namespace, pod, container) (</span><br><span class="hljs-string">            rate(container_cpu_usage_seconds_total&#123;job=&quot;cadvisor&quot;, image!=&quot;&quot;, container!=&quot;&quot;&#125;[5m])</span><br><span class="hljs-string">          )</span><br><span class="hljs-string">        record: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate</span><br></code></pre></td></tr></table></figure><h3 id="14-thanos-rules-stsyaml"><a class="markdownIt-Anchor" href="#14-thanos-rules-stsyaml"></a> 14-thanos-rules-sts.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rule</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">thanos-rule-headless</span><br>  <span class="hljs-attr">podManagementPolicy:</span> <span class="hljs-string">Parallel</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rule</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/thanos/thanos:v0.30.2</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">rule</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.level=info</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.format=logfmt</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--grpc-address=0.0.0.0:10901</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--http-address=0.0.0.0:10902</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--rule-file=/etc/thanos/rules/*rules.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--objstore.config-file=/etc/thanos/objectstorage.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--data-dir=/var/thanos/rule</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--label=rule_replica=&quot;$(NAME)&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--alert.label-drop=&quot;rule_replica&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--tsdb.retention=48h</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--tsdb.block-duration=2h</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--query=dnssrv+_http._tcp.thanos-query</span><br>          <span class="hljs-attr">env:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">NAME</span><br>            <span class="hljs-attr">valueFrom:</span><br>              <span class="hljs-attr">fieldRef:</span><br>                <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10901</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10902</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">24</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">18</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.42</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">420Mi</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.123</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">123Mi</span><br>          <span class="hljs-attr">terminationMessagePolicy:</span> <span class="hljs-string">FallbackToLogsOnError</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-data</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/thanos/rule</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/thanos/objectstorage.yaml</span><br>              <span class="hljs-attr">subPath:</span> <span class="hljs-string">objectstorage.yaml</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-config-volume</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/thanos/rules</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-objectstorage</span><br>          <span class="hljs-attr">secret:</span><br>            <span class="hljs-attr">secretName:</span> <span class="hljs-string">thanos-objectstorage</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-config</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rules-data</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&lt;storageclass_name&gt;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">100Gi</span><br></code></pre></td></tr></table></figure><h3 id="15-thanos-rules-svcyaml"><a class="markdownIt-Anchor" href="#15-thanos-rules-svcyaml"></a> 15-thanos-rules-svc.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">thanos-rule-headless</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10901</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">grpc</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">10902</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">thanos-rule</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学海无涯</category>
      
      <category>K8S</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>K8S部署方式简介</title>
    <link href="/posts/4fc885b8.html"/>
    <url>/posts/4fc885b8.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>   如今Kubernetes可谓是最为火热的云原生技术，即使没有用过，也一定听过这个名词。而对于运维而言，已经基本成为行业要求的刚需。不要求精通（毕竟任何技术都有一定的要求），但必须掌握基本原理、部署及基本使用。之前也写过K8S(Kubernetes单词首尾之前还有8个字母，类似还有Prometheus的P8S)的部署手册，自我学习的两三年过去，对此有了更深的一些体会，整理如下。</p><h3 id="原生方式"><a class="markdownIt-Anchor" href="#原生方式"></a> 原生方式</h3><h4 id="minikube"><a class="markdownIt-Anchor" href="#minikube"></a> <a href="https://minikube.sigs.k8s.io/docs/start/">Minikube</a>/<a href="https://kind.sigs.k8s.io/docs/user/quick-start/">Kind</a></h4><p>此类方式只适合学习环境快速接触K8S，了解即可。</p><h4 id="二进制"><a class="markdownIt-Anchor" href="#二进制"></a> 二进制</h4><p>安装部署的主要过程如下：</p><ul><li><p>初始化机器</p></li><li><p>生成证书及完成自签</p></li><li><p>Etcd节点通过二进制文件（系统服务）部署etcd</p></li><li><p>Master节点通过二进制文件（系统服务）部署Apiserver、Controller、Schedule等组件</p></li><li><p>Node节点通过二进制文件（系统服务）部署Docker、Kubelet、kube-proxy等组件</p></li><li><p>添加CNI插件</p><p>详细的部署过程可以参考拙文 <a href="https://koanight.github.io/posts/89a5c5a5.html">通过二进制方式部署Kubernetes集群</a></p></li></ul><h4 id="kubeadm"><a class="markdownIt-Anchor" href="#kubeadm"></a> <a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">Kubeadm</a></h4><p>安装部署的主要过程如下：</p><ul><li><p>初始化机器</p></li><li><p>所有节点先安装Docker、Kubeadm、Kubelet等组件</p></li><li><p>使用Kubeadm初始化，自动添加证书，使用容器化部署Etcd、Apiserver、Controller等组件（这一步其实也需要区分节点类型，只不过都是Kubeadm简单化了）</p></li><li><p>添加CNI插件</p><p>详细的部署过程可以参考拙文 <a href="https://koanight.github.io/posts/50bdf01d.html">通过Kubeadm部署Kubernetes单主多从集群</a> 和 <a href="https://koanight.github.io/posts/43012f97.html">通过Kubeadm部署Kubernetes高可用集群</a></p><p><em><strong>需要注意的是，K8S 从 V1.24 版本开始移除默认对Docker的支持，使用Containerd的方式，写这几篇部署文档时候还没有出现这种情况，仍以Docker为主，后续看个人情况是否进行完成，所以仅供参考</strong></em></p></li></ul><h4 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h4><blockquote><ul><li><p>通过Kubeadm可以简单、快速地搭建K8S集群，易于添加/删除节点，但是封装成容器对应用者屏蔽一些底层的逻辑。</p></li><li><p>通过二进制部署比较麻烦，却更好地了解每一个步骤及组件的作用，有利于后续出问题时的排查。</p></li><li><p>对于集群高可用即多个主节点的情况，也需要手动完成额外操作。</p></li></ul></blockquote><h3 id="优化方式"><a class="markdownIt-Anchor" href="#优化方式"></a> 优化方式</h3><p>对原生的方式，个人或团队进行优化（比如国内镜像地址）和自动化封装，包含且不限于基于二进制的 <em><a href="https://github.com/easzlab/kubeasz">Kubeasz</a></em> 和基于Kubeadm的 <em><a href="https://github.com/TimeBye/kubeadm-ha">Kubeadm HA</a></em></p><blockquote><p>此类工具一般具有以下特点：</p><ul><li><p>支持离线化部署</p></li><li><p>利用 ansible-playbook实现自动化，既可以一键安装，也可以安装各个组件</p></li><li><p>组件可选化，比如Docker/Containerd，Calico/Flannel等</p></li><li><p>适配多个操作系统和CPU架构</p></li><li><p>较为新的版本，高于V1.20、V1.22</p></li></ul></blockquote><h3 id="企业级应用"><a class="markdownIt-Anchor" href="#企业级应用"></a> 企业级应用</h3><p>在优化原生方式的基础上，再加以可视化、热插拔组件等额外功能的企业级应用，包括切不限于以下几种：</p><table><thead><tr><th></th><th><a href="https://www.rancher.com/">Rancher</a></th><th><a href="https://www.kuboard.cn/">Kuboard</a></th><th><a href="https://www.kubecube.io/">KubeCube</a></th><th><a href="https://kubesphere.io/zh/">KubeSphere</a></th><th><a href="https://kubeoperator.io/">KubeOperator</a></th></tr></thead><tbody><tr><td>部署K8S方式</td><td>可视化Rancher<br>RKE发行版</td><td>可视化 <a href="https://www.kuboard.cn/install/install-k8s.html">Kuboard-Spray</a></td><td>命令行脚本</td><td>命令行 <a href="https://kubesphere.io/zh/docs/v3.3/installing-on-linux/introduction/kubekey/">kubekey</a></td><td>可视化 <a href="https://kubeoperator.io/docs/">KubeOperator</a></td></tr><tr><td>Dashboard</td><td>Rancher</td><td>Kuboard</td><td>KubeCube</td><td>KubeSphere</td><td>KubePi</td></tr><tr><td>是否支持Arm架构</td><td></td><td>支持</td><td>支持</td><td>不支持</td><td>支持</td></tr><tr><td>离线化部署程度</td><td>需要自建私库及准备镜像</td><td>提供部分离线资源包</td><td></td><td>需要自建私库及准备镜像</td><td>提供完整的离线安装包</td></tr><tr><td>支持K8S版本</td><td></td><td>v1.23.1~v1.25.6</td><td>v1.18.20 ~ v1.23.5</td><td>v1.19~v1.24</td><td>v1.18.3~v1.22.12</td></tr><tr><td>开源许可证</td><td>Apache2.0</td><td>部署工具Apache2.0</td><td>Apache2.0</td><td>Apache2.0</td><td>Apache2.0</td></tr></tbody></table><h4 id="总结-2"><a class="markdownIt-Anchor" href="#总结-2"></a> 总结</h4><blockquote><p>此类工作一般具有以下特点：</p><ul><li><p>开箱即用</p></li><li><p>提供可视化的安装界面，降低部署难度</p></li><li><p>部署完成后默认自带或可以安装对应的Dashboard，Dashboard支持管理多集群</p></li><li><p>需要考虑开源性及是否商用</p></li></ul></blockquote><h3 id="封装容器"><a class="markdownIt-Anchor" href="#封装容器"></a> 封装容器</h3><p>可以看出，从原生方式到企业级应用，部署K8S的过程，是一步一步封装、简化、丰富的。那么，容器化的思想更近一步，把这个K8S集群当做一个整体，便是 <a href="https://www.sealyun.com/zh-Hans/">sealos</a> 和 <a href="http://sealer.cool/v0.8.6/zh/">sealor</a> 主要做的事情。省去了大部分的步骤和配置，以镜像的方式，只需几条命令便可以构建一个K8S集群。</p><p>不过，越是傻瓜的操作，意味着内部封装的程度越高，越不容易接触到里面的核心。不出问题还好，出了问题又不清楚原理，简直无从下手。况且这种方式远没有基于/改造原生方式成熟，慎用。</p><h3 id="云服务"><a class="markdownIt-Anchor" href="#云服务"></a> 云服务</h3><p>除了自己搭建K8S环境外，也可以使用云厂商提供的服务，且不需要提前规划服务器节点(之前的方式都需要区分节点角色)。总的来说大差不差，都是云厂商有底层的硬件和技术支撑，花钱买服务就行了。</p><h4 id="阿里ack"><a class="markdownIt-Anchor" href="#阿里ack"></a> <a href="https://www.aliyun.com/product/kubernetes?spm=5176.19720258.J_3207526240.33.e93976f4aVYqP6">阿里ACK</a></h4><h4 id="华为cce"><a class="markdownIt-Anchor" href="#华为cce"></a> <a href="https://www.huaweicloud.com/product/cce.html">华为CCE</a></h4><h4 id="腾讯tke"><a class="markdownIt-Anchor" href="#腾讯tke"></a> <a href="https://cloud.tencent.com/product/tke">腾讯TKE</a></h4><hr /><p>  在我学习K8S进群的初期，常常看看“开发Kubeadm，运维二进制”的说法。不论以何种方式，部署只是第一步，学习之路，道阻且长。从这几种方式来看，技术都是一步一步完善的，善于利用并借鉴已经成熟的东西，亦不失为一种好的学习方法。</p>]]></content>
    
    
    <categories>
      
      <category>学海无涯</category>
      
      <category>K8S</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Mac初體驗</title>
    <link href="/posts/b3f0b39b.html"/>
    <url>/posts/b3f0b39b.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><!-- block --><p>    等待了近一個月後，Mac Mini 終於入手。在此必須先隆重地感謝一下萬能的淘寶，成功讓我以教育優惠的價格，剩下 800 元巨款，也開啟了我的折騰之旅。</p><!-- block --><h1 id="基礎篇"><a class="markdownIt-Anchor" href="#基礎篇"></a> 基礎篇</h1><ul><li><p>為貼合語言習慣，在開始初始化時，地區選擇 香港，語言選擇 繁體中文（香港），然後發現 Apple ID 死活無法登錄，當然我也機智地發現是地區原因導致的，只能先跳過登錄。</p></li><li><p>本來想重置Mac的，新的系統新的安裝，掌握了就是副業，也不用跑蘋果店。在進入過Recovery之後，發現重新安裝MacOS需要十幾個小時（應該跟網速有點關係，畢竟要下載系統鏡像），唯有放棄二字。</p></li><li><p>這個系統設置，居然只能是個長條，無法最大化！搞得我以為是哪裡設置有問題。還有我找了半天，沒有找到更新顯示比例的地方：不是說支持 4K 嘛，雖然我顯示器只有堂堂 2K 的分辨率，即使上了4K，按100%比例顯示的字那也太小了吧。</p></li><li><p>程序關閉之後，並不會退出，只會最小化的性質關閉所有頁面停留到Dock欄上，這點和IOS上一樣，且頂層的菜單欄不可隱藏。可惜我有強迫症啊，不論Windows還是Linux，展示出來的都是乾淨、純粹的桌面，Dock不過是個入口而已，只靠狀態欄（或者叫任務欄或者菜單欄）而活。</p></li><li><p>只有通過 App Store 下載的應用才可以在管理頁面卸載，使用 dmg 和 pkg 安裝的軟件，裝完了事，卸載全靠 rm -rf。問我是怎麼知道的，為了同步圖片，我一個裝的應用是 OneDrive！不過後來發現，在 設置-存儲空間 中，也可以在應用類裡刪除，不過不徹底。最后，还是得靠其他專業的軟件啊。還有一點跟 IOS 不一樣的，系統應用無法刪除，並且对我而言基本的系統應用還真多。</p></li><li><p>這該死的快捷鍵！Control和Command傻傻分不清楚？回車鍵怎麼是重命名？Del為什麼刪除不了文件？F1~F12的功能鍵又不起作用了？我辛辛苦苦在Windows上打下的快捷江山，在Linux在使用KDE/Plasma都基本無縫切換，在Mac上毁于一旦！習慣不是問題，可是一旦在Mac養成習慣，到Window上又是一堆問題，就好像使用HHKB配列鍵盤上Caplock鍵是Ctrl，Alice配列鍵盤的分裂空格和雙B鍵……致力於尋找一條三端解決之道，吾輩義不容辭！</p></li></ul><h1 id="選擇篇"><a class="markdownIt-Anchor" href="#選擇篇"></a> 選擇篇</h1><ul><li><p>想過使用默認的Apple Music，畢竟我也是購買過年會會員的人，蘋果自家的東西兼容度肯定最高。可是啊，淘寶88會員每年都免費送網易雲會員，我最初想用Apple Music聽的英皇公司也在網易雲回歸，至於其他網易雲上沒有的，我還可以使用Listen1，只能對Apple Music說拜拜了。</p></li><li><p>想過使用默認的輸入法（顯示語言是繁體中文，輸入法可不能是倉頡），但是切換輸入法很麻煩，即使有軟件可以設置所用應用的默認輸入法。其實我想要的很簡單，通過一個鍵例如shift就可以切換中/英文，這個習慣就是Windows默认輸入法養成的——對不起，早知道還是搜狗。快捷鍵切換簡/繁體的問題也解決了，關鍵還得是有皮膚啊。</p></li><li><p>想過使用默認的Safari瀏覽器，但是瀏覽器插件居然也要當做應用在App Store里安装——對不起，早知道還是Google Chrome Canary，谷歌賬號同步所有，我的插件和密碼都回來了！在這裡不適用Microsoft Egde的原因，是mac專為工作生產力，自己家裡的PC沒有裝Chrome默認Edge，如果工作也用Edge，會同步工作上的一些記錄。當然，瀏覽器我還推薦一款Vivaldi，不過光下載這個瀏覽就要翻墻。</p></li><li><p>想過使用蘋果推薦的開發工作Xcode，但是我一看7.8G——對不起，早知道還是Visual Studio Code，微軟賬號同步所有，我的插件和皮膚都回來了！另外對於Goland和Python專業的工具——Jerbrain旗下的Goland和Pycharm，在我興致勃勃地激活Goland之後，我發現8G內存不夠了。我天真地認為mac的8G內存能有什麼黑科技，沒想到啊，還是只能放棄。算了，Vscode又不是不能跑。</p></li><li><p>想過使用默認的終端工具，但是默認使用zsh卻沒有裝oh my zsh。尋尋覓覓半天iterm2也不好用啊，配置也麻煩。使我想起了Linux上的Tilda、Guake、Yakuake這類下拉式終端——召之即來，揮之即去，甚至不會揮手就可以直接離開，不知道mac上有沒有什麼替代品。此外，對於一名專業度的運維開發工程師而言，不僅本地終端要好使用，通過ssh管理其他機器也非常重要。本來Window下有最強的Mobaxterm，奈何它只有Windows版本。另一台公司發的戴爾筆記本被我改裝了Ubuntu，考慮到三端皆可使用——Tabby呼之欲出！Termius也蠻好使，然在進階功能上不能與之一戰，其餘工具更是不過爾爾。何況，整天對著個醜的UI，幹活也不利索。</p></li><li><p>我不得不承認，Typora是我用過的最好用的Markdown編輯器，可能是我一開始寫md摸到了該類應用的上限，如果一開始我是老老實實入Markdown語法入門的，這種感覺就不會如此強烈。所寫即所見，成為了Markdown編輯器的剛需。遂Typora轉為收費之後，我變開始尋找替代品。Markdown編輯器雖多，所寫即所見的太少，並且也要考慮三端的問題，那麼在不考慮破解版的情況情況下，就決定是你了——Marktext。誠然他也是有缺點的，比如在我撰寫hexo博客文章的時候，有些語法不太友。所以我的方案是，使用低版本的Typora，低版本的又不需要破解嘍！</p></li></ul><h1 id="對比篇"><a class="markdownIt-Anchor" href="#對比篇"></a> 對比篇</h1><p>Mac對Window我就不說了，主要說下對比Linux桌面版。</p><ul><li><p>Mac的UI確實舒服，儘管我使用KDE/Plasma進行各種美化盡力貼合Mac，還是有差距。</p></li><li><p>Linux的桌面（對專業開發者，可以把桌面去掉）自由度是真的高啊，开源就是无敌！Mac上我換圖標、換指針都很費勁。</p></li><li><p>所有應用的菜單都可以在系統的狀態欄顯示，某些應用就可以再少一層菜單佈局，這個功能接受行很高，適應之後十分爽。KDE/Plasma上也可以，不過前者是系統內就已經實現的，後者應該是通過軟件實現的，且實現得不完全。</p></li><li><p>Mac上的軟件動不動就是收費的，在經濟實力上自然是要低頭的，我提個意見啊，開源不收費的精神就很好嘛。話說回來，在桌面端，還是有更多的開發者願意對Mac進行軟件開發，Linux畢竟作為服務器居多，桌面端要求不高，能用基本的開發軟件就行。</p></li></ul><hr /><p>    扯了這麼多，Mac之旅才剛剛開始，仍有很多未知的技巧等待發現。遺憾的是，使用Mac Mini會缺失觸控板和MenuBar的體驗。能以最便宜的價格就能玩弄MacOS，還要什麼自行車！</p>]]></content>
    
    
    <categories>
      
      <category>胡言亂語</category>
      
      <category>淺斟集</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>關於我喜愛的搖滾</title>
    <link href="/posts/946a3341.html"/>
    <url>/posts/946a3341.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1 id="起"><a class="markdownIt-Anchor" href="#起"></a> 起</h1><p>    已經忘了什麼時候開始聽搖滾的，現在算起的話，《挪威的森林》應該是第一首，伍佰&amp;China Blue算得上我的搖滾啟蒙。<br />    記得小時候，每年過年，我都會跟外公回他的老家。因為舅舅的關係，家裡有VCD，视频居多，音频的好像就一张，经常翻來覆去地播放。有兩首歌尤為深刻，一首莫文蔚《盛夏的果實》，一首就是伍佰的《挪威的森林》。那時候哪裡知道什麼村上春樹，只記得後者裡除了歌詞之外，有大段的solo（solo這個詞肯定也是後來才知道什麼意思的），而且伍佰的名字、外表和聲音……又確實那麼引人注意。可惜的是，後來回到自己家裡，既沒有VCD，也不像現在可以在網絡上隨意聽。<br />    後來《想見你》的爆紅，作爲穿越關鍵的《Last Dance》讓伍佰又火了一把。當然伍佰並不是只有以上兩首好聽，正如有人在評論中說的那樣：陳韻如聽磁帶都直接從B面開始，不聽A面的嗎？伍佰老師看上去像個落魄的浪子，實則是個迷人的浪漫痞子，聽著他的歌我一個人就能在家裡搖起來。<br />    對！搖起來。我去過的每一個搖滾Livehouse，哪次不是台下一幫人搖頭晃腦，猶如大型<s>嗑 藥</s>現場，聚眾<s>xi du</s>。以前不覺得自己搖得多起勁，今年我在活塞二樓看惘聞乐队演出，看到一樓的人，那可真是一言難盡，才發現自己一直都是其中的一員。<br />    說回伍佰老師，作為主唱的伍佰固然重要，也離不開整個China Blue。吉他、貝斯、鍵盤、鼓，搖滾四大件，每個位置都非常重要。</p><h1 id="承"><a class="markdownIt-Anchor" href="#承"></a> 承</h1><p>    人漸漸長大，要説這期間完全不聽搖滾也是不可能的，只不過最近兩三年更加有目的性，或者說更爲集中。集中的起因，卻不是搖滾。<br />    前幾年一時興趣，參加了人生第一場Livehouse。在等待的過程中，聽著各位道友討論著自己喜愛的歌手和樂隊。面對這個經常混跡於各個Livehouse的大佬，我只是一個萌新。本來事情到演出之後就結束了，但後來某一個道友在朋友圈分享了文雀的《本星》，因爲聽他説起過，所以抱著試一試的心態聽了一下。前6分鐘的鋪墊下，器樂的重複再重複，讓人不禁生出置身於漫漫宇宙空間的孤獨與迷惘；最後的1分鐘，則縱情于雀躍的歡喜，好像丟失目的地的飛行器在最後結束了執行周期即將返航。<br />    後來知道，這叫做後搖(Post Rock)。很難解釋後搖到底表達了什麽，也無法定義後搖是否需要歌詞。從此以後，我也長此以往地混跡於各個Livehouse。可惜的是，并沒有在文雀的現場，聽過《本星》的演奏。<br />   這也順便影響我聼個的方式，開始整張專輯地聼，事實證明如此聽歌是對的。尤其遇到萬能青年旅店的《冀西南林路行》，這張專輯的完整度是如此之高以致於無法割裂，而分軌后的《山雀》和《繞越》中間那極短的重複導致的不連貫又是多麽畫蛇添足。在每首歌的或前或后，都留下足夠的停頓和喘息，來應對其前其后的控訴或炸裂。</p><h1 id="轉"><a class="markdownIt-Anchor" href="#轉"></a> 轉</h1><p>    搖滾越聽越多，奇怪的一點是：儘管喜愛的搖滾歌手或樂隊都收到外國搖滾的影響，但到目前為止我好像對外國的搖滾樂不太感冒。也曾像當初聽古典音樂一樣，找一段時間沉浸其中，卻都沒有什麽收穫。也許像錢鍾書説的那樣“假如你吃了个鸡蛋，觉得不错，何必要认识那只下蛋的母鸡呢？”同樣，如果你覺地一首歌好聽，作爲一個普通聽衆，又何必去探究它受了什麽影響？只需要沉浸其中，便是最大的喜愛。</p><h1 id="合"><a class="markdownIt-Anchor" href="#合"></a> 合</h1><!-- block --><p>    搖滾是什麽？它可以是《潛龍勿用》的憤怒，可以是《光輝嵗月》的激昂，可以是《凡士林》的浪漫與迷幻，可以是《聖馬力諾之心》的永不言败，可以是自由、理想、控訴、呐喊、理想、失落，还可以是………………你想它是什么，它就是什么。</p><!-- block --><hr /><p>   PS：到這篇爲止，把之前拖拉的腹稿全部落成文字。其實不多，但跟之前相比，已經算是“井噴”了，也促成我加速搭建博客。我也不知道那段時間爲甚有那麽多想法，可能是我書桌上新放的李白銅擺件顯靈了吧，哈哈。以後有沒有的寫，那再說，最多我喝點酒刺激一下。</p><p align="right"> 腹稿於壬寅葭月</p><p align="right"> 完稿於壬寅冰月</p>]]></content>
    
    
    <categories>
      
      <category>胡言亂語</category>
      
      <category>音為歌</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>甜蜜大逃亡</title>
    <link href="/posts/c6292feb.html"/>
    <url>/posts/c6292feb.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>   大多数时候，每首歌都是獨立的；機緣巧合下，將幾首歌連起來聼，發生額外的化學反應；或者是幾首歌都和意外地和某個詞語或者感情有關，可以發展到組成一張歌單。我所有的歌都在播放器里，又是隨機播放，這種情況的幾率大大提高，比如這次就發生在“私奔”這個關鍵詞上。</p>    <div id="aplayer-YOoyxBbW" class="aplayer aplayer-tag-marker meting-tag-marker"         data-id="001LMWRO4TCtVu" data-server="tencent" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#ad7a86"    ></div><p>   第一首，名字就叫《私奔》，出自林夕+陳輝陽+楊千嬅的經典陣容，緣於上世紀九十年代的電影《末路狂花》。雖然當初好奇看过這部電影，時到腹稿卻基本忘記，爲了成稿只能補看，一言蔽之就是八個字：閨蜜、旅行、殺人、逃亡。</p><blockquote><p>青春有價 寂寞無限 盡量犯錯 錯了亦有賺</p></blockquote><blockquote><p>盡力浪擲刹那芳華 做一幅燦爛的畫</p></blockquote><blockquote><p>即使世界并沒童話 亦讓暴雨撇過我婚紗</p></blockquote><blockquote><p>窮途末路時放任地大笑有多好<br>窮途末路時在落日盡処看清早</p></blockquote><p>   看到結尾，Thelma和Louise相視大笑，緊握雙手，衝向科羅拉多大峽谷……才明白，爲何狂花愛末路。</p>    <div id="aplayer-FSVYGylm" class="aplayer aplayer-tag-marker meting-tag-marker"         data-id="405790387" data-server="netease" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#ad7a86"    ></div><p>   第二首，香港搖滾組合Dear Jane的大熱歌曲《哪裏只得我共你》。從主題上講，最符合“私奔”的含義:</p><blockquote><p>我要將你拯救 逃離人類荒謬<br>就用我的雙手 帶著你走 不掙扎 只緊扣<br>從未低頭 途徑幾百萬傷口<br>站在我的身後 要確保你無仇無憂</p></blockquote><p>   哎，本來腹稿裏有一大堆要說，貼完歌詞又不知道從何説起。和《只知感覺失了蹤》、《經過一些秋與冬》組成的三部曲，雖然後兩者也不差，但跟《哪裏只得我共你》相比，少了那份初初的壯烈而顯得平淡——“我的意中人是個蓋世英雄，有一天他會脚踏七彩祥雲來娶我。”在我看來，“我要將你拯救 逃離人類荒謬”帶有那麽一點英雄主義的浪漫。</p>    <div id="aplayer-eWCIziPI" class="aplayer aplayer-tag-marker meting-tag-marker"         data-id="1810017091" data-server="netease" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#ad7a86"    ></div><p>   第三首，轩仔的《Sweet Escape》并不完全是首英文歌，部分歌詞上甚至帶有些許的曖昧、誘惑及顔色。重點要細品這個英文歌名：sweet，甜蜜；escape，逃亡，用這個作爲“私奔”的翻譯，在表達含義上面豈不要比run away更加貼切？在情人私奔的道路上，刺激只是暫時，甜蜜才最重要。</p><p>   私奔，百度可查的意思如下：指不顧阻攔投奔所愛的人或一塊逃跑；舊指未婚私自投奔戀人而逃走；現在指兩人為了愛情拋棄一切出走或躲避流言蜚語；看上去，好像沒有愛情，就無法私奔一樣。其實私自奔走，跟愛情也可以沒有什麽關係。</p><!-- block --><p>   不管是私奔的哪一種，也不管私奔的原因是什麽，我最尊敬的，是那份豁出去的勇敢，是向往自由的渴望，是完成对自己或者他人的救贖，無論千難萬險，無論結果如何，走出去的那一刻，浪漫足以至死。</p><!-- block --><hr /><p>   <em><s>PS：很長一段時間裏，我都不知道樂評應該怎麽寫，或者說我不知道爲什麽要寫樂評。在很多範疇上，每個人都有自己劃定的圈子，假設這個圈子一開始就已經定死閉環，那麽注定不會和其他有任何交集。畢竟，也沒有人願意輕易打開一個缺口。我以前做的，像是国产软件面面俱到，每一个地方都充满提示，引导人们去如何使用——出发点固然好，但容易引起人的反感。那我现在要做的，就是国外软件：功能我都提供全，怎么使用，人们自己按需要使用。写嘔心瀝血說得太多，終究不如一聽。</s></em></p><hr /><p align="right"> 腹稿于壬寅葭月 </p><p align="right"> 完稿于壬寅冰月 </p>]]></content>
    
    
    <categories>
      
      <category>胡言亂語</category>
      
      <category>音為歌</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>天地之弦</title>
    <link href="/posts/e5478715.html"/>
    <url>/posts/e5478715.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>    寫這一篇的原因，是讀了郝景芳《孤獨深處》中收錄的《弦歌》。</p><p>    “一個人，一把小錘，一根弦。天地之間。”作者描述林老師準備利用共振引發天梯爆炸月球時如此寫道。我有所感的地方，不在於小説裏這個計劃本身，而在於其中所蘊含的人與天地的關係。</p><p>    “天地”這個詞，往小了說，好像一個人飯後散個步，都算得上“立於天地之間”；往大了說，從修身、齊家到治國、平天下，已經是個人的極限，考慮不到天地；而在幻想的小説或是影視作品，動輒銀河宇宙，衝出太陽系了。在地鉄上看小説的一瞬間，我只想到這一步。</p><p>    日有所思，晚上睡覺的時候，就順著這個思路展開想下去：“天地”包含的，遠遠超出了一般的意義，甚至無法具體指出何爲天，何爲地，又好像萬物皆可成爲天地。放在小説裏，我理解連接月球與地球的天梯，以及引起共振的那些從幾十米到幾千米的弓弦，都算的上“天地之弦”。跟這些相比，人是無足輕重的。但若沒有人敲擊這些“天地之弦”，又如何引起共振從而炸毀月球呢？</p><!-- block --><p>    ——人本身無法和天地相比，卻通過某些舉動足以影響天地，那麽人孰與天地大？</p><!-- block --><p>    當然，這個問題是在過分强調人之渺小而天地之宏大的基礎上提出的對立，如果從之前説的“立於天地”或者“人擁有自己的一方天地”的維度，該問題也不復存在。</p><p>    相對固定的人而言，天地的範疇是动态的，這導致人與天地的關係是複雜的，是可變的。以上只是我讀書時的一些胡言亂語，既不能揭示什么道理，亦無法窺得天機。</p><hr /><p>    PS：進來興起讀起了科幻小説，東西方的差異還是明顯（這一點我尤爲頭疼，感覺大部分西方的書真的不合我胃口，但是買了好多……）郝景芳的《孤獨深處》最早，科幻外衣包裹著人文之心；灰狐的《鯨魚航綫》比較具體，科學的味道也最重，很理性；夏桑的《月海電臺》最是浪漫，富有詩意，幻想要比科學多；大劉的《三體》還沒看完，等看完以我的筆力估計也不足敘述其萬一。</p><hr /><p align="right"> 腹稿于壬寅葭月 </p><p align="right"> 完稿于壬寅冰月 </p>]]></content>
    
    
    <categories>
      
      <category>胡言亂語</category>
      
      <category>淺斟集</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Hexo常用插件汇总</title>
    <link href="/posts/5438079.html"/>
    <url>/posts/5438079.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><blockquote><p>在上一篇 <a href="https://koanight.github.io/c1d5d64c/">搭建Hexo博客</a> 中，发布Github Page时用到了hexo-deployer-git插件，这里再介绍一些其他插件。可能大多数插件在使用主题时候已经集成了，本着“知其所以然”的态度，也稍稍探究一下。主要分为即用型和改造型，前者下载插件加以简单配置后就可以直接使用；后者还需要修改前端页面代码的内容，我还没有这个实力，推荐给比较硬核的玩家，或者直接使用已经包含该插件的主题。</p></blockquote><h1 id="即用型"><a class="markdownIt-Anchor" href="#即用型"></a> 即用型</h1><h2 id="更换markdown渲染器"><a class="markdownIt-Anchor" href="#更换markdown渲染器"></a> 更换markdown渲染器</h2><p>更换渲染器的原因，是我在按照语法编辑文档后，发现页面没有显示对应的效果，而是源代码或者标签，比如缩进两字符、文本右对齐、字体颜色等。参考大佬的博客 <a href="https://zsyyblog.com/b73ceb85.html">Hexo多种Markdown渲染器对比分析</a> 后，选用了hexo-renderer-markdown-it-plus渲染器，完美实现预期的效果。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm un hexo-renderer-marked --save<br>npm i hexo-renderer-markdown-it-plus --save<br></code></pre></td></tr></table></figure><h2 id="优化文章路径"><a class="markdownIt-Anchor" href="#优化文章路径"></a> 优化文章路径</h2><p>hexo默认的文章永久链接包含时间和标题，我认为url里还是尽量少出现中文和特殊字符，使用hexo-abbrlink可以生成带有数字的链接来规避。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i hexo-abbrlink --save<br></code></pre></td></tr></table></figure><p>在_config.yml中修改</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">permalink:</span> <span class="hljs-string">posts/:abbrlink.html</span><br></code></pre></td></tr></table></figure><p>在_config.yml中加入</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># abbrlink config</span><br><span class="hljs-attr">abbrlink:</span><br>  <span class="hljs-attr">alg:</span> <span class="hljs-string">crc32</span>      <span class="hljs-comment">#support crc16(default) and crc32</span><br>  <span class="hljs-attr">rep:</span> <span class="hljs-string">hex</span>        <span class="hljs-comment">#support dec(default) and hex</span><br>  <span class="hljs-attr">drafts:</span> <span class="hljs-literal">false</span>   <span class="hljs-comment">#(true)Process draft,(false)Do not process draft. false(default) </span><br>  <span class="hljs-comment"># Generate categories from directory-tree</span><br>  <span class="hljs-comment"># depth: the max_depth of directory-tree you want to generate, should &gt; 0</span><br>  <span class="hljs-attr">auto_category:</span><br>     <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment">#true(default)</span><br>     <span class="hljs-attr">depth:</span>        <span class="hljs-comment">#3(default)</span><br>     <span class="hljs-attr">over_write:</span> <span class="hljs-literal">false</span> <br>  <span class="hljs-attr">auto_title:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#enable auto title, it can auto fill the title by path</span><br>  <span class="hljs-attr">auto_date:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#enable auto date, it can auto fill the date by time today</span><br>  <span class="hljs-attr">force:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#enable force mode,in this mode, the plugin will ignore the cache, and calc the abbrlink for every post even it already had abbrlink. This only updates abbrlink rather than other front variables.</span><br></code></pre></td></tr></table></figure><p>详细配置参考官方文档 <a href="https://github.com/rozbo/hexo-abbrlink">GitHub - rozbo/hexo-abbrlink: create one and only link for every post for hexo</a></p><h2 id="播放音乐"><a class="markdownIt-Anchor" href="#播放音乐"></a> 播放音乐</h2><p>音乐爱好者必备插件，既可以使用单独页面播放歌单，也可以在文章里播放单曲。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i hexo-tag-aplayer --save<br></code></pre></td></tr></table></figure><p>在_config.yml中加入</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># hexo-tag-aplayer</span><br><span class="hljs-attr">aplayer:</span><br>  <span class="hljs-attr">meting:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>在md文章中加入</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- Simple example (id, server, type)  --&gt;</span><br>&#123;% meting &quot;60198&quot; &quot;netease&quot; &quot;playlist&quot; %&#125;<br></code></pre></td></tr></table></figure><p>详细配置参考官方文档 <a href="https://github.com/MoePlayer/hexo-tag-aplayer">GitHub - MoePlayer/hexo-tag-aplayer: Embed aplayer in Hexo posts/pages</a></p><h2 id="压缩资源"><a class="markdownIt-Anchor" href="#压缩资源"></a> 压缩资源</h2><p>压缩css/html/图片</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i hexo-all-minifier --save<br></code></pre></td></tr></table></figure><p>在_config.yml中加入</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># hexo-all-minifier</span><br><span class="hljs-attr">all_minifier:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h2 id="摘要"><a class="markdownIt-Anchor" href="#摘要"></a> 摘要</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i hexo-auto-excerpt --save<br></code></pre></td></tr></table></figure><p>与上面自动生成摘要相比，以下这个插件可以自定义摘要的内容，更加自由</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i hexo-excerpt-block  --save<br></code></pre></td></tr></table></figure><p>在文章中加入</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- block --&gt;</span><br>这里是摘要<br><span class="hljs-comment">&lt;!-- block --&gt;</span><br></code></pre></td></tr></table></figure><h1 id="改造型"><a class="markdownIt-Anchor" href="#改造型"></a> 改造型</h1><h2 id="本地全局搜索"><a class="markdownIt-Anchor" href="#本地全局搜索"></a> 本地全局搜索</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i hexo-generator-searchdb --save<br></code></pre></td></tr></table></figure><p>在_config.yml中加入</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">search:</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">search.xml</span><br>  <span class="hljs-attr">field:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">content:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">format:</span> <span class="hljs-string">html</span><br></code></pre></td></tr></table></figure><p>具体如何使用移步 <a href="https://github.com/next-theme/hexo-generator-searchdb">GitHub - next-theme/hexo-generator-searchdb: 🔍 Seach data generator plugin for Hexo.</a></p><h2 id="统计字数与时长"><a class="markdownIt-Anchor" href="#统计字数与时长"></a> 统计字数与时长</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i hexo-word-counter --save<br></code></pre></td></tr></table></figure><p>在_config.yml中加入</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># hexo-word-counter</span><br><span class="hljs-attr">symbols_count_time:</span><br>  <span class="hljs-attr">symbols:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">time:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">total_symbols:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">total_time:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">exclude_codeblock:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">awl:</span> <span class="hljs-number">4</span><br>  <span class="hljs-attr">wpm:</span> <span class="hljs-number">275</span><br>  <span class="hljs-attr">suffix:</span> <span class="hljs-string">&quot;mins.&quot;</span><br></code></pre></td></tr></table></figure><p>具体如何使用移步 <a href="https://github.com/next-theme/hexo-word-counter">GitHub - next-theme/hexo-word-counter: ⏱️ Word count and time to read of articles for Hexo.</a></p><h2 id=""><a class="markdownIt-Anchor" href="#"></a> </h2>]]></content>
    
    
    <categories>
      
      <category>学海无涯</category>
      
      <category>Hexo</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>淺斟集·代序</title>
    <link href="/posts/9b1b7662.html"/>
    <url>/posts/9b1b7662.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>    也許是終於將博客搭好，也許純粹因爲年紀上來，將平日偶爾寫的細碎東西整理在一起，算是我今年想做好的一件事。</p><p>    真的要算起來，從初高中寫起，哪怕沒有十萬也有個七、八萬字：詩詞歌賦、散文評論、隨筆小説，還是挺雜糅的，不過都被自己刪去，所剩無幾，原因只是回頭翻閲時不忍細看。大學看高中的如此，工作后看大學亦如是，每個階段看之前的，都不對勁。現在要解決這個問題的方法也簡單，眼不見心不煩，反正寫完傳到github，有錯別字也不管不顧——沒有必要再commit一次。</p><p>    “淺斟”二字，自然是從柳三變的《鶴衝天》來的，當然我也沒有什麽浮名可以拿來換的，也就能在回到家中時，在縮于被窩時，在愜意休憩時，在愉快活動時，倒一小杯酒淺嘗輒止。其次，也包含著五柳先生的點到即止、不求甚解——如果事事都去反復思量，考慮今是昨非，那豈不是給庸人自擾？</p><p>    風過留聲，雁過留痕，人活著總要留下點什麽。無錢無名，無權無人，也就這些零落如鴻爪的隻言片語，供諸君一饗——或是一哂。</p><hr /><p align="right"> 腹稿于壬寅葭月 </p><p align="right"> 完稿于壬寅冰月 </p>]]></content>
    
    
    <categories>
      
      <category>胡言亂語</category>
      
      <category>淺斟集</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>搭建Hexo博客</title>
    <link href="/posts/c1d5d64c.html"/>
    <url>/posts/c1d5d64c.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1 id="git"><a class="markdownIt-Anchor" href="#git"></a> git</h1><h2 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"> apt/yum/dnf install git -y<br></code></pre></td></tr></table></figure><h1 id="nodejs"><a class="markdownIt-Anchor" href="#nodejs"></a> nodejs</h1><h2 id="下载"><a class="markdownIt-Anchor" href="#下载"></a> 下载</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://nodejs.org/dist/v18.12.1/node-v18.12.1-linux-x64.tar.xz<br></code></pre></td></tr></table></figure><h2 id="解压"><a class="markdownIt-Anchor" href="#解压"></a> 解压</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar xf node-v18.12.1-linux-x64.tar.xz -C /opt<br></code></pre></td></tr></table></figure><h2 id="配置环境变量"><a class="markdownIt-Anchor" href="#配置环境变量"></a> 配置环境变量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;PATH=\$PATH:/opt/node-v18.12.1-linux-x64&quot;</span> &gt;&gt; /etc/profile<br>. /etc/profile<br></code></pre></td></tr></table></figure><h2 id="添加淘宝源"><a class="markdownIt-Anchor" href="#添加淘宝源"></a> 添加淘宝源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm config <span class="hljs-built_in">set</span> registry https://registry.npmmirror.com<br></code></pre></td></tr></table></figure><h1 id="hexo"><a class="markdownIt-Anchor" href="#hexo"></a> hexo</h1><h2 id="安装脚手架"><a class="markdownIt-Anchor" href="#安装脚手架"></a> 安装脚手架</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i -g hexo-cli<br></code></pre></td></tr></table></figure><h2 id="建站"><a class="markdownIt-Anchor" href="#建站"></a> 建站</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /opt<br>hexo init hexo<br>npm i<br></code></pre></td></tr></table></figure><h2 id="参考文档修改_configyml"><a class="markdownIt-Anchor" href="#参考文档修改_configyml"></a> 参考文档修改_config.yml</h2><p><a href="https://hexo.io/zh-cn/docs/configuration">配置 | Hexo</a></p><h2 id="修改模板字段"><a class="markdownIt-Anchor" href="#修改模板字段"></a> 修改模板字段</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim scaffolds/post.md 添加以下内容<br>    categories:<br></code></pre></td></tr></table></figure><h2 id="自行切换主题并参考主题说明修改相应配置"><a class="markdownIt-Anchor" href="#自行切换主题并参考主题说明修改相应配置"></a> 自行切换主题并参考主题说明修改相应配置</h2><h1 id="command"><a class="markdownIt-Anchor" href="#command"></a> command</h1><p><a href="https://hexo.io/zh-cn/docs/commands">指令 | Hexo</a></p><h1 id="release"><a class="markdownIt-Anchor" href="#release"></a> release</h1><h2 id="pm2"><a class="markdownIt-Anchor" href="#pm2"></a> pm2</h2><h3 id="安装pm2"><a class="markdownIt-Anchor" href="#安装pm2"></a> 安装pm2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i -g pm2<br></code></pre></td></tr></table></figure><h3 id="编写脚本"><a class="markdownIt-Anchor" href="#编写脚本"></a> 编写脚本</h3><h4 id="hexo-deployjs"><a class="markdownIt-Anchor" href="#hexo-deployjs"></a> hexo-deploy.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//deploy</span><br><span class="hljs-keyword">const</span> &#123; exec &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>)<br><span class="hljs-title function_">exec</span>(<span class="hljs-string">&#x27;hexo g (-w 用户监控文件改动情况自动发布)&#x27;</span>,<span class="hljs-function">(<span class="hljs-params">error, stdout, stderr</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span>(error)&#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;exec error: $&#123;error&#125;&#x27;</span>)<br>                <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;stdout: $&#123;stdout&#125;&#x27;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;stderr: $&#123;stderr&#125;&#x27;</span>);<br>&#125;)<br></code></pre></td></tr></table></figure><h4 id="hexo-runjs"><a class="markdownIt-Anchor" href="#hexo-runjs"></a> hexo-run.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//run</span><br><span class="hljs-keyword">const</span> &#123; exec &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>)<br><span class="hljs-title function_">exec</span>(<span class="hljs-string">&#x27;hexo s (-p 80 用户指定端口)&#x27;</span>,<span class="hljs-function">(<span class="hljs-params">error, stdout, stderr</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span>(error)&#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;exec error: $&#123;error&#125;&#x27;</span>)<br>                <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;stdout: $&#123;stdout&#125;&#x27;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;stderr: $&#123;stderr&#125;&#x27;</span>);<br>&#125;)<br></code></pre></td></tr></table></figure><h3 id="启动后台任务"><a class="markdownIt-Anchor" href="#启动后台任务"></a> 启动后台任务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">pm2 start hexo-deploy.js<br>pm2 start hexo-run.js<br></code></pre></td></tr></table></figure><p><strong>注：使用nginx发布时，不需要使用pm2启动hexo-run.js或者通过hexo s发布</strong></p><h2 id="nginx"><a class="markdownIt-Anchor" href="#nginx"></a> nginx</h2><h3 id="安装nginx"><a class="markdownIt-Anchor" href="#安装nginx"></a> 安装nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt/yum/dnf install nginx -y<br></code></pre></td></tr></table></figure><h3 id="添加路由配置"><a class="markdownIt-Anchor" href="#添加路由配置"></a> 添加路由配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">root</span> /opt/hexo/public;<br><br><span class="hljs-section">location</span> / &#123;<br>   <span class="hljs-attribute">index</span> index.html;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="启动nginx"><a class="markdownIt-Anchor" href="#启动nginx"></a> 启动nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl start nginx <br></code></pre></td></tr></table></figure><p><strong>可以使用pm2后台控制hexo的构建，nginx配置路由及https证书</strong></p><h2 id="github-page"><a class="markdownIt-Anchor" href="#github-page"></a> github page</h2><h3 id="生成密钥"><a class="markdownIt-Anchor" href="#生成密钥"></a> 生成密钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-keygen -t rsa -C github邮箱地址<br><br><span class="hljs-built_in">cat</span> id_rsa.pub<br></code></pre></td></tr></table></figure><h3 id="在github页码中配置密钥"><a class="markdownIt-Anchor" href="#在github页码中配置密钥"></a> 在github页码中配置密钥</h3><h3 id="安装插件"><a class="markdownIt-Anchor" href="#安装插件"></a> 安装插件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm i hexo-deployer-git --save<br></code></pre></td></tr></table></figure><h3 id="修改配置"><a class="markdownIt-Anchor" href="#修改配置"></a> 修改配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">deploy:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">git</span><br>  <span class="hljs-attr">repo:</span> <span class="hljs-string">&lt;repository</span> <span class="hljs-string">url&gt;</span>  <span class="hljs-comment"># ssh地址</span><br>  <span class="hljs-attr">branch:</span> <span class="hljs-string">&lt;branch</span> <span class="hljs-string">name&gt;</span>   <span class="hljs-comment"># master</span><br></code></pre></td></tr></table></figure><h3 id="配置git信息"><a class="markdownIt-Anchor" href="#配置git信息"></a> 配置git信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">git config --global user.name <span class="hljs-string">&quot;github用户名&quot;</span><br>git config --global user.email <span class="hljs-string">&quot;github邮箱地址&quot;</span><br></code></pre></td></tr></table></figure><h3 id="构建发布"><a class="markdownIt-Anchor" href="#构建发布"></a> 构建发布</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexo clean<br>hexo g -d<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学海无涯</category>
      
      <category>Hexo</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>手动部署Train版OpenStack</title>
    <link href="/posts/476f61d5.html"/>
    <url>/posts/476f61d5.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1 id="enviroment"><a class="markdownIt-Anchor" href="#enviroment"></a> Enviroment</h1><table><thead><tr><th style="text-align:center">hostname</th><th style="text-align:center">os</th><th style="text-align:center">static ip</th><th style="text-align:center">role</th></tr></thead><tbody><tr><td style="text-align:center">controller</td><td style="text-align:center">centos7.8</td><td style="text-align:center">网卡1Nat模式静态10.10.10.101；网卡2仅主机模式不设IP，网关地址192.168.40.1</td><td style="text-align:center">主控</td></tr><tr><td style="text-align:center">computer</td><td style="text-align:center">centos7.8</td><td style="text-align:center">网卡1Nat模式静态10.10.10.102；网卡2仅主机模式不设IP，网关地址192.168.40.1</td><td style="text-align:center">计算</td></tr><tr><td style="text-align:center">block</td><td style="text-align:center">centos7.8</td><td style="text-align:center">10.10.10.103</td><td style="text-align:center">块储存，双硬盘</td></tr></tbody></table><h1 id="prerequisites"><a class="markdownIt-Anchor" href="#prerequisites"></a> Prerequisites</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭防火墙</span><br>systemctl stop firewalld<br><span class="hljs-meta prompt_">#</span><span class="language-bash">禁用防火墙，重启生效</span><br>systemctl disable firewalld<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭selinux</span><br>setenforce 0<br><span class="hljs-meta prompt_">#</span><span class="language-bash">禁用selinux,重启生效</span><br>sed -i &quot;s/enforcing/disabled/g&quot; /etc/selinux/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装常用软件包</span><br>yum install vim net-tools lrzsz unzip dos2unix telnet sysstat iotop pciutils lsof tcpdump psmisc bc wget socat gcc tree chrony ntpdate -y<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主机名写入hosts</span><br>sed -i &#x27;$a\10.10.10.101 controller\n10.10.10.102 compute\n10.10.10.103 block&#x27; /etc/hosts<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主机间配置ssh免密登录</span><br>ssh-keygen -t rsa<br>for host in master backup node ; do ssh-copy-id -i ~/.ssh/id_rsa.pub $host;done<br></code></pre></td></tr></table></figure><h2 id="network-time-protoco"><a class="markdownIt-Anchor" href="#network-time-protoco"></a> <a href="https://docs.openstack.org/install-guide/environment-ntp.html#">Network Time Protoco</a></h2><h3 id="controller"><a class="markdownIt-Anchor" href="#controller"></a> controller</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install chrony -y<br><br>vim /etc/chrony.conf<br>allow 10.10.0.0/16 (主控节点网段)<br><br>for op in enable restart status;do systemctl $op chronyd;done<br></code></pre></td></tr></table></figure><h3 id="computerblock"><a class="markdownIt-Anchor" href="#computerblock"></a> computer,block</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install chrony -y<br><br>vim /etc/chrony.conf<br>server controller iburst<br><br>for op in enable restart status;do systemctl $op chronyd;done<br></code></pre></td></tr></table></figure><h2 id="openstack-packages"><a class="markdownIt-Anchor" href="#openstack-packages"></a> <a href="https://docs.openstack.org/install-guide/environment-packages.html#">OpenStack packages</a></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum list centos-release-openstack*<br>yum install centos-release-openstack-train -y<br>yum upgrade -y<br>yum install python-openstackclient openstack-selinux -y<br></code></pre></td></tr></table></figure><h2 id="sql-database"><a class="markdownIt-Anchor" href="#sql-database"></a> <a href="https://docs.openstack.org/install-guide/environment-sql-database.html">SQL database</a></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install mariadb mariadb-server python2-PyMySQL -y<br><br>vim /etc/my.cnf.d/openstack.conf<br>[mysqld]<br>bind-address = 10.10.10.101<br><br>default-storage-engine = innodb<br>innodb_file_per_table = on<br>max_connections = 4096<br>collation-server = utf8_general_ci<br>character-set-server = utf8<br><br>for op in enable start status;do systemctl $op mariadb;done<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">数据库初始化，需要设置密码</span><br>mysql_secure_installation<br></code></pre></td></tr></table></figure><h2 id="message-queue"><a class="markdownIt-Anchor" href="#message-queue"></a> <a href="https://docs.openstack.org/install-guide/environment-messaging.html">Message queue</a></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install rabbitmq-server -y<br><br>for op in enable start status;do systemctl $op rabbitmq-server;done<br><br>rabbitmqctl add_user openstack openstack<br><br>rabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装可视化插件</span><br>rabbitmq-plugins enable rabbitmq-management<br>systemctl restart rabbitmq-server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">访问http://主控节点IP:15672/，登录账户guest/guest，将刚建的openstack用户加入到管理组</span><br></code></pre></td></tr></table></figure><h2 id="memcached"><a class="markdownIt-Anchor" href="#memcached"></a> <a href="https://docs.openstack.org/install-guide/environment-memcached.html">Memcached</a></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install memcached python-memcached -y<br><br>sed -i &#x27;s/127.0.0.1/10.10.10.101/&#x27; /etc/sysconfig/memcached<br><br>for op in enable start status;do systemctl $op memcached;done<br></code></pre></td></tr></table></figure><h2 id="etcd"><a class="markdownIt-Anchor" href="#etcd"></a> <a href="https://docs.openstack.org/install-guide/environment-etcd.html">Etcd</a></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install etcd -y<br><br>vim /etc/etcd/etcd.conf<br><span class="hljs-meta prompt_">#</span><span class="language-bash">[Member]</span><br>ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;<br>ETCD_LISTEN_PEER_URLS=&quot;http://10.10.10.101:2380&quot;<br>ETCD_LISTEN_CLIENT_URLS=&quot;http://10.10.10.101:2379&quot;<br>ETCD_NAME=&quot;controller&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">[Clustering]</span><br>ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;http://10.10.10.101:2380&quot;<br>ETCD_ADVERTISE_CLIENT_URLS=&quot;http://10.10.10.101:2379&quot;<br>ETCD_INITIAL_CLUSTER=&quot;controller=http://10.10.10.101:2380&quot;<br>ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster-01&quot;<br>ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;<br><br>for op in enable start status;do systemctl $op etcd;done<br></code></pre></td></tr></table></figure><h1 id="keystone-installation-for-train"><a class="markdownIt-Anchor" href="#keystone-installation-for-train"></a> <a href="https://docs.openstack.org/keystone/train/install/">Keystone installation for Train</a></h1><h2 id="prerequisites-2"><a class="markdownIt-Anchor" href="#prerequisites-2"></a> Prerequisites</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">mysql -u root -p123456<br><br>CREATE DATABASE keystone;<br><br>GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;keystone&#x27;;<br>GRANT ALL PRIVILEGES ON keystone.* TO &#x27;keystone&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;keystone&#x27;;<br><br>exit;<br></code></pre></td></tr></table></figure><h2 id="install-and-configure-components"><a class="markdownIt-Anchor" href="#install-and-configure-components"></a> Install and configure components</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install openstack-keystone httpd mod_wsgi -y<br><br>cp /etc/keystone/keystone.conf /etc/keystone/keystone.conf.bak<br><br>vim /etc/keystone/keystone.conf<br>[database]<br>connection = mysql+pymysql://keystone:keystone@controller/keystone<br>[token]<br>provider = fernet<br><br>su -s /bin/sh -c &quot;keystone-manage db_sync&quot; keystone<br><br>keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone<br>keystone-manage credential_setup --keystone-user keystone --keystone-group keystone<br><br>keystone-manage bootstrap --bootstrap-password admin(管理员密码) \<br>  --bootstrap-admin-url http://controller:5000/v3/ \<br>  --bootstrap-internal-url http://controller:5000/v3/ \<br>  --bootstrap-public-url http://controller:5000/v3/ \<br>  --bootstrap-region-id RegionOne<br></code></pre></td></tr></table></figure><h2 id="configure-the-apache-http-server"><a class="markdownIt-Anchor" href="#configure-the-apache-http-server"></a> Configure the Apache HTTP server</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/httpd/conf/httpd.conf<br>ServerName controller(主机名)<br><br>ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/<br></code></pre></td></tr></table></figure><h2 id="finalize-the-installation"><a class="markdownIt-Anchor" href="#finalize-the-installation"></a> Finalize the installation</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">for op in enable start status;do systemctl $op httpd;done<br><br>vim admin-openrc<br>export OS_USERNAME=admin<br>export OS_PASSWORD=Aadmin(管理员密码)<br>export OS_PROJECT_NAME=admin<br>export OS_USER_DOMAIN_NAME=Default<br>export OS_PROJECT_DOMAIN_NAME=Default<br>export OS_AUTH_URL=http://controller:5000/v3<br>export OS_IDENTITY_API_VERSION=3<br><br>source admin-openrc<br></code></pre></td></tr></table></figure><h2 id="create-a-domain-projects-users-and-roles"><a class="markdownIt-Anchor" href="#create-a-domain-projects-users-and-roles"></a> Create a domain, projects, users, and roles</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">openstack domain create --description &quot;An Example Domain&quot; example<br><br>openstack project create --domain default \<br>  --description &quot;Service Project&quot; service<br><br>openstack project create --domain default \<br>  --description &quot;Demo Project&quot; myproject<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置普通用户密码</span><br>openstack user create --domain default \<br>  --password-prompt myuser<br><br>openstack role create myrole<br><br>openstack role add --project myproject --user myuser myrole<br></code></pre></td></tr></table></figure><h2 id="verify-operation"><a class="markdownIt-Anchor" href="#verify-operation"></a> Verify operation</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">unset OS_AUTH_URL OS_PASSWORD<br><br>openstack --os-auth-url http://controller:5000/v3 \<br>  --os-project-domain-name Default --os-user-domain-name Default \<br>  --os-project-name admin --os-username admin token issue<br><br>openstack --os-auth-url http://controller:5000/v3 \<br>  --os-project-domain-name Default --os-user-domain-name Default \<br>  --os-project-name myproject --os-username myuser token issue<br><br>vim demo-openrc<br>export OS_PROJECT_DOMAIN_NAME=Default<br>export OS_USER_DOMAIN_NAME=Default<br>export OS_PROJECT_NAME=myproject<br>export OS_USERNAME=myuser<br>export OS_PASSWORD=demo(普通用户密码)<br>export OS_AUTH_URL=http://controller:5000/v3<br>export OS_IDENTITY_API_VERSION=3<br>export OS_IMAGE_API_VERSION=2<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看普通用户token信息</span><br>source demo-openrc<br>openstack token issue<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看管理员token信息</span><br>source admin-openrc<br>openstack token issue<br></code></pre></td></tr></table></figure><h1 id="glance-installation-for-train"><a class="markdownIt-Anchor" href="#glance-installation-for-train"></a> <a href="https://docs.openstack.org/glance/train/install/">Glance installation for Train</a></h1><h2 id="prerequisites-3"><a class="markdownIt-Anchor" href="#prerequisites-3"></a> Prerequisites</h2><h3 id="create-database"><a class="markdownIt-Anchor" href="#create-database"></a> Create Database</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">mysql -u root -p123456<br><br>CREATE DATABASE glance;<br><br>GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;localhost&#x27; \<br>  IDENTIFIED BY &#x27;glance&#x27;;<br>GRANT ALL PRIVILEGES ON glance.* TO &#x27;glance&#x27;@&#x27;%&#x27; \<br>  IDENTIFIED BY &#x27;glance&#x27;;<br><br>exit;<br></code></pre></td></tr></table></figure><h3 id="configure-user-and-endpoints"><a class="markdownIt-Anchor" href="#configure-user-and-endpoints"></a> Configure User and Endpoints</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">. admin-openrc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置glance用户密码</span><br>openstack user create --domain default --password-prompt glance<br><br>openstack role add --project service --user glance admin<br><br>openstack service create --name glance \<br>  --description &quot;OpenStack Image&quot; image<br><br>openstack endpoint create --region RegionOne \<br>  image public http://controller:9292  <br>openstack endpoint create --region RegionOne \<br>  image internal http://controller:9292  <br>openstack endpoint create --region RegionOne \<br>  image admin http://controller:9292<br></code></pre></td></tr></table></figure><h2 id="install-and-configure-components-2"><a class="markdownIt-Anchor" href="#install-and-configure-components-2"></a> Install and configure components</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install openstack-glance -y<br><br>cp /etc/glance/glance-api.conf /etc/glance/glance-api.conf.bak<br>vim /etc/glance/glance-api.conf<br>[database]<br>connection = mysql+pymysql://glance:glance@controller/glance<br>[keystone_authtoken]<br>www_authenticate_uri  = http://controller:5000<br>auth_url = http://controller:5000<br>memcached_servers = controller:11211<br>auth_type = password<br>project_domain_name = Default<br>user_domain_name = Default<br>project_name = service<br>username = glance<br>password = glance(glance用户密码)<br>[paste_deploy]<br>flavor = keystone<br>[glance_store]<br>stores = file,http<br>default_store = file<br>filesystem_store_datadir = /var/lib/glance/images/<br><br>su -s /bin/sh -c &quot;glance-manage db_sync&quot; glance<br><br>for op in enable start status;do systemctl $op openstack-glance-api;done<br></code></pre></td></tr></table></figure><h2 id="verify-operation-2"><a class="markdownIt-Anchor" href="#verify-operation-2"></a> Verify operation</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img<br><br>glance image-create --name &quot;cirros&quot; \<br>  --file cirros-0.4.0-x86_64-disk.img \<br>  --disk-format qcow2 --container-format bare \<br>  --visibility public<br><br>glance image-create --name &quot;Centos7&quot; \<br>  --file CentOS-7-x86_64-GenericCloud-2003.qcow2c \<br>  --disk-format qcow2 --container-format bare \<br>  --visibility public<br><br>openstack images list<br></code></pre></td></tr></table></figure><h1 id="placement-installation-for-train"><a class="markdownIt-Anchor" href="#placement-installation-for-train"></a> <a href="https://docs.openstack.org/placement/train/install/">Placement installation for Train</a></h1><h2 id="prerequisites-4"><a class="markdownIt-Anchor" href="#prerequisites-4"></a> Prerequisites</h2><h3 id="create-database-2"><a class="markdownIt-Anchor" href="#create-database-2"></a> Create Database</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">mysql -u root -p123456<br><br>CREATE DATABASE placement;<br><br>GRANT ALL PRIVILEGES ON placement.* TO &#x27;placement&#x27;@&#x27;localhost&#x27; \<br>  IDENTIFIED BY &#x27;placement&#x27;;<br>GRANT ALL PRIVILEGES ON placement.* TO &#x27;placement&#x27;@&#x27;%&#x27; \<br>  IDENTIFIED BY &#x27;placement&#x27;;<br><br>exit<br></code></pre></td></tr></table></figure><h3 id="configure-user-and-endpoints-2"><a class="markdownIt-Anchor" href="#configure-user-and-endpoints-2"></a> Configure User and Endpoints</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">. admin-openrc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置placement用户密码</span><br>openstack user create --domain default --password-prompt placement<br><br>openstack role add --project service --user placement admin<br><br>openstack service create --name placement \<br>  --description &quot;Placement API&quot; placement<br><br>openstack endpoint create --region RegionOne \<br>  placement public http://controller:8778<br>openstack endpoint create --region RegionOne \<br>  placement internal http://controller:8778<br>openstack endpoint create --region RegionOne \<br>  placement admin http://controller:8778<br></code></pre></td></tr></table></figure><h2 id="install-and-configure-components-3"><a class="markdownIt-Anchor" href="#install-and-configure-components-3"></a> Install and configure components</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install openstack-placement-api -y<br><br>cp /etc/placement/placement.conf /etc/placement/placement.conf.bak<br>vim /etc/placement/placement.conf<br>[placement_database]<br>connection = mysql+pymysql://placement:placement@controller/placement<br>[api]<br>auth_strategy = keystone<br>[keystone_authtoken]<br>auth_url = http://controller:5000/v3<br>memcached_servers = controller:11211<br>auth_type = password<br>project_domain_name = Default<br>user_domain_name = Default<br>project_name = service<br>username = placement<br>password = placement(placement用户密码)<br><br>su -s /bin/sh -c &quot;placement-manage db sync&quot; placement<br><br>systemctl restart httpd &amp; systemctl status httpd<br></code></pre></td></tr></table></figure><h2 id="verify-operation-3"><a class="markdownIt-Anchor" href="#verify-operation-3"></a> Verify operation</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">. admin-openrc<br><br>placement-status upgrade check<br><br>yum install epel-release -y<br>yum install -y python-pip<br>pip install --upgrade pip<br>pip install osc-placement<br><br>openstack --os-placement-api-version 1.2 resource class list --sort-column name<br>openstack --os-placement-api-version 1.6 trait list --sort-column name<br></code></pre></td></tr></table></figure><h1 id="nova-installation-for-train"><a class="markdownIt-Anchor" href="#nova-installation-for-train"></a> <a href="https://docs.openstack.org/nova/train/install/">Nova installation for Train</a></h1><h2 id="controller-2"><a class="markdownIt-Anchor" href="#controller-2"></a> controller</h2><h3 id="prerequisites-5"><a class="markdownIt-Anchor" href="#prerequisites-5"></a> Prerequisites</h3><h4 id="create-database-3"><a class="markdownIt-Anchor" href="#create-database-3"></a> Create Database</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">mysql -u root -p123456<br><br>CREATE DATABASE nova_api;<br>CREATE DATABASE nova;<br>CREATE DATABASE nova_cell0;<br><br>GRANT ALL PRIVILEGES ON nova_api.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; \<br>  IDENTIFIED BY &#x27;nova&#x27;;<br>GRANT ALL PRIVILEGES ON nova_api.* TO &#x27;nova&#x27;@&#x27;%&#x27; \<br>  IDENTIFIED BY &#x27;nova&#x27;;<br><br>GRANT ALL PRIVILEGES ON nova.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; \<br>  IDENTIFIED BY &#x27;nova&#x27;;<br>GRANT ALL PRIVILEGES ON nova.* TO &#x27;nova&#x27;@&#x27;%&#x27; \<br>  IDENTIFIED BY &#x27;nova&#x27;;<br><br>GRANT ALL PRIVILEGES ON nova_cell0.* TO &#x27;nova&#x27;@&#x27;localhost&#x27; \<br>  IDENTIFIED BY &#x27;nova&#x27;;<br>GRANT ALL PRIVILEGES ON nova_cell0.* TO &#x27;nova&#x27;@&#x27;%&#x27; \<br>  IDENTIFIED BY &#x27;nova&#x27;;<br><br>exit;<br></code></pre></td></tr></table></figure><h4 id="configure-user-and-endpoints-3"><a class="markdownIt-Anchor" href="#configure-user-and-endpoints-3"></a> Configure User and Endpoints</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">. admin-openrc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置nova用户密码</span><br>openstack user create --domain default --password-prompt nova<br><br>openstack role add --project service --user nova admin<br><br>openstack service create --name nova \<br>  --description &quot;OpenStack Compute&quot; compute<br><br>openstack endpoint create --region RegionOne \<br>  compute public http://controller:8774/v2.1<br>openstack endpoint create --region RegionOne \<br>  compute internal http://controller:8774/v2.1<br>openstack endpoint create --region RegionOne \<br>  compute admin http://controller:8774/v2.1<br></code></pre></td></tr></table></figure><h3 id="install-and-configure-components-4"><a class="markdownIt-Anchor" href="#install-and-configure-components-4"></a> Install and configure components</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install openstack-nova-api openstack-nova-conductor \<br>  openstack-nova-novncproxy openstack-nova-scheduler -y<br>cp /etc/nova/nova.conf /etc/nova/nova.conf.bak<br>vim /etc/nova/nova.conf<br>[DEFAULT]<br>enabled_apis = osapi_compute,metadata<br>transport_url = rabbit://openstack:openstack@controller:5672/<br>my_ip = 10.10.10.101(主控节点IP)<br>use_neutron = true<br>firewall_driver = nova.virt.firewall.NoopFirewallDriver<br><br>[api_database]<br>connection = mysql+pymysql://nova:nova@controller/nova_api<br><br>[database]<br>connection = mysql+pymysql://nova:nova@controller/nova<br><br>[api]<br>auth_strategy = keystone<br><br>[keystone_authtoken]<br>www_authenticate_uri = http://controller:5000/<br>auth_url = http://controller:5000/<br>memcached_servers = controller:11211<br>auth_type = password<br>project_domain_name = Default<br>user_domain_name = Default<br>project_name = service<br>username = nova<br>password = nova(nova用户密码)<br><br>[vnc]<br>enabled = true<br>server_listen = $my_ip<br>server_proxyclient_address = $my_ip<br><br>[glance]<br>api_servers = http://controller:9292<br><br>[oslo_concurrency]<br>lock_path = /var/lib/nova/tmp<br><br>[placement]<br>region_name = RegionOne<br>project_domain_name = Default<br>project_name = service<br>auth_type = password<br>user_domain_name = Default<br>auth_url = http://controller:5000/v3<br>username = placement<br>password = placement(placement用户密码)<br><br>[scheduler]<br>discover_hosts_in_cells_interval = 300<br><br>vim /etc/httpd/conf.d/00-nova-placement-api.conf<br>&lt;Directory /usr/bin&gt;<br>   &lt;IfVersion &gt;= 2.4&gt;<br>      Require all granted<br>   &lt;/IfVersion&gt;<br>   &lt;IfVersion &lt; 2.4&gt;<br>      Order allow,deny<br>      Allow from all<br>   &lt;/IfVersion&gt;<br>&lt;/Directory&gt;<br><br>su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova<br>su -s /bin/sh -c &quot;nova-manage cell_v2 map_cell0&quot; nova<br>su -s /bin/sh -c &quot;nova-manage cell_v2 create_cell --name=cell1 --verbose&quot; nova<br>su -s /bin/sh -c &quot;nova-manage db sync&quot; nova<br>su -s /bin/sh -c &quot;nova-manage cell_v2 list_cells&quot; nova<br><br>for op in enable satrt status;do for service in openstack-nova-api openstack-nova-scheduler openstack-nova-conductor openstack-nova-novncproxy;do systemctl $op $service;done;done<br></code></pre></td></tr></table></figure><h2 id="compute"><a class="markdownIt-Anchor" href="#compute"></a> compute</h2><h3 id="install-and-configure-components-5"><a class="markdownIt-Anchor" href="#install-and-configure-components-5"></a> Install and configure components</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install openstack-nova-compute libvirt -y<br><br>cp /etc/nova/nova.conf /etc/nova/nova.conf.bak<br>vim /etc/nova/nova.conf<br>[DEFAULT]<br>enabled_apis = osapi_compute,metadata<br>transport_url = rabbit://openstack:openstack@controller<br>my_ip = 10.10.10.102(计算节点IP)<br>use_neutron = true<br>firewall_driver = nova.virt.firewall.NoopFirewallDriver<br><br>[api]<br>auth_strategy = keystone<br><br>[keystone_authtoken]<br>www_authenticate_uri = http://controller:5000/<br>auth_url = http://controller:5000/<br>memcached_servers = controller:11211<br>auth_type = password<br>project_domain_name = Default<br>user_domain_name = Default<br>project_name = service<br>username = nova<br>password = nova(nova用户密码)<br><br>[vnc]<br>enabled = true<br>server_listen = 0.0.0.0<br>server_proxyclient_address = $my_ip<br>novncproxy_base_url = http://controller:6080/vnc_auto.html<br><br>[glance]<br>api_servers = http://controller:9292<br><br>[oslo_concurrency]<br>lock_path = /var/lib/nova/tmp<br><br>[placement]<br>region_name = RegionOne<br>project_domain_name = Default<br>project_name = service<br>auth_type = password<br>user_domain_name = Default<br>auth_url = http://controller:5000/v3<br>username = placement<br>password = placement(placement用户密码)<br><br>[libvirt]<br>cpu_mode = none<br>virt_type=qemu<br><br><br>for op in enable satrt status;do for service in libvirtd openstack-nova-compute;do systemctl $op $service;done;done<br></code></pre></td></tr></table></figure><h2 id="controller-3"><a class="markdownIt-Anchor" href="#controller-3"></a> controller</h2><h3 id="verify-operation-4"><a class="markdownIt-Anchor" href="#verify-operation-4"></a> Verify operation</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">. admin-openrc<br>openstack compute service list<br>su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova<br></code></pre></td></tr></table></figure><h1 id="neutron-installation-for-train"><a class="markdownIt-Anchor" href="#neutron-installation-for-train"></a> <a href="https://docs.openstack.org/neutron/train/install/">Neutron installation for Train</a></h1><h2 id="controller-4"><a class="markdownIt-Anchor" href="#controller-4"></a> controller</h2><h3 id="prerequisites-6"><a class="markdownIt-Anchor" href="#prerequisites-6"></a> Prerequisites</h3><h4 id="create-database-4"><a class="markdownIt-Anchor" href="#create-database-4"></a> Create Database</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">mysql -u root -p123456<br><br>CREATE DATABASE neutron;<br><br>GRANT ALL PRIVILEGES ON neutron.* TO &#x27;neutron&#x27;@&#x27;localhost&#x27; \<br>  IDENTIFIED BY &#x27;neutron&#x27;;<br>GRANT ALL PRIVILEGES ON neutron.* TO &#x27;neutron&#x27;@&#x27;%&#x27; \<br>  IDENTIFIED BY &#x27;neutron&#x27;;<br><br>exit;<br></code></pre></td></tr></table></figure><h4 id="configure-user-and-endpoints-4"><a class="markdownIt-Anchor" href="#configure-user-and-endpoints-4"></a> Configure User and Endpoints</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">. admin-openrc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置neutron用户密码</span><br>openstack user create --domain default --password-prompt neutron<br><br>openstack role add --project service --user neutron admin<br><br>openstack service create --name neutron \<br>  --description &quot;OpenStack Networking&quot; network<br><br>openstack endpoint create --region RegionOne \<br>  network public http://controller:9696<br>openstack endpoint create --region RegionOne \<br>  network internal http://controller:9696<br>openstack endpoint create --region RegionOne \<br>  network admin http://controller:9696<br></code></pre></td></tr></table></figure><h3 id="install-and-configure-components-6"><a class="markdownIt-Anchor" href="#install-and-configure-components-6"></a> Install and configure components</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install openstack-neutron openstack-neutron-ml2 \<br>  openstack-neutron-linuxbridge ebtables -y<br></code></pre></td></tr></table></figure><h4 id="provider-networks"><a class="markdownIt-Anchor" href="#provider-networks"></a> <a href="https://docs.openstack.org/neutron/train/install/controller-install-option1-rdo.html">Provider networks</a></h4><h5 id="vim-etcneutronneutronconf"><a class="markdownIt-Anchor" href="#vim-etcneutronneutronconf"></a> vim /etc/neutron/neutron.conf</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[database]</span><br><span class="hljs-attr">connection</span> = <span class="hljs-string">mysql+pymysql://neutron:neutron@controller/neutron</span><br><br><span class="hljs-attr">[DEFAULT]</span><br><span class="hljs-attr">core_plugin</span> = <span class="hljs-string">ml2</span><br><span class="hljs-attr">service_plugins</span> =<span class="hljs-string"></span><br><span class="hljs-attr">transport_url</span> = <span class="hljs-string">rabbit://openstack:openstack@controller</span><br><span class="hljs-attr">auth_strategy</span> = <span class="hljs-string">keystone</span><br><span class="hljs-attr">notify_nova_on_port_status_changes</span> = <span class="hljs-string">true</span><br><span class="hljs-attr">notify_nova_on_port_data_changes</span> = <span class="hljs-string">true</span><br><br><span class="hljs-attr">[keystone_authtoken]</span><br><span class="hljs-attr">www_authenticate_uri</span> = <span class="hljs-string">http://controller:5000</span><br><span class="hljs-attr">auth_url</span> = <span class="hljs-string">http://controller:5000</span><br><span class="hljs-attr">memcached_servers</span> = <span class="hljs-string">controller:11211</span><br><span class="hljs-attr">auth_type</span> = <span class="hljs-string">password</span><br><span class="hljs-attr">project_domain_name</span> = <span class="hljs-string">default</span><br><span class="hljs-attr">user_domain_name</span> = <span class="hljs-string">default</span><br><span class="hljs-attr">project_name</span> = <span class="hljs-string">service</span><br><span class="hljs-attr">username</span> = <span class="hljs-string">neutron</span><br><span class="hljs-attr">password</span> = <span class="hljs-string">neutron(neutron用户密码)</span><br><br><span class="hljs-attr">[nova]</span><br><span class="hljs-attr">auth_url</span> = <span class="hljs-string">http://controller:5000</span><br><span class="hljs-attr">auth_type</span> = <span class="hljs-string">password</span><br><span class="hljs-attr">project_domain_name</span> = <span class="hljs-string">default</span><br><span class="hljs-attr">user_domain_name</span> = <span class="hljs-string">default</span><br><span class="hljs-attr">region_name</span> = <span class="hljs-string">RegionOne</span><br><span class="hljs-attr">project_name</span> = <span class="hljs-string">service</span><br><span class="hljs-attr">username</span> = <span class="hljs-string">nova</span><br><span class="hljs-attr">password</span> = <span class="hljs-string">nova(nova用户密码)</span><br><br><span class="hljs-attr">[oslo_concurrency]</span><br><span class="hljs-attr">lock_path</span> = <span class="hljs-string">/var/lib/neutron/tmp</span><br></code></pre></td></tr></table></figure><h5 id="vim-etcneutronpluginsml2ml2_confini"><a class="markdownIt-Anchor" href="#vim-etcneutronpluginsml2ml2_confini"></a> vim /etc/neutron/plugins/ml2/ml2_conf.ini</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[ml2]</span><br><span class="hljs-attr">type_drivers</span> = <span class="hljs-string">flat,vlan</span><br><span class="hljs-attr">tenant_network_types</span> =<span class="hljs-string"></span><br><span class="hljs-attr">mechanism_drivers</span> = <span class="hljs-string">linuxbridge</span><br><span class="hljs-attr">extension_drivers</span> = <span class="hljs-string">port_security</span><br><br><span class="hljs-attr">[ml2_type_flat]</span><br><span class="hljs-attr">flat_networks</span> = <span class="hljs-string">provider</span><br><br><span class="hljs-attr">[securitygroup]</span><br><span class="hljs-attr">enable_ipset</span> = <span class="hljs-string">true</span><br></code></pre></td></tr></table></figure><h5 id="vim-etcneutronpluginsml2linuxbridge_agentini"><a class="markdownIt-Anchor" href="#vim-etcneutronpluginsml2linuxbridge_agentini"></a> vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[linux_bridge]</span><br><span class="hljs-attr">physical_interface_mappings</span> = <span class="hljs-string">provider:ens33(服务器网络接口名)</span><br><br><span class="hljs-attr">[vxlan]</span><br><span class="hljs-attr">enable_vxlan</span> = <span class="hljs-string">false</span><br><br><span class="hljs-attr">[securitygroup]</span><br><span class="hljs-attr">enable_security_group</span> = <span class="hljs-string">true</span><br><span class="hljs-attr">firewall_driver</span> = <span class="hljs-string">neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br></code></pre></td></tr></table></figure><h5 id="edit-kernel-supports"><a class="markdownIt-Anchor" href="#edit-kernel-supports"></a> edit kernel supports</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">modprobe br_netfilter<br><br>vim /etc/sysctl.conf<br>net.bridge.bridge-nf-call-iptables = 1<br>net.bridge.bridge-nf-call-ip6tables = 1<br><br>sysctl -p<br></code></pre></td></tr></table></figure><h5 id="vim-etcneutrondhcp_agentini"><a class="markdownIt-Anchor" href="#vim-etcneutrondhcp_agentini"></a> vim /etc/neutron/dhcp_agent.ini</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[DEFAULT]</span><br><span class="hljs-attr">interface_driver</span> = <span class="hljs-string">linuxbridge</span><br><span class="hljs-attr">dhcp_driver</span> = <span class="hljs-string">neutron.agent.linux.dhcp.Dnsmasq</span><br><span class="hljs-attr">enable_isolated_metadata</span> = <span class="hljs-string">true</span><br></code></pre></td></tr></table></figure><h5 id="vim-etcneutronmetadata_agentini"><a class="markdownIt-Anchor" href="#vim-etcneutronmetadata_agentini"></a> vim /etc/neutron/metadata_agent.ini</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[DEFAULT]</span><br><span class="hljs-attr">nova_metadata_host</span> = <span class="hljs-string">controller</span><br><span class="hljs-attr">metadata_proxy_shared_secret</span> = <span class="hljs-string">metadata(网络共享密码)</span><br></code></pre></td></tr></table></figure><h5 id="vim-etcnovanovaconf"><a class="markdownIt-Anchor" href="#vim-etcnovanovaconf"></a> vim /etc/nova/nova.conf</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[neutron]</span><br><span class="hljs-attr">auth_url</span> = <span class="hljs-string">http://controller:5000</span><br><span class="hljs-attr">auth_type</span> = <span class="hljs-string">password</span><br><span class="hljs-attr">project_domain_name</span> = <span class="hljs-string">default</span><br><span class="hljs-attr">user_domain_name</span> = <span class="hljs-string">default</span><br><span class="hljs-attr">region_name</span> = <span class="hljs-string">RegionOne</span><br><span class="hljs-attr">project_name</span> = <span class="hljs-string">service</span><br><span class="hljs-attr">username</span> = <span class="hljs-string">neutron</span><br><span class="hljs-attr">password</span> = <span class="hljs-string">neutron(neutron用户密码)</span><br><span class="hljs-attr">service_metadata_proxy</span> = <span class="hljs-string">true</span><br><span class="hljs-attr">metadata_proxy_shared_secret</span> = <span class="hljs-string">metadata(网络共享密码)</span><br></code></pre></td></tr></table></figure><h3 id="finalize-installation"><a class="markdownIt-Anchor" href="#finalize-installation"></a> Finalize installation</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini<br><br>su -s /bin/sh -c &quot;neutron-db-manage --config-file /etc/neutron/neutron.conf \<br>  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head&quot; neutron<br><br>systemctl restart openstack-nova-api.service<br><br>for op in enable start status;do for service in neutron-server neutron-linuxbridge-agent neutron-dhcp-agent neutron-metadata-agent;do systemctl $op $servicel;done;done<br><br>for op in enable start status;do systemctl $op neutron-l3-agent;done<br></code></pre></td></tr></table></figure><h2 id="compute-2"><a class="markdownIt-Anchor" href="#compute-2"></a> compute</h2><h3 id="install-and-configure-components-7"><a class="markdownIt-Anchor" href="#install-and-configure-components-7"></a> Install and configure components</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install openstack-neutron-linuxbridge ebtables ipset -y<br></code></pre></td></tr></table></figure><h4 id="vim-etcneutronneutronconf-2"><a class="markdownIt-Anchor" href="#vim-etcneutronneutronconf-2"></a> vim /etc/neutron/neutron.conf</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[DEFAULT]</span><br><span class="hljs-attr">transport_url</span> = <span class="hljs-string">rabbit://openstack:openstack@controller</span><br><span class="hljs-attr">auth_strategy</span> = <span class="hljs-string">keystone</span><br><br><span class="hljs-attr">[keystone_authtoken]</span><br><span class="hljs-attr">www_authenticate_uri</span> = <span class="hljs-string">http://controller:5000</span><br><span class="hljs-attr">auth_url</span> = <span class="hljs-string">http://controller:5000</span><br><span class="hljs-attr">memcached_servers</span> = <span class="hljs-string">controller:11211</span><br><span class="hljs-attr">auth_type</span> = <span class="hljs-string">password</span><br><span class="hljs-attr">project_domain_name</span> = <span class="hljs-string">default</span><br><span class="hljs-attr">user_domain_name</span> = <span class="hljs-string">default</span><br><span class="hljs-attr">project_name</span> = <span class="hljs-string">service</span><br><span class="hljs-attr">username</span> = <span class="hljs-string">neutron</span><br><span class="hljs-attr">password</span> = <span class="hljs-string">neutron(neutron用户密码)</span><br><br><span class="hljs-attr">[oslo_concurrency]</span><br><span class="hljs-attr">lock_path</span> = <span class="hljs-string">/var/lib/neutron/tmp</span><br></code></pre></td></tr></table></figure><h4 id="provider-networks-2"><a class="markdownIt-Anchor" href="#provider-networks-2"></a> <a href="https://docs.openstack.org/neutron/train/install/compute-install-option1-rdo.html">Provider networks</a></h4><h5 id="vim-etcneutronpluginsml2linuxbridge_agentini-2"><a class="markdownIt-Anchor" href="#vim-etcneutronpluginsml2linuxbridge_agentini-2"></a> vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[linux_bridge]</span><br><span class="hljs-attr">physical_interface_mappings</span> = <span class="hljs-string">provider:ens33(服务器网络接口名)</span><br><br><span class="hljs-attr">[vxlan]</span><br><span class="hljs-attr">enable_vxlan</span> = <span class="hljs-string">false</span><br><br><span class="hljs-attr">[securitygroup]</span><br><span class="hljs-attr">enable_security_group</span> = <span class="hljs-string">true</span><br><span class="hljs-attr">firewall_driver</span> = <span class="hljs-string">neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br></code></pre></td></tr></table></figure><h5 id="edit-kernel-supports-2"><a class="markdownIt-Anchor" href="#edit-kernel-supports-2"></a> edit kernel supports</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">modprobe br_netfilter<br><br>vim /etc/sysctl.conf<br>net.bridge.bridge-nf-call-iptables = 1<br>net.bridge.bridge-nf-call-ip6tables = 1<br><br>sysctl -p<br></code></pre></td></tr></table></figure><h4 id="vim-etcnovanovaconf-2"><a class="markdownIt-Anchor" href="#vim-etcnovanovaconf-2"></a> vim /etc/nova/nova.conf</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">[neutron]</span><br><span class="hljs-attr">auth_url</span> = <span class="hljs-string">http://controller:5000</span><br><span class="hljs-attr">auth_type</span> = <span class="hljs-string">password</span><br><span class="hljs-attr">project_domain_name</span> = <span class="hljs-string">default</span><br><span class="hljs-attr">user_domain_name</span> = <span class="hljs-string">default</span><br><span class="hljs-attr">region_name</span> = <span class="hljs-string">RegionOne</span><br><span class="hljs-attr">project_name</span> = <span class="hljs-string">service</span><br><span class="hljs-attr">username</span> = <span class="hljs-string">neutron</span><br><span class="hljs-attr">password</span> = <span class="hljs-string">neutron(neutron用户密码)</span><br></code></pre></td></tr></table></figure><h3 id="finalize-installation-2"><a class="markdownIt-Anchor" href="#finalize-installation-2"></a> Finalize installation</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl restart openstack-nova-compute<br><br>for op in enable start status;do systemctl $op neutron-linuxbridge-agent;done<br></code></pre></td></tr></table></figure><h2 id="verify-operation-5"><a class="markdownIt-Anchor" href="#verify-operation-5"></a> Verify operation</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">. admin-openrc<br></code></pre></td></tr></table></figure><h3 id="provider-networks-3"><a class="markdownIt-Anchor" href="#provider-networks-3"></a> <a href="https://docs.openstack.org/neutron/train/install/verify-option1.html">Provider networks</a></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">openstack extension list --network<br></code></pre></td></tr></table></figure><h3 id="self-service-networks"><a class="markdownIt-Anchor" href="#self-service-networks"></a> <a href="https://docs.openstack.org/neutron/train/install/verify-option2.html">Self-service networks</a></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">openstack network agent list<br></code></pre></td></tr></table></figure><h1 id="cinder-installation-for-train"><a class="markdownIt-Anchor" href="#cinder-installation-for-train"></a> <a href="https://docs.openstack.org/cinder/train/install/">Cinder installation for Train</a></h1><h2 id="controller-5"><a class="markdownIt-Anchor" href="#controller-5"></a> controller</h2><h3 id="prerequisites-7"><a class="markdownIt-Anchor" href="#prerequisites-7"></a> Prerequisites</h3><h4 id="create-database-5"><a class="markdownIt-Anchor" href="#create-database-5"></a> Create Database</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">mysql -u root -p123456<br><br>CREATE DATABASE cinder;<br><br>GRANT ALL PRIVILEGES ON cinder.* TO &#x27;cinder&#x27;@&#x27;localhost&#x27; \<br>  IDENTIFIED BY &#x27;cinder&#x27;;<br>GRANT ALL PRIVILEGES ON cinder.* TO &#x27;cinder&#x27;@&#x27;%&#x27; \<br>  IDENTIFIED BY &#x27;cinder&#x27;;<br><br>exit;<br></code></pre></td></tr></table></figure><h4 id="configure-user-and-endpoints-5"><a class="markdownIt-Anchor" href="#configure-user-and-endpoints-5"></a> Configure User and Endpoints</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell">. admin-openrc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置cinder用户密码</span><br>openstack user create --domain default --password-prompt cinder<br><br>openstack role add --project service --user cinder admin<br><br>openstack service create --name cinderv2 \<br>  --description &quot;OpenStack Block Storage&quot; volumev2<br>openstack service create --name cinderv3 \<br>  --description &quot;OpenStack Block Storage&quot; volumev3<br><br>openstack endpoint create --region RegionOne \<br>  volumev2 public http://controller:8776/v2/%\(project_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev2 internal http://controller:8776/v2/%\(project_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev2 admin http://controller:8776/v2/%\(project_id\)s<br><br>openstack endpoint create --region RegionOne \<br>  volumev3 public http://controller:8776/v3/%\(project_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev3 internal http://controller:8776/v3/%\(project_id\)s<br>openstack endpoint create --region RegionOne \<br>  volumev3 admin http://controller:8776/v3/%\(project_id\)s<br></code></pre></td></tr></table></figure><h3 id="install-and-configure-components-8"><a class="markdownIt-Anchor" href="#install-and-configure-components-8"></a> Install and configure components</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install openstack-cinder -y<br><br>vim /etc/cinder/cinder.conf<br>[DEFAULT]<br>transport_url = rabbit://openstack:openstack@controller<br>auth_strategy = keystone<br>my_ip = 10.10.10.101<br>[database]<br>connection = mysql+pymysql://cinder:cinder@controller/cinder<br>[keystone_authtoken]<br>www_authenticate_uri = http://controller:5000<br>auth_url = http://controller:5000<br>memcached_servers = controller:11211<br>auth_type = password<br>project_domain_name = default<br>user_domain_name = default<br>project_name = service<br>username = cinder<br>password = cinder(cinder用户密码)<br>[oslo_concurrency]<br>lock_path = /var/lib/cinder/tmp<br><br>su -s /bin/sh -c &quot;cinder-manage db sync&quot; cinder<br></code></pre></td></tr></table></figure><h3 id="configure-compute-to-use-block-storage"><a class="markdownIt-Anchor" href="#configure-compute-to-use-block-storage"></a> Configure Compute to use Block Storage[</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/nova/nova.conf<br>[cinder]<br>os_region_name = RegionOne<br></code></pre></td></tr></table></figure><h3 id="finalize-installation-3"><a class="markdownIt-Anchor" href="#finalize-installation-3"></a> Finalize installation</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">for op in restart status;do systemctl $op openstack-nova-api;done<br><br>for op in enable restart status;do for service in openstack-cinder-api openstack-cinder-scheduler;do systemctl $op $service;done;done<br></code></pre></td></tr></table></figure><h2 id="block"><a class="markdownIt-Anchor" href="#block"></a> block</h2><h3 id="prerequisites-8"><a class="markdownIt-Anchor" href="#prerequisites-8"></a> Prerequisites</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install lvm2 device-mapper-persistent-data<br><br>for op in enable start status;do systemctl $op lvm2-lvmetad;done<br><br>pvcreate /dev/sdb<br><br>vgcreate cinder-volumes /dev/sdb<br><br>vim /etc/lvm/lvm.conf<br>devices &#123;<br>...<br>filter = [ &quot;a/sdb/&quot;, &quot;r/.*/&quot;]<br></code></pre></td></tr></table></figure><h3 id="install-and-configure-components-9"><a class="markdownIt-Anchor" href="#install-and-configure-components-9"></a> Install and configure components</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install openstack-cinder targetcli python-keystone -y<br><br>vim /etc/cinder/cinder.conf<br>[DEFAULT]<br>auth_strategy = keystone<br>transport_url = rabbit://openstack:openstack@controller<br>my_ip = 10.10.10.103<br>enabled_backends = lvm<br>glance_api_servers = http://controller:9292<br>[database]<br>connection = mysql+pymysql://cinder:cinder@controller/cinder<br>[keystone_authtoken]<br>www_authenticate_uri = http://controller:5000<br>auth_url = http://controller:5000<br>memcached_servers = controller:11211<br>auth_type = password<br>project_domain_name = default<br>user_domain_name = default<br>project_name = service<br>username = cinder<br>password = cinder<br>[lvm]<br>volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver<br>volume_group = cinder-volumes<br>target_protocol = iscsi<br>target_helper = lioadm<br>[oslo_concurrency]<br>lock_path = /var/lib/cinder/tmp<br></code></pre></td></tr></table></figure><h3 id="finalize-installation-4"><a class="markdownIt-Anchor" href="#finalize-installation-4"></a> Finalize installation</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">for op in enable restart status;do for service in openstack-cinder-volume target;do systemctl $op $service;done;done<br></code></pre></td></tr></table></figure><h2 id="verify-cinder-operation"><a class="markdownIt-Anchor" href="#verify-cinder-operation"></a> Verify Cinder operation</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">. admin-openrc<br>openstack volume service list<br></code></pre></td></tr></table></figure><h1 id="horizon-installation-for-train"><a class="markdownIt-Anchor" href="#horizon-installation-for-train"></a> <a href="https://docs.openstack.org/horizon/train/install/">Horizon installation for Train</a></h1><h2 id="install-and-configure-components-10"><a class="markdownIt-Anchor" href="#install-and-configure-components-10"></a> Install and configure components</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install openstack-dashboard -y<br><br>vim /etc/openstack-dashboard/local_settings<br><br>OPENSTACK_HOST = &quot;controller&quot;<br>ALLOWED_HOSTS = [&#x27;*&#x27;]<br>SESSION_ENGINE = &#x27;django.contrib.sessions.backends.cache&#x27;<br>CACHES = &#123;<br>    &#x27;default&#x27;: &#123;<br>         &#x27;BACKEND&#x27;: &#x27;django.core.cache.backends.memcached.MemcachedCache&#x27;,<br>         &#x27;LOCATION&#x27;: &#x27;controller:11211&#x27;,<br>    &#125;<br>&#125;<br>OPENSTACK_KEYSTONE_URL = &quot;http://%s:5000/v3&quot; % OPENSTACK_HOST<br>OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True<br>OPENSTACK_API_VERSIONS = &#123;<br>    &quot;identity&quot;: 3,<br>    &quot;image&quot;: 2,<br>    &quot;volume&quot;: 3,<br>&#125;<br>OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = &quot;Default&quot;<br>OPENSTACK_KEYSTONE_DEFAULT_ROLE = &quot;user&quot;<br>OPENSTACK_NEUTRON_NETWORK = &#123;<br>    ...<br>    &#x27;enable_router&#x27;: False,<br>    &#x27;enable_quotas&#x27;: False,<br>    &#x27;enable_distributed_router&#x27;: False,<br>    &#x27;enable_ha_router&#x27;: False,<br>    &#x27;enable_lb&#x27;: False,<br>    &#x27;enable_firewall&#x27;: False,<br>    &#x27;enable_vpn&#x27;: False,<br>    &#x27;enable_fip_topology_check&#x27;: False,<br>&#125;<br>TIME_ZONE = &quot;Asia/Shanghai&quot;<br>WEBROOT = &#x27;/dashboard/&#x27;<br><br>vim  /etc/httpd/conf.d/openstack-dashboard.conf<br>WSGIApplicationGroup %&#123;GLOBAL&#125;<br></code></pre></td></tr></table></figure><h2 id="finalize-installation-5"><a class="markdownIt-Anchor" href="#finalize-installation-5"></a> Finalize installation</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl restart httpd.service memcached.service<br><span class="hljs-meta prompt_">#</span><span class="language-bash">访问http://主控节点IP/dashboard/,域:default</span><br></code></pre></td></tr></table></figure><h1 id="launch-an-instance可以通过dashboard实现"><a class="markdownIt-Anchor" href="#launch-an-instance可以通过dashboard实现"></a> Launch an instance（可以通过dashboard实现）</h1><h2 id="create-virtual-networks"><a class="markdownIt-Anchor" href="#create-virtual-networks"></a> Create virtual networks</h2><h3 id="provider-network"><a class="markdownIt-Anchor" href="#provider-network"></a> Provider network</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">. admin-openrc<br><br>openstack network create  --share --external \<br>  --provider-physical-network provider \<br>  --provider-network-type flat provider<br><br>openstack subnet create --network provider \<br>  --allocation-pool start=192.168.40.101,end=192.168.40.250 \<br>  --dns-nameserver 8.8.8.8 --gateway 192.168.40.1 \<br>  --subnet-range 192.168.40.0/24 provider  <br></code></pre></td></tr></table></figure><h3 id="self-service-network"><a class="markdownIt-Anchor" href="#self-service-network"></a> Self-service network</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">. demo-openrc<br><br>openstack network create selfservice<br><br>openstack subnet create --network selfservice \<br>  --dns-nameserver 8.8.4.4 --gateway 172.16.1.1 \<br>  --subnet-range 172.16.1.0/24 selfservice<br><br>openstack router create router<br>openstack router add subnet router selfservice<br>openstack router set router --external-gateway provider<br><br>. admin-openrc<br>ip netns<br>openstack port list --router router<br></code></pre></td></tr></table></figure><h2 id="create-m1nano-flavor"><a class="markdownIt-Anchor" href="#create-m1nano-flavor"></a> Create m1.nano flavor</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">for op in enable satrt status;do for service in libvirtd openstack-nova-compute;do systemctl $op $service;done;done<br><br>openstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano<br>openstack flavor create --id 0 --vcpus 1 --ram 1024 --disk 10 m2.nano<br></code></pre></td></tr></table></figure><h2 id="generate-a-key-pair"><a class="markdownIt-Anchor" href="#generate-a-key-pair"></a> Generate a key pair</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle">. demo-openrc<br>ssh-keygen -q -N <span class="hljs-string">&quot;&quot;</span><br>openstack keypair create --<span class="hljs-keyword">public</span>-key ~<span class="hljs-regexp">/.ssh/i</span>d_rsa.pub mykey<br>openstack keypair list<br></code></pre></td></tr></table></figure><h2 id="add-security-group-rules"><a class="markdownIt-Anchor" href="#add-security-group-rules"></a> Add security group rules</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">openstack security group rule create --proto icmp default<br>openstack security group rule create --proto tcp --dst-port 22 default<br></code></pre></td></tr></table></figure><h2 id="launch-an-instance"><a class="markdownIt-Anchor" href="#launch-an-instance"></a> Launch an instance</h2><h3 id="provider-network-2"><a class="markdownIt-Anchor" href="#provider-network-2"></a> Provider network</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">. demo-openrc<br>openstack flavor list<br>openstack image list<br>openstack network list<br>openstack security group list<br><br>openstack server create --flavor m1.nano --image cirros \<br>  --nic net-id=PROVIDER_NET_ID --security-group default \<br>  --key-name mykey provider-instance<br>openstack server list<br>openstack console url show provider-instance<br></code></pre></td></tr></table></figure><h3 id="self-service-network-2"><a class="markdownIt-Anchor" href="#self-service-network-2"></a> Self-service network</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">openstack server create --flavor m1.nano --image cirros \<br>  --nic net-id=b364d40b-0e57-4b32-9949-db83666f0f57 --security-group default \<br>  --key-name mykey newserver<br></code></pre></td></tr></table></figure><h2 id="修改实例默认密码controller"><a class="markdownIt-Anchor" href="#修改实例默认密码controller"></a> 修改实例默认密码(controller)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/nova/nova.conf<br>inject_password=True<br><br>vim /etc/openstack-dashboard/local_settings<br>OPENSTACK_HYPERVISOR_FEATURES = &#123;<br>&#x27;can_set_password&#x27;: True<br>&#125;<br><br>systemctl restart openstack-nova-*<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建实例时写入以下脚本，并勾选配置驱动</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>passwd root&lt;&lt;EOF<br>123456<br>123456<br>EOF<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学海无涯</category>
      
      <category>Others</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>通过二进制方式部署Kubernetes集群</title>
    <link href="/posts/89a5c5a5.html"/>
    <url>/posts/89a5c5a5.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1 id="refence"><a class="markdownIt-Anchor" href="#refence"></a> Refence</h1><p><a href="https://www.cnblogs.com/lizexiong/p/14882419.html#blogTitle32">https://www.cnblogs.com/lizexiong/p/14882419.html#blogTitle32</a></p><h1 id="enviroment"><a class="markdownIt-Anchor" href="#enviroment"></a> Enviroment</h1><table><thead><tr><th style="text-align:center">Role</th><th style="text-align:center">IP</th><th style="text-align:center">Component</th><th style="text-align:center">Hostname</th></tr></thead><tbody><tr><td style="text-align:center">master(Kubernetes,Etcd)</td><td style="text-align:center">10.10.10.101</td><td style="text-align:center">cfssl<br/>etcd<br/>docker<br/>kube-apiserver<br/>kube-controller-manager<br/>kube-scheduler<br/>kubectl</td><td style="text-align:center">master</td></tr><tr><td style="text-align:center">node1(Kubernetes,Etcd)</td><td style="text-align:center">10.10.10.102</td><td style="text-align:center">etcd<br/>docker<br/>kubelet<br/>kube-proxy</td><td style="text-align:center">minion</td></tr><tr><td style="text-align:center">node2(Kubernetes,Etcd)</td><td style="text-align:center">10.10.10.103</td><td style="text-align:center">etcd<br/>docker<br/>kubelet<br/>kube-proxy</td><td style="text-align:center">slave</td></tr></tbody></table><h1 id="prepare"><a class="markdownIt-Anchor" href="#prepare"></a> Prepare</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">关闭防火墙</span><br>systemctl disable firewalld --now<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭selinux</span><br>setenforce 0<br><span class="hljs-meta prompt_">#</span><span class="language-bash">禁用,重启生效</span><br>sed -i &quot;s/enforcing/disabled/g&quot; /etc/selinux/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭swap</span><br>swapoff -a<br><span class="hljs-meta prompt_">#</span><span class="language-bash">永久关闭</span><br>sed -i &#x27;s/^[^#].*swap*/#&amp;/g&#x27; /etc/fstab<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装常用软件包</span><br>yum install vim net-tools lrzsz unzip dos2unix telnet sysstat iotop pciutils lsof tcpdump psmisc bc wget socat gcc tree chrony ntpdate mlocate zip unzip -y<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置主机名</span><br>hostnamectl set-hostname &lt;hostname&gt; <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主机名写入hosts</span><br>cat &gt;&gt; /etc/hosts &lt;&lt; EOF<br>10.10.10.101 master<br>10.10.10.102 minion<br>10.10.10.103 slave<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主机间配置ssh免密登录</span><br>ssh-keygen -t rsa<br>for host in master minion slave; do ssh-copy-id -i ~/.ssh/id_rsa.pub $host;done<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">内核开启网络支持</span><br>cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>net.ipv4.ip_forward = 1<br>net.ipv4.ip_nonlocal_bind = 1<br>EOF<br>modprobe br_netfilter<br>sysctl -p /etc/sysctl.d/kubernetes.conf<br></code></pre></td></tr></table></figure><h1 id="cfssl"><a class="markdownIt-Anchor" href="#cfssl"></a> Cfssl</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64<br>wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64<br>wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64<br>chmod +x cfssl*<br><br>mv cfssl_linux-amd64 /usr/bin/cfssl<br>mv cfssljson_linux-amd64 /usr/bin/cfssljson<br>mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo<br></code></pre></td></tr></table></figure><h1 id="etcd"><a class="markdownIt-Anchor" href="#etcd"></a> Etcd</h1><h2 id="自签ca"><a class="markdownIt-Anchor" href="#自签ca"></a> 自签CA</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir cfssl/etcd -p &amp;&amp; cd cfssl/etcd <br><br>cat &gt; ca-config.json &lt;&lt; EOF<br>&#123;<br>  &quot;signing&quot;: &#123;<br>    &quot;default&quot;: &#123;<br>      &quot;expiry&quot;: &quot;87600h&quot;<br>    &#125;,<br>    &quot;profiles&quot;: &#123;<br>      &quot;www&quot;: &#123;<br>         &quot;expiry&quot;: &quot;87600h&quot;,<br>         &quot;usages&quot;: [<br>            &quot;signing&quot;,<br>            &quot;key encipherment&quot;,<br>            &quot;server auth&quot;,<br>            &quot;client auth&quot;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>EOF<br><br>cat &gt; ca-csr.json &lt;&lt; EOF<br>&#123;<br>    &quot;CN&quot;: &quot;etcd CA&quot;,<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;ShangHai&quot;,<br>            &quot;ST&quot;: &quot;ShangHai&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成ca.pem和ca-key.pem文件</span><br>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -<br></code></pre></td></tr></table></figure><h2 id="使用自签ca签发https证书"><a class="markdownIt-Anchor" href="#使用自签ca签发https证书"></a> 使用自签CA签发HTTPS证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">hosts内为节点IP</span><br>cat &gt; server-csr.json &lt;&lt; EOF<br>&#123;<br>    &quot;CN&quot;: &quot;etcd&quot;,<br>    &quot;hosts&quot;: [<br>    &quot;10.10.10.101&quot;,<br>    &quot;10.10.10.102&quot;,<br>    &quot;10.10.10.103&quot;<br>    ],<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;ShangHai&quot;,<br>            &quot;ST&quot;: &quot;ShangHai&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成server.pem和server-key.pem文件</span><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server<br></code></pre></td></tr></table></figure><h2 id="手动安装"><a class="markdownIt-Anchor" href="#手动安装"></a> 手动安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可以在https://github.com/etcd-io/etcd/releases寻找下载</span><br>mkdir /etc/etcd/&#123;bin,ssl&#125; -p<br>tar -mxvf etcd-v3.5.0-linux-amd64.tar<br>mv etcd-v3.5.0-linux-amd64.tar/etcd* /etc/etcd/bin/<br></code></pre></td></tr></table></figure><h2 id="yum安装"><a class="markdownIt-Anchor" href="#yum安装"></a> Yum安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install etcd -y<br>mkdir /etc/etcd/ssl -p<br></code></pre></td></tr></table></figure><h2 id="修改配置文件"><a class="markdownIt-Anchor" href="#修改配置文件"></a> 修改配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">注意检查各个节点的etcd.conf中主机名和IP是否和当前节点一致(没有则新建)</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">[Member]</span><br>ETCD_NAME=&quot;etcd-master&quot;<br>ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;<br>ETCD_LISTEN_PEER_URLS=&quot;https://10.10.10.101:2380&quot;<br>ETCD_LISTEN_CLIENT_URLS=&quot;https://10.10.10.101:2379&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">[Clustering]</span><br>ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://10.10.10.101:2380&quot;<br>ETCD_ADVERTISE_CLIENT_URLS=&quot;https://10.10.10.101:2379&quot;<br>ETCD_INITIAL_CLUSTER=&quot;etcd-master=https://10.10.10.101:2380,etcd-minion=https://10.10.10.102:2380,etcd-slave=https://10.10.10.103:2380&quot;<br>ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;<br>ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;<br></code></pre></td></tr></table></figure><h2 id="拷贝证书"><a class="markdownIt-Anchor" href="#拷贝证书"></a> 拷贝证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">for host in master minion slave; do scp cfssl/etcd/*.pem $host:/etc/etcd/ssl/;done<br></code></pre></td></tr></table></figure><h2 id="修改系统服务文件"><a class="markdownIt-Anchor" href="#修改系统服务文件"></a> 修改系统服务文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">/lib/systemd/system/etcd.service(没有则新建)</span><br>[Unit]<br>Description=Etcd Server<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br><br>[Service]<br>Type=notify<br>EnvironmentFile=/etc/etcd/etcd.conf<br>ExecStart=/etc/etcd/etcd \<br>--cert-file=/etc/etcd/ssl/server.pem \<br>--key-file=/etc/etcd/ssl/server-key.pem \<br>--peer-cert-file=/etc/etcd/ssl/server.pem \<br>--peer-key-file=/etc/etcd/ssl/server-key.pem \<br>--trusted-ca-file=/etc/etcd/ssl/ca.pem \<br>--peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \<br>--logger=zap<br>Restart=on-failure<br>LimitNOFILE=65536<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure><h2 id="自启启动"><a class="markdownIt-Anchor" href="#自启启动"></a> 自启启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">for host in master minion slave;do ssh $host &#x27;systemctl daemon-reload;systemctl enable etcd --now&#x27;;done<br></code></pre></td></tr></table></figure><h2 id="查看集群状态"><a class="markdownIt-Anchor" href="#查看集群状态"></a> 查看集群状态</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">ETCDCTL_API=3 /etc/etcd/etcdctl --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/server.pem --key=/etc/etcd/ssl/server-key.pem --endpoints=&quot;https://10.10.10.101:2379,https://10.10.10.102:2379,https://10.10.10.103:2379&quot; endpoint health --write-out=table<br><br>+-----------------------------+--------+-------------+-------+<br>|          ENDPOINT           | HEALTH |    TOOK     | ERROR |<br>+-----------------------------+--------+-------------+-------+<br>| https://10.10.10.101:2379   |  true  | 50.191672ms |       |<br>| https://10.10.10.102:2379   |  true  | 52.394036ms |       |<br>| https://10.10.10.103:2379   |  true  | 46.009422ms |       |<br>+-----------------------------+--------+-------------+-------+<br></code></pre></td></tr></table></figure><h1 id="docker"><a class="markdownIt-Anchor" href="#docker"></a> Docker</h1><h2 id="手动安装-2"><a class="markdownIt-Anchor" href="#手动安装-2"></a> 手动安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可以在https://download.docker.com/linux/static/stable/x86_64/载</span><br>tar -mxvf docker-20.10.7.tgz<br>mv docker/* /usr/bin<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建系统服务文件</span><br>cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF<br>[Unit]<br>Description=Docker Application Container Engine<br>Documentation=https://docs.docker.com<br>After=network-online.target firewalld.service<br>Wants=network-online.target<br><br>[Service]<br>Type=notify<br>ExecStart=/usr/bin/dockerd<br>ExecReload=/bin/kill -s HUP $MAINPID<br>LimitNOFILE=infinity<br>LimitNPROC=infinity<br>LimitCORE=infinity<br>TimeoutStartSec=0<br>Delegate=yes<br>KillMode=process<br>Restart=on-failure<br>StartLimitBurst=3<br>StartLimitInterval=60s<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h2 id="yum安装-2"><a class="markdownIt-Anchor" href="#yum安装-2"></a> Yum安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">官方脚本安装</span><br>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">手动yum安装</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">卸载原有docker</span><br>yum remove docker*<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装所需的软件包。yum-utils 提供了 yum-config-manager ，并且 device mapper 存储驱动程序需要 device-mapper-persistent-data 和 lvm2</span><br>yum install -y yum-utils device-mapper-persistent-data lvm2<br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置阿里源地址</span><br>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装</span><br>yum install docker-ce docker-ce-cli containerd.io -y<br></code></pre></td></tr></table></figure><h2 id="修改配置"><a class="markdownIt-Anchor" href="#修改配置"></a> 修改配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">配置镜像加速地址,并修改Cgroup Driver(docker默认cgroupfs，k8s推荐使用systemd)</span><br>mkdir /etc/docker -p<br>cat &gt; /etc/docker/daemon.json &lt;&lt; EOF<br>&#123;&quot;registry-mirrors&quot;:[&quot;https://docker.mirrors.ustc.edu.cn/&quot;],<br>  &quot;exec-etcs&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125;<br>EOF<br></code></pre></td></tr></table></figure><h2 id="自启启动-2"><a class="markdownIt-Anchor" href="#自启启动-2"></a> 自启启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">for host in master minion slave;do ssh $host &#x27;systemctl daemon-reload;systemctl enable docker --now&#x27;;done<br></code></pre></td></tr></table></figure><h1 id="master"><a class="markdownIt-Anchor" href="#master"></a> Master</h1><h2 id="二进制文件"><a class="markdownIt-Anchor" href="#二进制文件"></a> 二进制文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可以在https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md寻找下载</span><br>mkdir -p /etc/kubernetes/&#123;bin,conf,ssl,logs&#125;<br>tar -mxvf kubernetes-server-linux-amd64.tar.gz<br>cd kubernetes/server/bin/<br>cp kube-apiserver kube-scheduler kube-controller-manager /etc/kubernetes/bin/<br>cp kubectl /usr/bin/<br></code></pre></td></tr></table></figure><h2 id="自签ca-2"><a class="markdownIt-Anchor" href="#自签ca-2"></a> 自签CA</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir cfssl/kubernetes -p &amp;&amp; cd cfssl/kubernetes<br><br>cat &gt; ca-config.json &lt;&lt; EOF<br>&#123;<br>  &quot;signing&quot;: &#123;<br>    &quot;default&quot;: &#123;<br>      &quot;expiry&quot;: &quot;87600h&quot;<br>    &#125;,<br>    &quot;profiles&quot;: &#123;<br>      &quot;kubernetes&quot;: &#123;<br>         &quot;expiry&quot;: &quot;87600h&quot;,<br>         &quot;usages&quot;: [<br>            &quot;signing&quot;,<br>            &quot;key encipherment&quot;,<br>            &quot;server auth&quot;,<br>            &quot;client auth&quot;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>EOF<br><br>cat &gt; ca-csr.json &lt;&lt; EOF<br>&#123;<br>    &quot;CN&quot;: &quot;kubernetes&quot;,<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;ShangHai&quot;,<br>            &quot;ST&quot;: &quot;ShangHai&quot;,<br>            &quot;O&quot;: &quot;Kubernetes&quot;,<br>            &quot;OU&quot;: &quot;System&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成ca.pem和ca-key.pem文件</span><br>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -<br></code></pre></td></tr></table></figure><h2 id="kube-apiserver"><a class="markdownIt-Anchor" href="#kube-apiserver"></a> kube-apiserver</h2><h3 id="使用自签ca签-https证书"><a class="markdownIt-Anchor" href="#使用自签ca签-https证书"></a> 使用自签CA签 HTTPS证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">hosts内为节点IP,为了方便后期扩容可以多写几个预留的IP</span><br>cat &gt; server-csr.json &lt;&lt; EOF<br>&#123;<br>    &quot;CN&quot;: &quot;kubernetes&quot;,<br>    &quot;hosts&quot;: [<br>      &quot;10.0.0.1&quot;,<br>      &quot;127.0.0.1&quot;,<br>      &quot;10.10.10.101&quot;,<br>      &quot;10.10.10.102&quot;,<br>      &quot;10.10.10.103&quot;,<br>      &quot;kubernetes&quot;,<br>      &quot;kubernetes.default&quot;,<br>      &quot;kubernetes.default.svc&quot;,<br>      &quot;kubernetes.default.svc.cluster&quot;,<br>      &quot;kubernetes.default.svc.cluster.local&quot;<br>    ],<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;ShangHai&quot;,<br>            &quot;ST&quot;: &quot;ShangHai&quot;,<br>            &quot;O&quot;: &quot;Kubernetes&quot;,<br>            &quot;OU&quot;: &quot;System&quot;<br>        &#125;<br>    ]<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成server.pem和server-key.pem文件</span><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span><br>cp cfssl/kubernetes/*.pem /etc/kubernetes/ssl<br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果etcd和master不在一台机器部署，这里etcd的证书也要拷贝</span><br>cp cfssl/etcd/*.pem /etc/etcd/ssl<br></code></pre></td></tr></table></figure><h3 id="创建配置文件"><a class="markdownIt-Anchor" href="#创建配置文件"></a> 创建配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建token</span><br>cat &gt; /opt/kubernetes/conf/token.csv &lt;&lt; EOF<br>c47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">token也可自行生成替换</span><br>head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;<br><br>cat &gt; /opt/kubernetes/conf/kube-apiserver.conf &lt;&lt; EOF<br>KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\<br>--v=2 \\<br>--log-dir=/opt/kubernetes/logs \\<br>--etcd-servers=https://10.10.10.101:2379,https://10.10.10.102:2379,https://10.10.10.103:2379 \\<br>--bind-address=10.10.10.101 \\<br>--secure-port=6443 \\<br>--advertise-address=10.10.10.101 \\<br>--allow-privileged=true \\<br>--service-cluster-ip-range=10.0.0.0/24 \\<br>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\<br>--authorization-mode=RBAC,Node \\<br>--enable-bootstrap-token-auth=true \\<br>--token-auth-file=/opt/kubernetes/conf/token.csv \\<br>--service-node-port-range=1-65535 \\<br>--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\<br>--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\<br>--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\<br>--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\<br>--client-ca-file=/opt/kubernetes/ssl/ca.pem \\<br>--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\<br>--service-account-issuer=api \\<br>--service-account-signing-key-file=/opt/kubernetes/ssl/server-key.pem \\<br>--etcd-cafile=/opt/etcd/ssl/ca.pem \\<br>--etcd-certfile=/opt/etcd/ssl/server.pem \\<br>--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\<br>--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\<br>--proxy-client-cert-file=/opt/kubernetes/ssl/server.pem \\<br>--proxy-client-key-file=/opt/kubernetes/ssl/server-key.pem \\<br>--requestheader-allowed-names=kubernetes \\<br>--requestheader-extra-headers-prefix=X-Remote-Extra- \\<br>--requestheader-group-headers=X-Remote-Group \\<br>--requestheader-username-headers=X-Remote-User \\<br>--enable-aggregator-routing=true \\<br>--audit-log-maxage=30 \\<br>--audit-log-maxbackup=3 \\<br>--audit-log-maxsize=100 \\<br>--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;<br>EOF<br></code></pre></td></tr></table></figure><h3 id="创建系统服务文件"><a class="markdownIt-Anchor" href="#创建系统服务文件"></a> 创建系统服务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /lib/systemd/system/kube-apiserver.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes API Server<br>Documentation=https://github.com/kubernetes/kubernetes<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/conf/kube-apiserver.conf<br>ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS<br>Restart=on-failure<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h3 id="自启启动-3"><a class="markdownIt-Anchor" href="#自启启动-3"></a> 自启启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable kube-apiserver --now<br></code></pre></td></tr></table></figure><h2 id="kube-controller-manager"><a class="markdownIt-Anchor" href="#kube-controller-manager"></a> kube-controller-manager</h2><h3 id="证书"><a class="markdownIt-Anchor" href="#证书"></a> 证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span><br>cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF<br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;ShangHai&quot;, <br>      &quot;ST&quot;: &quot;ShangHai&quot;,<br>      &quot;O&quot;: &quot;system:masters&quot;,<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span><br>cp cfssl/kubernetes/kube-controller-manager*.pem /etc/kubernetes/ssl<br></code></pre></td></tr></table></figure><h3 id="创建配置文件-2"><a class="markdownIt-Anchor" href="#创建配置文件-2"></a> 创建配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-controller-manager.conf &lt;&lt; EOF<br>KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\<br>--v=2 \\<br>--log-dir=/opt/kubernetes/logs \\<br>--leader-elect=true \\<br>--kubeconfig=/opt/kubernetes/conf/kube-controller-manager.kubeconfig \\<br>--bind-address=127.0.0.1 \\<br>--allocate-node-cidrs=true \\<br>--cluster-cidr=10.244.0.0/16 \\<br>--service-cluster-ip-range=10.0.0.0/24 \\<br>--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\<br>--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\<br>--root-ca-file=/opt/kubernetes/ssl/ca.pem \\<br>--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\<br>--cluster-signing-duration=87600h0m0s&quot;<br>EOF<br></code></pre></td></tr></table></figure><h3 id="创建kubeconfig文件"><a class="markdownIt-Anchor" href="#创建kubeconfig文件"></a> 创建kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/kube-controller-manager.kubeconfig&quot;<br>KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;<br><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/opt/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-credentials kube-controller-manager \<br>  --client-certificate=/opt/kubernetes/ssl/kube-controller-manager.pem \<br>  --client-key=/opt/kubernetes/ssl/kube-controller-manager-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kube-controller-manager \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;<br></code></pre></td></tr></table></figure><h3 id="创建系统服务文件-2"><a class="markdownIt-Anchor" href="#创建系统服务文件-2"></a> 创建系统服务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Controller Manager<br>Documentation=https://github.com/kubernetes/kubernetes<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/conf/kube-controller-manager.conf<br>ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS<br>Restart=on-failure<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h3 id="自启启动-4"><a class="markdownIt-Anchor" href="#自启启动-4"></a> 自启启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable kube-controller-manager --now<br></code></pre></td></tr></table></figure><h2 id="kube-scheduler"><a class="markdownIt-Anchor" href="#kube-scheduler"></a> kube-scheduler</h2><h3 id="证书-2"><a class="markdownIt-Anchor" href="#证书-2"></a> 证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span><br>cat &gt; kube-scheduler-csr.json &lt;&lt; EOF<br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;ShangHai&quot;,<br>      &quot;ST&quot;: &quot;ShangHai&quot;,<br>      &quot;O&quot;: &quot;system:masters&quot;,<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span><br>cp cfssl/kubernetes/kube-cheduler*.pem /etc/kubernetes/ssl<br></code></pre></td></tr></table></figure><h3 id="创建配置文件-3"><a class="markdownIt-Anchor" href="#创建配置文件-3"></a> 创建配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-scheduler.conf &lt;&lt; EOF<br>KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \\<br>--v=2 \\<br>--log-dir=/opt/kubernetes/logs \\<br>--leader-elect \\<br>--kubeconfig=/opt/kubernetes/conf/kube-scheduler.kubeconfig \\<br>--bind-address=127.0.0.1&quot;<br>EOF<br></code></pre></td></tr></table></figure><h3 id="创建kubeconfig文件-2"><a class="markdownIt-Anchor" href="#创建kubeconfig文件-2"></a> 创建kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/kube-scheduler.kubeconfig&quot;<br>KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;<br><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/opt/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-credentials kube-scheduler \<br>  --client-certificate=/opt/kubernetes/ssl/kube-scheduler.pem \<br>  --client-key=/opt/kubernetes/ssl/kube-scheduler-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kube-scheduler \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;<br></code></pre></td></tr></table></figure><h3 id="创建系统服务"><a class="markdownIt-Anchor" href="#创建系统服务"></a> 创建系统服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Scheduler<br>Documentation=https://github.com/kubernetes/kubernetes<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/conf/kube-scheduler.conf<br>ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS<br>Restart=on-failure<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h3 id="自启启动-5"><a class="markdownIt-Anchor" href="#自启启动-5"></a> 自启启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable kube-scheduler --now<br></code></pre></td></tr></table></figure><h2 id="查看集群状态-2"><a class="markdownIt-Anchor" href="#查看集群状态-2"></a> 查看集群状态</h2><h3 id="证书-3"><a class="markdownIt-Anchor" href="#证书-3"></a> 证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span><br>cat &gt; admin-csr.json &lt;&lt;EOF<br>&#123;<br>  &quot;CN&quot;: &quot;admin&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;ShangHai&quot;,<br>      &quot;ST&quot;: &quot;ShangHai&quot;,<br>      &quot;O&quot;: &quot;system:masters&quot;,<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span><br>cp cfssl/kubernetes/admin*.pem /etc/kubernetes/ssl<br></code></pre></td></tr></table></figure><h3 id="创建kubeconfig文件-3"><a class="markdownIt-Anchor" href="#创建kubeconfig文件-3"></a> 创建kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir /root/.kube<br><br>KUBE_CONFIG=&quot;/root/.kube/config&quot;<br>KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;<br><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/etc/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-credentials cluster-admin \<br>  --client-certificate=//etc/kubernetes/ssl/admin.pem \<br>  --client-key=/etc/kubernetes/ssl/admin-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=cluster-admin \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;<br></code></pre></td></tr></table></figure><h3 id="查看当前组建状态"><a class="markdownIt-Anchor" href="#查看当前组建状态"></a> 查看当前组建状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get cs<br>NAME                STATUS    MESSAGE             ERROR<br>scheduler           Healthy   ok                  <br>controller-manager  Healthy   ok                   <br>etcd-master         Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;<br>etcd-minio          Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;  <br>etcd-slave          Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;  <br></code></pre></td></tr></table></figure><h3 id="授权kubelet-bootstrap用户允许请求证书"><a class="markdownIt-Anchor" href="#授权kubelet-bootstrap用户允许请求证书"></a> 授权kubelet-bootstrap用户允许请求证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建node必备，不然node的kubelet无法启动,就是创建一个可以申请证书的用户</span><br>kubectl create clusterrolebinding kubelet-bootstrap \<br>--clusterrole=system:node-bootstrapper \<br>--user=kubelet-bootstrap<br><br>kubectl create clusterrolebinding system:anonymous --clusterrole=cluster-admin ?--user=system:anonymous<br></code></pre></td></tr></table></figure><h1 id="nodes"><a class="markdownIt-Anchor" href="#nodes"></a> Nodes</h1><h2 id="拷贝二进制文件和证书"><a class="markdownIt-Anchor" href="#拷贝二进制文件和证书"></a> 拷贝二进制文件和证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh minion &quot;mkdir -p /opt/kubernetes/&#123;bin,conf,ssl,logs&#125;&quot;<br>cd kubernetes/server/bin/<br>scp -r kubelet kube-proxy minion:/opt/kubernetes/bin/<br>scp /opt/kubernetes/ssl/ca.pem minion:/opt/kubernetes/ssl/<br>scp /usr/bin/kubectl minion:/usr/bin<br></code></pre></td></tr></table></figure><h2 id="kubulet"><a class="markdownIt-Anchor" href="#kubulet"></a> kubulet</h2><h3 id="创建配置文件-4"><a class="markdownIt-Anchor" href="#创建配置文件-4"></a> 创建配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kubelet.conf &lt;&lt; EOF<br>KUBELET_OPTS=&quot;--logtostderr=false \\<br>--v=2 \\<br>--log-dir=/opt/kubernetes/logs \\<br>--hostname-override=(节点名) \\<br>--network-plugin=cni \\<br>--kubeconfig=/opt/kubernetes/conf/kubelet.kubeconfig \\<br>--bootstrap-kubeconfig=/opt/kubernetes/conf/bootstrap.kubeconfig \\<br>--config=/opt/kubernetes/conf/kubelet-config.yml \\<br>--cert-dir=/opt/kubernetes/ssl \\<br>--pod-infra-container-image=lizexiong/pause-amd64:3.0(pause镜像)&quot;<br>EOF<br></code></pre></td></tr></table></figure><h3 id="配置参数文件"><a class="markdownIt-Anchor" href="#配置参数文件"></a> 配置参数文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kubelet-config.yml &lt;&lt; EOF<br>kind: KubeletConfiguration<br>apiVersion: kubelet.config.k8s.io/v1beta1<br>address: 0.0.0.0<br>port: 10250<br>readOnlyPort: 10255<br>cgroupDriver: systemd(和docker的cgroupdriver保持一致)<br>clusterDNS:<br>- 10.0.0.2<br>clusterDomain: cluster.local <br>failSwapOn: false<br>authentication:<br>  anonymous:<br>    enabled: false<br>  webhook:<br>    cacheTTL: 2m0s<br>    enabled: true<br>  x509:<br>    clientCAFile: /opt/kubernetes/ssl/ca.pem <br>authorization:<br>  mode: Webhook<br>  webhook:<br>    cacheAuthorizedTTL: 5m0s<br>    cacheUnauthorizedTTL: 30s<br>evictionHard:<br>  imagefs.available: 15%<br>  memory.available: 100Mi<br>  nodefs.available: 10%<br>  nodefs.inodesFree: 5%<br>maxOpenFiles: 1000000<br>maxPods: 110<br>EOF<br></code></pre></td></tr></table></figure><h3 id="创建kubeconfig文件-4"><a class="markdownIt-Anchor" href="#创建kubeconfig文件-4"></a> 创建kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/bootstrap.kubeconfig&quot;<br>KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot; # apiserver IP:PORT<br>TOKEN=&quot;c47ffb939f5ca36231d9e3121a252940&quot; # 与token.csv里保持一致<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">生成 kubelet bootstrap kubeconfig 配置文件</span><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/opt/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-credentials &quot;kubelet-bootstrap&quot; \<br>  --token=$&#123;TOKEN&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=&quot;kubelet-bootstrap&quot; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;<br></code></pre></td></tr></table></figure><h3 id="创建系统服务文件-3"><a class="markdownIt-Anchor" href="#创建系统服务文件-3"></a> 创建系统服务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Kubelet<br>After=docker.service<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/conf/kubelet.conf<br>ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS<br>Restart=on-failure<br>LimitNOFILE=65536<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h3 id="自启启动-6"><a class="markdownIt-Anchor" href="#自启启动-6"></a> 自启启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable kubelet --now<br></code></pre></td></tr></table></figure><h3 id="master批准node加入集群"><a class="markdownIt-Anchor" href="#master批准node加入集群"></a> master批准node加入集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">获取node-csr名称</span><br>kubectl get csr <br><span class="hljs-meta prompt_">#</span><span class="language-bash">批准</span><br>kubectl certificate approve &lt;node-csr-name&gt;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">获取节点信息</span><br>kubectl get node<br></code></pre></td></tr></table></figure><h2 id="kube-proxy"><a class="markdownIt-Anchor" href="#kube-proxy"></a> kube-proxy</h2><h3 id="创建配置文件-5"><a class="markdownIt-Anchor" href="#创建配置文件-5"></a> 创建配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-proxy.conf &lt;&lt; EOF<br>KUBE_PROXY_OPTS=&quot;--logtostderr=false \\<br>--v=2 \\<br>--log-dir=/opt/kubernetes/logs \\<br>--config=/opt/kubernetes/conf/kube-proxy-config.yml&quot;<br>EOF<br></code></pre></td></tr></table></figure><h3 id="配置参数文件-2"><a class="markdownIt-Anchor" href="#配置参数文件-2"></a> 配置参数文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /opt/kubernetes/conf/kube-proxy-config.yml &lt;&lt; EOF<br>kind: KubeProxyConfiguration<br>apiVersion: kubeproxy.config.k8s.io/v1alpha1<br>bindAddress: 0.0.0.0<br>metricsBindAddress: 0.0.0.0:10249<br>clientConnection:<br>  kubeconfig: /opt/kubernetes/conf/kube-proxy.kubeconfig<br>hostnameOverride: node01<br>clusterCIDR: 10.0.0.0/24<br>EOF<br></code></pre></td></tr></table></figure><h3 id="master生成证书并拷贝"><a class="markdownIt-Anchor" href="#master生成证书并拷贝"></a> master生成证书并拷贝</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd cfssl/kubernetes<br><br>cat &gt; kube-proxy-csr.json &lt;&lt; EOF<br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-proxy&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;ShangHai&quot;,<br>      &quot;ST&quot;: &quot;ShangHai&quot;,<br>      &quot;O&quot;: &quot;Kubernets&quot;,<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span><br>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">拷贝证书</span><br>scp /cfssl/kubernetes/kube-proxy*pem minion:/opt/kubernetes/ssl<br></code></pre></td></tr></table></figure><h3 id="创建kubeconfig文件-5"><a class="markdownIt-Anchor" href="#创建kubeconfig文件-5"></a> 创建kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">KUBE_CONFIG=&quot;/opt/kubernetes/conf/kube-proxy.kubeconfig&quot;<br>KUBE_APISERVER=&quot;https://10.10.10.101:6443&quot;<br><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/opt/kubernetes/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-credentials kube-proxy \<br>  --client-certificate=/opt/kubernetes/ssl/kube-proxy.pem \<br>  --client-key=/opt/kubernetes/ssl/kube-proxy-key.pem \<br>  --embed-certs=true \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kube-proxy \<br>  --kubeconfig=$&#123;KUBE_CONFIG&#125;<br>kubectl config use-context default --kubeconfig=$&#123;KUBE_CONFIG&#125;<br></code></pre></td></tr></table></figure><h3 id="创建系统服务文件-4"><a class="markdownIt-Anchor" href="#创建系统服务文件-4"></a> 创建系统服务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF<br>[Unit]<br>Description=Kubernetes Proxy<br>After=network.target<br><br>[Service]<br>EnvironmentFile=/opt/kubernetes/conf/kube-proxy.conf<br>ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS<br>Restart=on-failure<br>LimitNOFILE=65536<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br></code></pre></td></tr></table></figure><h3 id="自启启动-7"><a class="markdownIt-Anchor" href="#自启启动-7"></a> 自启启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable kube-proxy --now<br></code></pre></td></tr></table></figure><h2 id="部署网络组件"><a class="markdownIt-Anchor" href="#部署网络组件"></a> 部署网络组件</h2><h3 id="calico"><a class="markdownIt-Anchor" href="#calico"></a> calico</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">https://blog.csdn.net/qq_31136839/article/details/100032022<br><span class="hljs-meta prompt_">#</span><span class="language-bash">下载yaml</span><br>wget https://docs.projectcalico.org/manifests/calico.yaml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改CALICO_IPV4POOL_CIDR,此处的网段地址应和kube-controller-manager.conf中的--cluster-cidr保持一致,修改后应用</span><br>kubectl apply -f calico.yaml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看pod直到成功运行</span><br>kubectl get pods -n kube-system<br></code></pre></td></tr></table></figure><h3 id="flannel"><a class="markdownIt-Anchor" href="#flannel"></a> flannel</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">修改Network,此处的网段地址应和kube-controller-manager.conf中的--cluster-cidr保持一致,修改后应用</span><br>kubectl apply -f flannel.yaml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看pod直到成功运行</span><br>kubectl get pods -n kube-system<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果报错找不到/run/flannel/subnet.env</span><br>cat &gt; /run/flannel/subnet.env &lt;&lt; EOF<br>FLANNEL_NETWORK=10.244.0.0/16<br>FLANNEL_SUBNET=10.244.0.1/24<br>FLANNEL_MTU=1450<br>FLANNEL_IPMASQ=true<br>EOF<br></code></pre></td></tr></table></figure><h2 id="授权apiserver"><a class="markdownIt-Anchor" href="#授权apiserver"></a> 授权apiserver</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; EOF<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRole<br>metadata:<br>  annotations:<br>    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;<br>  labels:<br>    kubernetes.io/bootstrapping: rbac-defaults<br>  name: system:kube-apiserver-to-kubelet<br>rules:<br>  - apiGroups:<br>      - &quot;&quot;<br>    resources:<br>      - nodes/proxy<br>      - nodes/stats<br>      - nodes/log<br>      - nodes/spec<br>      - nodes/metrics<br>      - pods/log<br>    verbs:<br>      - &quot;*&quot;<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: system:kube-apiserver<br>  namespace: &quot;&quot;<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: system:kube-apiserver-to-kubelet<br>subjects:<br>  - apiGroup: rbac.authorization.k8s.io<br>    kind: User<br>    name: kubernetes<br>EOF<br><br>kubectl apply -f apiserver-to-kubelet-rbac.yaml<br></code></pre></td></tr></table></figure><h2 id="部署coredns"><a class="markdownIt-Anchor" href="#部署coredns"></a> 部署Coredns</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/coredns/coredns.yaml.in<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改dns_memory_limit和clusterIP,clusterIP地址应和kubelet-config.yml中的clusterDNS保持一致,修改后应用</span><br>kubelet apply -f coredns.yaml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">授权</span><br>kubectl create clusterrolebinding add-on-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:coredns<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看pod成功运行</span><br>kubectl get pods -n kube-system<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学海无涯</category>
      
      <category>K8S</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Commands</title>
    <link href="/posts/6348717a.html"/>
    <url>/posts/6348717a.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1 id="linux"><a class="markdownIt-Anchor" href="#linux"></a> Linux</h1><h2 id="history添加时间戳"><a class="markdownIt-Anchor" href="#history添加时间戳"></a> History添加时间戳</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;export HISTTIMEFORMAT=&quot;`whoami` : %F %T : &quot;&#x27;</span> &gt;&gt; /etc/profile . /etc/profile<br></code></pre></td></tr></table></figure><h2 id="美化ps1"><a class="markdownIt-Anchor" href="#美化ps1"></a> 美化PS1</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">PS1=\[\e[37;1m\][\[\e[31;1m\]\h\[\e[34;1m\]@\[\e[33;1m\]\w \[\e[32;1m\]\t\[\e[37;1m\]]\[\e[36;1m\]&gt;\[\e[m\]<br></code></pre></td></tr></table></figure><h2 id="ubuntu修改dash"><a class="markdownIt-Anchor" href="#ubuntu修改dash"></a> Ubuntu修改dash</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo dpkg-reconfigure dash<br></code></pre></td></tr></table></figure><h2 id="vim添加脚本简介"><a class="markdownIt-Anchor" href="#vim添加脚本简介"></a> vim添加脚本简介</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim ~/.vimrc<br>autocmd BufNewFile *.py,*.sh, <span class="hljs-built_in">exec</span> <span class="hljs-string">&quot;:call SetTitle()&quot;</span><br><span class="hljs-built_in">let</span> <span class="hljs-variable">$author_name</span>=<span class="hljs-string">&quot;Felix Cheung&quot;</span><br><span class="hljs-built_in">let</span> <span class="hljs-variable">$author_email</span>=<span class="hljs-string">&quot;felix7cheung@163.com&quot;</span><br><br>func SetTitle()<br><span class="hljs-keyword">if</span> &amp;filetype == <span class="hljs-string">&#x27;sh&#x27;</span><br>call setline(1,<span class="hljs-string">&quot;\#!/bin/bash&quot;</span>)<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>),   <span class="hljs-string">&quot;\#File Name    : &quot;</span>.<span class="hljs-built_in">expand</span>(<span class="hljs-string">&quot;%&quot;</span>))<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>)+1, <span class="hljs-string">&quot;\#Author       : &quot;</span>.<span class="hljs-variable">$author_name</span>)<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>)+2, <span class="hljs-string">&quot;\#Mail         : &quot;</span>.<span class="hljs-variable">$author_email</span>)<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>)+3, <span class="hljs-string">&quot;\#Create Time  : &quot;</span>.strftime(<span class="hljs-string">&quot;%Y-%m-%d %H:%M&quot;</span>))<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>)+4, <span class="hljs-string">&quot;\#Description  : &quot;</span>)<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>)+5, <span class="hljs-string">&quot;&quot;</span>)<br><span class="hljs-keyword">else</span><br>call setline(1,<span class="hljs-string">&quot;\#!/usr/bin/env python&quot;</span>)<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>),   <span class="hljs-string">&quot;\#File Name    : &quot;</span>.<span class="hljs-built_in">expand</span>(<span class="hljs-string">&quot;%&quot;</span>))<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>)+1, <span class="hljs-string">&quot;\#Author       : &quot;</span>.<span class="hljs-variable">$author_name</span>)<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>)+2, <span class="hljs-string">&quot;\#Mail         : &quot;</span>.<span class="hljs-variable">$author_email</span>)<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>)+3, <span class="hljs-string">&quot;\#Create Time  : &quot;</span>.strftime(<span class="hljs-string">&quot;%Y-%m-%d %H:%M&quot;</span>))<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>)+4, <span class="hljs-string">&quot;\#Description  : &quot;</span>)<br>call append(line(<span class="hljs-string">&quot;.&quot;</span>)+5, <span class="hljs-string">&quot;&quot;</span>)<br>endif<br>endfunc<br>autocmd BufNewfile * normal G<br></code></pre></td></tr></table></figure><h2 id="centos换源"><a class="markdownIt-Anchor" href="#centos换源"></a> centos换源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /opt/centos-yum.bak <br><span class="hljs-built_in">mv</span> /etc/yum.repos.d/* /opt/centos-yum.bak/<br>wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo<br><br>yum clean all <br>yum makecache<br></code></pre></td></tr></table></figure><h1 id="python"><a class="markdownIt-Anchor" href="#python"></a> Python</h1><h2 id="文件下载器-当前路径"><a class="markdownIt-Anchor" href="#文件下载器-当前路径"></a> 文件下载器, 当前路径</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python -m http.server（可直接加端口，不加默认8000）<br></code></pre></td></tr></table></figure><h2 id="升级pip"><a class="markdownIt-Anchor" href="#升级pip"></a> 升级pip</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python -m pip install --upgrade pip<br></code></pre></td></tr></table></figure><h2 id="py环境变量"><a class="markdownIt-Anchor" href="#py环境变量"></a> py环境变量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/bin/env python<br></code></pre></td></tr></table></figure><h2 id="换源"><a class="markdownIt-Anchor" href="#换源"></a> 换源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip config <span class="hljs-built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple<br></code></pre></td></tr></table></figure><h1 id="go"><a class="markdownIt-Anchor" href="#go"></a> Go</h1><h2 id="换源-2"><a class="markdownIt-Anchor" href="#换源-2"></a> 换源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go <span class="hljs-built_in">env</span> -w GOPROXY=https://goproxy.cn,direct // 切换下载代理<br></code></pre></td></tr></table></figure><h2 id="cobra"><a class="markdownIt-Anchor" href="#cobra"></a> cobra</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get -u github.com/spf13/cobra@latest<br>go install github.com/spf13/cobra-cli@latest<br><br>cobra-cli init<br>cobra-cli add xxxx<br></code></pre></td></tr></table></figure><h2 id="静态编译"><a class="markdownIt-Anchor" href="#静态编译"></a> 静态编译</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">CGO_ENABLED=0 GOOS=linux go build -a -ldflags <span class="hljs-string">&#x27;-extldflags &quot;-static&quot; -w -s&#x27;</span> .<br></code></pre></td></tr></table></figure><h2 id="压缩"><a class="markdownIt-Anchor" href="#压缩"></a> 压缩</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">upx -9 xxx<br></code></pre></td></tr></table></figure><h1 id="jenkins"><a class="markdownIt-Anchor" href="#jenkins"></a> Jenkins</h1><h2 id="换源-3"><a class="markdownIt-Anchor" href="#换源-3"></a> 换源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sed -i <span class="hljs-string">&#x27;s/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g&#x27;</span> default.json &amp;&amp; sed -i <span class="hljs-string">&#x27;s/http:\/\/www.google.com/https:\/\/www.baidu.com/g&#x27;</span> <span class="hljs-variable">$JENKINS_HOME</span>/update/default.json<br><br>https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json<br></code></pre></td></tr></table></figure><h2 id="查用插件"><a class="markdownIt-Anchor" href="#查用插件"></a> 查用插件</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Chinese<br><span class="hljs-keyword">Role</span>-based <span class="hljs-keyword">Authorization</span> Strategy<br>Job <span class="hljs-keyword">Configuration</span> History<br>Workspace Cleanup Plugin<br></code></pre></td></tr></table></figure><h1 id="docker"><a class="markdownIt-Anchor" href="#docker"></a> Docker</h1><h2 id="自动安装"><a class="markdownIt-Anchor" href="#自动安装"></a> 自动安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun<br></code></pre></td></tr></table></figure><h2 id="配置镜像加速地址"><a class="markdownIt-Anchor" href="#配置镜像加速地址"></a> 配置镜像加速地址</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /etc/docker/ -p <br><span class="hljs-built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">    &quot;registry-mirrors&quot;:[&quot;https://docker.mirrors.ustc.edu.cn/&quot;],</span><br><span class="hljs-string">     &quot;data-root&quot;: &quot;/mnt/docker&quot;</span><br><span class="hljs-string">&#125; </span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure><h1 id="kubenetes"><a class="markdownIt-Anchor" href="#kubenetes"></a> Kubenetes</h1><h2 id="命令补全"><a class="markdownIt-Anchor" href="#命令补全"></a> 命令补全</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y bash-completion<br><span class="hljs-built_in">source</span> /usr/share/bash-completion/bash_completion<br><span class="hljs-built_in">source</span> &lt;(kubectl completion bash)<br></code></pre></td></tr></table></figure><h2 id="切换默认命名空间"><a class="markdownIt-Anchor" href="#切换默认命名空间"></a> 切换默认命名空间</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl config set-context $(kubectl config current-context) --namespace=&lt;work_namespace&gt;<br></code></pre></td></tr></table></figure><h2 id="删除terminal状态的pvpod"><a class="markdownIt-Anchor" href="#删除terminal状态的pvpod"></a> 删除terminal状态的pv/pod</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl patch pv xxx -p <span class="hljs-string">&#x27;&#123;&quot;metadata&quot;:&#123;&quot;finalizers&quot;:null&#125;&#125;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="删除terminal状态的ns"><a class="markdownIt-Anchor" href="#删除terminal状态的ns"></a> 删除terminal状态的ns</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/qq_44273583/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">124594314</span><br></code></pre></td></tr></table></figure><h2 id="调整端口范围"><a class="markdownIt-Anchor" href="#调整端口范围"></a> 调整端口范围</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/kubernetes/manifests/kube-apiserver.yaml<br>  -    --service-node-port-range=1-65535<br></code></pre></td></tr></table></figure><h2 id="证书过期"><a class="markdownIt-Anchor" href="#证书过期"></a> 证书过期</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">Unable to connect to the server: x509: certificate has expired or is not yet valid<br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/swan_tang/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">115755311</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学海无涯</category>
      
      <category>Others</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>通过Kubeadm部署Kubernetes高可用集群</title>
    <link href="/posts/43012f97.html"/>
    <url>/posts/43012f97.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1 id="学习环境"><a class="markdownIt-Anchor" href="#学习环境"></a> 学习环境</h1><p>vmware安装三台虚拟机，或者先安装一台，完成下面的准备操作后克隆两台虚拟机，再修改IP；主机名可以在安装时候设置，或者装完之后通过hostnamectl set-hostname修改</p><table><thead><tr><th style="text-align:center">hostname</th><th style="text-align:center">os</th><th style="text-align:center">static ip</th><th style="text-align:center">role</th></tr></thead><tbody><tr><td style="text-align:center">master</td><td style="text-align:center">centos7.8</td><td style="text-align:center">192.168.204.141</td><td style="text-align:center">master1，node1</td></tr><tr><td style="text-align:center">backup</td><td style="text-align:center">centos7.8</td><td style="text-align:center">192.168.204.142</td><td style="text-align:center">master2，node2</td></tr><tr><td style="text-align:center">node</td><td style="text-align:center">centos7.8</td><td style="text-align:center">192.168.204.143</td><td style="text-align:center">master3，node3</td></tr></tbody></table><p>没有特殊说明，默认每台虚拟机都要操作</p><p>网站文档：<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p><h1 id="准备操作"><a class="markdownIt-Anchor" href="#准备操作"></a> 准备操作</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭防火墙</span><br>systemctl stop firewalld<br><span class="hljs-meta prompt_">#</span><span class="language-bash">禁用，重启生效</span><br>systemctl disable firewalld <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭</span><br>setenforce 0<br><span class="hljs-meta prompt_">#</span><span class="language-bash">禁用，重启生效</span><br>sed -i &quot;s/enforcing/disabled/g&quot; /etc/selinux/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭</span><br>swapoff -a<br><span class="hljs-meta prompt_">#</span><span class="language-bash">永久关闭</span><br>sed -i &#x27;s/^[^#].*swap*/#&amp;/g&#x27; /etc/fstab<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装常用软件包</span><br>yum install vim net-tools lrzsz unzip dos2unix telnet sysstat iotop pciutils lsof tcpdump psmisc bc wget socat gcc tree chrony ntpdate mlocate -y<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主机名写入hosts</span><br>cat &gt;&gt; /etc/hosts &lt;&lt; EOF<br>192.168.204.141 master<br>192.168.204.142 backup<br>192.168.204.143 node<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主机间配置ssh免密登录</span><br>ssh-keygen -t rsa<br>for host in master backup node; do ssh-copy-id -i ~/.ssh/id_rsa.pub $host;done<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">内核开启网络支持</span><br>cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>net.ipv4.ip_forward = 1<br>net.ipv4.ip_nonlocal_bind = 1<br>EOF<br>modprobe br_netfilter<br>sysctl -p /etc/sysctl.d/kubernetes.conf<br></code></pre></td></tr></table></figure><h1 id="安装docker"><a class="markdownIt-Anchor" href="#安装docker"></a> 安装Docker</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">官方脚本安装</span><br>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">手动yum安装</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">卸载原有docker</span><br>yum remove docker*<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装所需的软件包。yum-utils 提供了 yum-config-manager ，并且 device mapper 存储驱动程序需要 device-mapper-persistent-data 和 lvm2</span><br>yum install -y yum-utils device-mapper-persistent-data lvm2<br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置阿里源地址</span><br>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装docker-ce</span><br>yum install docker-ce docker-ce-cli containerd.io -y<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置镜像加速地址,并修改Cgroup Driver(docker默认cgroupfs，k8s推荐使用systemd)</span><br>mkdir /etc/docker/ -p<br>cat &gt; /etc/docker/daemon.json &lt;&lt; EOF<br>&#123;&quot;registry-mirrors&quot;:[&quot;https://docker.mirrors.ustc.edu.cn/&quot;],<br>  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125;<br>EOF<br>systemctl daemon-reload<br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动docker并设置自启</span><br>for op in enable start status;do systemctl $op docker;done<br></code></pre></td></tr></table></figure><h1 id="master"><a class="markdownIt-Anchor" href="#master"></a> Master</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">配置k8s阿里源地址</span><br>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo<br>[kubernetes]<br>name=Kubernetes<br>baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64<br>enabled=1<br>gpgcheck=0<br>repo_gpgcheck=0<br>gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg<br>http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装k8s相关</span><br>yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes<br>systemctl enable --now kubelet<br></code></pre></td></tr></table></figure><h2 id="keepalived"><a class="markdownIt-Anchor" href="#keepalived"></a> keepalived</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">安装keeplived并备份配置⽂件</span><br>for host in master backup node;do ssh root@$host &quot;yum install -y keepalived&quot;;done<br>for host in master backup node;do ssh root@$host &quot;mv /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak&quot;;done<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改keepalived配置⽂件如下，标注的地⽅需要修改</span><br>cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF<br>! Configuration File for keepalived<br>global_defs &#123;<br>    router_id master                        #标识，可⽤机器主机名作为标识<br>&#125;<br>vrrp_instance VI_1 &#123;<br>    state MASTER                             #设置⻆⾊，第⼀个master为MASTER，剩余的节点均为BACKUP<br>    interface ens32                         #设置vip绑定端⼝<br>    virtual_router_id 51                     #让master和backup在同⼀个虚拟路由⾥，id号必须相同<br>    priority 100                             #优先级,谁的优先级⾼谁就是master，值越⼤优先级越⾼<br>    advert_int 1                             #⼼跳间隔时间<br>    authentication &#123;<br>        auth_type PASS                         #认证<br>        auth_pass k8s                         #密码<br>    &#125;<br>     virtual_ipaddress &#123;<br>        192.168.204.200                        #虚拟ip<br>    &#125;<br>&#125;<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动keepalived并设置开机⾃启</span><br>for op in enable start status;do systemctl $op keepalived;done<br></code></pre></td></tr></table></figure><h2 id="haproxy可以不装不装则不负载"><a class="markdownIt-Anchor" href="#haproxy可以不装不装则不负载"></a> haproxy(可以不装，不装则不负载)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">安装haproxy并备份配置⽂件</span><br>for host in master backup node;do ssh root@$host &quot;yum install -y haproxy&quot;;done<br>for host in master backup node;do ssh root@$host &quot;mv /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak&quot;;done<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改haproxy配置⽂件如下，标注的地⽅需要修改</span><br>cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; EOF<br>global<br>        chroot /var/lib/haproxy<br>        daemon<br>        group haproxy<br>        user haproxy<br>        log 127.0.0.1:514 local0 warning<br>        pidfile /var/lib/haproxy.pid<br>        maxconn 20000<br>        spread-checks 3<br>        nbproc 8<br>defaults<br>        log global<br>        mode tcp<br>        retries 3<br>        option redispatch<br>listen k8s-apiserver<br>        bind 0.0.0.0:8443<br>        mode tcp<br>        balance roundrobin<br>        timeout server 15s<br>        timeout connect 15s<br>        server k8sapiserver1 192.168.204.141:6443 check port 6443 inter 5000 fall 5<br>        server k8sapiserver2 192.168.204.142:6443 check port 6443 inter 5000 fall 5<br>        server k8sapiserver3 192.168.204.143:6443 check port 6443 inter 5000 fall 5<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动haproxy并设置开机⾃启</span><br>for op in enable start status;do systemctl $op haproxy;done<br></code></pre></td></tr></table></figure><h1 id="初始化"><a class="markdownIt-Anchor" href="#初始化"></a> 初始化</h1><h2 id="主master"><a class="markdownIt-Anchor" href="#主master"></a> 主Master</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化master</span><br>A:参数初始(可选参数较多，命令会比较长)<br>kubeadm init \<br>--apiserver-advertise-address=192.168.204.141 \<br>--kubernetes-version v1.20.4 \<br>--service-cidr=192.100.0.0/16 \<br>--pod-network-cidr=192.244.0.0/16 \<br>--control-plane-endpoint 192.168.204.200:8443 \<br>--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers<br><br>B:配置文件初始(通过配置文件修改参数，复用性高，易修改)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">导出默认配置文件</span><br>kubeadm config print init-defaults &gt; kubeadm-init.yml<br>vim kubeadm-init.yml<br>//<br>apiVersion: kubeadm.k8s.io/v1beta2<br>bootstrapTokens:<br>- groups:<br>  - system:bootstrappers:kubeadm:default-node-token<br>  token: abcdef.0123456789abcdef                        #token,默认值即可<br>  ttl: 2400h0m0s                                         #token有效期，添加节点如果token过期需要重新⽣成<br>  usages:<br>  - signing<br>  - authentication<br>kind: InitConfiguration<br>localAPIEndpoint:<br>  advertiseAddress: 192.168.204.131                   #修改为本地主机IP<br>  bindPort: 6443<br>nodeRegistration:<br>  criSocket: /var/run/dockershim.sock<br>  name: master                                        #默认为本地主机名<br>  taints:<br>  - effect: NoSchedule<br>    key: node-role.kubernetes.io/master<br>---<br>apiServer:<br>  timeoutForControlPlane: 4m0s<br>apiVersion: kubeadm.k8s.io/v1beta2<br>certificatesDir: /etc/kubernetes/pki<br>clusterName: kubernetes<br>controlPlaneEndpoint: &quot;192.168.204.200:8443&quot;                 #单master节点时这⾥写“本地真实IP:6443”；多master节点时写“VIP:端⼝”，端⼝要与haproxy配置中的bind字段的端⼝⼀致（如果没有装haproxy则仍然是6443）<br>controllerManager: &#123;&#125;<br>dns: &#123;&#125;<br>etcd:<br>  local:<br>    dataDir: /var/lib/etcd<br>imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers     #镜像地址，默认为k8s地址，此处已修改为阿里云<br>kind: ClusterConfiguration<br>kubernetesVersion: v1.20.4                                    #指定k8s版本，可以通用kubectl version查看获取<br>networking:<br>  dnsDomain: cluster.local<br>  podSubnet: 192.244.0.0/16                                    #指定Pod的⽹络范围<br>  serviceSubnet: 192.100.0.0/16                                #指定Service的⽹络范围<br>scheduler: &#123;&#125;<br>//<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">预下载镜像</span><br>kubeadm config images pull --config kubeadm-init.yml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化</span><br>kubeadm init --config kubeadm-init.yml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置kubectl的config⽂件</span><br>mkdir -p $HOME/.kube<br>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>sudo chown $(id -u):$(id -g) $HOME/.kube/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装flannel网络插件（k8s支持很多网络插件，此处以flannel为例）</span><br>cat &gt; /run/flannel/subnet.env &lt;&lt; EOF<br>FLANNEL_NETWORK=10.244.0.0/16<br>FLANNEL_SUBNET=10.244.0.1/24<br>FLANNEL_MTU=1450<br>FLANNEL_IPMASQ=true<br>EOF<br><br>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置命令补全</span><br>yum install -y bash-completion<br>source /usr/share/bash-completion/bash_completion<br>source &lt;(kubectl completion bash)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">切换默认命名空间</span><br>kubectl config set-context $(kubectl config current-context) --namespace=kube-system<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看pod情况</span><br>kubectl get pod -o wide<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化失败或者反复可以重置</span><br>kubeadm reset<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">复制一下脚本内容</span><br>vim add_master.sh<br><span class="hljs-meta prompt_">#</span><span class="language-bash">/bin/bash</span><br>CONTROL_PLANE_IPS=&quot;backup node&quot;                                               #多个节点以空格隔开<br>for host in $&#123;CONTROL_PLANE_IPS&#125;<br>do<br> ssh root@$&#123;host&#125; &quot;mkdir -p /etc/kubernetes/pki/etcd&quot;<br> scp -r /etc/kubernetes/pki/ca.* root@$&#123;host&#125;:/etc/kubernetes/pki/<br> scp -r /etc/kubernetes/pki/sa.* root@$&#123;host&#125;:/etc/kubernetes/pki/<br> scp -r /etc/kubernetes/pki/front-proxy-ca.* root@$&#123;host&#125;:/etc/kubernetes/pki/<br> scp -r /etc/kubernetes/pki/etcd/ca.* root@$&#123;host&#125;:/etc/kubernetes/pki/etcd/<br> scp -r /etc/kubernetes/admin.conf root@$&#123;host&#125;:/etc/kubernetes/<br>done<br><span class="hljs-meta prompt_">#</span><span class="language-bash">执行脚本，将证书信息传到其他副master</span><br>sh add_master.sh<br></code></pre></td></tr></table></figure><h2 id="副master"><a class="markdownIt-Anchor" href="#副master"></a> 副Master</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">加入进已经初始化的主master(此处命令在主master初始化会有)</span><br>kubeadm join 192.168.204.200:8443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:4159d86c40fea91f3b7a2669eb4ca0e927466928e7df0a901c11b40dfd766dda --control-plane<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置kubectl的config⽂件</span><br>mkdir -p $HOME/.kube<br>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>sudo chown $(id -u):$(id -g) $HOME/.kube/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装flannel网络插件（k8s支持很多网络插件，此处以flannel为例）</span><br>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看节点情况（如果不安装网络插件，查看的STATUS会为NOT READY）</span><br>kubectl get nodes<br>NAME     STATUS   ROLES                  AGE     VERSION<br>backup   Ready    control-plane,master   9m53s   v1.20.4<br>master   Ready    control-plane,master   32m     v1.20.4<br>node     Ready    control-plane,master   4m20s   v1.20.4<br></code></pre></td></tr></table></figure><h2 id="设置为node"><a class="markdownIt-Anchor" href="#设置为node"></a> 设置为node</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看节点容忍，当前三个节点无法调用pod</span><br>kubectl describe node master |grep -E &#x27;(Role|Taint)&#x27;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">取消污点后，master可以当作node</span><br>kubectl taint nodes master node-role.kubernetes.io/master-<br></code></pre></td></tr></table></figure><h2 id="token过期"><a class="markdownIt-Anchor" href="#token过期"></a> token过期</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">列出token信息</span><br>kubeadm token list<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建新的token</span><br>kubeadm token create<br><span class="hljs-meta prompt_">#</span><span class="language-bash">获取ca证书sha256编码<span class="hljs-built_in">hash</span>值</span><br>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &#x27;s/^.* //&#x27;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成新token和获取<span class="hljs-built_in">hash</span>后放入之前的<span class="hljs-built_in">join</span>命令重新拼接执行</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学海无涯</category>
      
      <category>K8S</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>通过Kubeadm部署Kubernetes单主多从集群</title>
    <link href="/posts/50bdf01d.html"/>
    <url>/posts/50bdf01d.html</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1 id="学习环境"><a class="markdownIt-Anchor" href="#学习环境"></a> 学习环境</h1><p>vmware安装三台虚拟机，或者先安装一台，完成下面的准备操作后克隆两台虚拟机，再修改IP；主机名可以在安装时候设置，或者装完之后通过hostnamectl set-hostname修改；</p><table><thead><tr><th style="text-align:center">hostname</th><th style="text-align:center">os</th><th style="text-align:center">static ip</th><th style="text-align:center">role</th></tr></thead><tbody><tr><td style="text-align:center">master</td><td style="text-align:center">centos7.6</td><td style="text-align:center">192.168.204.131</td><td style="text-align:center">master</td></tr><tr><td style="text-align:center">minion</td><td style="text-align:center">centos7.6</td><td style="text-align:center">192.168.204.132</td><td style="text-align:center">node1</td></tr><tr><td style="text-align:center">slave</td><td style="text-align:center">centos7.6</td><td style="text-align:center">192.168.204.133</td><td style="text-align:center">node2</td></tr></tbody></table><p>没有特殊说明，默认每台虚拟机都要操作；</p><p>网站文档：<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/%EF%BC%9B">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/；</a></p><h1 id="准备操作"><a class="markdownIt-Anchor" href="#准备操作"></a> 准备操作</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭</span><br>systemctl stop firewalld<br><span class="hljs-meta prompt_">#</span><span class="language-bash">禁用，重启生效</span><br>systemctl disable firewalld<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭</span><br>setenforce 0<br><span class="hljs-meta prompt_">#</span><span class="language-bash">禁用,重启生效</span><br>sed -i &quot;s/enforcing/disabled/g&quot; /etc/selinux/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">临时关闭</span><br>swapoff -a<br><span class="hljs-meta prompt_">#</span><span class="language-bash">永久关闭</span><br>sed -i &#x27;s/^[^#].*swap*/#&amp;/g&#x27; /etc/fstab<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装常用软件包</span><br>yum install vim net-tools lrzsz unzip dos2unix telnet sysstat iotop pciutils lsof tcpdump psmisc bc wget socat gcc tree chrony ntpdate mlocate -y<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主机名写入hosts</span><br>cat &gt;&gt; /etc/hosts &lt;&lt; EOF<br>192.168.204.131 master<br>192.168.204.132 minion<br>192.168.204.133 slave<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主机间配置ssh免密登录</span><br>ssh-keygen -t rsa<br>for host in master minion slave; do ssh-copy-id -i ~/.ssh/id_rsa.pub $host;done<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">内核开启网络支持</span><br>cat &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>net.ipv4.ip_forward = 1<br>net.ipv4.ip_nonlocal_bind = 1<br>EOF<br>modprobe br_netfilter<br>sysctl -p /etc/sysctl.d/kubernetes.conf<br></code></pre></td></tr></table></figure><h1 id="docker"><a class="markdownIt-Anchor" href="#docker"></a> Docker</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">官方脚本安装</span><br>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">手动yum安装</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">卸载原有docker</span><br>yum remove docker*<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装所需的软件包。yum-utils 提供了 yum-config-manager ，并且 device mapper 存储驱动程序需要 device-mapper-persistent-data 和 lvm2</span><br>yum install -y yum-utils device-mapper-persistent-data lvm2<br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置阿里源地址</span><br>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装</span><br>yum install docker-ce docker-ce-cli containerd.io -y<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置镜像加速地址,并修改Cgroup Driver(docker默认cgroupfs，k8s推荐使用systemd)</span><br>mkdir /etc/docker -p<br>cat &gt; /etc/docker/daemon.json &lt;&lt; EOF<br>&#123;&quot;registry-mirrors&quot;:[&quot;https://docker.mirrors.ustc.edu.cn/&quot;],<br>  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125;<br>EOF<br>systemctl daemon-reload<br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动docker并设置自启</span><br>for op in enable start status;do systemctl $op docker;done<br></code></pre></td></tr></table></figure><h1 id="master"><a class="markdownIt-Anchor" href="#master"></a> Master</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">配置k8s阿里源地址</span><br>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo<br>[kubernetes]<br>name=Kubernetes<br>baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64<br>enabled=1<br>gpgcheck=0<br>repo_gpgcheck=0<br>gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg<br>http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装k8s相关</span><br>yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes<br>systemctl enable --now kubelet<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化master</span><br>A:参数初始(可选参数较多，命令会比较长)<br>kubeadm init \<br>--apiserver-advertise-address=192.168.204.131 \<br>--kubernetes-version v1.20.4 \<br>--service-cidr=192.100.0.0/16 \<br>--pod-network-cidr=192.244.0.0/16 \<br>--control-plane-endpoint 192.168.204.200:8443 \<br>--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers<br><br>B:配置文件初始(通过配置文件修改参数，复用性高，易修改)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">导出默认配置文件</span><br>kubeadm config print init-defaults &gt; kubeadm-init.yml<br>vim kubeadm-init.yml<br>//<br>apiVersion: kubeadm.k8s.io/v1beta2<br>bootstrapTokens:<br>- groups:<br>  - system:bootstrappers:kubeadm:default-node-token<br>  token: abcdef.0123456789abcdef                        #token,默认值即可<br>  ttl: 2400h0m0s                                         #token有效期，添加节点如果token过期需要重新⽣成<br>  usages:<br>  - signing<br>  - authentication<br>kind: InitConfiguration<br>localAPIEndpoint:<br>  advertiseAddress: 192.168.204.131                   #修改为本地主机IP<br>  bindPort: 6443<br>nodeRegistration:<br>  criSocket: /var/run/dockershim.sock<br>  name: master                                        #默认为本地主机名<br>  taints:<br>  - effect: NoSchedule<br>    key: node-role.kubernetes.io/master<br>---<br>apiServer:<br>  timeoutForControlPlane: 4m0s<br>apiVersion: kubeadm.k8s.io/v1beta2<br>certificatesDir: /etc/kubernetes/pki<br>clusterName: kubernetes<br>controlPlaneEndpoint: &quot;192.168.204.131:6443&quot;                 #单master节点时这⾥写“本地真实IP:6443”；多master节点时写“VIP:端⼝”，端⼝要与haproxy配置中的bind字段的端⼝⼀致<br>controllerManager: &#123;&#125;<br>dns: &#123;&#125;<br>etcd:<br>  local:<br>    dataDir: /var/lib/etcd<br>imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers    #镜像地址，默认为k8s地址，此处已修改为阿里云<br>kind: ClusterConfiguration<br>kubernetesVersion: v1.20.4                                    #指定k8s版本，可以通用kubectl version查看获取<br>networking:<br>  dnsDomain: cluster.local<br>  podSubnet: 192.244.0.0/16                                    #指定Pod的⽹络范围                        <br>  serviceSubnet: 192.100.0.0/16                                #指定Service的⽹络范围<br>scheduler: &#123;&#125;<br>//<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">预下载镜像</span><br>kubeadm config images pull --config kubeadm-init.yml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化</span><br>kubeadm init --config kubeadm-init.yml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置kubectl的config⽂件(此处命令在master初始化会有)</span><br>mkdir -p $HOME/.kube<br>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>sudo chown $(id -u):$(id -g) $HOME/.kube/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装flannel网络插件（k8s支持很多网络插件，此处以flannel为例）</span><br>cat &gt; /run/flannel/subnet.env &lt;&lt; EOF<br>FLANNEL_NETWORK=10.244.0.0/16<br>FLANNEL_SUBNET=10.244.0.1/24<br>FLANNEL_MTU=1450<br>FLANNEL_IPMASQ=true<br>EOF<br><br>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置命令补全</span><br>yum install -y bash-completion<br>source /usr/share/bash-completion/bash_completion<br>source &lt;(kubectl completion bash)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">切换默认命名空间</span><br>kubectl config set-context $(kubectl config current-context) --namespace=kube-system<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看pod情况</span><br>kubectl get pod -o wide<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化失败或者反复可以重置</span><br>kubeadm reset<br></code></pre></td></tr></table></figure><h1 id="nodes"><a class="markdownIt-Anchor" href="#nodes"></a> Nodes</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">配置k8s阿里源地址</span><br>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo<br>[kubernetes]<br>name=Kubernetes<br>baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64<br>enabled=1<br>gpgcheck=0<br>repo_gpgcheck=0<br>gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg<br>http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装k8s相关</span><br>yum install -y kubelet kubeadm --disableexcludes=kubernetes<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动kubelet并设置自启</span><br>for op in enable start status;do systemctl $op kubelet;done<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">加入nodes(此处命令在master初始化会有)</span><br>kubeadm join 192.168.204.131:6443 --token abcdef.0123456789abcdef<br>    --discovery-token-ca-cert-hash sha256:724d623dc0cde1d350ebea86b6a583c3221a2bdef735db804b145eac751037b0<br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果忘记通过以下命令查看</span><br>kubeadm token create --print-join-command<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">node节点<span class="hljs-built_in">join</span>之后，可以在master查看节点情况（如果不安装网络插件，查看的STATUS会为NOT READY）</span><br>kubectl get nodes<br>NAME     STATUS   ROLES                  AGE     VERSION<br>master   Ready    control-plane,master   32m     v1.20.4<br>minion   Ready    &lt;none&gt;                   9m      v1.20.4<br>slave    Ready    &lt;none&gt;                4m20s   v1.20.4<br></code></pre></td></tr></table></figure><h1 id="安装dashboardmaster"><a class="markdownIt-Anchor" href="#安装dashboardmaster"></a> 安装dashboard（Master）</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">下载默认yaml文件</span><br>wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta4/aio/deploy/recommended.yaml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改yaml</span><br>vim recommended.yaml修改NodePort <br>//<br>kind: Service<br>apiVersion: v1<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard<br>  namespace: kubernetes-dashboard<br>spec:<br>  type: NodePort                              #默认没有，添加<br>  ports:<br>    - port: 443<br>      targetPort: 8443<br>      nodePort: 30001                        #默认没有，添加，30001为自定义端口<br>  selector:<br>    k8s-app: kubernetes-dashboard<br>//<br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动dashboard，执行命令之后可以稍微等一会</span><br>kubectl apply -f recommended.yaml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看dashboard的pod</span><br>kubectl get pod -n kubernetes-dashboard | grep dashboard<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成证书</span><br>openssl genrsa -out dashboard.key 2048 <br>openssl req -new -out dashboard.csr -key dashboard.key -subj &#x27;/CN=192.168.204.131&#x27;<br>openssl x509 -req -days 3650 -in dashboard.csr -signkey dashboard.key -out dashboard.crt<br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除原有证书</span><br>kubectl delete secret kubernetes-dashboard-certs -n kubernetes-dashboard<br><span class="hljs-meta prompt_">#</span><span class="language-bash">通过新生成的证书创建secret</span><br>kubectl create secret generic kubernetes-dashboard-certs --from-file=dashboard.key --from-file=dashboard.crt -n kubernetes-dashboard<br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除原有pod即可（会自动创建新的pod）</span><br>kubectl delete pod &lt;pod name&gt; -n kubernetes-dashboard<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">给所有namespace授权</span><br>kubectl create serviceaccount dashboard-serviceaccount -n kubernetes-dashboard<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建clusterrolebinding</span><br>kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-serviceaccount<br><span class="hljs-meta prompt_">#</span><span class="language-bash">获取token</span><br>kubectl get secret -n kubernetes-dashboard | grep dashboard-serviceaccount-token<br>kubectl describe secret &lt;secret name&gt;<br><br>访问https://IP:之前自定义的端口,输入上一步获取的token即可登录看到相关信息<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学海无涯</category>
      
      <category>K8S</category>
      
    </categories>
    
    
  </entry>
  
  
  
  
  
  
  <entry>
    <title>關於</title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><div style="text-align: center"><p>無錫卅年土著 平時喜好讀書<br />跟隨貓咪腳步 生活並不孤獨</p><p>玩過一陣鋼筆 燒過兩年耳機<br />追過livehouse 去過酒吧蹦迪</p><p>最近沉迷鍵盤 間中買買模玩<br />深愛香港樂壇 週末遠足登山</p></div><p>    博客的95%終於搭好了，剩下的5%估計又要拖延……</p><p>    至於搭博客的原因：一部分是最近比較閑，有時間可以玩一玩，看到大佬都有自己的博客，也隨調研了一下各個開源框架，最終敲定了Hexo——相比較其它傻瓜式操作，Hexo顯得比較硬核，能體現出我是個搞技術的；其次是足夠成熟，用的人也多，有問題容易解決；再就是有花里胡哨的主題，一年365天一天換一套都不是問題。畢竟人嘛，總是會厭的，一天換一套太麻煩的話，一個月換一套也行。</p><p>    二來，就是確確實實想留下一點不能説毫無價值只能説意義不大的東西：前面説了，我是個搞技術的，搞技術的總得有筆記和文章證明吧，不然空口無憑誰信啊？以後換工作，給人貼GitHub Page地址也能順便瞭解一下我的實力；除了技術和學習相關的 ，也趁這個機會把平日偶爾寫的，記錄生活或者評論感想的細碎東西整理在一起，給大型同性別交友平臺GitHub托管我也比較放心。</p><p>    先到這裏，溜了溜了……</p>]]></content>
    
  </entry>
  
  
  
  <entry>
    <title>2023の歌</title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script>    <div id="aplayer-PsWLiNgZ" class="aplayer aplayer-tag-marker meting-tag-marker"         data-id="8006753638" data-server="netease" data-type="playlist" data-mode="circulation" data-autoplay="true" data-mutex="true" data-listmaxheight="500px" data-preload="auto" data-theme="#ad7a86" data-loop="all" data-order="random"    ></div>]]></content>
    
  </entry>
  
  
  
</search>
